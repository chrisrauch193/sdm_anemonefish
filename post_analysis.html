<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Anemonefish Mutualism Analysis Results</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="post_analysis_files/libs/clipboard/clipboard.min.js"></script>
<script src="post_analysis_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="post_analysis_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="post_analysis_files/libs/quarto-html/popper.min.js"></script>
<script src="post_analysis_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="post_analysis_files/libs/quarto-html/anchor.min.js"></script>
<link href="post_analysis_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="post_analysis_files/libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="post_analysis_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="post_analysis_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="post_analysis_files/libs/bootstrap/bootstrap-f6cd28cd790afc395fca185dab4641dc.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="fullcontent quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Anemonefish Mutualism Analysis Results</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="drivers-of-host-sea-anemone-and-anemonefish-richness" class="level1">
<h1>Drivers of Host Sea Anemone and Anemonefish Richness</h1>
<p>This section replicates the initial data loading and processing steps from the desert ant paperâ€™s results section, adapted for the anemonefish-anemone mutualism. We load the current predicted suitability rasters for host sea anemones and anemonefish (environmental-only models), calculate community richness, and crop them to the Indo-Pacific study area.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Using pacman for streamlined package management</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"pacman"</span>)) <span class="fu">install.packages</span>(<span class="st">"pacman"</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(here, dplyr, terra, sf, stringr, ggplot2, readr, tools, naturalearth, tidyterra)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Load project configuration</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure your working directory is the root of your sdm_anemonefish project</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(<span class="st">"scripts/config.R"</span>)) {</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">source</span>(<span class="st">"scripts/config.R"</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">file.exists</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"scripts/config.R"</span>))) {</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">source</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"scripts/config.R"</span>))</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"FATAL: Configuration file 'scripts/config.R' not found. Please set your working directory to the project root."</span>)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Configuration loaded and bundled into 'config' list.
Base directory: /home/bi-server-kyoto/a0236995/sdm_anemonefish 
Intermediate SDM Output Dir: /home/bi-server-kyoto/a0236995/sdm_anemonefish/data/sdm_output_intermediate 
Intermediate Models Dir: /home/bi-server-kyoto/a0236995/sdm_anemonefish/data/sdm_output_intermediate/models 
Intermediate Results Dir: /home/bi-server-kyoto/a0236995/sdm_anemonefish/data/sdm_output_intermediate/results 
Target Prediction Base: /home/bi-server-kyoto/a0236995/sdm_anemonefish/data/output/predictions 
Target Results Base: /home/bi-server-kyoto/a0236995/sdm_anemonefish/predictions 
Logging to file: /home/bi-server-kyoto/a0236995/sdm_anemonefish/data/sdm_output_intermediate/logs_and_analysis/sdm_run_20251127_172549.log (Level: INFO Append: TRUE )
Logging to console: TRUE (Level: INFO )
Parallel execution: TRUE with 31 cores.
Using predictors: PCA </code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"config"</span>)) <span class="fu">stop</span>(<span class="st">"FATAL: 'config' list not found after sourcing config.R"</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Helper function for constructing prediction filenames (already in your sdm_modeling_helpers.R)</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Make sure this helper is sourced or defined if not running the full pipeline before this</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(config<span class="sc">$</span>helpers_dir, <span class="st">"sdm_modeling_helpers.R"</span>)) <span class="co"># If needed</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>construct_mean_prediction_filename <span class="ot">&lt;-</span> <span class="cf">function</span>(species_name_sanitized, scenario_name, predictor_type_suffix, config) {</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># base_filename &lt;- paste0(config$global_seed, "-pred_", species_name_sanitized) # Using SDMtune mean convention implicitly</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># base_filename &lt;- paste0("mean_pred_", species_name_sanitized) # Using SDMtune mean convention implicitly</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># base_filename &lt;- paste0("501-pred_", species_name_sanitized) # Using SDMtune mean convention implicitly</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  base_filename <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"1-pred_"</span>, species_name_sanitized) <span class="co"># Using SDMtune mean convention implicitly</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  target_dir <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  target_filename_stem <span class="ot">&lt;-</span> <span class="cn">NULL</span> <span class="co"># Filename without extension</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (scenario_name <span class="sc">==</span> <span class="st">"current"</span>) {</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    target_dir <span class="ot">&lt;-</span> config<span class="sc">$</span>target_predictions_current_dir</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    target_filename_stem <span class="ot">&lt;-</span> <span class="fu">paste0</span>(base_filename, predictor_type_suffix) <span class="co"># Add suffix</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    ssp_dir_name <span class="ot">&lt;-</span> config<span class="sc">$</span>ssp_scenario_map[[scenario_name]]</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(ssp_dir_name)) { <span class="fu">warning</span>(<span class="st">"No SSP directory mapping for scenario: "</span>, scenario_name, <span class="at">call. =</span> <span class="cn">FALSE</span>); <span class="fu">return</span>(<span class="cn">NULL</span>) }</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    target_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(config<span class="sc">$</span>target_predictions_future_base, ssp_dir_name)</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    time_tag_clean <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">grepl</span>(<span class="st">"2050$"</span>, scenario_name), <span class="st">"dec50"</span>, <span class="fu">ifelse</span>(<span class="fu">grepl</span>(<span class="st">"2100$"</span>, scenario_name), <span class="st">"dec100"</span>, <span class="st">"UNKNOWN"</span>))</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(time_tag_clean <span class="sc">==</span> <span class="st">"UNKNOWN"</span>) { <span class="fu">warning</span>(<span class="st">"Cannot extract time tag from scenario: "</span>, scenario_name, <span class="at">call. =</span> <span class="cn">FALSE</span>); <span class="fu">return</span>(<span class="cn">NULL</span>) }</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    target_filename_stem <span class="ot">&lt;-</span> <span class="fu">paste0</span>(base_filename, <span class="st">"_"</span>, ssp_dir_name, <span class="st">"_"</span>, time_tag_clean, predictor_type_suffix) <span class="co"># Add suffix</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(target_dir) <span class="sc">||</span> <span class="fu">is.null</span>(target_filename_stem)) { <span class="fu">warning</span>(<span class="st">"Could not construct target path components."</span>, <span class="at">call. =</span> <span class="cn">FALSE</span>); <span class="fu">return</span>(<span class="cn">NULL</span>) }</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>  target_filename <span class="ot">&lt;-</span> <span class="fu">paste0</span>(target_filename_stem, <span class="st">".tif"</span>)</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">file.path</span>(target_dir, target_filename))</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Create Essential Output Directories ---</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a><span class="co"># This assumes config$base_dir is correctly defined in your config.R as the project root</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a><span class="co"># and you want to create directories relative to that.</span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Directory for general analysis outputs (like CSV summaries)</span></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>analysis_output_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(config<span class="sc">$</span>base_dir, <span class="st">"outputs_for_analysis"</span>)</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(analysis_output_dir)) {</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dir.create</span>(analysis_output_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Created directory for analysis outputs at:"</span>, analysis_output_dir, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Directory for figures</span></span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>figure_output_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(config<span class="sc">$</span>base_dir, <span class="st">"figure_files"</span>)</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(figure_output_dir)) {</span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dir.create</span>(figure_output_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Created directory for figures at:"</span>, figure_output_dir, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a><span class="co"># You can add other commonly used output directories here if needed.</span></span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a><span class="co"># For example, if you have a specific place for model objects:</span></span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a><span class="co"># model_objects_dir &lt;- file.path(config$base_dir, "model_objects")</span></span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a><span class="co"># if (!dir.exists(model_objects_dir)) {</span></span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a><span class="co">#   dir.create(model_objects_dir, recursive = TRUE)</span></span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a><span class="co">#   cat("Created directory for model objects at:", model_objects_dir, "\n")</span></span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"--- Setup: Essential output directories checked/created. ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- Setup: Essential output directories checked/created. ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Scenario Label Converter (Good to have this defined early) ---</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>scenario_label_converter <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"current"</span>     <span class="ot">=</span> <span class="st">"Current"</span>,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ssp119_2050"</span> <span class="ot">=</span> <span class="st">"SSP1-1.9 (2050)"</span>,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ssp119_2100"</span> <span class="ot">=</span> <span class="st">"SSP1-1.9 (2100)"</span>,</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ssp245_2050"</span> <span class="ot">=</span> <span class="st">"SSP2-4.5 (2050)"</span>, </span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ssp245_2100"</span> <span class="ot">=</span> <span class="st">"SSP2-4.5 (2100)"</span>, </span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ssp370_2050"</span> <span class="ot">=</span> <span class="st">"SSP3-7.0 (2050)"</span>, </span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ssp370_2100"</span> <span class="ot">=</span> <span class="st">"SSP3-7.0 (2100)"</span>, </span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ssp585_2050"</span> <span class="ot">=</span> <span class="st">"SSP5-8.5 (2050)"</span>,</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ssp585_2100"</span> <span class="ot">=</span> <span class="st">"SSP5-8.5 (2100)"</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add any other scenarios your project uses</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="co">#' Construct Target Prediction Filename</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="co">#' Builds the expected filename and path for a prediction raster based on target structure.</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="co">#' Used for checking if a prediction file already exists.</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param species_name_sanitized Sanitized species name (e.g., "Genus_species").</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param scenario_name The name of the scenario (e.g., "current", "ssp119_2050").</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param predictor_type_suffix Suffix indicating model type (e.g., "_pca", "_combined_pca").</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param config The configuration list.</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return Character string with the full path to the expected prediction file.</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>construct_mean_prediction_filename <span class="ot">&lt;-</span> <span class="cf">function</span>(species_name_sanitized, scenario_name, predictor_type_suffix, config) {</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>  base_filename <span class="ot">&lt;-</span> <span class="fu">paste0</span>(config<span class="sc">$</span>global_seed, <span class="st">"-pred_"</span>, species_name_sanitized) <span class="co"># Using SDMtune mean convention implicitly</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># base_filename &lt;- paste0("mean_pred_", species_name_sanitized) # Using SDMtune mean convention implicitly</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># base_filename &lt;- paste0(501, "-pred_", species_name_sanitized)</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>  target_dir <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>  target_filename_stem <span class="ot">&lt;-</span> <span class="cn">NULL</span> <span class="co"># Filename without extension</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (scenario_name <span class="sc">==</span> <span class="st">"current"</span>) {</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>    target_dir <span class="ot">&lt;-</span> config<span class="sc">$</span>target_predictions_current_dir</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>    target_filename_stem <span class="ot">&lt;-</span> <span class="fu">paste0</span>(base_filename, predictor_type_suffix) <span class="co"># Add suffix</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>    ssp_dir_name <span class="ot">&lt;-</span> config<span class="sc">$</span>ssp_scenario_map[[scenario_name]]</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(ssp_dir_name)) { <span class="fu">warning</span>(<span class="st">"No SSP directory mapping for scenario: "</span>, scenario_name, <span class="at">call. =</span> <span class="cn">FALSE</span>); <span class="fu">return</span>(<span class="cn">NULL</span>) }</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>    target_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(config<span class="sc">$</span>target_predictions_future_base, ssp_dir_name)</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>    time_tag_clean <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">grepl</span>(<span class="st">"2050$"</span>, scenario_name), <span class="st">"dec50"</span>, <span class="fu">ifelse</span>(<span class="fu">grepl</span>(<span class="st">"2100$"</span>, scenario_name), <span class="st">"dec100"</span>, <span class="st">"UNKNOWN"</span>))</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(time_tag_clean <span class="sc">==</span> <span class="st">"UNKNOWN"</span>) { <span class="fu">warning</span>(<span class="st">"Cannot extract time tag from scenario: "</span>, scenario_name, <span class="at">call. =</span> <span class="cn">FALSE</span>); <span class="fu">return</span>(<span class="cn">NULL</span>) }</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>    target_filename_stem <span class="ot">&lt;-</span> <span class="fu">paste0</span>(base_filename, <span class="st">"_"</span>, ssp_dir_name, <span class="st">"_"</span>, time_tag_clean, predictor_type_suffix) <span class="co"># Add suffix</span></span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(target_dir) <span class="sc">||</span> <span class="fu">is.null</span>(target_filename_stem)) { <span class="fu">warning</span>(<span class="st">"Could not construct target path components."</span>, <span class="at">call. =</span> <span class="cn">FALSE</span>); <span class="fu">return</span>(<span class="cn">NULL</span>) }</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>  target_filename <span class="ot">&lt;-</span> <span class="fu">paste0</span>(target_filename_stem, <span class="st">".tif"</span>)</span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">file.path</span>(target_dir, target_filename))</span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"--- Setup: Scenario label converter defined. ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- Setup: Scenario label converter defined. ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Load a world map for plotting ---</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>world_map_sf <span class="ot">&lt;-</span> rnaturalearth<span class="sc">::</span><span class="fu">ne_countries</span>(<span class="at">scale =</span> <span class="st">"medium"</span>, <span class="at">returnclass =</span> <span class="st">"sf"</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"--- Setup: World map loaded for plotting. ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- Setup: World map loaded for plotting. ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>bathymetry_raster_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(config<span class="sc">$</span>base_dir, <span class="st">"data"</span>, <span class="st">"env"</span>, <span class="st">"terrain"</span>, <span class="st">"bathymetry_mean.tif"</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>global_bathymetry <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(bathymetry_raster_path)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 0. Define Validation Helper Function ---</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="co"># This function ensures that a list of rasters shares the exact same geometry</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="co"># (CRS, extent, resolution, origin) as a reference raster.</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>validate_and_align_rasters <span class="ot">&lt;-</span> <span class="cf">function</span>(raster_list, reference_raster, <span class="at">method =</span> <span class="st">"bilinear"</span>) {</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>  aligned_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ensure reference is a SpatRaster</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">inherits</span>(reference_raster, <span class="st">"SpatRaster"</span>)) {</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Reference raster must be a terra SpatRaster object."</span>)</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"--- Starting Raster Alignment (Reference: %s) ---</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">names</span>(reference_raster)[<span class="dv">1</span>]))</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (name <span class="cf">in</span> <span class="fu">names</span>(raster_list)) {</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    r <span class="ot">&lt;-</span> raster_list[[name]]</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(r)) {</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  Skipping %s (NULL object)</span><span class="sc">\n</span><span class="st">"</span>, name))</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>      aligned_list[[name]] <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. Check CRS</span></span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (terra<span class="sc">::</span><span class="fu">crs</span>(r)<span class="sc">!=</span> terra<span class="sc">::</span><span class="fu">crs</span>(reference_raster)) {</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  [Fix] CRS mismatch for %s. Reprojecting...</span><span class="sc">\n</span><span class="st">"</span>, name))</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>      r <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">project</span>(r, reference_raster)</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Check Geometry (Extent, Resolution, Origin)</span></span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># compareGeom returns TRUE if strict alignment is met</span></span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>    is_aligned <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">compareGeom</span>(r, reference_raster, <span class="at">stopOnError =</span> <span class="cn">FALSE</span>, </span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>                         <span class="at">rowcol =</span> <span class="cn">TRUE</span>, <span class="at">ext =</span> <span class="cn">TRUE</span>, <span class="at">res =</span> <span class="cn">TRUE</span>, <span class="at">orig =</span> <span class="cn">TRUE</span>),</span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>      <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">FALSE</span></span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span>is_aligned) {</span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  [Fix] Geometry mismatch for %s. Resampling to reference...</span><span class="sc">\n</span><span class="st">"</span>, name))</span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Resample aligns the grid to the reference</span></span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>      r <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">resample</span>(r, reference_raster, <span class="at">method =</span> method)</span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Masking ensures NAs match the reference (e.g., landmask)</span></span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>      r <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">mask</span>(r, reference_raster)</span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  [OK] %s is already aligned.</span><span class="sc">\n</span><span class="st">"</span>, name))</span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>    aligned_list[[name]] <span class="ot">&lt;-</span> r</span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"--- Alignment Complete ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(aligned_list)</span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Master Species Lists for Analysis ---</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Comment out any species you wish to EXCLUDE from all subsequent analyses.</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co"># -- Host Anemone Species to Include --</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>include_anemones <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Entacmaea quadricolor"</span>,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Radianthus crispa"</span>,</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Radianthus magnifica"</span>,</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Stichodactyla gigantea"</span>,</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Cryptodendrum adhaesivum"</span>,</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Macrodactyla doreensis"</span>,</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Stichodactyla mertensii"</span>,</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Stichodactyla haddoni"</span>,</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Radianthus malu"</span>,</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Heteractis aurora"</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="co"># -- Anemonefish Species to Include --</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>include_anemonefish <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion clarkii"</span>,</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion frenatus"</span>,</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion ocellaris"</span>,</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion perideraion"</span>,</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion polymnus"</span>,</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion sandaracinos"</span>,</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion akallopisos"</span>,</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion omanensis"</span>,</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion akindynos"</span>,</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion allardi"</span>,</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion barberi"</span>,</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion bicinctus"</span>,</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># "Amphiprion chagosensis",</span></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion chrysogaster"</span>,</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion chrysopterus"</span>,</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion ephippium"</span>,</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion fuscocaudatus"</span>,</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion latezonatus"</span>,</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion latifasciatus"</span>,</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion leucokranos"</span>,</span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># "Amphiprion mccullochi",</span></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion melanopus"</span>,</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion nigripes"</span>,</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion percula"</span>,</span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion rubrocinctus"</span>,</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion sebae"</span>,</span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion tricinctus"</span>,</span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Premnas biaculeatus"</span>,</span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion pacificus"</span></span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Load and Filter the Main Data Frames ---</span></span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a><span class="co"># This part reads the full CSVs (created by script 02) and filters them.</span></span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a><span class="co"># The filtered data frames will be used by all subsequent chunks.</span></span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a><span class="co"># Load Anemones</span></span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>anemone_species_df_full <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(config<span class="sc">$</span>anemone_species_list_file, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>anemone_species_df <span class="ot">&lt;-</span> anemone_species_df_full <span class="sc">%&gt;%</span></span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(scientificName <span class="sc">%in%</span> include_anemones)</span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Filtered Host Anemones: Retaining %d of %d species for analysis.</span><span class="sc">\n</span><span class="st">"</span>, </span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a>            <span class="fu">nrow</span>(anemone_species_df), <span class="fu">nrow</span>(anemone_species_df_full)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Filtered Host Anemones: Retaining 10 of 10 species for analysis.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load Anemonefish</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>anemonefish_species_df_full <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(config<span class="sc">$</span>anemonefish_species_list_file, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>anemonefish_species_df <span class="ot">&lt;-</span> anemonefish_species_df_full <span class="sc">%&gt;%</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(scientificName <span class="sc">%in%</span> include_anemonefish)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Filtered Anemonefish: Retaining %d of %d species for analysis.</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>            <span class="fu">nrow</span>(anemonefish_species_df), <span class="fu">nrow</span>(anemonefish_species_df_full)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Filtered Anemonefish: Retaining 27 of 29 species for analysis.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Define Parameters ---</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>current_scenario_name <span class="ot">&lt;-</span> <span class="st">"current"</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co"># predictor_suffix &lt;- ifelse(config$use_pca_predictors, "_pca", "_vif")</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>predictor_suffix_anemone <span class="ot">&lt;-</span> <span class="st">"_pca"</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>predictor_suffix <span class="ot">&lt;-</span> <span class="st">"_combined_pca"</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 0. Create figure directory if it doesn't exist ---</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>figure_output_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(config<span class="sc">$</span>base_dir, <span class="st">"figure_files"</span>)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(figure_output_dir)) {</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dir.create</span>(figure_output_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Created directory for figures at:"</span>, figure_output_dir, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 1. Load Host Sea Anemone Data ---</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"--- Loading Host Sea Anemone Predictions (Current Scenario) ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- Loading Host Sea Anemone Predictions (Current Scenario) ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This assumes anemone_species_df is loaded and filtered from a previous chunk.</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>host_raster_files <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>host_short_names <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(anemone_species_df)) {</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  sp_name_sanitized <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">"_"</span>, anemone_species_df<span class="sc">$</span>scientificName[i])</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  pred_file_path <span class="ot">&lt;-</span> <span class="fu">construct_mean_prediction_filename</span>(</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">species_name_sanitized =</span> sp_name_sanitized,</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">scenario_name =</span> current_scenario_name,</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">predictor_type_suffix =</span> predictor_suffix_anemone, </span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">config =</span> config</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">file.exists</span>(pred_file_path)) {</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>    host_raster_files <span class="ot">&lt;-</span> <span class="fu">c</span>(host_raster_files, pred_file_path)</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    host_short_names <span class="ot">&lt;-</span> <span class="fu">c</span>(host_short_names, sp_name_sanitized) </span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Warning: Host prediction file not found for"</span>, sp_name_sanitized, <span class="st">"at"</span>, pred_file_path, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>host_pred_stack <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(host_raster_files) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>  host_pred_stack <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(host_raster_files)</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(host_pred_stack) <span class="ot">&lt;-</span> host_short_names</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Loaded"</span>, terra<span class="sc">::</span><span class="fu">nlyr</span>(host_pred_stack), <span class="st">"host anemone prediction rasters.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>  host_richness_sum <span class="ot">&lt;-</span> <span class="fu">sum</span>(host_pred_stack, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(host_richness_sum) <span class="ot">&lt;-</span> <span class="st">"HostAnemoneRichness"</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Calculated host anemone summed richness.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Error: No host anemone prediction rasters found. Cannot proceed with host richness.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>  host_richness_sum <span class="ot">&lt;-</span> <span class="cn">NULL</span> </span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Loaded 10 host anemone prediction rasters.
Calculated host anemone summed richness.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 2. Load Anemonefish (Combined Models) Data ---</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Loading Anemonefish (Combined) Predictions (Current Scenario) ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Loading Anemonefish (Combined) Predictions (Current Scenario) ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This assumes anemonefish_species_df is loaded and filtered from a previous chunk.</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>fish_raster_files <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>fish_short_names <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(anemonefish_species_df)) {</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  sp_name_sanitized <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">"_"</span>, anemonefish_species_df<span class="sc">$</span>scientificName[i])</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  pred_file_path <span class="ot">&lt;-</span> <span class="fu">construct_mean_prediction_filename</span>(</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">species_name_sanitized =</span> sp_name_sanitized,</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">scenario_name =</span> current_scenario_name,</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">predictor_type_suffix =</span> predictor_suffix, </span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">config =</span> config</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">file.exists</span>(pred_file_path)) {</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    fish_raster_files <span class="ot">&lt;-</span> <span class="fu">c</span>(fish_raster_files, pred_file_path)</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    fish_short_names <span class="ot">&lt;-</span> <span class="fu">c</span>(fish_short_names, sp_name_sanitized)</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Warning: Anemonefish (combined) prediction file not found for"</span>, sp_name_sanitized, <span class="st">"at"</span>, pred_file_path, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Warning: Anemonefish (combined) prediction file not found for Amphiprion_pacificus at /home/bi-server-kyoto/a0236995/sdm_anemonefish/data/output/predictions/1-pred_Amphiprion_pacificus_combined_pca.tif </code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>fish_pred_stack <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(fish_raster_files) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  fish_pred_stack <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(fish_raster_files)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(fish_pred_stack) <span class="ot">&lt;-</span> fish_short_names</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Loaded"</span>, terra<span class="sc">::</span><span class="fu">nlyr</span>(fish_pred_stack), <span class="st">"anemonefish (combined) prediction rasters.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  fish_richness_sum <span class="ot">&lt;-</span> <span class="fu">sum</span>(fish_pred_stack, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(fish_richness_sum) <span class="ot">&lt;-</span> <span class="st">"AnemonefishRichness_Combined"</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Calculated anemonefish (combined) summed richness.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Error: No anemonefish (combined) prediction rasters found. Cannot proceed with fish richness.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>  fish_richness_sum <span class="ot">&lt;-</span> <span class="cn">NULL</span> </span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Loaded 26 anemonefish (combined) prediction rasters.
Calculated anemonefish (combined) summed richness.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 3. Crop to Indo-Pacific Extent (if rasters were successfully loaded) ---</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Cropping Rasters to Indo-Pacific Extent ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Cropping Rasters to Indo-Pacific Extent ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (config<span class="sc">$</span>apply_indo_pacific_crop) {</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  ip_extent <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">ext</span>(config<span class="sc">$</span>indo_pacific_bbox)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Using Indo-Pacific Bounding Box for cropping:"</span>, <span class="fu">paste</span>(config<span class="sc">$</span>indo_pacific_bbox, <span class="at">collapse=</span><span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(host_pred_stack)) {</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    host_pred_stack_cropped <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(terra<span class="sc">::</span><span class="fu">crop</span>(host_pred_stack, ip_extent), <span class="at">error =</span> <span class="cf">function</span>(e) { <span class="fu">cat</span>(<span class="st">"Warning: Failed to crop host_pred_stack:"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>); host_pred_stack })</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> { host_pred_stack_cropped <span class="ot">&lt;-</span> <span class="cn">NULL</span> }</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(host_richness_sum)) {</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    host_richness_sum_cropped <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(terra<span class="sc">::</span><span class="fu">crop</span>(host_richness_sum, ip_extent), <span class="at">error =</span> <span class="cf">function</span>(e) { <span class="fu">cat</span>(<span class="st">"Warning: Failed to crop host_richness_sum:"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>); host_richness_sum })</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> { host_richness_sum_cropped <span class="ot">&lt;-</span> <span class="cn">NULL</span> }</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(fish_pred_stack)) {</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>    fish_pred_stack_cropped <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(terra<span class="sc">::</span><span class="fu">crop</span>(fish_pred_stack, ip_extent), <span class="at">error =</span> <span class="cf">function</span>(e) { <span class="fu">cat</span>(<span class="st">"Warning: Failed to crop fish_pred_stack:"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>); fish_pred_stack })</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> { fish_pred_stack_cropped <span class="ot">&lt;-</span> <span class="cn">NULL</span> }</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(fish_richness_sum)) {</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>    fish_richness_sum_cropped <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(terra<span class="sc">::</span><span class="fu">crop</span>(fish_richness_sum, ip_extent), <span class="at">error =</span> <span class="cf">function</span>(e) { <span class="fu">cat</span>(<span class="st">"Warning: Failed to crop fish_richness_sum:"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>); fish_richness_sum })</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> { fish_richness_sum_cropped <span class="ot">&lt;-</span> <span class="cn">NULL</span> }</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Cropping complete.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Skipping Indo-Pacific cropping based on config.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>  host_pred_stack_cropped <span class="ot">&lt;-</span> host_pred_stack</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>  host_richness_sum_cropped <span class="ot">&lt;-</span> host_richness_sum</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>  fish_pred_stack_cropped <span class="ot">&lt;-</span> fish_pred_stack</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>  fish_richness_sum_cropped <span class="ot">&lt;-</span> fish_richness_sum</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Using Indo-Pacific Bounding Box for cropping: 30, 180, -50, 50 
Cropping complete.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 4. Plot Cropped Richness Maps AND SAVE THEM ---</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Plotting and Saving Cropped Richness Maps ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Plotting and Saving Cropped Richness Maps ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(host_richness_sum_cropped)) {</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  host_plot_filename <span class="ot">&lt;-</span> <span class="fu">file.path</span>(figure_output_dir, <span class="st">"host_richness_current_cropped.png"</span>)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- MODIFIED: Use new plotting function for host richness ---</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Normalize richness values to a 0-1 scale for consistent coloring</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  max_host_rich <span class="ot">&lt;-</span> <span class="fu">global</span>(host_richness_sum_cropped, <span class="st">"max"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)<span class="sc">$</span>max</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>  host_richness_normalized <span class="ot">&lt;-</span> <span class="cf">if</span>(max_host_rich <span class="sc">&gt;</span> <span class="dv">0</span>) host_richness_sum_cropped <span class="sc">/</span> max_host_rich <span class="cf">else</span> host_richness_sum_cropped</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>  host_richness_plot <span class="ot">&lt;-</span> <span class="fu">plot_prediction_map</span>(</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">prediction_raster =</span> host_richness_normalized,</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">species_name =</span> <span class="st">"Summed Host Anemone Richness (Current, Cropped)"</span>,</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">world_basemap =</span> world_map_sf</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggsave</span>(host_plot_filename, <span class="at">plot =</span> host_richness_plot, <span class="at">width =</span> <span class="dv">10</span>, <span class="at">height =</span> <span class="dv">7</span>, <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">bg=</span><span class="st">"white"</span>)</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Saved host richness plot to:"</span>, host_plot_filename, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(host_richness_plot)</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Saved host richness plot to: /home/bi-server-kyoto/a0236995/sdm_anemonefish/figure_files/host_richness_current_cropped.png </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/load-and-process-rasters-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(fish_richness_sum_cropped)) {</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  fish_plot_filename <span class="ot">&lt;-</span> <span class="fu">file.path</span>(figure_output_dir, <span class="st">"fish_richness_current_combined_cropped.png"</span>)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- MODIFIED: Use new plotting function for fish richness ---</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  max_fish_rich <span class="ot">&lt;-</span> <span class="fu">global</span>(fish_richness_sum_cropped, <span class="st">"max"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)<span class="sc">$</span>max</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>  fish_richness_normalized <span class="ot">&lt;-</span> <span class="cf">if</span>(max_fish_rich <span class="sc">&gt;</span> <span class="dv">0</span>) fish_richness_sum_cropped <span class="sc">/</span> max_fish_rich <span class="cf">else</span> fish_richness_sum_cropped</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>  fish_richness_plot <span class="ot">&lt;-</span> <span class="fu">plot_prediction_map</span>(</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">prediction_raster =</span> fish_richness_normalized,</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">species_name =</span> <span class="st">"Summed Anemonefish Richness (Current, Combined, Cropped)"</span>,</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">world_basemap =</span> world_map_sf</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggsave</span>(fish_plot_filename, <span class="at">plot =</span> fish_richness_plot, <span class="at">width =</span> <span class="dv">10</span>, <span class="at">height =</span> <span class="dv">7</span>, <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">bg=</span><span class="st">"white"</span>)</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Saved anemonefish richness plot to:"</span>, fish_plot_filename, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(fish_richness_plot)</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Saved anemonefish richness plot to: /home/bi-server-kyoto/a0236995/sdm_anemonefish/figure_files/fish_richness_current_combined_cropped.png </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/load-and-process-rasters-2.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 5. Plot Cropped Individual Stacks with Occurrences (for display only) ---</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Displaying Individual Species Suitability Maps with Occurrences ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Displaying Individual Species Suitability Maps with Occurrences ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Optional: Plot cropped individual stacks if needed for visual check</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(host_pred_stack_cropped)) {</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">-- Host Anemone Individual Maps --</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nlyr</span>(host_pred_stack_cropped)) {</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    species_raster <span class="ot">&lt;-</span> host_pred_stack_cropped[[i]]</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    sp_name <span class="ot">&lt;-</span> <span class="fu">names</span>(species_raster)</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>    aphia_id <span class="ot">&lt;-</span> anemone_species_df<span class="sc">$</span>AphiaID[anemone_species_df<span class="sc">$</span>scientificName <span class="sc">==</span> <span class="fu">gsub</span>(<span class="st">"_"</span>, <span class="st">" "</span>, sp_name)]</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>    occ_sf <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(aphia_id) <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>      occ_file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(config<span class="sc">$</span>anemone_occurrence_dir, <span class="fu">paste0</span>(aphia_id, <span class="st">".csv"</span>))</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">file.exists</span>(occ_file)) {</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>        occ_df <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(occ_file, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(decimalLongitude) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(decimalLatitude))</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">nrow</span>(occ_df)<span class="sc">&gt;</span><span class="dv">0</span>) occ_sf <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_as_sf</span>(occ_df, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"decimalLongitude"</span>, <span class="st">"decimalLatitude"</span>), <span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="fu">plot_prediction_map</span>(species_raster, <span class="fu">gsub</span>(<span class="st">"_"</span>, <span class="st">" "</span>, sp_name), world_map_sf, occ_sf)</span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(p)</span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
-- Host Anemone Individual Maps --</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/load-and-process-rasters-3.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/load-and-process-rasters-4.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/load-and-process-rasters-5.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/load-and-process-rasters-6.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/load-and-process-rasters-7.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/load-and-process-rasters-8.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/load-and-process-rasters-9.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/load-and-process-rasters-10.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/load-and-process-rasters-11.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/load-and-process-rasters-12.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(fish_pred_stack_cropped)) {</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">-- Anemonefish (Combined) Individual Maps --</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nlyr</span>(fish_pred_stack_cropped)) {</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    species_raster <span class="ot">&lt;-</span> fish_pred_stack_cropped[[i]]</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    sp_name <span class="ot">&lt;-</span> <span class="fu">names</span>(species_raster)</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    aphia_id <span class="ot">&lt;-</span> anemonefish_species_df<span class="sc">$</span>AphiaID[anemonefish_species_df<span class="sc">$</span>scientificName <span class="sc">==</span> <span class="fu">gsub</span>(<span class="st">"_"</span>, <span class="st">" "</span>, sp_name)]</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    occ_sf <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(aphia_id) <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>      occ_file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(config<span class="sc">$</span>anemonefish_occurrence_dir, <span class="fu">paste0</span>(aphia_id, <span class="st">".csv"</span>))</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">file.exists</span>(occ_file)) {</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>        occ_df <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(occ_file, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(decimalLongitude) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(decimalLatitude))</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">nrow</span>(occ_df)<span class="sc">&gt;</span><span class="dv">0</span>) occ_sf <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_as_sf</span>(occ_df, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"decimalLongitude"</span>, <span class="st">"decimalLatitude"</span>), <span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="fu">plot_prediction_map</span>(species_raster, <span class="fu">gsub</span>(<span class="st">"_"</span>, <span class="st">" "</span>, sp_name), world_map_sf, occ_sf)</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(p)</span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
-- Anemonefish (Combined) Individual Maps --</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/load-and-process-rasters-13.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/load-and-process-rasters-14.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/load-and-process-rasters-15.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/load-and-process-rasters-16.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/load-and-process-rasters-17.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/load-and-process-rasters-18.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/load-and-process-rasters-19.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/load-and-process-rasters-20.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/load-and-process-rasters-21.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/load-and-process-rasters-22.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/load-and-process-rasters-23.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/load-and-process-rasters-24.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/load-and-process-rasters-25.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/load-and-process-rasters-26.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/load-and-process-rasters-27.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/load-and-process-rasters-28.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/load-and-process-rasters-29.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/load-and-process-rasters-30.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/load-and-process-rasters-31.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/load-and-process-rasters-32.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/load-and-process-rasters-33.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/load-and-process-rasters-34.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/load-and-process-rasters-35.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/load-and-process-rasters-36.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/load-and-process-rasters-37.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/load-and-process-rasters-38.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- First section of results processing finished. ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- First section of results processing finished. ---</code></pre>
</div>
</div>
<section id="evaluate-models" class="level2">
<h2 class="anchored" data-anchor-id="evaluate-models">Evaluate models</h2>
<p>This section loads the cross-validation (CV) results from the various SDM runs for host sea anemones and different types of anemonefish models (environmental-only, biotic-only, and combined environmental + biotic), focusing on AUC.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr) <span class="co"># For map_df</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr) <span class="co"># For data manipulation</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr) <span class="co"># For read_csv</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr) <span class="co"># For str_extract, str_remove</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 1. Load Host Sea Anemone CV Results ("Plants" equivalent) ---</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>host_predictor_suffix <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(config<span class="sc">$</span>use_pca_predictors, <span class="st">"_pca"</span>, <span class="st">"_vif"</span>)</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>host_cv_results_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(config<span class="sc">$</span>target_results_base, <span class="fu">paste0</span>(<span class="st">"anemone"</span>, host_predictor_suffix))</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Loading Host Sea Anemone CV results from:"</span>, host_cv_results_dir, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Loading Host Sea Anemone CV results from: /home/bi-server-kyoto/a0236995/sdm_anemonefish/predictions/anemone_pca </code></pre>
</div>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>host_cv_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(host_cv_results_dir,</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>                            <span class="at">pattern =</span> <span class="st">"^CV_Results_.*_depth_-750</span><span class="sc">\\</span><span class="st">.csv$"</span>,</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>                            <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(host_cv_files) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>  host_cv_data <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map_df</span>(host_cv_files, </span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>                <span class="sc">~</span>readr<span class="sc">::</span><span class="fu">read_csv</span>(.x, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">mutate</span>(<span class="at">filename_full =</span> .x, </span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>                          <span class="at">filename =</span> <span class="fu">basename</span>(.x),</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>                          <span class="at">SpeciesName =</span> <span class="fu">str_remove</span>(<span class="fu">str_extract</span>(<span class="fu">basename</span>(.x), <span class="st">"(?&lt;=CV_Results_).*(?=_depth)"</span>), <span class="st">"_pca|_vif"</span>))) <span class="co"># Extract species name cleanly</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>  host_model_evals <span class="ot">&lt;-</span> host_cv_data <span class="sc">%&gt;%</span></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(SpeciesName) <span class="sc">%&gt;%</span> <span class="co"># Group by SpeciesName for summary</span></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_AUC_test_CV =</span> <span class="fu">mean</span>(AUC_test_CV, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">sd_AUC_test_CV =</span> <span class="fu">sd</span>(AUC_test_CV, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_TSS_test_CV =</span> <span class="fu">mean</span>(TSS_test_CV, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="co"># ADDED TSS</span></span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">sd_TSS_test_CV =</span> <span class="fu">sd</span>(TSS_test_CV, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)     <span class="co"># ADDED TSS</span></span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), <span class="sc">~</span><span class="fu">round</span>(., <span class="dv">3</span>))) </span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">First few rows of Host Sea Anemone Model Evaluations (AUC and TSS):</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">head</span>(host_model_evals))</span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a>  host_cv_summary_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(config<span class="sc">$</span>base_dir, <span class="st">"outputs_for_analysis"</span>, <span class="st">"host_anemone_CV_summary_auc_tss.csv"</span>) <span class="co"># Renamed output file</span></span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dir.create</span>(<span class="fu">dirname</span>(host_cv_summary_path), <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>)</span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write.csv</span>(host_model_evals, host_cv_summary_path, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb44-28"><a href="#cb44-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Host Sea Anemone CV summary (AUC and TSS) saved to:"</span>, host_cv_summary_path, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb44-29"><a href="#cb44-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-30"><a href="#cb44-30" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb44-31"><a href="#cb44-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Warning: No CV_Results CSV files found for host sea anemones in"</span>, host_cv_results_dir, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb44-32"><a href="#cb44-32" aria-hidden="true" tabindex="-1"></a>  host_cv_data <span class="ot">&lt;-</span> <span class="cn">NULL</span> </span>
<span id="cb44-33"><a href="#cb44-33" aria-hidden="true" tabindex="-1"></a>  host_model_evals <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb44-34"><a href="#cb44-34" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
First few rows of Host Sea Anemone Model Evaluations (AUC and TSS):
# A tibble: 6 Ã— 5
  SpeciesName    mean_AUC_test_CV sd_AUC_test_CV mean_TSS_test_CV sd_TSS_test_CV
  &lt;chr&gt;                     &lt;dbl&gt;          &lt;dbl&gt;            &lt;dbl&gt;          &lt;dbl&gt;
1 Cryptodendrumâ€¦            0.896          0.033            0.701          0.053
2 Entacmaea_quaâ€¦            0.952          0.013            0.823          0.019
3 Heteractis_auâ€¦            0.896          0.012            0.773          0.023
4 Macrodactyla_â€¦            0.936          0.01             0.779          0.009
5 Radianthus_crâ€¦            0.867          0.025            0.696          0.045
6 Radianthus_maâ€¦            0.934          0.011            0.796          0.014

Host Sea Anemone CV summary (AUC and TSS) saved to: /home/bi-server-kyoto/a0236995/sdm_anemonefish/outputs_for_analysis/host_anemone_CV_summary_auc_tss.csv </code></pre>
</div>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 2. Load Anemonefish Environmental-Only CV Results ("Ants Climate-Only" equivalent) ---</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>fish_env_predictor_suffix <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(config<span class="sc">$</span>use_pca_predictors, <span class="st">"_pca"</span>, <span class="st">"_vif"</span>)</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>fish_env_cv_results_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(config<span class="sc">$</span>target_results_base, <span class="fu">paste0</span>(<span class="st">"anemonefish"</span>, fish_env_predictor_suffix))</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Loading Anemonefish (Environmental-Only) CV results from:"</span>, fish_env_cv_results_dir, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Loading Anemonefish (Environmental-Only) CV results from: /home/bi-server-kyoto/a0236995/sdm_anemonefish/predictions/anemonefish_pca </code></pre>
</div>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>fish_env_cv_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(fish_env_cv_results_dir,</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>                                <span class="at">pattern =</span> <span class="st">"^CV_Results_.*_depth_-750</span><span class="sc">\\</span><span class="st">.csv$"</span>,</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>                                <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(fish_env_cv_files) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>  fish_env_cv_data <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map_df</span>(fish_env_cv_files, </span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>                  <span class="sc">~</span>readr<span class="sc">::</span><span class="fu">read_csv</span>(.x, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">mutate</span>(<span class="at">filename_full =</span> .x,</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>                            <span class="at">filename =</span> <span class="fu">basename</span>(.x)))</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Loaded"</span>, <span class="fu">nrow</span>(fish_env_cv_data), <span class="st">"rows from"</span>, <span class="fu">length</span>(fish_env_cv_files), <span class="st">"anemonefish (combined) CV files.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Showing a sample including TSS</span></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">head</span>(fish_env_cv_data <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(filename, AUC_test_CV, TSS_test_CV) <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(filename) <span class="sc">%&gt;%</span> <span class="fu">slice_head</span>(<span class="at">n=</span><span class="dv">1</span>), <span class="at">n=</span><span class="dv">3</span>)) </span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Warning: No CV_Results CSV files found for anemonefish (combined) in"</span>, fish_env_cv_results_dir, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>  fish_env_cv_data <span class="ot">&lt;-</span> <span class="cn">NULL</span> </span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Loaded 408 rows from 27 anemonefish (combined) CV files.
# A tibble: 3 Ã— 3
# Groups:   filename [3]
  filename                                         AUC_test_CV TSS_test_CV
  &lt;chr&gt;                                                  &lt;dbl&gt;       &lt;dbl&gt;
1 CV_Results_Amphiprion_akallopisos_depth_-750.csv       0.931       0.799
2 CV_Results_Amphiprion_akindynos_depth_-750.csv         0.973       0.919
3 CV_Results_Amphiprion_allardi_depth_-750.csv           0.984       0.955</code></pre>
</div>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 3. Load Anemonefish Biotic Model CV Results (Equivalent to "Ant Contrasts") ---</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>fish_biotic_only_suffix_config <span class="ot">&lt;-</span> <span class="st">"_biotic_only"</span> </span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>fish_biotic_only_cv_results_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(config<span class="sc">$</span>target_results_base, <span class="fu">paste0</span>(<span class="st">"anemonefish"</span>, fish_biotic_only_suffix_config))</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Loading Anemonefish (Biotic-Only) CV results from:"</span>, fish_biotic_only_cv_results_dir, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Loading Anemonefish (Biotic-Only) CV results from: /home/bi-server-kyoto/a0236995/sdm_anemonefish/predictions/anemonefish_biotic_only </code></pre>
</div>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>fish_biotic_only_cv_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(fish_biotic_only_cv_results_dir,</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">pattern =</span> <span class="st">"^CV_Results_.*</span><span class="sc">\\</span><span class="st">.csv$"</span>,</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(fish_biotic_only_cv_files) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>  anemonefish_biotic_cv_data <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map_df</span>(fish_biotic_only_cv_files, </span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>                <span class="sc">~</span>readr<span class="sc">::</span><span class="fu">read_csv</span>(.x, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">mutate</span>(<span class="at">filename_full =</span> .x,</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>                          <span class="at">filename =</span> <span class="fu">basename</span>(.x)))</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Loaded"</span>, <span class="fu">nrow</span>(anemonefish_biotic_cv_data), <span class="st">"rows from"</span>, <span class="fu">length</span>(fish_biotic_only_cv_files), <span class="st">"anemonefish (biotic-only) CV files.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Showing a sample including TSS</span></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">head</span>(anemonefish_biotic_cv_data <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(filename, AUC_test_CV, TSS_test_CV) <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(filename) <span class="sc">%&gt;%</span> <span class="fu">slice_head</span>(<span class="at">n=</span><span class="dv">1</span>), <span class="at">n=</span><span class="dv">3</span>)) </span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Warning: No CV_Results CSV files found for anemonefish (biotic-only) in"</span>, fish_biotic_only_cv_results_dir, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>  anemonefish_biotic_cv_data <span class="ot">&lt;-</span> <span class="cn">NULL</span> </span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Loaded 413 rows from 27 anemonefish (biotic-only) CV files.
# A tibble: 3 Ã— 3
# Groups:   filename [3]
  filename                                         AUC_test_CV TSS_test_CV
  &lt;chr&gt;                                                  &lt;dbl&gt;       &lt;dbl&gt;
1 CV_Results_Amphiprion_akallopisos_depth_-750.csv       0.912       0.765
2 CV_Results_Amphiprion_akindynos_depth_-750.csv         0.947       0.825
3 CV_Results_Amphiprion_allardi_depth_-750.csv           0.988       0.916</code></pre>
</div>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 3b. Combined Env+Biotic CV Results (from 06d)</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>fish_combined_suffix_config <span class="ot">&lt;-</span> <span class="st">"_combined_pca"</span> <span class="co"># Assuming this suffix for combined models</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>fish_combined_cv_results_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(config<span class="sc">$</span>target_results_base, <span class="fu">paste0</span>(<span class="st">"anemonefish"</span>, fish_combined_suffix_config))</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Loading Anemonefish (Combined Env+Biotic) CV results from:"</span>, fish_combined_cv_results_dir, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Loading Anemonefish (Combined Env+Biotic) CV results from: /home/bi-server-kyoto/a0236995/sdm_anemonefish/predictions/anemonefish_combined_pca </code></pre>
</div>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>fish_combined_cv_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(fish_combined_cv_results_dir,</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">pattern =</span> <span class="st">"^CV_Results_.*</span><span class="sc">\\</span><span class="st">.csv$"</span>,</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(fish_combined_cv_files) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>  anemonefish_combined_cv_data <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map_df</span>(fish_combined_cv_files, </span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>                <span class="sc">~</span>readr<span class="sc">::</span><span class="fu">read_csv</span>(.x, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">mutate</span>(<span class="at">filename_full =</span> .x,</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>                          <span class="at">filename =</span> <span class="fu">basename</span>(.x)))</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Loaded"</span>, <span class="fu">nrow</span>(anemonefish_combined_cv_data), <span class="st">"rows from"</span>, <span class="fu">length</span>(fish_combined_cv_files), <span class="st">"anemonefish (combined) CV files.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Showing a sample including TSS</span></span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">head</span>(anemonefish_combined_cv_data <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(filename, AUC_test_CV, TSS_test_CV) <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(filename) <span class="sc">%&gt;%</span> <span class="fu">slice_head</span>(<span class="at">n=</span><span class="dv">1</span>), <span class="at">n=</span><span class="dv">3</span>)) </span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Warning: No CV_Results CSV files found for anemonefish (combined) in"</span>, fish_combined_cv_results_dir, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>  anemonefish_combined_cv_data <span class="ot">&lt;-</span> <span class="cn">NULL</span> </span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Loaded 404 rows from 27 anemonefish (combined) CV files.
# A tibble: 3 Ã— 3
# Groups:   filename [3]
  filename                                         AUC_test_CV TSS_test_CV
  &lt;chr&gt;                                                  &lt;dbl&gt;       &lt;dbl&gt;
1 CV_Results_Amphiprion_akallopisos_depth_-750.csv       0.917       0.743
2 CV_Results_Amphiprion_akindynos_depth_-750.csv         0.977       0.924
3 CV_Results_Amphiprion_allardi_depth_-750.csv           0.994       0.945</code></pre>
</div>
</div>
</section>
<section id="collect-and-prepare-anemonefish-model-evaluation-data" class="level2">
<h2 class="anchored" data-anchor-id="collect-and-prepare-anemonefish-model-evaluation-data">Collect and Prepare Anemonefish Model Evaluation Data</h2>
<p>This section gathers the CV results from the different anemonefish model types (environmental-only, biotic-only, and combined host+environment), cleans the species names, and standardizes a â€˜model_typeâ€™ column for comparison.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr) <span class="co"># For separate (though not directly used in the final version, good to keep if you had other tidyr ops)</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr) <span class="co"># For string manipulation</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure df_fish_comparison is available from previous chunks or initialize as NULL</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a><span class="co"># This is a safeguard, but typically it should come from 'load-cv-results'</span></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"fish_env_cv_data"</span>)) fish_env_cv_data <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"anemonefish_biotic_cv_data"</span>)) anemonefish_biotic_cv_data <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"anemonefish_combined_cv_data"</span>)) anemonefish_combined_cv_data <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 1. Prepare Anemonefish Environmental-Only Data ---</span></span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(fish_env_cv_data) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(fish_env_cv_data) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>  fish_env_processed <span class="ot">&lt;-</span> fish_env_cv_data <span class="sc">%&gt;%</span></span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">species =</span> SpeciesName, <span class="co"># Assuming SpeciesName is already derived in load-cv-results</span></span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">model_type =</span> <span class="st">"env_only"</span></span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(species, model_type, AUC_test_CV, TSS_test_CV, filename_full)</span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Processed anemonefish environmental-only CV data.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Warning: fish_env_cv_data is empty or NULL. Cannot process environmental-only models.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb58-23"><a href="#cb58-23" aria-hidden="true" tabindex="-1"></a>  fish_env_processed <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb58-24"><a href="#cb58-24" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Processed anemonefish environmental-only CV data.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 2. Prepare Anemonefish Biotic-Only Data ---</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(anemonefish_biotic_cv_data) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(anemonefish_biotic_cv_data) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>  fish_biotic_processed <span class="ot">&lt;-</span> anemonefish_biotic_cv_data <span class="sc">%&gt;%</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">species =</span> SpeciesName, <span class="co"># Assuming SpeciesName is already derived</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">model_type =</span> <span class="st">"biotic_only"</span></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(species, model_type, AUC_test_CV, TSS_test_CV, filename_full)</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Processed anemonefish biotic-only CV data.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Warning: anemonefish_biotic_cv_data is empty or NULL. Cannot process biotic-only models.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>  fish_biotic_processed <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Processed anemonefish biotic-only CV data.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 3. Prepare Anemonefish Combined (Host + Env) Data ---</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(anemonefish_combined_cv_data) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(anemonefish_combined_cv_data) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>  fish_combined_processed <span class="ot">&lt;-</span> anemonefish_combined_cv_data <span class="sc">%&gt;%</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">species =</span> SpeciesName, <span class="co"># Assuming SpeciesName is already derived</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">model_type =</span> <span class="st">"combined_host_env"</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(species, model_type, AUC_test_CV, TSS_test_CV, filename_full)</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Processed anemonefish Host + Environment CV data.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Warning: anemonefish_combined_cv_data is empty or NULL. Cannot process combined models.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>  fish_combined_processed <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Processed anemonefish Host + Environment CV data.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 4. Combine all processed anemonefish model data ---</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>df_fish_comparison <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>  fish_env_processed,</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>  fish_biotic_processed,</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>  fish_combined_processed</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(df_fish_comparison) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(df_fish_comparison) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Removed: The left_join for specialization_type from this chunk.</span></span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Specialization will now be joined in the 'compare-model-performance-by-specialization' chunk.</span></span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Combined data frame 'df_fish_comparison' created with"</span>, <span class="fu">nrow</span>(df_fish_comparison), <span class="st">"rows.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Summary of model types and counts:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">table</span>(df_fish_comparison<span class="sc">$</span>model_type))</span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">First few rows of combined data (with AUC and TSS):</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">head</span>(df_fish_comparison))</span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb64-18"><a href="#cb64-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Error: 'df_fish_comparison' is empty. No anemonefish CV data was successfully processed.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb64-19"><a href="#cb64-19" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Combined data frame 'df_fish_comparison' created with 1225 rows.
Summary of model types and counts:

      biotic_only combined_host_env          env_only 
              413               404               408 

First few rows of combined data (with AUC and TSS):
# A tibble: 6 Ã— 5
  species                model_type AUC_test_CV TSS_test_CV filename_full       
  &lt;chr&gt;                  &lt;chr&gt;            &lt;dbl&gt;       &lt;dbl&gt; &lt;chr&gt;               
1 Amphiprion_akallopisos env_only         0.931       0.799 /home/bi-server-kyoâ€¦
2 Amphiprion_akallopisos env_only         0.906       0.721 /home/bi-server-kyoâ€¦
3 Amphiprion_akallopisos env_only         0.943       0.785 /home/bi-server-kyoâ€¦
4 Amphiprion_akallopisos env_only         0.92        0.782 /home/bi-server-kyoâ€¦
5 Amphiprion_akallopisos env_only         0.917       0.791 /home/bi-server-kyoâ€¦
6 Amphiprion_akallopisos env_only         0.922       0.755 /home/bi-server-kyoâ€¦</code></pre>
</div>
</div>
</section>
<section id="auc-improvement-by-host-specialization-broadened-specialist-definition" class="level2">
<h2 class="anchored" data-anchor-id="auc-improvement-by-host-specialization-broadened-specialist-definition">AUC Improvement by Host Specialization (Broadened Specialist Definition)</h2>
<p>This section investigates whether the inclusion of host anemone distribution data (in â€œcombined host+environmentâ€ models) provides a differential improvement in predictive performance (Test AUC) compared to â€œenvironment-onlyâ€ models for anemonefish species. Species are classified based on their number of documented host anemones from `data/processed_anemonefish_host_associations.csv`: â€œSpecialistsâ€ are defined as those associating with 3 or fewer host species, and â€œGeneralistsâ€ as those associating with more than 3 host species. We then calculate the AUC improvement for each species and test for significant differences in this improvement between the two specialization groups.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load necessary libraries, including lme4 and lmerTest for the new model</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4)</span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lmerTest)</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here) </span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Defining Anemonefish Specialization (&lt;=3 hosts = Specialist) from CSV and Calculating Model Performance Improvement ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Defining Anemonefish Specialization (&lt;=3 hosts = Specialist) from CSV and Calculating Model Performance Improvement ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure df_fish_comparison is available from previous chunks</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"df_fish_comparison"</span>) <span class="sc">||</span> <span class="fu">is.null</span>(df_fish_comparison) <span class="sc">||</span> </span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">all</span>(<span class="fu">c</span>(<span class="st">"species"</span>, <span class="st">"model_type"</span>, <span class="st">"AUC_test_CV"</span>, <span class="st">"TSS_test_CV"</span>) <span class="sc">%in%</span> <span class="fu">names</span>(df_fish_comparison))) {</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"df_fish_comparison is not available or is missing required columns. Please ensure previous chunks have run successfully."</span>)</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Data Preparation for Specialization ---</span></span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>association_file_path <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"processed_anemonefish_host_associations.csv"</span>)</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(association_file_path)) {</span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"Anemonefish-host association file not found at: "</span>, association_file_path)</span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a>host_associations_df <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(association_file_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">AnemonefishScientificName =</span> <span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">"_"</span>, AnemonefishScientificName),</span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a>         <span class="at">AssociatedAnemoneScientificName =</span> <span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">"_"</span>, AssociatedAnemoneScientificName))</span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a>anemonefish_host_counts <span class="ot">&lt;-</span> host_associations_df <span class="sc">%&gt;%</span></span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(AnemonefishScientificName) <span class="sc">%&gt;%</span></span>
<span id="cb68-20"><a href="#cb68-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">n_hosts =</span> <span class="fu">n_distinct</span>(AssociatedAnemoneScientificName), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb68-21"><a href="#cb68-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-22"><a href="#cb68-22" aria-hidden="true" tabindex="-1"></a>anemonefish_specialization_df <span class="ot">&lt;-</span> anemonefish_host_counts <span class="sc">%&gt;%</span></span>
<span id="cb68-23"><a href="#cb68-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">specialization_type =</span> <span class="fu">factor</span>(<span class="fu">ifelse</span>(n_hosts <span class="sc">&lt;=</span> <span class="dv">3</span>, <span class="st">"Specialist"</span>, <span class="st">"Generalist"</span>), </span>
<span id="cb68-24"><a href="#cb68-24" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Generalist"</span>, <span class="st">"Specialist"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb68-25"><a href="#cb68-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">species =</span> AnemonefishScientificName)</span>
<span id="cb68-26"><a href="#cb68-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-27"><a href="#cb68-27" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Anemonefish Specialization (&lt;=3 hosts = Specialist):</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Anemonefish Specialization (&lt;=3 hosts = Specialist):</code></pre>
</div>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(anemonefish_specialization_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 29 Ã— 3
   species                 n_hosts specialization_type
   &lt;chr&gt;                     &lt;int&gt; &lt;fct&gt;              
 1 Amphiprion_akallopisos        2 Specialist         
 2 Amphiprion_akindynos          6 Generalist         
 3 Amphiprion_allardi            3 Specialist         
 4 Amphiprion_barberi            2 Specialist         
 5 Amphiprion_bicinctus          5 Generalist         
 6 Amphiprion_chagosensis        1 Specialist         
 7 Amphiprion_chrysogaster       3 Specialist         
 8 Amphiprion_chrysopterus       6 Generalist         
 9 Amphiprion_clarkii            9 Generalist         
10 Amphiprion_ephippium          2 Specialist         
# â„¹ 19 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge specialization info into the main comparison dataframe</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>df_fish_comparison_specialization <span class="ot">&lt;-</span> df_fish_comparison <span class="sc">%&gt;%</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(anemonefish_specialization_df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(species, specialization_type, n_hosts), <span class="at">by =</span> <span class="st">"species"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add a fold_id for the LMM, assuming the order is consistent per species</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(species, model_type) <span class="sc">%&gt;%</span></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">fold_id =</span> <span class="fu">row_number</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">any</span>(<span class="fu">is.na</span>(df_fish_comparison_specialization<span class="sc">$</span>specialization_type))) {</span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>  unclassified_species <span class="ot">&lt;-</span> <span class="fu">unique</span>(df_fish_comparison_specialization<span class="sc">$</span>species[<span class="fu">is.na</span>(df_fish_comparison_specialization<span class="sc">$</span>specialization_type)])</span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Warning: The following species were not found in the specialization list and will be excluded:</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">paste</span>(unclassified_species, <span class="at">collapse=</span><span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a>  df_fish_comparison_specialization <span class="ot">&lt;-</span> df_fish_comparison_specialization <span class="sc">%&gt;%</span></span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(specialization_type))</span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">nrow</span>(df_fish_comparison_specialization) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb72-17"><a href="#cb72-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"No species remaining after merging specialization type. Check consistency."</span>)</span>
<span id="cb72-18"><a href="#cb72-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb72-19"><a href="#cb72-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-20"><a href="#cb72-20" aria-hidden="true" tabindex="-1"></a><span class="co"># --- CORRECTED: Calculate per-fold improvement for the LMM ---</span></span>
<span id="cb72-21"><a href="#cb72-21" aria-hidden="true" tabindex="-1"></a><span class="co"># The key change is to ensure the columns are explicitly numeric before subtraction</span></span>
<span id="cb72-22"><a href="#cb72-22" aria-hidden="true" tabindex="-1"></a>improvement_df_long <span class="ot">&lt;-</span> df_fish_comparison_specialization <span class="sc">%&gt;%</span></span>
<span id="cb72-23"><a href="#cb72-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(model_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"env_only"</span>, <span class="st">"combined_host_env"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb72-24"><a href="#cb72-24" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(species, specialization_type, fold_id, model_type, AUC_test_CV, TSS_test_CV) <span class="sc">%&gt;%</span></span>
<span id="cb72-25"><a href="#cb72-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb72-26"><a href="#cb72-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">AUC_test_CV =</span> <span class="fu">as.numeric</span>(AUC_test_CV),</span>
<span id="cb72-27"><a href="#cb72-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">TSS_test_CV =</span> <span class="fu">as.numeric</span>(TSS_test_CV)</span>
<span id="cb72-28"><a href="#cb72-28" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb72-29"><a href="#cb72-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> model_type, <span class="at">values_from =</span> <span class="fu">c</span>(AUC_test_CV, TSS_test_CV)) <span class="sc">%&gt;%</span></span>
<span id="cb72-30"><a href="#cb72-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(AUC_test_CV_env_only) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(AUC_test_CV_combined_host_env)) <span class="sc">%&gt;%</span></span>
<span id="cb72-31"><a href="#cb72-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb72-32"><a href="#cb72-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">AUC_improvement =</span> AUC_test_CV_combined_host_env <span class="sc">-</span> AUC_test_CV_env_only,</span>
<span id="cb72-33"><a href="#cb72-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">TSS_improvement =</span> TSS_test_CV_combined_host_env <span class="sc">-</span> TSS_test_CV_env_only</span>
<span id="cb72-34"><a href="#cb72-34" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb72-35"><a href="#cb72-35" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(species, specialization_type, fold_id, AUC_improvement, TSS_improvement)</span>
<span id="cb72-36"><a href="#cb72-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-37"><a href="#cb72-37" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">AUC Improvement data (first few rows for LMM):</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
AUC Improvement data (first few rows for LMM):</code></pre>
</div>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">head</span>(improvement_df_long <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(species, specialization_type, fold_id, AUC_improvement)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 Ã— 4
  species                specialization_type fold_id AUC_improvement
  &lt;chr&gt;                  &lt;fct&gt;                 &lt;int&gt;           &lt;dbl&gt;
1 Amphiprion_akallopisos Specialist                1        -0.0136 
2 Amphiprion_akallopisos Specialist                2         0.00730
3 Amphiprion_akallopisos Specialist                3        -0.0160 
4 Amphiprion_akallopisos Specialist                4        -0.00320
5 Amphiprion_akallopisos Specialist                5         0.00760
6 Amphiprion_akallopisos Specialist                6         0.0242 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Statistical Test for AUC Improvement using LMM ---</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(improvement_df_long) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(improvement_df_long) <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span> </span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">unique</span>(improvement_df_long<span class="sc">$</span>specialization_type)) <span class="sc">==</span> <span class="dv">2</span>) {</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Statistical Test for AUC Improvement ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>  lmm_auc_improvement <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>    lmerTest<span class="sc">::</span><span class="fu">lmer</span>(AUC_improvement <span class="sc">~</span> specialization_type <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> species), <span class="at">data =</span> improvement_df_long)</span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Error in LMM for AUC improvement:"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>); <span class="cn">NULL</span></span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"LMM for difference in AUC Improvement between Generalist and Specialist Anemonefish:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(lmm_auc_improvement)) <span class="fu">print</span>(<span class="fu">summary</span>(lmm_auc_improvement))</span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Not enough data or distinct groups to perform statistical test on AUC improvement.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Statistical Test for AUC Improvement ---
LMM for difference in AUC Improvement between Generalist and Specialist Anemonefish:
Linear mixed model fit by REML. t-tests use Satterthwaite's method [
lmerModLmerTest]
Formula: AUC_improvement ~ specialization_type + (1 | species)
   Data: improvement_df_long

REML criterion at convergence: -1210.5

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-4.9170 -0.3801 -0.0741  0.2690  4.3930 

Random effects:
 Groups   Name        Variance  Std.Dev.
 species  (Intercept) 0.0004869 0.02207 
 Residual             0.0020546 0.04533 
Number of obs: 377, groups:  species, 27

Fixed effects:
                               Estimate Std. Error        df t value Pr(&gt;|t|)
(Intercept)                    0.016964   0.010123 22.023295   1.676    0.108
specialization_typeSpecialist  0.007994   0.011584 22.519051   0.690    0.497

Correlation of Fixed Effects:
            (Intr)
spclztn_tyS -0.874</code></pre>
</div>
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Statistical Test for TSS Improvement using LMM ---</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(improvement_df_long) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(improvement_df_long) <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span> </span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">unique</span>(improvement_df_long<span class="sc">$</span>specialization_type)) <span class="sc">==</span> <span class="dv">2</span>) {</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Statistical Test for TSS Improvement ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>  lmm_tss_improvement <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>    lmerTest<span class="sc">::</span><span class="fu">lmer</span>(TSS_improvement <span class="sc">~</span> specialization_type <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> species), <span class="at">data =</span> improvement_df_long)</span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Error in LMM for TSS improvement:"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>); <span class="cn">NULL</span></span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"LMM for difference in TSS Improvement between Generalist and Specialist Anemonefish:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(lmm_tss_improvement)) <span class="fu">print</span>(<span class="fu">summary</span>(lmm_tss_improvement))</span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb78-15"><a href="#cb78-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Not enough data or distinct groups to perform statistical test on TSS improvement.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb78-16"><a href="#cb78-16" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Statistical Test for TSS Improvement ---
LMM for difference in TSS Improvement between Generalist and Specialist Anemonefish:
Linear mixed model fit by REML. t-tests use Satterthwaite's method [
lmerModLmerTest]
Formula: TSS_improvement ~ specialization_type + (1 | species)
   Data: improvement_df_long

REML criterion at convergence: -811.1

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-5.1143 -0.3620 -0.0603  0.2344  4.5691 

Random effects:
 Groups   Name        Variance Std.Dev.
 species  (Intercept) 0.001514 0.03891 
 Residual             0.005939 0.07707 
Number of obs: 377, groups:  species, 27

Fixed effects:
                               Estimate Std. Error        df t value Pr(&gt;|t|)  
(Intercept)                    0.033846   0.017719 22.393436   1.910    0.069 .
specialization_typeSpecialist -0.009906   0.020269 22.880971  -0.489    0.630  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Correlation of Fixed Effects:
            (Intr)
spclztn_tyS -0.874</code></pre>
</div>
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Re-calculating means for plotting (unchanged from your original code) ---</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>mean_performance_per_species_model <span class="ot">&lt;-</span> df_fish_comparison_specialization <span class="sc">%&gt;%</span></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(model_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"env_only"</span>, <span class="st">"combined_host_env"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(species, specialization_type, n_hosts, model_type) <span class="sc">%&gt;%</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_AUC_test_CV =</span> <span class="fu">mean</span>(AUC_test_CV, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_TSS_test_CV =</span> <span class="fu">mean</span>(TSS_test_CV, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), </span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a>auc_improvement_df <span class="ot">&lt;-</span> mean_performance_per_species_model <span class="sc">%&gt;%</span></span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(species, specialization_type, n_hosts, model_type, mean_AUC_test_CV) <span class="sc">%&gt;%</span></span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> model_type, <span class="at">values_from =</span> mean_AUC_test_CV) <span class="sc">%&gt;%</span></span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(env_only) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(combined_host_env)) <span class="sc">%&gt;%</span></span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">AUC_improvement =</span> combined_host_env <span class="sc">-</span> env_only) <span class="sc">%&gt;%</span></span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(species, specialization_type, n_hosts, AUC_improvement) <span class="sc">%&gt;%</span></span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>()</span>
<span id="cb80-18"><a href="#cb80-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-19"><a href="#cb80-19" aria-hidden="true" tabindex="-1"></a>tss_improvement_df <span class="ot">&lt;-</span> mean_performance_per_species_model <span class="sc">%&gt;%</span></span>
<span id="cb80-20"><a href="#cb80-20" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(species, specialization_type, n_hosts, model_type, mean_TSS_test_CV) <span class="sc">%&gt;%</span> </span>
<span id="cb80-21"><a href="#cb80-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> model_type, <span class="at">values_from =</span> mean_TSS_test_CV) <span class="sc">%&gt;%</span> </span>
<span id="cb80-22"><a href="#cb80-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(env_only) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(combined_host_env)) <span class="sc">%&gt;%</span></span>
<span id="cb80-23"><a href="#cb80-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">TSS_improvement =</span> combined_host_env <span class="sc">-</span> env_only) <span class="sc">%&gt;%</span> </span>
<span id="cb80-24"><a href="#cb80-24" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(species, specialization_type, n_hosts, TSS_improvement) <span class="sc">%&gt;%</span></span>
<span id="cb80-25"><a href="#cb80-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>()</span>
<span id="cb80-26"><a href="#cb80-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-27"><a href="#cb80-27" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Plot AUC Improvement ---</span></span>
<span id="cb80-28"><a href="#cb80-28" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(auc_improvement_df) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(auc_improvement_df) <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span> </span>
<span id="cb80-29"><a href="#cb80-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">unique</span>(auc_improvement_df<span class="sc">$</span>specialization_type[<span class="sc">!</span><span class="fu">is.na</span>(auc_improvement_df<span class="sc">$</span>specialization_type)])) <span class="sc">==</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> </span>
<span id="cb80-30"><a href="#cb80-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(auc_improvement_df<span class="sc">$</span>specialization_type <span class="sc">==</span> <span class="st">"Generalist"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">&gt;</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> </span>
<span id="cb80-31"><a href="#cb80-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(auc_improvement_df<span class="sc">$</span>specialization_type <span class="sc">==</span> <span class="st">"Specialist"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb80-32"><a href="#cb80-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb80-33"><a href="#cb80-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Plotting AUC Improvement ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb80-34"><a href="#cb80-34" aria-hidden="true" tabindex="-1"></a>  plot_auc_improvement <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(auc_improvement_df, <span class="fu">aes</span>(<span class="at">x =</span> specialization_type, <span class="at">y =</span> AUC_improvement, <span class="at">fill =</span> specialization_type)) <span class="sc">+</span></span>
<span id="cb80-35"><a href="#cb80-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_boxplot</span>(<span class="at">alpha =</span> <span class="fl">0.8</span>, <span class="at">width=</span><span class="fl">0.6</span>, <span class="at">outlier.shape =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb80-36"><a href="#cb80-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_jitter</span>(<span class="at">width =</span> <span class="fl">0.15</span>, <span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">size=</span><span class="fl">2.5</span>) <span class="sc">+</span></span>
<span id="cb80-37"><a href="#cb80-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_summary</span>(<span class="at">fun =</span> mean, <span class="at">geom =</span> <span class="st">"point"</span>, <span class="at">shape =</span> <span class="dv">18</span>, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">color =</span> <span class="st">"black"</span>,</span>
<span id="cb80-38"><a href="#cb80-38" aria-hidden="true" tabindex="-1"></a>                 <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">width =</span> <span class="fl">0.6</span>)) <span class="sc">+</span></span>
<span id="cb80-39"><a href="#cb80-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"AUC Improvement by Host Specialization"</span>,</span>
<span id="cb80-40"><a href="#cb80-40" aria-hidden="true" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="st">"Combined model AUC - Environmental-only model AUC"</span>,</span>
<span id="cb80-41"><a href="#cb80-41" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Anemonefish Specialization"</span>,</span>
<span id="cb80-42"><a href="#cb80-42" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="fu">expression</span>(Delta <span class="sc">*</span> <span class="st">" AUC (Combined - Env-Only)"</span>)) <span class="sc">+</span></span>
<span id="cb80-43"><a href="#cb80-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Generalist"</span> <span class="ot">=</span> <span class="st">"cornflowerblue"</span>, <span class="st">"Specialist"</span> <span class="ot">=</span> <span class="st">"darkorange"</span>),</span>
<span id="cb80-44"><a href="#cb80-44" aria-hidden="true" tabindex="-1"></a>                      <span class="at">name =</span> <span class="st">"Specialization Type"</span>,</span>
<span id="cb80-45"><a href="#cb80-45" aria-hidden="true" tabindex="-1"></a>                      <span class="at">na.translate =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb80-46"><a href="#cb80-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb80-47"><a href="#cb80-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>,</span>
<span id="cb80-48"><a href="#cb80-48" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">11</span>, <span class="at">face=</span><span class="st">"bold"</span>),</span>
<span id="cb80-49"><a href="#cb80-49" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face=</span><span class="st">"bold"</span>),</span>
<span id="cb80-50"><a href="#cb80-50" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb80-51"><a href="#cb80-51" aria-hidden="true" tabindex="-1"></a>          <span class="at">panel.grid.major.x =</span> <span class="fu">element_blank</span>())</span>
<span id="cb80-52"><a href="#cb80-52" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb80-53"><a href="#cb80-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(plot_auc_improvement)</span>
<span id="cb80-54"><a href="#cb80-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb80-55"><a href="#cb80-55" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Save AUC improvement plot</span></span>
<span id="cb80-56"><a href="#cb80-56" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"figure_output_dir"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">dir.exists</span>(figure_output_dir)) {</span>
<span id="cb80-57"><a href="#cb80-57" aria-hidden="true" tabindex="-1"></a>    improvement_plot_filename <span class="ot">&lt;-</span> <span class="fu">file.path</span>(figure_output_dir, <span class="st">"auc_improvement_by_specialization.png"</span>)</span>
<span id="cb80-58"><a href="#cb80-58" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggsave</span>(<span class="at">filename =</span> improvement_plot_filename, <span class="at">plot =</span> plot_auc_improvement, <span class="at">width =</span> <span class="dv">8</span>, <span class="at">height =</span> <span class="dv">6</span>, <span class="at">units =</span> <span class="st">"in"</span>, <span class="at">dpi =</span> <span class="dv">300</span>)</span>
<span id="cb80-59"><a href="#cb80-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Saved AUC improvement by specialization plot to:"</span>, improvement_plot_filename, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb80-60"><a href="#cb80-60" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb80-61"><a href="#cb80-61" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Warning: 'figure_output_dir' not defined or does not exist. AUC improvement plot not saved to file.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb80-62"><a href="#cb80-62" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb80-63"><a href="#cb80-63" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb80-64"><a href="#cb80-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Not enough data or distinct groups to plot AUC improvement.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb80-65"><a href="#cb80-65" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Plotting AUC Improvement ---</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/compare-model-performance-by-specialization-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Saved AUC improvement by specialization plot to: /home/bi-server-kyoto/a0236995/sdm_anemonefish/figure_files/auc_improvement_by_specialization.png </code></pre>
</div>
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Plot TSS Improvement ---</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(tss_improvement_df) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(tss_improvement_df) <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span> </span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">unique</span>(tss_improvement_df<span class="sc">$</span>specialization_type[<span class="sc">!</span><span class="fu">is.na</span>(tss_improvement_df<span class="sc">$</span>specialization_type)])) <span class="sc">==</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> </span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(tss_improvement_df<span class="sc">$</span>specialization_type <span class="sc">==</span> <span class="st">"Generalist"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">&gt;</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> </span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(tss_improvement_df<span class="sc">$</span>specialization_type <span class="sc">==</span> <span class="st">"Specialist"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Plotting TSS Improvement ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>  plot_tss_improvement <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(tss_improvement_df, <span class="fu">aes</span>(<span class="at">x =</span> specialization_type, <span class="at">y =</span> TSS_improvement, <span class="at">fill =</span> specialization_type)) <span class="sc">+</span></span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_boxplot</span>(<span class="at">alpha =</span> <span class="fl">0.8</span>, <span class="at">width=</span><span class="fl">0.6</span>, <span class="at">outlier.shape =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_jitter</span>(<span class="at">width =</span> <span class="fl">0.15</span>, <span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">size=</span><span class="fl">2.5</span>) <span class="sc">+</span></span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_summary</span>(<span class="at">fun =</span> mean, <span class="at">geom =</span> <span class="st">"point"</span>, <span class="at">shape =</span> <span class="dv">18</span>, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">color =</span> <span class="st">"black"</span>,</span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a>                 <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">width =</span> <span class="fl">0.6</span>)) <span class="sc">+</span></span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"TSS Improvement by Host Specialization"</span>,</span>
<span id="cb83-14"><a href="#cb83-14" aria-hidden="true" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="st">"Combined model TSS - Environmental-only model TSS"</span>,</span>
<span id="cb83-15"><a href="#cb83-15" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Anemonefish Specialization"</span>,</span>
<span id="cb83-16"><a href="#cb83-16" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="fu">expression</span>(Delta <span class="sc">*</span> <span class="st">" TSS (Combined - Env-Only)"</span>)) <span class="sc">+</span></span>
<span id="cb83-17"><a href="#cb83-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Generalist"</span> <span class="ot">=</span> <span class="st">"lightcoral"</span>, <span class="st">"Specialist"</span> <span class="ot">=</span> <span class="st">"lightblue"</span>),</span>
<span id="cb83-18"><a href="#cb83-18" aria-hidden="true" tabindex="-1"></a>                      <span class="at">name =</span> <span class="st">"Specialization Type"</span>,</span>
<span id="cb83-19"><a href="#cb83-19" aria-hidden="true" tabindex="-1"></a>                      <span class="at">na.translate =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb83-20"><a href="#cb83-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb83-21"><a href="#cb83-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>,</span>
<span id="cb83-22"><a href="#cb83-22" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">11</span>, <span class="at">face=</span><span class="st">"bold"</span>),</span>
<span id="cb83-23"><a href="#cb83-23" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face=</span><span class="st">"bold"</span>),</span>
<span id="cb83-24"><a href="#cb83-24" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb83-25"><a href="#cb83-25" aria-hidden="true" tabindex="-1"></a>          <span class="at">panel.grid.major.x =</span> <span class="fu">element_blank</span>())</span>
<span id="cb83-26"><a href="#cb83-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb83-27"><a href="#cb83-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(plot_tss_improvement)</span>
<span id="cb83-28"><a href="#cb83-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb83-29"><a href="#cb83-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Save TSS improvement plot</span></span>
<span id="cb83-30"><a href="#cb83-30" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"figure_output_dir"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">dir.exists</span>(figure_output_dir)) {</span>
<span id="cb83-31"><a href="#cb83-31" aria-hidden="true" tabindex="-1"></a>    tss_improvement_plot_filename <span class="ot">&lt;-</span> <span class="fu">file.path</span>(figure_output_dir, <span class="st">"tss_improvement_by_specialization.png"</span>)</span>
<span id="cb83-32"><a href="#cb83-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggsave</span>(<span class="at">filename =</span> tss_improvement_plot_filename, <span class="at">plot =</span> plot_tss_improvement, <span class="at">width =</span> <span class="dv">8</span>, <span class="at">height =</span> <span class="dv">6</span>, <span class="at">units =</span> <span class="st">"in"</span>, <span class="at">dpi =</span> <span class="dv">300</span>)</span>
<span id="cb83-33"><a href="#cb83-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Saved TSS improvement by specialization plot to:"</span>, tss_improvement_plot_filename, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb83-34"><a href="#cb83-34" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb83-35"><a href="#cb83-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Warning: 'figure_output_dir' not defined or does not exist. TSS improvement plot not saved to file.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb83-36"><a href="#cb83-36" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb83-37"><a href="#cb83-37" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb83-38"><a href="#cb83-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Not enough data or distinct groups to plot TSS improvement.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb83-39"><a href="#cb83-39" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Plotting TSS Improvement ---</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/compare-model-performance-by-specialization-2.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Saved TSS improvement by specialization plot to: /home/bi-server-kyoto/a0236995/sdm_anemonefish/figure_files/tss_improvement_by_specialization.png </code></pre>
</div>
</div>
</section>
<section id="compare-anemonefish-model-performance" class="level2">
<h2 class="anchored" data-anchor-id="compare-anemonefish-model-performance">Compare anemonefish model performance</h2>
<p>This section statistically compares the performance (test AUC) of the different anemonefish model types (environmental-only, biotic-only, combined host+environment) using a linear mixed model. It also visualizes these comparisons.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glmmTMB)</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr) <span class="co"># For kable</span></span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a><span class="co"># library(performance) # Optional, for model_performance() if needed later</span></span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure dplyr, stringr, knitr are loaded if you use them later in the chunk for the summary table</span></span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a><span class="co"># pacman::p_load(dplyr, stringr, knitr) # Or ensure they are loaded in setup</span></span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(df_fish_comparison) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(df_fish_comparison) <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span> </span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"AUC_test_CV"</span> <span class="sc">%in%</span> <span class="fu">names</span>(df_fish_comparison) <span class="sc">&amp;&amp;</span> <span class="st">"TSS_test_CV"</span> <span class="sc">%in%</span> <span class="fu">names</span>(df_fish_comparison)) {</span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ensure model_type is a factor for the GLMM</span></span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This assumes your df_fish_comparison$model_type has values like "env_only", "biotic_only", "combined_host_env"</span></span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># OR if you renamed them in a previous step to "env", "host_env", "host_only", adjust levels accordingly.</span></span>
<span id="cb86-16"><a href="#cb86-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># For consistency with the ant paper structure and direct comparison to env_only:</span></span>
<span id="cb86-17"><a href="#cb86-17" aria-hidden="true" tabindex="-1"></a>  df_fish_comparison<span class="sc">$</span>model_type <span class="ot">&lt;-</span> <span class="fu">factor</span>(df_fish_comparison<span class="sc">$</span>model_type, </span>
<span id="cb86-18"><a href="#cb86-18" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"env_only"</span>, <span class="st">"combined_host_env"</span>, <span class="st">"biotic_only"</span>))</span>
<span id="cb86-19"><a href="#cb86-19" aria-hidden="true" tabindex="-1"></a>                                          <span class="co"># Reference: env_only</span></span>
<span id="cb86-20"><a href="#cb86-20" aria-hidden="true" tabindex="-1"></a>                                          <span class="co"># Second Coeff: combined_host_env vs env_only</span></span>
<span id="cb86-21"><a href="#cb86-21" aria-hidden="true" tabindex="-1"></a>                                          <span class="co"># Third Coeff: biotic_only vs env_only</span></span>
<span id="cb86-22"><a href="#cb86-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-23"><a href="#cb86-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Statistical Comparison for AUC_test_CV using GLMM ---</span></span>
<span id="cb86-24"><a href="#cb86-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Fitting GLMM to compare AUC_test_CV across model types ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-25"><a href="#cb86-25" aria-hidden="true" tabindex="-1"></a>  m1_fish_auc <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb86-26"><a href="#cb86-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">glmmTMB</span>(AUC_test_CV <span class="sc">~</span> model_type <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>species), <span class="at">data =</span> df_fish_comparison)</span>
<span id="cb86-27"><a href="#cb86-27" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb86-28"><a href="#cb86-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Error fitting GLMM for AUC:"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-29"><a href="#cb86-29" aria-hidden="true" tabindex="-1"></a>    <span class="cn">NULL</span></span>
<span id="cb86-30"><a href="#cb86-30" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb86-31"><a href="#cb86-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-32"><a href="#cb86-32" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(m1_fish_auc)) {</span>
<span id="cb86-33"><a href="#cb86-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Summary of GLMM for AUC_test_CV:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-34"><a href="#cb86-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">summary</span>(m1_fish_auc))</span>
<span id="cb86-35"><a href="#cb86-35" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb86-36"><a href="#cb86-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-37"><a href="#cb86-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Statistical Comparison for TSS_test_CV using GLMM ---</span></span>
<span id="cb86-38"><a href="#cb86-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Fitting GLMM to compare TSS_test_CV across model types ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-39"><a href="#cb86-39" aria-hidden="true" tabindex="-1"></a>  m1_fish_tss <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb86-40"><a href="#cb86-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">glmmTMB</span>(TSS_test_CV <span class="sc">~</span> model_type <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>species), <span class="at">data =</span> df_fish_comparison)</span>
<span id="cb86-41"><a href="#cb86-41" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb86-42"><a href="#cb86-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Error fitting GLMM for TSS:"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-43"><a href="#cb86-43" aria-hidden="true" tabindex="-1"></a>    <span class="cn">NULL</span></span>
<span id="cb86-44"><a href="#cb86-44" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb86-45"><a href="#cb86-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-46"><a href="#cb86-46" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(m1_fish_tss)) {</span>
<span id="cb86-47"><a href="#cb86-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Summary of GLMM for TSS_test_CV:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-48"><a href="#cb86-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">summary</span>(m1_fish_tss))</span>
<span id="cb86-49"><a href="#cb86-49" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb86-50"><a href="#cb86-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-51"><a href="#cb86-51" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- PREPARING DATA FOR PLOTTING ---</span></span>
<span id="cb86-52"><a href="#cb86-52" aria-hidden="true" tabindex="-1"></a>  df_fish_comparison_for_overall_plot <span class="ot">&lt;-</span> df_fish_comparison <span class="sc">%&gt;%</span></span>
<span id="cb86-53"><a href="#cb86-53" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">model_type_display =</span> <span class="fu">factor</span>(model_type,</span>
<span id="cb86-54"><a href="#cb86-54" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"env_only"</span>, <span class="st">"biotic_only"</span>, <span class="st">"combined_host_env"</span>), <span class="co"># Order for plot x-axis</span></span>
<span id="cb86-55"><a href="#cb86-55" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Environmental Only"</span>, <span class="st">"Biotic (Host) Only"</span>, <span class="st">"Host + Environment"</span>))) <span class="co"># Labels for plot legend</span></span>
<span id="cb86-56"><a href="#cb86-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-57"><a href="#cb86-57" aria-hidden="true" tabindex="-1"></a>  df_fish_comparison_plot_species <span class="ot">&lt;-</span> df_fish_comparison <span class="sc">%&gt;%</span></span>
<span id="cb86-58"><a href="#cb86-58" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">species_display =</span> <span class="fu">str_replace</span>(species, <span class="st">"_"</span>, <span class="st">" "</span>),</span>
<span id="cb86-59"><a href="#cb86-59" aria-hidden="true" tabindex="-1"></a>           <span class="at">model_type_display =</span> <span class="fu">factor</span>(model_type, <span class="co"># Ensure consistent factor for plotting</span></span>
<span id="cb86-60"><a href="#cb86-60" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"env_only"</span>, <span class="st">"biotic_only"</span>, <span class="st">"combined_host_env"</span>),</span>
<span id="cb86-61"><a href="#cb86-61" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Environmental Only"</span>, <span class="st">"Biotic (Host) Only"</span>, <span class="st">"Host + Environment"</span>)))</span>
<span id="cb86-62"><a href="#cb86-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-63"><a href="#cb86-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-64"><a href="#cb86-64" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Visualization for AUC_test_CV ---</span></span>
<span id="cb86-65"><a href="#cb86-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Generating boxplot of AUC_test_CV by model type ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-66"><a href="#cb86-66" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-67"><a href="#cb86-67" aria-hidden="true" tabindex="-1"></a>  plot_auc_comparison <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df_fish_comparison_for_overall_plot, <span class="fu">aes</span>(<span class="at">x =</span> model_type_display, <span class="at">y =</span> AUC_test_CV, <span class="at">fill =</span> model_type_display)) <span class="sc">+</span></span>
<span id="cb86-68"><a href="#cb86-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_boxplot</span>(<span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb86-69"><a href="#cb86-69" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_summary</span>(<span class="at">fun =</span> mean, <span class="at">geom =</span> <span class="st">"point"</span>, <span class="at">shape =</span> <span class="dv">18</span>, <span class="at">size =</span> <span class="dv">3</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb86-70"><a href="#cb86-70" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb86-71"><a href="#cb86-71" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Anemonefish Model Performance Comparison (AUC)"</span>,</span>
<span id="cb86-72"><a href="#cb86-72" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Model Type"</span>,</span>
<span id="cb86-73"><a href="#cb86-73" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"AUC (Predictive Accuracy)"</span></span>
<span id="cb86-74"><a href="#cb86-74" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb86-75"><a href="#cb86-75" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_manual</span>(</span>
<span id="cb86-76"><a href="#cb86-76" aria-hidden="true" tabindex="-1"></a>      <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Environmental Only"</span> <span class="ot">=</span> <span class="st">"grey70"</span>, <span class="st">"Biotic (Host) Only"</span> <span class="ot">=</span> <span class="st">"skyblue"</span>, <span class="st">"Host + Environment"</span> <span class="ot">=</span> <span class="st">"salmon"</span>),</span>
<span id="cb86-77"><a href="#cb86-77" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="st">"Model Type"</span></span>
<span id="cb86-78"><a href="#cb86-78" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb86-79"><a href="#cb86-79" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb86-80"><a href="#cb86-80" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb86-81"><a href="#cb86-81" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.major.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb86-82"><a href="#cb86-82" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.minor.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb86-83"><a href="#cb86-83" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb86-84"><a href="#cb86-84" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb86-85"><a href="#cb86-85" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>) </span>
<span id="cb86-86"><a href="#cb86-86" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb86-87"><a href="#cb86-87" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(plot_auc_comparison)</span>
<span id="cb86-88"><a href="#cb86-88" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-89"><a href="#cb86-89" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Save overall AUC comparison plot</span></span>
<span id="cb86-90"><a href="#cb86-90" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"figure_output_dir"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">dir.exists</span>(figure_output_dir)) {</span>
<span id="cb86-91"><a href="#cb86-91" aria-hidden="true" tabindex="-1"></a>    overall_auc_comparison_plot_filename <span class="ot">&lt;-</span> <span class="fu">file.path</span>(figure_output_dir, <span class="st">"anemonefish_model_auc_comparison_overall.png"</span>)</span>
<span id="cb86-92"><a href="#cb86-92" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggsave</span>(<span class="at">filename =</span> overall_auc_comparison_plot_filename, </span>
<span id="cb86-93"><a href="#cb86-93" aria-hidden="true" tabindex="-1"></a>           <span class="at">plot =</span> plot_auc_comparison, </span>
<span id="cb86-94"><a href="#cb86-94" aria-hidden="true" tabindex="-1"></a>           <span class="at">width =</span> <span class="dv">8</span>, <span class="at">height =</span> <span class="dv">6</span>, <span class="at">units =</span> <span class="st">"in"</span>, <span class="at">dpi =</span> <span class="dv">300</span>)</span>
<span id="cb86-95"><a href="#cb86-95" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Saved overall model AUC comparison plot to:"</span>, overall_auc_comparison_plot_filename, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-96"><a href="#cb86-96" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb86-97"><a href="#cb86-97" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Warning: 'figure_output_dir' not defined or does not exist. Overall AUC comparison plot not saved to file.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-98"><a href="#cb86-98" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb86-99"><a href="#cb86-99" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-100"><a href="#cb86-100" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Detailed boxplot per species for AUC</span></span>
<span id="cb86-101"><a href="#cb86-101" aria-hidden="true" tabindex="-1"></a>  plot_auc_per_species <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df_fish_comparison_plot_species, <span class="fu">aes</span>(<span class="at">x =</span> species_display, <span class="at">y =</span> AUC_test_CV, <span class="at">fill =</span> model_type_display)) <span class="sc">+</span></span>
<span id="cb86-102"><a href="#cb86-102" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_boxplot</span>(<span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">preserve =</span> <span class="st">"single"</span>)) <span class="sc">+</span> </span>
<span id="cb86-103"><a href="#cb86-103" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb86-104"><a href="#cb86-104" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Anemonefish Model Performance by Species and Type (AUC)"</span>,</span>
<span id="cb86-105"><a href="#cb86-105" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Anemonefish Species"</span>,</span>
<span id="cb86-106"><a href="#cb86-106" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"AUC (Predictive Accuracy)"</span></span>
<span id="cb86-107"><a href="#cb86-107" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb86-108"><a href="#cb86-108" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_manual</span>(</span>
<span id="cb86-109"><a href="#cb86-109" aria-hidden="true" tabindex="-1"></a>      <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Environmental Only"</span> <span class="ot">=</span> <span class="st">"grey70"</span>, <span class="st">"Biotic (Host) Only"</span> <span class="ot">=</span> <span class="st">"skyblue"</span>, <span class="st">"Host + Environment"</span> <span class="ot">=</span> <span class="st">"salmon"</span>),</span>
<span id="cb86-110"><a href="#cb86-110" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="st">"Model Type:"</span></span>
<span id="cb86-111"><a href="#cb86-111" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb86-112"><a href="#cb86-112" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">11</span>) <span class="sc">+</span></span>
<span id="cb86-113"><a href="#cb86-113" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb86-114"><a href="#cb86-114" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.major.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb86-115"><a href="#cb86-115" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb86-116"><a href="#cb86-116" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">"top"</span>,</span>
<span id="cb86-117"><a href="#cb86-117" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">60</span>, <span class="at">hjust =</span> <span class="dv">1</span>), </span>
<span id="cb86-118"><a href="#cb86-118" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb86-119"><a href="#cb86-119" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>)</span>
<span id="cb86-120"><a href="#cb86-120" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb86-121"><a href="#cb86-121" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="dv">1</span>) </span>
<span id="cb86-122"><a href="#cb86-122" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(plot_auc_per_species)</span>
<span id="cb86-123"><a href="#cb86-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-124"><a href="#cb86-124" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Save per-species AUC comparison plot</span></span>
<span id="cb86-125"><a href="#cb86-125" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"figure_output_dir"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">dir.exists</span>(figure_output_dir)) {</span>
<span id="cb86-126"><a href="#cb86-126" aria-hidden="true" tabindex="-1"></a>    per_species_auc_comparison_plot_filename <span class="ot">&lt;-</span> <span class="fu">file.path</span>(figure_output_dir, <span class="st">"anemonefish_model_auc_comparison_per_species.png"</span>)</span>
<span id="cb86-127"><a href="#cb86-127" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggsave</span>(<span class="at">filename =</span> per_species_auc_comparison_plot_filename, </span>
<span id="cb86-128"><a href="#cb86-128" aria-hidden="true" tabindex="-1"></a>           <span class="at">plot =</span> plot_auc_per_species, </span>
<span id="cb86-129"><a href="#cb86-129" aria-hidden="true" tabindex="-1"></a>           <span class="at">width =</span> <span class="dv">12</span>, <span class="at">height =</span> <span class="dv">8</span>, <span class="at">units =</span> <span class="st">"in"</span>, <span class="at">dpi =</span> <span class="dv">300</span>) <span class="co"># Increased size for better readability</span></span>
<span id="cb86-130"><a href="#cb86-130" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Saved per-species model AUC comparison plot to:"</span>, per_species_auc_comparison_plot_filename, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-131"><a href="#cb86-131" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb86-132"><a href="#cb86-132" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Warning: 'figure_output_dir' not defined or does not exist. Per-species AUC comparison plot not saved to file.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-133"><a href="#cb86-133" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb86-134"><a href="#cb86-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-135"><a href="#cb86-135" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Visualization for TSS_test_CV ---</span></span>
<span id="cb86-136"><a href="#cb86-136" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Generating boxplot of TSS_test_CV by model type ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-137"><a href="#cb86-137" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-138"><a href="#cb86-138" aria-hidden="true" tabindex="-1"></a>  plot_tss_comparison <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df_fish_comparison_for_overall_plot, <span class="fu">aes</span>(<span class="at">x =</span> model_type_display, <span class="at">y =</span> TSS_test_CV, <span class="at">fill =</span> model_type_display)) <span class="sc">+</span></span>
<span id="cb86-139"><a href="#cb86-139" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_boxplot</span>(<span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb86-140"><a href="#cb86-140" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_summary</span>(<span class="at">fun =</span> mean, <span class="at">geom =</span> <span class="st">"point"</span>, <span class="at">shape =</span> <span class="dv">18</span>, <span class="at">size =</span> <span class="dv">3</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb86-141"><a href="#cb86-141" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb86-142"><a href="#cb86-142" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Anemonefish Model Performance Comparison (TSS)"</span>,</span>
<span id="cb86-143"><a href="#cb86-143" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Model Type"</span>,</span>
<span id="cb86-144"><a href="#cb86-144" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"TSS (Predictive Accuracy)"</span></span>
<span id="cb86-145"><a href="#cb86-145" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb86-146"><a href="#cb86-146" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_manual</span>(</span>
<span id="cb86-147"><a href="#cb86-147" aria-hidden="true" tabindex="-1"></a>      <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Environmental Only"</span> <span class="ot">=</span> <span class="st">"grey70"</span>, <span class="st">"Biotic (Host) Only"</span> <span class="ot">=</span> <span class="st">"lightgreen"</span>, <span class="st">"Host + Environment"</span> <span class="ot">=</span> <span class="st">"purple"</span>), <span class="co"># New colors for TSS</span></span>
<span id="cb86-148"><a href="#cb86-148" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="st">"Model Type"</span></span>
<span id="cb86-149"><a href="#cb86-149" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb86-150"><a href="#cb86-150" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb86-151"><a href="#cb86-151" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb86-152"><a href="#cb86-152" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.major.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb86-153"><a href="#cb86-153" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.minor.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb86-154"><a href="#cb86-154" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb86-155"><a href="#cb86-155" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb86-156"><a href="#cb86-156" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>) </span>
<span id="cb86-157"><a href="#cb86-157" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb86-158"><a href="#cb86-158" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(plot_tss_comparison)</span>
<span id="cb86-159"><a href="#cb86-159" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-160"><a href="#cb86-160" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Save overall TSS comparison plot</span></span>
<span id="cb86-161"><a href="#cb86-161" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"figure_output_dir"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">dir.exists</span>(figure_output_dir)) {</span>
<span id="cb86-162"><a href="#cb86-162" aria-hidden="true" tabindex="-1"></a>    overall_tss_comparison_plot_filename <span class="ot">&lt;-</span> <span class="fu">file.path</span>(figure_output_dir, <span class="st">"anemonefish_model_tss_comparison_overall.png"</span>)</span>
<span id="cb86-163"><a href="#cb86-163" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggsave</span>(<span class="at">filename =</span> overall_tss_comparison_plot_filename, </span>
<span id="cb86-164"><a href="#cb86-164" aria-hidden="true" tabindex="-1"></a>           <span class="at">plot =</span> plot_tss_comparison, </span>
<span id="cb86-165"><a href="#cb86-165" aria-hidden="true" tabindex="-1"></a>           <span class="at">width =</span> <span class="dv">8</span>, <span class="at">height =</span> <span class="dv">6</span>, <span class="at">units =</span> <span class="st">"in"</span>, <span class="at">dpi =</span> <span class="dv">300</span>)</span>
<span id="cb86-166"><a href="#cb86-166" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Saved overall model TSS comparison plot to:"</span>, overall_tss_comparison_plot_filename, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-167"><a href="#cb86-167" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb86-168"><a href="#cb86-168" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Warning: 'figure_output_dir' not defined or does not exist. Overall TSS comparison plot not saved to file.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-169"><a href="#cb86-169" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb86-170"><a href="#cb86-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-171"><a href="#cb86-171" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Detailed boxplot per species for TSS</span></span>
<span id="cb86-172"><a href="#cb86-172" aria-hidden="true" tabindex="-1"></a>  plot_tss_per_species <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df_fish_comparison_plot_species, <span class="fu">aes</span>(<span class="at">x =</span> species_display, <span class="at">y =</span> TSS_test_CV, <span class="at">fill =</span> model_type_display)) <span class="sc">+</span></span>
<span id="cb86-173"><a href="#cb86-173" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_boxplot</span>(<span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">preserve =</span> <span class="st">"single"</span>)) <span class="sc">+</span> </span>
<span id="cb86-174"><a href="#cb86-174" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb86-175"><a href="#cb86-175" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Anemonefish Model Performance by Species and Type (TSS)"</span>,</span>
<span id="cb86-176"><a href="#cb86-176" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Anemonefish Species"</span>,</span>
<span id="cb86-177"><a href="#cb86-177" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"TSS (Predictive Accuracy)"</span></span>
<span id="cb86-178"><a href="#cb86-178" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb86-179"><a href="#cb86-179" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_manual</span>(</span>
<span id="cb86-180"><a href="#cb86-180" aria-hidden="true" tabindex="-1"></a>      <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Environmental Only"</span> <span class="ot">=</span> <span class="st">"grey70"</span>, <span class="st">"Biotic (Host) Only"</span> <span class="ot">=</span> <span class="st">"lightgreen"</span>, <span class="st">"Host + Environment"</span> <span class="ot">=</span> <span class="st">"purple"</span>), <span class="co"># New colors for TSS</span></span>
<span id="cb86-181"><a href="#cb86-181" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="st">"Model Type:"</span></span>
<span id="cb86-182"><a href="#cb86-182" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb86-183"><a href="#cb86-183" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">11</span>) <span class="sc">+</span></span>
<span id="cb86-184"><a href="#cb86-184" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb86-185"><a href="#cb86-185" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.major.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb86-186"><a href="#cb86-186" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb86-187"><a href="#cb86-187" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">"top"</span>,</span>
<span id="cb86-188"><a href="#cb86-188" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">60</span>, <span class="at">hjust =</span> <span class="dv">1</span>), </span>
<span id="cb86-189"><a href="#cb86-189" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb86-190"><a href="#cb86-190" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>)</span>
<span id="cb86-191"><a href="#cb86-191" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb86-192"><a href="#cb86-192" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="dv">1</span>) <span class="co"># TSS can also range from -1 to 1, but typically 0-1 for good models</span></span>
<span id="cb86-193"><a href="#cb86-193" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(plot_tss_per_species)</span>
<span id="cb86-194"><a href="#cb86-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-195"><a href="#cb86-195" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Save per-species TSS comparison plot</span></span>
<span id="cb86-196"><a href="#cb86-196" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"figure_output_dir"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">dir.exists</span>(figure_output_dir)) {</span>
<span id="cb86-197"><a href="#cb86-197" aria-hidden="true" tabindex="-1"></a>    per_species_tss_comparison_plot_filename <span class="ot">&lt;-</span> <span class="fu">file.path</span>(figure_output_dir, <span class="st">"anemonefish_model_tss_comparison_per_species.png"</span>)</span>
<span id="cb86-198"><a href="#cb86-198" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggsave</span>(<span class="at">filename =</span> per_species_tss_comparison_plot_filename, </span>
<span id="cb86-199"><a href="#cb86-199" aria-hidden="true" tabindex="-1"></a>           <span class="at">plot =</span> plot_tss_per_species, </span>
<span id="cb86-200"><a href="#cb86-200" aria-hidden="true" tabindex="-1"></a>           <span class="at">width =</span> <span class="dv">12</span>, <span class="at">height =</span> <span class="dv">8</span>, <span class="at">units =</span> <span class="st">"in"</span>, <span class="at">dpi =</span> <span class="dv">300</span>) <span class="co"># Increased size for better readability</span></span>
<span id="cb86-201"><a href="#cb86-201" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Saved per-species model TSS comparison plot to:"</span>, per_species_tss_comparison_plot_filename, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-202"><a href="#cb86-202" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb86-203"><a href="#cb86-203" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Warning: 'figure_output_dir' not defined or does not exist. Per-species TSS comparison plot not saved to file.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-204"><a href="#cb86-204" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb86-205"><a href="#cb86-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-206"><a href="#cb86-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-207"><a href="#cb86-207" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Summary Table for AUC ---</span></span>
<span id="cb86-208"><a href="#cb86-208" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Mean and Standard Deviation of Test AUC per Anemonefish Species and Model Type ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-209"><a href="#cb86-209" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-210"><a href="#cb86-210" aria-hidden="true" tabindex="-1"></a>  anemonefish_auc_summary_table <span class="ot">&lt;-</span> df_fish_comparison <span class="sc">%&gt;%</span></span>
<span id="cb86-211"><a href="#cb86-211" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(species, model_type) <span class="sc">%&gt;%</span></span>
<span id="cb86-212"><a href="#cb86-212" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">summarize</span>(</span>
<span id="cb86-213"><a href="#cb86-213" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_AUC_test =</span> <span class="fu">mean</span>(AUC_test_CV, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb86-214"><a href="#cb86-214" aria-hidden="true" tabindex="-1"></a>      <span class="at">sd_AUC_test =</span> <span class="fu">sd</span>(AUC_test_CV, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb86-215"><a href="#cb86-215" aria-hidden="true" tabindex="-1"></a>      <span class="at">n_CV_folds =</span> <span class="fu">n</span>(), </span>
<span id="cb86-216"><a href="#cb86-216" aria-hidden="true" tabindex="-1"></a>      <span class="at">.groups =</span> <span class="st">'drop'</span></span>
<span id="cb86-217"><a href="#cb86-217" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb86-218"><a href="#cb86-218" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">species_display =</span> stringr<span class="sc">::</span><span class="fu">str_replace</span>(species, <span class="st">"_"</span>, <span class="st">" "</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb86-219"><a href="#cb86-219" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="at">Species =</span> species_display, <span class="at">Model_Type =</span> model_type, <span class="at">Mean_AUC =</span> mean_AUC_test, <span class="at">SD_AUC =</span> sd_AUC_test, <span class="at">N_Folds =</span> n_CV_folds) <span class="sc">%&gt;%</span></span>
<span id="cb86-220"><a href="#cb86-220" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Mean_AUC =</span> <span class="fu">round</span>(Mean_AUC, <span class="dv">3</span>),</span>
<span id="cb86-221"><a href="#cb86-221" aria-hidden="true" tabindex="-1"></a>           <span class="at">SD_AUC =</span> <span class="fu">round</span>(SD_AUC, <span class="dv">3</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb86-222"><a href="#cb86-222" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(Species, Model_Type)</span>
<span id="cb86-223"><a href="#cb86-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-224"><a href="#cb86-224" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"knitr"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(anemonefish_auc_summary_table) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb86-225"><a href="#cb86-225" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(knitr<span class="sc">::</span><span class="fu">kable</span>(anemonefish_auc_summary_table, </span>
<span id="cb86-226"><a href="#cb86-226" aria-hidden="true" tabindex="-1"></a>                        <span class="at">caption =</span> <span class="st">"Mean and Standard Deviation of Test AUC for Anemonefish Models by Species and Type."</span>))</span>
<span id="cb86-227"><a href="#cb86-227" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">nrow</span>(anemonefish_auc_summary_table) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb86-228"><a href="#cb86-228" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(anemonefish_auc_summary_table)</span>
<span id="cb86-229"><a href="#cb86-229" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb86-230"><a href="#cb86-230" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"No summary data to print for anemonefish AUC.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-231"><a href="#cb86-231" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb86-232"><a href="#cb86-232" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-233"><a href="#cb86-233" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Save AUC summary table to CSV</span></span>
<span id="cb86-234"><a href="#cb86-234" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"analysis_output_dir"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">dir.exists</span>(analysis_output_dir)) {</span>
<span id="cb86-235"><a href="#cb86-235" aria-hidden="true" tabindex="-1"></a>      anemonefish_cv_summary_auc_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(analysis_output_dir, <span class="st">"anemonefish_detailed_CV_summary_auc.csv"</span>)</span>
<span id="cb86-236"><a href="#cb86-236" aria-hidden="true" tabindex="-1"></a>      <span class="fu">write.csv</span>(anemonefish_auc_summary_table, anemonefish_cv_summary_auc_path, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb86-237"><a href="#cb86-237" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Anemonefish detailed CV summary (Mean &amp; SD AUC) saved to:"</span>, anemonefish_cv_summary_auc_path, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-238"><a href="#cb86-238" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb86-239"><a href="#cb86-239" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Warning: 'analysis_output_dir' not defined. Anemonefish detailed CV summary (AUC) not saved to CSV.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-240"><a href="#cb86-240" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb86-241"><a href="#cb86-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-242"><a href="#cb86-242" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Summary Table for TSS ---</span></span>
<span id="cb86-243"><a href="#cb86-243" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Mean and Standard Deviation of Test TSS per Anemonefish Species and Model Type ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-244"><a href="#cb86-244" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-245"><a href="#cb86-245" aria-hidden="true" tabindex="-1"></a>  anemonefish_tss_summary_table <span class="ot">&lt;-</span> df_fish_comparison <span class="sc">%&gt;%</span></span>
<span id="cb86-246"><a href="#cb86-246" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(species, model_type) <span class="sc">%&gt;%</span></span>
<span id="cb86-247"><a href="#cb86-247" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">summarize</span>(</span>
<span id="cb86-248"><a href="#cb86-248" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_TSS_test =</span> <span class="fu">mean</span>(TSS_test_CV, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="co"># Use TSS_test_CV</span></span>
<span id="cb86-249"><a href="#cb86-249" aria-hidden="true" tabindex="-1"></a>      <span class="at">sd_TSS_test =</span> <span class="fu">sd</span>(TSS_test_CV, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),     <span class="co"># Use TSS_test_CV</span></span>
<span id="cb86-250"><a href="#cb86-250" aria-hidden="true" tabindex="-1"></a>      <span class="at">n_CV_folds =</span> <span class="fu">n</span>(), </span>
<span id="cb86-251"><a href="#cb86-251" aria-hidden="true" tabindex="-1"></a>      <span class="at">.groups =</span> <span class="st">'drop'</span></span>
<span id="cb86-252"><a href="#cb86-252" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb86-253"><a href="#cb86-253" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">species_display =</span> stringr<span class="sc">::</span><span class="fu">str_replace</span>(species, <span class="st">"_"</span>, <span class="st">" "</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb86-254"><a href="#cb86-254" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="at">Species =</span> species_display, <span class="at">Model_Type =</span> model_type, <span class="at">Mean_TSS =</span> mean_TSS_test, <span class="at">SD_TSS =</span> sd_TSS_test, <span class="at">N_Folds =</span> n_CV_folds) <span class="sc">%&gt;%</span> <span class="co"># Rename columns for TSS</span></span>
<span id="cb86-255"><a href="#cb86-255" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Mean_TSS =</span> <span class="fu">round</span>(Mean_TSS, <span class="dv">3</span>),</span>
<span id="cb86-256"><a href="#cb86-256" aria-hidden="true" tabindex="-1"></a>           <span class="at">SD_TSS =</span> <span class="fu">round</span>(SD_TSS, <span class="dv">3</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb86-257"><a href="#cb86-257" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(Species, Model_Type)</span>
<span id="cb86-258"><a href="#cb86-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-259"><a href="#cb86-259" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"knitr"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(anemonefish_tss_summary_table) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb86-260"><a href="#cb86-260" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(knitr<span class="sc">::</span><span class="fu">kable</span>(anemonefish_tss_summary_table, </span>
<span id="cb86-261"><a href="#cb86-261" aria-hidden="true" tabindex="-1"></a>                        <span class="at">caption =</span> <span class="st">"Mean and Standard Deviation of Test TSS for Anemonefish Models by Species and Type."</span>))</span>
<span id="cb86-262"><a href="#cb86-262" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">nrow</span>(anemonefish_tss_summary_table) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb86-263"><a href="#cb86-263" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(anemonefish_tss_summary_table)</span>
<span id="cb86-264"><a href="#cb86-264" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb86-265"><a href="#cb86-265" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"No summary data to print for anemonefish TSS.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-266"><a href="#cb86-266" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb86-267"><a href="#cb86-267" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-268"><a href="#cb86-268" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Save TSS summary table to CSV</span></span>
<span id="cb86-269"><a href="#cb86-269" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"analysis_output_dir"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">dir.exists</span>(analysis_output_dir)) {</span>
<span id="cb86-270"><a href="#cb86-270" aria-hidden="true" tabindex="-1"></a>      anemonefish_cv_summary_tss_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(analysis_output_dir, <span class="st">"anemonefish_detailed_CV_summary_tss.csv"</span>)</span>
<span id="cb86-271"><a href="#cb86-271" aria-hidden="true" tabindex="-1"></a>      <span class="fu">write.csv</span>(anemonefish_tss_summary_table, anemonefish_cv_summary_tss_path, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb86-272"><a href="#cb86-272" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Anemonefish detailed CV summary (Mean &amp; SD TSS) saved to:"</span>, anemonefish_cv_summary_tss_path, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-273"><a href="#cb86-273" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb86-274"><a href="#cb86-274" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Warning: 'analysis_output_dir' not defined. Anemonefish detailed CV summary (TSS) not saved to CSV.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-275"><a href="#cb86-275" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb86-276"><a href="#cb86-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-277"><a href="#cb86-277" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb86-278"><a href="#cb86-278" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Skipping model comparison as 'df_fish_comparison' is empty or required CV columns (AUC_test_CV, TSS_test_CV) are missing.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-279"><a href="#cb86-279" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Fitting GLMM to compare AUC_test_CV across model types ---

Summary of GLMM for AUC_test_CV:
 Family: gaussian  ( identity )
Formula:          AUC_test_CV ~ model_type + (1 | species)
Data: df_fish_comparison

      AIC       BIC    logLik -2*log(L)  df.resid 
  -3805.3   -3779.7    1907.6   -3815.3      1220 

Random effects:

Conditional model:
 Groups   Name        Variance Std.Dev.
 species  (Intercept) 0.007504 0.08663 
 Residual             0.002332 0.04830 
Number of obs: 1225, groups:  species, 27

Dispersion estimate for gaussian family (sigma^2): 0.00233 

Conditional model:
                             Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)                  0.894265   0.016873   53.00  &lt; 2e-16 ***
model_typecombined_host_env  0.021677   0.003407    6.36 1.99e-10 ***
model_typebiotic_only       -0.012437   0.003395   -3.66 0.000249 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

--- Fitting GLMM to compare TSS_test_CV across model types ---

Summary of GLMM for TSS_test_CV:
 Family: gaussian  ( identity )
Formula:          TSS_test_CV ~ model_type + (1 | species)
Data: df_fish_comparison

      AIC       BIC    logLik -2*log(L)  df.resid 
  -2609.4   -2583.8    1309.7   -2619.4      1220 

Random effects:

Conditional model:
 Groups   Name        Variance Std.Dev.
 species  (Intercept) 0.008527 0.09234 
 Residual             0.006309 0.07943 
Number of obs: 1225, groups:  species, 27

Dispersion estimate for gaussian family (sigma^2): 0.00631 

Conditional model:
                             Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)                  0.765913   0.018272   41.92  &lt; 2e-16 ***
model_typecombined_host_env  0.024375   0.005603    4.35 1.36e-05 ***
model_typebiotic_only       -0.031895   0.005583   -5.71 1.11e-08 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

--- Generating boxplot of AUC_test_CV by model type ---</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/compare-fish-model-performance-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Saved overall model AUC comparison plot to: /home/bi-server-kyoto/a0236995/sdm_anemonefish/figure_files/anemonefish_model_auc_comparison_overall.png </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/compare-fish-model-performance-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Saved per-species model AUC comparison plot to: /home/bi-server-kyoto/a0236995/sdm_anemonefish/figure_files/anemonefish_model_auc_comparison_per_species.png 

--- Generating boxplot of TSS_test_CV by model type ---</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/compare-fish-model-performance-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Saved overall model TSS comparison plot to: /home/bi-server-kyoto/a0236995/sdm_anemonefish/figure_files/anemonefish_model_tss_comparison_overall.png </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/compare-fish-model-performance-4.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Saved per-species model TSS comparison plot to: /home/bi-server-kyoto/a0236995/sdm_anemonefish/figure_files/anemonefish_model_tss_comparison_per_species.png 

--- Mean and Standard Deviation of Test AUC per Anemonefish Species and Model Type ---


Table: Mean and Standard Deviation of Test AUC for Anemonefish Models by Species and Type.

|Species                  |Model_Type        | Mean_AUC| SD_AUC| N_Folds|
|:------------------------|:-----------------|--------:|------:|-------:|
|Amphiprion akallopisos   |env_only          |    0.922|  0.015|      13|
|Amphiprion akallopisos   |combined_host_env |    0.928|  0.010|      16|
|Amphiprion akallopisos   |biotic_only       |    0.917|  0.019|      17|
|Amphiprion akindynos     |env_only          |    0.969|  0.016|      18|
|Amphiprion akindynos     |combined_host_env |    0.970|  0.014|      17|
|Amphiprion akindynos     |biotic_only       |    0.946|  0.006|      17|
|Amphiprion allardi       |env_only          |    0.969|  0.024|       7|
|Amphiprion allardi       |combined_host_env |    0.983|  0.011|      17|
|Amphiprion allardi       |biotic_only       |    0.969|  0.014|      17|
|Amphiprion barberi       |env_only          |    0.916|  0.026|      16|
|Amphiprion barberi       |combined_host_env |    0.941|  0.034|      15|
|Amphiprion barberi       |biotic_only       |    0.904|  0.045|      16|
|Amphiprion bicinctus     |env_only          |    0.980|  0.007|      15|
|Amphiprion bicinctus     |combined_host_env |    0.983|  0.006|      13|
|Amphiprion bicinctus     |biotic_only       |    0.973|  0.005|       7|
|Amphiprion chrysogaster  |env_only          |    0.824|  0.045|      17|
|Amphiprion chrysogaster  |combined_host_env |    0.874|  0.055|      13|
|Amphiprion chrysogaster  |biotic_only       |    0.840|  0.044|      17|
|Amphiprion chrysopterus  |env_only          |    0.920|  0.013|      18|
|Amphiprion chrysopterus  |combined_host_env |    0.927|  0.014|      17|
|Amphiprion chrysopterus  |biotic_only       |    0.832|  0.018|      17|
|Amphiprion clarkii       |env_only          |    0.930|  0.009|      18|
|Amphiprion clarkii       |combined_host_env |    0.929|  0.005|      17|
|Amphiprion clarkii       |biotic_only       |    0.913|  0.007|      17|
|Amphiprion ephippium     |env_only          |    0.935|  0.032|      17|
|Amphiprion ephippium     |combined_host_env |    0.932|  0.045|      17|
|Amphiprion ephippium     |biotic_only       |    0.891|  0.060|      16|
|Amphiprion frenatus      |env_only          |    0.904|  0.030|      13|
|Amphiprion frenatus      |combined_host_env |    0.921|  0.025|      17|
|Amphiprion frenatus      |biotic_only       |    0.875|  0.026|      17|
|Amphiprion fuscocaudatus |env_only          |    0.734|  0.120|      14|
|Amphiprion fuscocaudatus |combined_host_env |    0.839|  0.117|      13|
|Amphiprion fuscocaudatus |biotic_only       |    0.771|  0.139|      13|
|Amphiprion latezonatus   |env_only          |    0.923|  0.032|      18|
|Amphiprion latezonatus   |combined_host_env |    0.953|  0.023|       7|
|Amphiprion latezonatus   |biotic_only       |    0.941|  0.016|       7|
|Amphiprion latifasciatus |env_only          |    0.947|  0.039|      13|
|Amphiprion latifasciatus |combined_host_env |    0.972|  0.026|      16|
|Amphiprion latifasciatus |biotic_only       |    0.959|  0.028|      16|
|Amphiprion leucokranos   |env_only          |    0.790|  0.148|      15|
|Amphiprion leucokranos   |combined_host_env |    0.848|  0.103|      17|
|Amphiprion leucokranos   |biotic_only       |    0.828|  0.101|      17|
|Amphiprion mccullochi    |env_only          |    0.447|     NA|       1|
|Amphiprion mccullochi    |combined_host_env |    0.548|     NA|       1|
|Amphiprion mccullochi    |biotic_only       |    0.433|     NA|       1|
|Amphiprion melanopus     |env_only          |    0.923|  0.025|      17|
|Amphiprion melanopus     |combined_host_env |    0.942|  0.010|      17|
|Amphiprion melanopus     |biotic_only       |    0.924|  0.009|      17|
|Amphiprion nigripes      |env_only          |    0.930|  0.031|      17|
|Amphiprion nigripes      |combined_host_env |    0.945|  0.025|      17|
|Amphiprion nigripes      |biotic_only       |    0.921|  0.020|      17|
|Amphiprion ocellaris     |env_only          |    0.925|  0.010|       8|
|Amphiprion ocellaris     |combined_host_env |    0.926|  0.008|      12|
|Amphiprion ocellaris     |biotic_only       |    0.889|  0.013|      17|
|Amphiprion omanensis     |env_only          |    0.920|  0.082|      17|
|Amphiprion omanensis     |combined_host_env |    0.936|  0.059|      15|
|Amphiprion omanensis     |biotic_only       |    0.882|  0.114|      16|
|Amphiprion percula       |env_only          |    0.886|  0.024|      15|
|Amphiprion percula       |combined_host_env |    0.914|  0.015|      14|
|Amphiprion percula       |biotic_only       |    0.901|  0.014|      17|
|Amphiprion perideraion   |env_only          |    0.923|  0.015|      18|
|Amphiprion perideraion   |combined_host_env |    0.947|  0.011|      17|
|Amphiprion perideraion   |biotic_only       |    0.923|  0.011|      17|
|Amphiprion polymnus      |env_only          |    0.882|  0.034|      18|
|Amphiprion polymnus      |combined_host_env |    0.911|  0.020|      17|
|Amphiprion polymnus      |biotic_only       |    0.877|  0.035|      17|
|Amphiprion rubrocinctus  |env_only          |    0.976|  0.009|      17|
|Amphiprion rubrocinctus  |combined_host_env |    0.977|  0.011|      17|
|Amphiprion rubrocinctus  |biotic_only       |    0.959|  0.011|      17|
|Amphiprion sandaracinos  |env_only          |    0.910|  0.030|      18|
|Amphiprion sandaracinos  |combined_host_env |    0.920|  0.021|      15|
|Amphiprion sandaracinos  |biotic_only       |    0.870|  0.029|      16|
|Amphiprion sebae         |env_only          |    0.892|  0.056|      17|
|Amphiprion sebae         |combined_host_env |    0.896|  0.050|      17|
|Amphiprion sebae         |biotic_only       |    0.877|  0.056|      17|
|Amphiprion tricinctus    |env_only          |    0.906|  0.091|      17|
|Amphiprion tricinctus    |combined_host_env |    0.965|  0.023|      16|
|Amphiprion tricinctus    |biotic_only       |    0.837|  0.077|      16|
|Premnas biaculeatus      |env_only          |    0.894|  0.021|      16|
|Premnas biaculeatus      |combined_host_env |    0.925|  0.010|      17|
|Premnas biaculeatus      |biotic_only       |    0.912|  0.016|      17|

Anemonefish detailed CV summary (Mean &amp; SD AUC) saved to: /home/bi-server-kyoto/a0236995/sdm_anemonefish/outputs_for_analysis/anemonefish_detailed_CV_summary_auc.csv 

--- Mean and Standard Deviation of Test TSS per Anemonefish Species and Model Type ---


Table: Mean and Standard Deviation of Test TSS for Anemonefish Models by Species and Type.

|Species                  |Model_Type        | Mean_TSS| SD_TSS| N_Folds|
|:------------------------|:-----------------|--------:|------:|-------:|
|Amphiprion akallopisos   |env_only          |    0.771|  0.032|      13|
|Amphiprion akallopisos   |combined_host_env |    0.779|  0.021|      16|
|Amphiprion akallopisos   |biotic_only       |    0.767|  0.029|      17|
|Amphiprion akindynos     |env_only          |    0.891|  0.033|      18|
|Amphiprion akindynos     |combined_host_env |    0.893|  0.030|      17|
|Amphiprion akindynos     |biotic_only       |    0.827|  0.017|      17|
|Amphiprion allardi       |env_only          |    0.908|  0.053|       7|
|Amphiprion allardi       |combined_host_env |    0.923|  0.030|      17|
|Amphiprion allardi       |biotic_only       |    0.873|  0.029|      17|
|Amphiprion barberi       |env_only          |    0.774|  0.050|      16|
|Amphiprion barberi       |combined_host_env |    0.815|  0.070|      15|
|Amphiprion barberi       |biotic_only       |    0.756|  0.065|      16|
|Amphiprion bicinctus     |env_only          |    0.921|  0.015|      15|
|Amphiprion bicinctus     |combined_host_env |    0.922|  0.015|      13|
|Amphiprion bicinctus     |biotic_only       |    0.877|  0.021|       7|
|Amphiprion chrysogaster  |env_only          |    0.641|  0.072|      17|
|Amphiprion chrysogaster  |combined_host_env |    0.719|  0.071|      13|
|Amphiprion chrysogaster  |biotic_only       |    0.649|  0.065|      17|
|Amphiprion chrysopterus  |env_only          |    0.750|  0.027|      18|
|Amphiprion chrysopterus  |combined_host_env |    0.748|  0.032|      17|
|Amphiprion chrysopterus  |biotic_only       |    0.583|  0.037|      17|
|Amphiprion clarkii       |env_only          |    0.783|  0.014|      18|
|Amphiprion clarkii       |combined_host_env |    0.793|  0.014|      17|
|Amphiprion clarkii       |biotic_only       |    0.752|  0.019|      17|
|Amphiprion ephippium     |env_only          |    0.825|  0.068|      17|
|Amphiprion ephippium     |combined_host_env |    0.815|  0.078|      17|
|Amphiprion ephippium     |biotic_only       |    0.777|  0.083|      16|
|Amphiprion frenatus      |env_only          |    0.756|  0.031|      13|
|Amphiprion frenatus      |combined_host_env |    0.750|  0.032|      17|
|Amphiprion frenatus      |biotic_only       |    0.720|  0.032|      17|
|Amphiprion fuscocaudatus |env_only          |    0.594|  0.184|      14|
|Amphiprion fuscocaudatus |combined_host_env |    0.744|  0.192|      13|
|Amphiprion fuscocaudatus |biotic_only       |    0.645|  0.198|      13|
|Amphiprion latezonatus   |env_only          |    0.799|  0.063|      18|
|Amphiprion latezonatus   |combined_host_env |    0.814|  0.049|       7|
|Amphiprion latezonatus   |biotic_only       |    0.787|  0.026|       7|
|Amphiprion latifasciatus |env_only          |    0.889|  0.052|      13|
|Amphiprion latifasciatus |combined_host_env |    0.916|  0.051|      16|
|Amphiprion latifasciatus |biotic_only       |    0.878|  0.040|      16|
|Amphiprion leucokranos   |env_only          |    0.688|  0.179|      15|
|Amphiprion leucokranos   |combined_host_env |    0.714|  0.173|      17|
|Amphiprion leucokranos   |biotic_only       |    0.677|  0.167|      17|
|Amphiprion mccullochi    |env_only          |    0.349|     NA|       1|
|Amphiprion mccullochi    |combined_host_env |    0.498|     NA|       1|
|Amphiprion mccullochi    |biotic_only       |    0.328|     NA|       1|
|Amphiprion melanopus     |env_only          |    0.761|  0.033|      17|
|Amphiprion melanopus     |combined_host_env |    0.767|  0.031|      17|
|Amphiprion melanopus     |biotic_only       |    0.737|  0.019|      17|
|Amphiprion nigripes      |env_only          |    0.791|  0.087|      17|
|Amphiprion nigripes      |combined_host_env |    0.820|  0.056|      17|
|Amphiprion nigripes      |biotic_only       |    0.775|  0.033|      17|
|Amphiprion ocellaris     |env_only          |    0.748|  0.021|       8|
|Amphiprion ocellaris     |combined_host_env |    0.761|  0.018|      12|
|Amphiprion ocellaris     |biotic_only       |    0.713|  0.020|      17|
|Amphiprion omanensis     |env_only          |    0.857|  0.150|      17|
|Amphiprion omanensis     |combined_host_env |    0.884|  0.121|      15|
|Amphiprion omanensis     |biotic_only       |    0.810|  0.194|      16|
|Amphiprion percula       |env_only          |    0.710|  0.025|      15|
|Amphiprion percula       |combined_host_env |    0.715|  0.029|      14|
|Amphiprion percula       |biotic_only       |    0.709|  0.028|      17|
|Amphiprion perideraion   |env_only          |    0.764|  0.019|      18|
|Amphiprion perideraion   |combined_host_env |    0.805|  0.023|      17|
|Amphiprion perideraion   |biotic_only       |    0.769|  0.021|      17|
|Amphiprion polymnus      |env_only          |    0.735|  0.040|      18|
|Amphiprion polymnus      |combined_host_env |    0.733|  0.050|      17|
|Amphiprion polymnus      |biotic_only       |    0.693|  0.062|      17|
|Amphiprion rubrocinctus  |env_only          |    0.915|  0.021|      17|
|Amphiprion rubrocinctus  |combined_host_env |    0.918|  0.023|      17|
|Amphiprion rubrocinctus  |biotic_only       |    0.885|  0.022|      17|
|Amphiprion sandaracinos  |env_only          |    0.730|  0.029|      18|
|Amphiprion sandaracinos  |combined_host_env |    0.743|  0.031|      15|
|Amphiprion sandaracinos  |biotic_only       |    0.662|  0.056|      16|
|Amphiprion sebae         |env_only          |    0.729|  0.103|      17|
|Amphiprion sebae         |combined_host_env |    0.740|  0.083|      17|
|Amphiprion sebae         |biotic_only       |    0.718|  0.101|      17|
|Amphiprion tricinctus    |env_only          |    0.741|  0.196|      17|
|Amphiprion tricinctus    |combined_host_env |    0.879|  0.051|      16|
|Amphiprion tricinctus    |biotic_only       |    0.635|  0.117|      16|
|Premnas biaculeatus      |env_only          |    0.738|  0.024|      16|
|Premnas biaculeatus      |combined_host_env |    0.743|  0.020|      17|
|Premnas biaculeatus      |biotic_only       |    0.726|  0.024|      17|

Anemonefish detailed CV summary (Mean &amp; SD TSS) saved to: /home/bi-server-kyoto/a0236995/sdm_anemonefish/outputs_for_analysis/anemonefish_detailed_CV_summary_tss.csv </code></pre>
</div>
</div>
</section>
<section id="the-impact-of-host-specialization-on-model-performance" class="level2">
<h2 class="anchored" data-anchor-id="the-impact-of-host-specialization-on-model-performance">The Impact of Host Specialization on Model Performance</h2>
<p>This section builds upon the previous analysis by investigating whether the performance gain from including biotic information is greater for specialist species compared to generalist species. We test this hypothesis using a single mixed-effects model with an interaction term and visualize the results.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure necessary libraries are loaded</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4)</span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lmerTest)</span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here) </span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Data Preparation: Re-join specialization data ---</span></span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true" tabindex="-1"></a><span class="co"># This re-runs the data prep from the old specialization section to ensure the</span></span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true" tabindex="-1"></a><span class="co"># specialization_type column is present for this model.</span></span>
<span id="cb92-13"><a href="#cb92-13" aria-hidden="true" tabindex="-1"></a>association_file_path <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"processed_anemonefish_host_associations.csv"</span>)</span>
<span id="cb92-14"><a href="#cb92-14" aria-hidden="true" tabindex="-1"></a>host_associations_df <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(association_file_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb92-15"><a href="#cb92-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">AnemonefishScientificName =</span> <span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">"_"</span>, AnemonefishScientificName))</span>
<span id="cb92-16"><a href="#cb92-16" aria-hidden="true" tabindex="-1"></a>anemonefish_host_counts <span class="ot">&lt;-</span> host_associations_df <span class="sc">%&gt;%</span></span>
<span id="cb92-17"><a href="#cb92-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(AnemonefishScientificName) <span class="sc">%&gt;%</span></span>
<span id="cb92-18"><a href="#cb92-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">n_hosts =</span> <span class="fu">n_distinct</span>(AssociatedAnemoneScientificName), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb92-19"><a href="#cb92-19" aria-hidden="true" tabindex="-1"></a>anemonefish_specialization_df <span class="ot">&lt;-</span> anemonefish_host_counts <span class="sc">%&gt;%</span></span>
<span id="cb92-20"><a href="#cb92-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">specialization_type =</span> <span class="fu">factor</span>(<span class="fu">ifelse</span>(n_hosts <span class="sc">&lt;=</span> <span class="dv">3</span>, <span class="st">"Specialist"</span>, <span class="st">"Generalist"</span>), </span>
<span id="cb92-21"><a href="#cb92-21" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Generalist"</span>, <span class="st">"Specialist"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb92-22"><a href="#cb92-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">species =</span> AnemonefishScientificName)</span>
<span id="cb92-23"><a href="#cb92-23" aria-hidden="true" tabindex="-1"></a>df_comparison_with_specialization <span class="ot">&lt;-</span> df_fish_comparison <span class="sc">%&gt;%</span></span>
<span id="cb92-24"><a href="#cb92-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(anemonefish_specialization_df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(species, specialization_type, n_hosts), <span class="at">by =</span> <span class="st">"species"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb92-25"><a href="#cb92-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(specialization_type)) <span class="sc">%&gt;%</span></span>
<span id="cb92-26"><a href="#cb92-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(species, model_type) <span class="sc">%&gt;%</span></span>
<span id="cb92-27"><a href="#cb92-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">fold_id =</span> <span class="fu">row_number</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb92-28"><a href="#cb92-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb92-29"><a href="#cb92-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-30"><a href="#cb92-30" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Filter data for the interaction model ---</span></span>
<span id="cb92-31"><a href="#cb92-31" aria-hidden="true" tabindex="-1"></a><span class="co"># We only compare the 'env_only' and 'combined_host_env' models for this hypothesis.</span></span>
<span id="cb92-32"><a href="#cb92-32" aria-hidden="true" tabindex="-1"></a>df_interaction_data <span class="ot">&lt;-</span> df_comparison_with_specialization <span class="sc">%&gt;%</span></span>
<span id="cb92-33"><a href="#cb92-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(model_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"env_only"</span>, <span class="st">"combined_host_env"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb92-34"><a href="#cb92-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb92-35"><a href="#cb92-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">model_type =</span> <span class="fu">factor</span>(model_type, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"env_only"</span>, <span class="st">"combined_host_env"</span>))</span>
<span id="cb92-36"><a href="#cb92-36" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb92-37"><a href="#cb92-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-38"><a href="#cb92-38" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Statistical Model 1: Test for interaction on AUC ---</span></span>
<span id="cb92-39"><a href="#cb92-39" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Fitting LMM to test for interaction on AUC_test_CV ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Fitting LMM to test for interaction on AUC_test_CV ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>lmm_auc_interaction <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lmer</span>(AUC_test_CV <span class="sc">~</span> model_type <span class="sc">*</span> specialization_type <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> species), <span class="at">data =</span> df_interaction_data)</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>}, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Error in LMM for AUC interaction:"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>); <span class="cn">NULL</span></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"LMM for interaction between model type and specialization type (AUC):</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>LMM for interaction between model type and specialization type (AUC):</code></pre>
</div>
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(lmm_auc_interaction)) <span class="fu">print</span>(<span class="fu">summary</span>(lmm_auc_interaction))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML. t-tests use Satterthwaite's method [
lmerModLmerTest]
Formula: AUC_test_CV ~ model_type * specialization_type + (1 | species)
   Data: df_interaction_data

REML criterion at convergence: -2540.8

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-7.7981 -0.2928  0.0647  0.4257  4.0845 

Random effects:
 Groups   Name        Variance Std.Dev.
 species  (Intercept) 0.006836 0.08268 
 Residual             0.002140 0.04626 
Number of obs: 812, groups:  species, 27

Fixed effects:
                                                            Estimate Std. Error
(Intercept)                                                 0.937857   0.034058
model_typecombined_host_env                                 0.015814   0.006530
specialization_typeSpecialist                              -0.055418   0.038659
model_typecombined_host_env:specialization_typeSpecialist   0.008092   0.007545
                                                                  df t value
(Intercept)                                                20.845020  27.537
model_typecombined_host_env                               777.881656   2.422
specialization_typeSpecialist                              20.926652  -1.434
model_typecombined_host_env:specialization_typeSpecialist 777.998235   1.072
                                                          Pr(&gt;|t|)    
(Intercept)                                                 &lt;2e-16 ***
model_typecombined_host_env                                 0.0157 *  
specialization_typeSpecialist                               0.1665    
model_typecombined_host_env:specialization_typeSpecialist   0.2838    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Correlation of Fixed Effects:
            (Intr) mdl___ spcl_S
mdl_typcm__ -0.092              
spclztn_tyS -0.881  0.081       
mdl_ty__:_S  0.080 -0.865 -0.095</code></pre>
</div>
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Statistical Model 2: Test for interaction on TSS ---</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Fitting LMM to test for interaction on TSS_test_CV ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Fitting LMM to test for interaction on TSS_test_CV ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>lmm_tss_interaction <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lmer</span>(TSS_test_CV <span class="sc">~</span> model_type <span class="sc">*</span> specialization_type <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> species), <span class="at">data =</span> df_interaction_data)</span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>}, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Error in LMM for TSS interaction:"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>); <span class="cn">NULL</span></span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"LMM for interaction between model type and specialization type (TSS):</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>LMM for interaction between model type and specialization type (TSS):</code></pre>
</div>
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(lmm_tss_interaction)) <span class="fu">print</span>(<span class="fu">summary</span>(lmm_tss_interaction))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML. t-tests use Satterthwaite's method [
lmerModLmerTest]
Formula: TSS_test_CV ~ model_type * specialization_type + (1 | species)
   Data: df_interaction_data

REML criterion at convergence: -1724.4

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-5.5888 -0.3172  0.0522  0.4210  3.6871 

Random effects:
 Groups   Name        Variance Std.Dev.
 species  (Intercept) 0.007742 0.08799 
 Residual             0.006042 0.07773 
Number of obs: 812, groups:  species, 27

Fixed effects:
                                                           Estimate Std. Error
(Intercept)                                                 0.80844    0.03672
model_typecombined_host_env                                 0.03163    0.01097
specialization_typeSpecialist                              -0.05348    0.04174
model_typecombined_host_env:specialization_typeSpecialist  -0.00912    0.01268
                                                                 df t value
(Intercept)                                                21.41649  22.014
model_typecombined_host_env                               778.34082   2.882
specialization_typeSpecialist                              21.58536  -1.281
model_typecombined_host_env:specialization_typeSpecialist 778.62203  -0.719
                                                          Pr(&gt;|t|)    
(Intercept)                                               3.41e-16 ***
model_typecombined_host_env                                0.00406 ** 
specialization_typeSpecialist                              0.21371    
model_typecombined_host_env:specialization_typeSpecialist  0.47216    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Correlation of Fixed Effects:
            (Intr) mdl___ spcl_S
mdl_typcm__ -0.144              
spclztn_tyS -0.880  0.127       
mdl_ty__:_S  0.125 -0.865 -0.148</code></pre>
</div>
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Data for Plotting ---</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a summary table for visualization</span></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>summary_for_plot <span class="ot">&lt;-</span> df_interaction_data <span class="sc">%&gt;%</span></span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(specialization_type, model_type) <span class="sc">%&gt;%</span></span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_AUC =</span> <span class="fu">mean</span>(AUC_test_CV, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_TSS =</span> <span class="fu">mean</span>(TSS_test_CV, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">sd_AUC =</span> <span class="fu">sd</span>(AUC_test_CV, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">sd_TSS =</span> <span class="fu">sd</span>(TSS_test_CV, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb104-11"><a href="#cb104-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb104-12"><a href="#cb104-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb104-13"><a href="#cb104-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">model_type_display =</span> <span class="fu">factor</span>(model_type, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Environmental Only"</span>, <span class="st">"Host + Environment"</span>))</span>
<span id="cb104-14"><a href="#cb104-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb104-15"><a href="#cb104-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-16"><a href="#cb104-16" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Visualization 1: AUC Interaction Plot ---</span></span>
<span id="cb104-17"><a href="#cb104-17" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Generating AUC interaction plot ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Generating AUC interaction plot ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>plot_auc_interaction <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(summary_for_plot, <span class="fu">aes</span>(<span class="at">x =</span> model_type_display, <span class="at">y =</span> mean_AUC, <span class="at">color =</span> specialization_type, <span class="at">group =</span> specialization_type)) <span class="sc">+</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> mean_AUC <span class="sc">-</span> sd_AUC, <span class="at">ymax =</span> mean_AUC <span class="sc">+</span> sd_AUC), <span class="at">width =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Model Performance by Specialization and Model Type (AUC)"</span>,</span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Model Type"</span>,</span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Mean AUC (Predictive Accuracy)"</span></span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Generalist"</span> <span class="ot">=</span> <span class="st">"cornflowerblue"</span>, <span class="st">"Specialist"</span> <span class="ot">=</span> <span class="st">"darkorange"</span>)) <span class="sc">+</span></span>
<span id="cb106-11"><a href="#cb106-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb106-12"><a href="#cb106-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>, <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>)) <span class="sc">+</span></span>
<span id="cb106-13"><a href="#cb106-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="fl">0.8</span>, <span class="dv">1</span>)</span>
<span id="cb106-14"><a href="#cb106-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-15"><a href="#cb106-15" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(plot_auc_interaction)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/specialization-interaction-model-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Save plot</span></span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"figure_output_dir"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">dir.exists</span>(figure_output_dir)) {</span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>  filename <span class="ot">&lt;-</span> <span class="fu">file.path</span>(figure_output_dir, <span class="st">"model_performance_by_specialization_AUC.png"</span>)</span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggsave</span>(filename, <span class="at">plot =</span> plot_auc_interaction, <span class="at">width =</span> <span class="dv">8</span>, <span class="at">height =</span> <span class="dv">6</span>, <span class="at">units =</span> <span class="st">"in"</span>, <span class="at">dpi =</span> <span class="dv">300</span>)</span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Saved AUC interaction plot to:"</span>, filename, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Saved AUC interaction plot to: /home/bi-server-kyoto/a0236995/sdm_anemonefish/figure_files/model_performance_by_specialization_AUC.png </code></pre>
</div>
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Visualization 2: TSS Interaction Plot ---</span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Generating TSS interaction plot ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Generating TSS interaction plot ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>plot_tss_interaction <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(summary_for_plot, <span class="fu">aes</span>(<span class="at">x =</span> model_type_display, <span class="at">y =</span> mean_TSS, <span class="at">color =</span> specialization_type, <span class="at">group =</span> specialization_type)) <span class="sc">+</span></span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> mean_TSS <span class="sc">-</span> sd_TSS, <span class="at">ymax =</span> mean_TSS <span class="sc">+</span> sd_TSS), <span class="at">width =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Model Performance by Specialization and Model Type (TSS)"</span>,</span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Model Type"</span>,</span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Mean TSS (Predictive Accuracy)"</span></span>
<span id="cb111-9"><a href="#cb111-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb111-10"><a href="#cb111-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Generalist"</span> <span class="ot">=</span> <span class="st">"lightcoral"</span>, <span class="st">"Specialist"</span> <span class="ot">=</span> <span class="st">"lightblue"</span>)) <span class="sc">+</span></span>
<span id="cb111-11"><a href="#cb111-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb111-12"><a href="#cb111-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>, <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>)) <span class="sc">+</span></span>
<span id="cb111-13"><a href="#cb111-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="fl">0.5</span>, <span class="dv">1</span>)</span>
<span id="cb111-14"><a href="#cb111-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-15"><a href="#cb111-15" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(plot_tss_interaction)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/specialization-interaction-model-2.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Save plot</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"figure_output_dir"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">dir.exists</span>(figure_output_dir)) {</span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>  filename <span class="ot">&lt;-</span> <span class="fu">file.path</span>(figure_output_dir, <span class="st">"model_performance_by_specialization_TSS.png"</span>)</span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggsave</span>(filename, <span class="at">plot =</span> plot_tss_interaction, <span class="at">width =</span> <span class="dv">8</span>, <span class="at">height =</span> <span class="dv">6</span>, <span class="at">units =</span> <span class="st">"in"</span>, <span class="at">dpi =</span> <span class="dv">300</span>)</span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Saved TSS interaction plot to:"</span>, filename, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Saved TSS interaction plot to: /home/bi-server-kyoto/a0236995/sdm_anemonefish/figure_files/model_performance_by_specialization_TSS.png </code></pre>
</div>
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Summary Table for AUC and TSS by specialization ---</span></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Mean and SD of Test AUC and TSS by Model Type and Specialization ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Mean and SD of Test AUC and TSS by Model Type and Specialization ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>summary_table_combined <span class="ot">&lt;-</span> df_interaction_data <span class="sc">%&gt;%</span></span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(specialization_type, model_type) <span class="sc">%&gt;%</span></span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarize</span>(</span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">Mean_AUC =</span> <span class="fu">mean</span>(AUC_test_CV, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">SD_AUC =</span> <span class="fu">sd</span>(AUC_test_CV, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">Mean_TSS =</span> <span class="fu">mean</span>(TSS_test_CV, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">SD_TSS =</span> <span class="fu">sd</span>(TSS_test_CV, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb116-8"><a href="#cb116-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">N_Folds =</span> <span class="fu">n</span>(),</span>
<span id="cb116-9"><a href="#cb116-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">'drop'</span></span>
<span id="cb116-10"><a href="#cb116-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb116-11"><a href="#cb116-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), <span class="sc">~</span><span class="fu">round</span>(., <span class="dv">3</span>)))</span>
<span id="cb116-12"><a href="#cb116-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-13"><a href="#cb116-13" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"knitr"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb116-14"><a href="#cb116-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(knitr<span class="sc">::</span><span class="fu">kable</span>(summary_table_combined, </span>
<span id="cb116-15"><a href="#cb116-15" aria-hidden="true" tabindex="-1"></a>                     <span class="at">caption =</span> <span class="st">"Summary of Model Performance by Specialization and Model Type."</span>))</span>
<span id="cb116-16"><a href="#cb116-16" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb116-17"><a href="#cb116-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(summary_table_combined)</span>
<span id="cb116-18"><a href="#cb116-18" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>

Table: Summary of Model Performance by Specialization and Model Type.

|specialization_type |model_type        | Mean_AUC| SD_AUC| Mean_TSS| SD_TSS| N_Folds|
|:-------------------|:-----------------|--------:|------:|--------:|------:|-------:|
|Generalist          |env_only          |    0.937|  0.046|    0.806|  0.106|     104|
|Generalist          |combined_host_env |    0.952|  0.024|    0.836|  0.068|      97|
|Specialist          |env_only          |    0.897|  0.080|    0.764|  0.115|     304|
|Specialist          |combined_host_env |    0.923|  0.060|    0.791|  0.104|     307|</code></pre>
</div>
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Save summary table</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"analysis_output_dir"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">dir.exists</span>(analysis_output_dir)) {</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>  summary_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(analysis_output_dir, <span class="st">"anemonefish_specialization_summary_table.csv"</span>)</span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write.csv</span>(summary_table_combined, summary_path, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Saved specialization summary table to:"</span>, summary_path, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Saved specialization summary table to: /home/bi-server-kyoto/a0236995/sdm_anemonefish/outputs_for_analysis/anemonefish_specialization_summary_table.csv </code></pre>
</div>
</div>
</section>
<section id="current-environmental-predictors-pca" class="level2">
<h2 class="anchored" data-anchor-id="current-environmental-predictors-pca">Current Environmental Predictors (PCA)</h2>
<p>This section loads the Principal Component Analysis (PCA) rasters for the current environmental conditions. These PCA rasters were generated by script <code>05_preprocess_env_pca_only.R</code> (if PCA was used) and represent the primary environmental gradients used in the SDMs.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (config<span class="sc">$</span>use_pca_predictors) {</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"--- Loading Current Environmental PCA Rasters ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># The rds file stores a list of paths, one for each scenario's PCA .tif file</span></span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(config<span class="sc">$</span>pca_raster_paths_rds_path)) {</span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"PCA raster paths RDS file not found: "</span>, config<span class="sc">$</span>pca_raster_paths_rds_path, </span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>         <span class="st">"</span><span class="sc">\n</span><span class="st">Please ensure script 05 (PCA preprocessing) ran successfully."</span>)</span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a>  all_pca_raster_paths <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(config<span class="sc">$</span>pca_raster_paths_rds_path)</span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a>  current_pca_path <span class="ot">&lt;-</span> all_pca_raster_paths[[<span class="st">"current"</span>]]</span>
<span id="cb120-11"><a href="#cb120-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(current_pca_path) <span class="sc">||</span> <span class="sc">!</span><span class="fu">file.exists</span>(current_pca_path)) {</span>
<span id="cb120-12"><a href="#cb120-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Path for 'current' PCA raster not found in RDS or file does not exist: "</span>, current_pca_path <span class="sc">%||%</span> <span class="st">"NULL"</span>)</span>
<span id="cb120-13"><a href="#cb120-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb120-14"><a href="#cb120-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb120-15"><a href="#cb120-15" aria-hidden="true" tabindex="-1"></a>  env_pca_current <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb120-16"><a href="#cb120-16" aria-hidden="true" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">rast</span>(current_pca_path)</span>
<span id="cb120-17"><a href="#cb120-17" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb120-18"><a href="#cb120-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Error loading current PCA raster from:"</span>, current_pca_path, <span class="st">"</span><span class="sc">\n</span><span class="st">Error:"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb120-19"><a href="#cb120-19" aria-hidden="true" tabindex="-1"></a>    <span class="cn">NULL</span></span>
<span id="cb120-20"><a href="#cb120-20" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb120-21"><a href="#cb120-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb120-22"><a href="#cb120-22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(env_pca_current)) {</span>
<span id="cb120-23"><a href="#cb120-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(env_pca_current) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"Current Environmental PC"</span>, <span class="dv">1</span><span class="sc">:</span>terra<span class="sc">::</span><span class="fu">nlyr</span>(env_pca_current)) <span class="co"># Ensure standard names</span></span>
<span id="cb120-24"><a href="#cb120-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Loaded current environmental PCA rasters. Layers:"</span>, <span class="fu">paste</span>(<span class="fu">names</span>(env_pca_current), <span class="at">collapse=</span><span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb120-25"><a href="#cb120-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb120-26"><a href="#cb120-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Crop if configured (should match how other current rasters were handled)</span></span>
<span id="cb120-27"><a href="#cb120-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (config<span class="sc">$</span>apply_indo_pacific_crop) {</span>
<span id="cb120-28"><a href="#cb120-28" aria-hidden="true" tabindex="-1"></a>      ip_extent <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">ext</span>(config<span class="sc">$</span>indo_pacific_bbox)</span>
<span id="cb120-29"><a href="#cb120-29" aria-hidden="true" tabindex="-1"></a>      env_pca_current_cropped <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">crop</span>(env_pca_current, ip_extent)</span>
<span id="cb120-30"><a href="#cb120-30" aria-hidden="true" tabindex="-1"></a>      <span class="fu">plot</span>(env_pca_current_cropped)</span>
<span id="cb120-31"><a href="#cb120-31" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb120-32"><a href="#cb120-32" aria-hidden="true" tabindex="-1"></a>      env_pca_current_cropped <span class="ot">&lt;-</span> env_pca_current <span class="co"># Use uncropped if not configured</span></span>
<span id="cb120-33"><a href="#cb120-33" aria-hidden="true" tabindex="-1"></a>      <span class="fu">plot</span>(env_pca_current_cropped)</span>
<span id="cb120-34"><a href="#cb120-34" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb120-35"><a href="#cb120-35" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb120-36"><a href="#cb120-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Error: Could not load current environmental PCA rasters.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb120-37"><a href="#cb120-37" aria-hidden="true" tabindex="-1"></a>    env_pca_current_cropped <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb120-38"><a href="#cb120-38" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb120-39"><a href="#cb120-39" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb120-40"><a href="#cb120-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"--- PCA predictors not used. Skipping loading of current PCA rasters. ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb120-41"><a href="#cb120-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"    You might need to load your VIF-selected current environmental rasters here if needed for specific analyses.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb120-42"><a href="#cb120-42" aria-hidden="true" tabindex="-1"></a>  env_pca_current_cropped <span class="ot">&lt;-</span> <span class="cn">NULL</span> <span class="co"># Ensure this object exists as NULL if PCA not used</span></span>
<span id="cb120-43"><a href="#cb120-43" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- Loading Current Environmental PCA Rasters ---
Loaded current environmental PCA rasters. Layers: Current Environmental PC1, Current Environmental PC2, Current Environmental PC3, Current Environmental PC4 </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/load-current-env-pca-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="future-species-richness-projections" class="level2">
<h2 class="anchored" data-anchor-id="future-species-richness-projections">Future Species Richness Projections</h2>
<p>This section loads the predicted future suitability rasters for host sea anemones and anemonefish (from environmental-only models) for each future scenario and time step, and calculates the summed richness.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the future scenarios and time steps from your config</span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Your config$env_scenarios already includes "current", so we filter that out</span></span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>future_scenarios_to_load <span class="ot">&lt;-</span> config<span class="sc">$</span>env_scenarios[config<span class="sc">$</span>env_scenarios <span class="sc">!=</span> <span class="st">"current"</span>]</span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(future_scenarios_to_load) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a> <span class="fu">cat</span>(<span class="st">"No future scenarios defined in config$env_scenarios to load predictions for.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-8"><a href="#cb122-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Lists to store the summed richness rasters for each future scenario</span></span>
<span id="cb122-9"><a href="#cb122-9" aria-hidden="true" tabindex="-1"></a>host_richness_future_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb122-10"><a href="#cb122-10" aria-hidden="true" tabindex="-1"></a>fish_richness_future_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb122-11"><a href="#cb122-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-12"><a href="#cb122-12" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Create subdirectory for these specific future richness maps ---</span></span>
<span id="cb122-13"><a href="#cb122-13" aria-hidden="true" tabindex="-1"></a><span class="co"># This assumes figure_output_dir is defined in your setup chunk</span></span>
<span id="cb122-14"><a href="#cb122-14" aria-hidden="true" tabindex="-1"></a>future_richness_maps_subdir <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb122-15"><a href="#cb122-15" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"figure_output_dir"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">dir.exists</span>(figure_output_dir)) {</span>
<span id="cb122-16"><a href="#cb122-16" aria-hidden="true" tabindex="-1"></a> future_richness_maps_subdir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(figure_output_dir, <span class="st">"future_richness_projections"</span>)</span>
<span id="cb122-17"><a href="#cb122-17" aria-hidden="true" tabindex="-1"></a> <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(future_richness_maps_subdir)) {</span>
<span id="cb122-18"><a href="#cb122-18" aria-hidden="true" tabindex="-1"></a>   <span class="fu">dir.create</span>(future_richness_maps_subdir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb122-19"><a href="#cb122-19" aria-hidden="true" tabindex="-1"></a>   <span class="fu">cat</span>(<span class="st">"Created subdirectory for future richness maps at:"</span>, future_richness_maps_subdir, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb122-20"><a href="#cb122-20" aria-hidden="true" tabindex="-1"></a> }</span>
<span id="cb122-21"><a href="#cb122-21" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb122-22"><a href="#cb122-22" aria-hidden="true" tabindex="-1"></a> <span class="fu">cat</span>(<span class="st">"Warning: 'figure_output_dir' not defined or does not exist. Future richness maps will not be saved to file.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb122-23"><a href="#cb122-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb122-24"><a href="#cb122-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-25"><a href="#cb122-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-26"><a href="#cb122-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through each future scenario</span></span>
<span id="cb122-27"><a href="#cb122-27" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (scenario_name <span class="cf">in</span> future_scenarios_to_load) {</span>
<span id="cb122-28"><a href="#cb122-28" aria-hidden="true" tabindex="-1"></a> <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Processing Future Scenario:"</span>, scenario_name, <span class="st">"---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb122-29"><a href="#cb122-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-30"><a href="#cb122-30" aria-hidden="true" tabindex="-1"></a> <span class="co"># --- 1. Load Host Sea Anemone Future Predictions ---</span></span>
<span id="cb122-31"><a href="#cb122-31" aria-hidden="true" tabindex="-1"></a> <span class="co"># [cite_start]Host models were built using environmental predictors (PCAs) [cite: 145]</span></span>
<span id="cb122-32"><a href="#cb122-32" aria-hidden="true" tabindex="-1"></a> predictor_suffix_anemone <span class="ot">&lt;-</span> <span class="st">"_pca"</span></span>
<span id="cb122-33"><a href="#cb122-33" aria-hidden="true" tabindex="-1"></a> <span class="fu">cat</span>(<span class="st">"  Loading Host Sea Anemone predictions for"</span>, scenario_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb122-34"><a href="#cb122-34" aria-hidden="true" tabindex="-1"></a> host_future_raster_files <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb122-35"><a href="#cb122-35" aria-hidden="true" tabindex="-1"></a> <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(anemone_species_df)) {</span>
<span id="cb122-36"><a href="#cb122-36" aria-hidden="true" tabindex="-1"></a>   sp_name_sanitized <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">"_"</span>, anemone_species_df<span class="sc">$</span>scientificName[i])</span>
<span id="cb122-37"><a href="#cb122-37" aria-hidden="true" tabindex="-1"></a>   pred_file_path <span class="ot">&lt;-</span> <span class="fu">construct_mean_prediction_filename</span>(</span>
<span id="cb122-38"><a href="#cb122-38" aria-hidden="true" tabindex="-1"></a>     <span class="at">species_name_sanitized =</span> sp_name_sanitized,</span>
<span id="cb122-39"><a href="#cb122-39" aria-hidden="true" tabindex="-1"></a>     <span class="at">scenario_name =</span> scenario_name,</span>
<span id="cb122-40"><a href="#cb122-40" aria-hidden="true" tabindex="-1"></a>     <span class="at">predictor_type_suffix =</span> predictor_suffix_anemone,</span>
<span id="cb122-41"><a href="#cb122-41" aria-hidden="true" tabindex="-1"></a>     <span class="at">config =</span> config</span>
<span id="cb122-42"><a href="#cb122-42" aria-hidden="true" tabindex="-1"></a>   )</span>
<span id="cb122-43"><a href="#cb122-43" aria-hidden="true" tabindex="-1"></a>   <span class="cf">if</span> (<span class="fu">file.exists</span>(pred_file_path)) {</span>
<span id="cb122-44"><a href="#cb122-44" aria-hidden="true" tabindex="-1"></a>     host_future_raster_files <span class="ot">&lt;-</span> <span class="fu">c</span>(host_future_raster_files, pred_file_path)</span>
<span id="cb122-45"><a href="#cb122-45" aria-hidden="true" tabindex="-1"></a>   } <span class="cf">else</span> {</span>
<span id="cb122-46"><a href="#cb122-46" aria-hidden="true" tabindex="-1"></a>     <span class="fu">cat</span>(<span class="st">"  Warning: Host prediction file not found for"</span>, sp_name_sanitized, <span class="st">"in"</span>, scenario_name, <span class="st">"at"</span>, pred_file_path, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb122-47"><a href="#cb122-47" aria-hidden="true" tabindex="-1"></a>   }</span>
<span id="cb122-48"><a href="#cb122-48" aria-hidden="true" tabindex="-1"></a> }</span>
<span id="cb122-49"><a href="#cb122-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-50"><a href="#cb122-50" aria-hidden="true" tabindex="-1"></a> <span class="cf">if</span> (<span class="fu">length</span>(host_future_raster_files) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb122-51"><a href="#cb122-51" aria-hidden="true" tabindex="-1"></a>   host_pred_stack_future <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(host_future_raster_files)</span>
<span id="cb122-52"><a href="#cb122-52" aria-hidden="true" tabindex="-1"></a>   host_richness_sum_future <span class="ot">&lt;-</span> <span class="fu">sum</span>(host_pred_stack_future, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb122-53"><a href="#cb122-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-54"><a href="#cb122-54" aria-hidden="true" tabindex="-1"></a>   <span class="cf">if</span> (config<span class="sc">$</span>apply_indo_pacific_crop) {</span>
<span id="cb122-55"><a href="#cb122-55" aria-hidden="true" tabindex="-1"></a>     ip_extent <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">ext</span>(config<span class="sc">$</span>indo_pacific_bbox)</span>
<span id="cb122-56"><a href="#cb122-56" aria-hidden="true" tabindex="-1"></a>     host_richness_future_list[[scenario_name]] <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">crop</span>(host_richness_sum_future, ip_extent)</span>
<span id="cb122-57"><a href="#cb122-57" aria-hidden="true" tabindex="-1"></a>   } <span class="cf">else</span> {</span>
<span id="cb122-58"><a href="#cb122-58" aria-hidden="true" tabindex="-1"></a>     host_richness_future_list[[scenario_name]] <span class="ot">&lt;-</span> host_richness_sum_future</span>
<span id="cb122-59"><a href="#cb122-59" aria-hidden="true" tabindex="-1"></a>   }</span>
<span id="cb122-60"><a href="#cb122-60" aria-hidden="true" tabindex="-1"></a>   <span class="fu">cat</span>(<span class="st">"  Processed host anemone richness for"</span>, scenario_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb122-61"><a href="#cb122-61" aria-hidden="true" tabindex="-1"></a> } <span class="cf">else</span> {</span>
<span id="cb122-62"><a href="#cb122-62" aria-hidden="true" tabindex="-1"></a>   <span class="fu">cat</span>(<span class="st">"  Warning: No host prediction files found for scenario"</span>, scenario_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb122-63"><a href="#cb122-63" aria-hidden="true" tabindex="-1"></a>   host_richness_future_list[[scenario_name]] <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb122-64"><a href="#cb122-64" aria-hidden="true" tabindex="-1"></a> }</span>
<span id="cb122-65"><a href="#cb122-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-66"><a href="#cb122-66" aria-hidden="true" tabindex="-1"></a> <span class="co"># --- 2. Load Anemonefish (Combined) Future Predictions ---</span></span>
<span id="cb122-67"><a href="#cb122-67" aria-hidden="true" tabindex="-1"></a> <span class="co"># [cite_start]Based on Hypothesis 1 results, combined models are the best performers for anemonefish[cite: 22, 156].</span></span>
<span id="cb122-68"><a href="#cb122-68" aria-hidden="true" tabindex="-1"></a> predictor_suffix_anemonefish <span class="ot">&lt;-</span> <span class="st">"_combined_pca"</span></span>
<span id="cb122-69"><a href="#cb122-69" aria-hidden="true" tabindex="-1"></a> <span class="co"># predictor_suffix_anemonefish &lt;- "_env_only"</span></span>
<span id="cb122-70"><a href="#cb122-70" aria-hidden="true" tabindex="-1"></a> <span class="fu">cat</span>(<span class="st">"  Loading Anemonefish (Combined) predictions for"</span>, scenario_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb122-71"><a href="#cb122-71" aria-hidden="true" tabindex="-1"></a> fish_future_raster_files <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb122-72"><a href="#cb122-72" aria-hidden="true" tabindex="-1"></a> <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(anemonefish_species_df)) {</span>
<span id="cb122-73"><a href="#cb122-73" aria-hidden="true" tabindex="-1"></a>   sp_name_sanitized <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">"_"</span>, anemonefish_species_df<span class="sc">$</span>scientificName[i])</span>
<span id="cb122-74"><a href="#cb122-74" aria-hidden="true" tabindex="-1"></a>   pred_file_path <span class="ot">&lt;-</span> <span class="fu">construct_mean_prediction_filename</span>(</span>
<span id="cb122-75"><a href="#cb122-75" aria-hidden="true" tabindex="-1"></a>     <span class="at">species_name_sanitized =</span> sp_name_sanitized,</span>
<span id="cb122-76"><a href="#cb122-76" aria-hidden="true" tabindex="-1"></a>     <span class="at">scenario_name =</span> scenario_name,</span>
<span id="cb122-77"><a href="#cb122-77" aria-hidden="true" tabindex="-1"></a>     <span class="at">predictor_type_suffix =</span> predictor_suffix_anemonefish,</span>
<span id="cb122-78"><a href="#cb122-78" aria-hidden="true" tabindex="-1"></a>     <span class="at">config =</span> config</span>
<span id="cb122-79"><a href="#cb122-79" aria-hidden="true" tabindex="-1"></a>   )</span>
<span id="cb122-80"><a href="#cb122-80" aria-hidden="true" tabindex="-1"></a>   <span class="cf">if</span> (<span class="fu">file.exists</span>(pred_file_path)) {</span>
<span id="cb122-81"><a href="#cb122-81" aria-hidden="true" tabindex="-1"></a>     fish_future_raster_files <span class="ot">&lt;-</span> <span class="fu">c</span>(fish_future_raster_files, pred_file_path)</span>
<span id="cb122-82"><a href="#cb122-82" aria-hidden="true" tabindex="-1"></a>   } <span class="cf">else</span> {</span>
<span id="cb122-83"><a href="#cb122-83" aria-hidden="true" tabindex="-1"></a>     <span class="fu">cat</span>(<span class="st">"  Warning: Anemonefish (Combined) prediction file not found for"</span>, sp_name_sanitized, <span class="st">"in"</span>, scenario_name, <span class="st">"at"</span>, pred_file_path, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb122-84"><a href="#cb122-84" aria-hidden="true" tabindex="-1"></a>   }</span>
<span id="cb122-85"><a href="#cb122-85" aria-hidden="true" tabindex="-1"></a> }</span>
<span id="cb122-86"><a href="#cb122-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-87"><a href="#cb122-87" aria-hidden="true" tabindex="-1"></a> <span class="cf">if</span> (<span class="fu">length</span>(fish_future_raster_files) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb122-88"><a href="#cb122-88" aria-hidden="true" tabindex="-1"></a>   fish_pred_stack_future <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(fish_future_raster_files)</span>
<span id="cb122-89"><a href="#cb122-89" aria-hidden="true" tabindex="-1"></a>   fish_richness_sum_future <span class="ot">&lt;-</span> <span class="fu">sum</span>(fish_pred_stack_future, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb122-90"><a href="#cb122-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-91"><a href="#cb122-91" aria-hidden="true" tabindex="-1"></a>   <span class="cf">if</span> (config<span class="sc">$</span>apply_indo_pacific_crop) {</span>
<span id="cb122-92"><a href="#cb122-92" aria-hidden="true" tabindex="-1"></a>     ip_extent <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">ext</span>(config<span class="sc">$</span>indo_pacific_bbox)</span>
<span id="cb122-93"><a href="#cb122-93" aria-hidden="true" tabindex="-1"></a>     fish_richness_future_list[[scenario_name]] <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">crop</span>(fish_richness_sum_future, ip_extent)</span>
<span id="cb122-94"><a href="#cb122-94" aria-hidden="true" tabindex="-1"></a>   } <span class="cf">else</span> {</span>
<span id="cb122-95"><a href="#cb122-95" aria-hidden="true" tabindex="-1"></a>     fish_richness_future_list[[scenario_name]] <span class="ot">&lt;-</span> fish_richness_sum_future</span>
<span id="cb122-96"><a href="#cb122-96" aria-hidden="true" tabindex="-1"></a>   }</span>
<span id="cb122-97"><a href="#cb122-97" aria-hidden="true" tabindex="-1"></a>   <span class="fu">cat</span>(<span class="st">"  Processed anemonefish (Combined) richness for"</span>, scenario_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb122-98"><a href="#cb122-98" aria-hidden="true" tabindex="-1"></a> } <span class="cf">else</span> {</span>
<span id="cb122-99"><a href="#cb122-99" aria-hidden="true" tabindex="-1"></a>   <span class="fu">cat</span>(<span class="st">"  Warning: No anemonefish (Combined) prediction files found for scenario"</span>, scenario_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb122-100"><a href="#cb122-100" aria-hidden="true" tabindex="-1"></a>   fish_richness_future_list[[scenario_name]] <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb122-101"><a href="#cb122-101" aria-hidden="true" tabindex="-1"></a> }</span>
<span id="cb122-102"><a href="#cb122-102" aria-hidden="true" tabindex="-1"></a>} <span class="co"># End loop through future scenarios</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Processing Future Scenario: ssp119_2050 ---
  Loading Host Sea Anemone predictions for ssp119_2050 
  Processed host anemone richness for ssp119_2050 
  Loading Anemonefish (Combined) predictions for ssp119_2050 
  Warning: Anemonefish (Combined) prediction file not found for Amphiprion_pacificus in ssp119_2050 at /home/bi-server-kyoto/a0236995/sdm_anemonefish/data/output/predictions/Future/ssp119/1-pred_Amphiprion_pacificus_ssp119_dec50_combined_pca.tif 
  Processed anemonefish (Combined) richness for ssp119_2050 

--- Processing Future Scenario: ssp119_2100 ---
  Loading Host Sea Anemone predictions for ssp119_2100 
  Processed host anemone richness for ssp119_2100 
  Loading Anemonefish (Combined) predictions for ssp119_2100 
  Warning: Anemonefish (Combined) prediction file not found for Amphiprion_pacificus in ssp119_2100 at /home/bi-server-kyoto/a0236995/sdm_anemonefish/data/output/predictions/Future/ssp119/1-pred_Amphiprion_pacificus_ssp119_dec100_combined_pca.tif 
  Processed anemonefish (Combined) richness for ssp119_2100 

--- Processing Future Scenario: ssp585_2050 ---
  Loading Host Sea Anemone predictions for ssp585_2050 
  Processed host anemone richness for ssp585_2050 
  Loading Anemonefish (Combined) predictions for ssp585_2050 
  Warning: Anemonefish (Combined) prediction file not found for Amphiprion_pacificus in ssp585_2050 at /home/bi-server-kyoto/a0236995/sdm_anemonefish/data/output/predictions/Future/ssp585/1-pred_Amphiprion_pacificus_ssp585_dec50_combined_pca.tif 
  Processed anemonefish (Combined) richness for ssp585_2050 

--- Processing Future Scenario: ssp585_2100 ---
  Loading Host Sea Anemone predictions for ssp585_2100 
  Processed host anemone richness for ssp585_2100 
  Loading Anemonefish (Combined) predictions for ssp585_2100 
  Warning: Anemonefish (Combined) prediction file not found for Amphiprion_pacificus in ssp585_2100 at /home/bi-server-kyoto/a0236995/sdm_anemonefish/data/output/predictions/Future/ssp585/1-pred_Amphiprion_pacificus_ssp585_dec100_combined_pca.tif 
  Processed anemonefish (Combined) richness for ssp585_2100 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Future species prediction loading and processing finished. ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Future species prediction loading and processing finished. ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Final Plots Comparison and Saving ---</span></span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Generating and Saving Final Richness Comparison Plots ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Generating and Saving Final Richness Comparison Plots ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define plot parameters (no longer needed by the helper, but kept for reference)</span></span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>png_width_map <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a>png_height_map <span class="ot">&lt;-</span> <span class="dv">750</span></span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a>png_res_map <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a><span class="co"># MODIFIED Helper function to use the new ggplot-based plotting function</span></span>
<span id="cb128-7"><a href="#cb128-7" aria-hidden="true" tabindex="-1"></a>plot_and_save_richness_map <span class="ot">&lt;-</span> <span class="cf">function</span>(raster_obj, main_title, filename_base, subdir) {</span>
<span id="cb128-8"><a href="#cb128-8" aria-hidden="true" tabindex="-1"></a> <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(raster_obj)) {</span>
<span id="cb128-9"><a href="#cb128-9" aria-hidden="true" tabindex="-1"></a>   <span class="co"># --- Normalization for consistent color scale ---</span></span>
<span id="cb128-10"><a href="#cb128-10" aria-hidden="true" tabindex="-1"></a>   max_val <span class="ot">&lt;-</span> <span class="fu">global</span>(raster_obj, <span class="st">"max"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)<span class="sc">$</span>max</span>
<span id="cb128-11"><a href="#cb128-11" aria-hidden="true" tabindex="-1"></a>   <span class="co"># Handle case where raster is all 0s or NAs</span></span>
<span id="cb128-12"><a href="#cb128-12" aria-hidden="true" tabindex="-1"></a>   richness_normalized <span class="ot">&lt;-</span> <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.na</span>(max_val) <span class="sc">&amp;&amp;</span> max_val <span class="sc">&gt;</span> <span class="dv">0</span>) raster_obj <span class="sc">/</span> max_val <span class="cf">else</span> raster_obj</span>
<span id="cb128-13"><a href="#cb128-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-14"><a href="#cb128-14" aria-hidden="true" tabindex="-1"></a>   <span class="co"># --- Create plot using the ggplot function ---</span></span>
<span id="cb128-15"><a href="#cb128-15" aria-hidden="true" tabindex="-1"></a>   <span class="co"># This assumes `plot_prediction_map` and `world_map_sf` are defined in a previous chunk</span></span>
<span id="cb128-16"><a href="#cb128-16" aria-hidden="true" tabindex="-1"></a>   the_plot <span class="ot">&lt;-</span> <span class="fu">plot_prediction_map</span>(</span>
<span id="cb128-17"><a href="#cb128-17" aria-hidden="true" tabindex="-1"></a>     <span class="at">prediction_raster =</span> richness_normalized,</span>
<span id="cb128-18"><a href="#cb128-18" aria-hidden="true" tabindex="-1"></a>     <span class="at">species_name =</span> main_title,</span>
<span id="cb128-19"><a href="#cb128-19" aria-hidden="true" tabindex="-1"></a>     <span class="at">world_basemap =</span> world_map_sf</span>
<span id="cb128-20"><a href="#cb128-20" aria-hidden="true" tabindex="-1"></a>   )</span>
<span id="cb128-21"><a href="#cb128-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-22"><a href="#cb128-22" aria-hidden="true" tabindex="-1"></a>   <span class="co"># --- Display plot in RMarkdown output ---</span></span>
<span id="cb128-23"><a href="#cb128-23" aria-hidden="true" tabindex="-1"></a>   <span class="fu">print</span>(the_plot)</span>
<span id="cb128-24"><a href="#cb128-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-25"><a href="#cb128-25" aria-hidden="true" tabindex="-1"></a>   <span class="co"># --- Save the plot to file ---</span></span>
<span id="cb128-26"><a href="#cb128-26" aria-hidden="true" tabindex="-1"></a>   <span class="co"># This keeps your original file naming and location logic</span></span>
<span id="cb128-27"><a href="#cb128-27" aria-hidden="true" tabindex="-1"></a>   <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(subdir) <span class="sc">&amp;&amp;</span> <span class="fu">dir.exists</span>(subdir)) {</span>
<span id="cb128-28"><a href="#cb128-28" aria-hidden="true" tabindex="-1"></a>     <span class="co"># We add "_ggplot" to the filename to distinguish from potential old plots</span></span>
<span id="cb128-29"><a href="#cb128-29" aria-hidden="true" tabindex="-1"></a>     plot_filename <span class="ot">&lt;-</span> <span class="fu">file.path</span>(subdir, <span class="fu">paste0</span>(filename_base, <span class="st">"_ggplot.png"</span>))</span>
<span id="cb128-30"><a href="#cb128-30" aria-hidden="true" tabindex="-1"></a>     <span class="co"># Use ggsave for ggplot objects</span></span>
<span id="cb128-31"><a href="#cb128-31" aria-hidden="true" tabindex="-1"></a>     <span class="fu">ggsave</span>(plot_filename, <span class="at">plot =</span> the_plot, <span class="at">width =</span> <span class="dv">10</span>, <span class="at">height =</span> <span class="dv">7</span>, <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">bg =</span> <span class="st">"white"</span>)</span>
<span id="cb128-32"><a href="#cb128-32" aria-hidden="true" tabindex="-1"></a>     <span class="fu">cat</span>(<span class="st">"  Plot saved to:"</span>, plot_filename, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb128-33"><a href="#cb128-33" aria-hidden="true" tabindex="-1"></a>   } <span class="cf">else</span> {</span>
<span id="cb128-34"><a href="#cb128-34" aria-hidden="true" tabindex="-1"></a>     <span class="fu">cat</span>(<span class="st">"  Warning: Output subdirectory '"</span>, subdir, <span class="st">"' for plot '"</span>, filename_base, <span class="st">"' not available. Plot not saved to file.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb128-35"><a href="#cb128-35" aria-hidden="true" tabindex="-1"></a>   }</span>
<span id="cb128-36"><a href="#cb128-36" aria-hidden="true" tabindex="-1"></a> } <span class="cf">else</span> {</span>
<span id="cb128-37"><a href="#cb128-37" aria-hidden="true" tabindex="-1"></a>   <span class="fu">cat</span>(<span class="st">"  Skipping plot for '"</span>, main_title, <span class="st">"' as raster object is NULL.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb128-38"><a href="#cb128-38" aria-hidden="true" tabindex="-1"></a> }</span>
<span id="cb128-39"><a href="#cb128-39" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb128-40"><a href="#cb128-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-41"><a href="#cb128-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot current richness maps first (assuming host_richness_sum_cropped and fish_richness_sum_cropped are from a previous chunk)</span></span>
<span id="cb128-42"><a href="#cb128-42" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">exists</span>(<span class="st">"host_richness_sum_cropped"</span>)){</span>
<span id="cb128-43"><a href="#cb128-43" aria-hidden="true" tabindex="-1"></a> <span class="fu">plot_and_save_richness_map</span>(</span>
<span id="cb128-44"><a href="#cb128-44" aria-hidden="true" tabindex="-1"></a>   host_richness_sum_cropped,</span>
<span id="cb128-45"><a href="#cb128-45" aria-hidden="true" tabindex="-1"></a>   <span class="st">"Host Richness - Current"</span>,</span>
<span id="cb128-46"><a href="#cb128-46" aria-hidden="true" tabindex="-1"></a>   <span class="st">"host_richness_current"</span>,</span>
<span id="cb128-47"><a href="#cb128-47" aria-hidden="true" tabindex="-1"></a>   future_richness_maps_subdir</span>
<span id="cb128-48"><a href="#cb128-48" aria-hidden="true" tabindex="-1"></a> )</span>
<span id="cb128-49"><a href="#cb128-49" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/load-future-species-predictions-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Plot saved to: /home/bi-server-kyoto/a0236995/sdm_anemonefish/figure_files/future_richness_projections/host_richness_current_ggplot.png </code></pre>
</div>
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The current richness map for anemonefish should also be based on the Combined model for consistency,</span></span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a><span class="co"># but your current code loads env-only, which is fine for showing the difference.</span></span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">exists</span>(<span class="st">"fish_richness_sum_cropped"</span>)){</span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># </span><span class="al">NOTE</span><span class="co">: This plot still uses the old env-only richness for the CURRENT scenario, which is a fine choice for showing the contrast with future predictions from the COMBINED model.</span></span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If you want to use the combined model here too, you would need to add a load step for the combined richness maps for the current scenario.</span></span>
<span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_and_save_richness_map</span>(</span>
<span id="cb130-7"><a href="#cb130-7" aria-hidden="true" tabindex="-1"></a>    fish_richness_sum_cropped,</span>
<span id="cb130-8"><a href="#cb130-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Anemonefish (Combined) Richness - Current"</span>,</span>
<span id="cb130-9"><a href="#cb130-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fish_richness_combined_current"</span>,</span>
<span id="cb130-10"><a href="#cb130-10" aria-hidden="true" tabindex="-1"></a>    future_richness_maps_subdir</span>
<span id="cb130-11"><a href="#cb130-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb130-12"><a href="#cb130-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/load-future-species-predictions-2.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Plot saved to: /home/bi-server-kyoto/a0236995/sdm_anemonefish/figure_files/future_richness_projections/fish_richness_combined_current_ggplot.png </code></pre>
</div>
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Iterate through the scenarios you want for the final plot grid</span></span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>scenarios_for_grid_plot <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"ssp119_2050"</span>, <span class="st">"ssp119_2100"</span>, <span class="st">"ssp585_2050"</span>, <span class="st">"ssp585_2100"</span>)</span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (scen_name <span class="cf">in</span> scenarios_for_grid_plot) {</span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a> <span class="co"># Host plots</span></span>
<span id="cb132-6"><a href="#cb132-6" aria-hidden="true" tabindex="-1"></a> <span class="cf">if</span> (scen_name <span class="sc">%in%</span> <span class="fu">names</span>(host_richness_future_list)) {</span>
<span id="cb132-7"><a href="#cb132-7" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot_and_save_richness_map</span>(</span>
<span id="cb132-8"><a href="#cb132-8" aria-hidden="true" tabindex="-1"></a>     host_richness_future_list[[scen_name]],</span>
<span id="cb132-9"><a href="#cb132-9" aria-hidden="true" tabindex="-1"></a>     <span class="fu">paste</span>(<span class="st">"Host Richness -"</span>, scenario_label_converter[scen_name]),</span>
<span id="cb132-10"><a href="#cb132-10" aria-hidden="true" tabindex="-1"></a>     <span class="fu">paste0</span>(<span class="st">"host_richness_"</span>, scen_name),</span>
<span id="cb132-11"><a href="#cb132-11" aria-hidden="true" tabindex="-1"></a>     future_richness_maps_subdir</span>
<span id="cb132-12"><a href="#cb132-12" aria-hidden="true" tabindex="-1"></a>   )</span>
<span id="cb132-13"><a href="#cb132-13" aria-hidden="true" tabindex="-1"></a> }</span>
<span id="cb132-14"><a href="#cb132-14" aria-hidden="true" tabindex="-1"></a> <span class="co"># Fish plots</span></span>
<span id="cb132-15"><a href="#cb132-15" aria-hidden="true" tabindex="-1"></a> <span class="cf">if</span> (scen_name <span class="sc">%in%</span> <span class="fu">names</span>(fish_richness_future_list)) {</span>
<span id="cb132-16"><a href="#cb132-16" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot_and_save_richness_map</span>(</span>
<span id="cb132-17"><a href="#cb132-17" aria-hidden="true" tabindex="-1"></a>     fish_richness_future_list[[scen_name]],</span>
<span id="cb132-18"><a href="#cb132-18" aria-hidden="true" tabindex="-1"></a>     <span class="fu">paste</span>(<span class="st">"Anemonefish (Combined) Richness -"</span>, scenario_label_converter[scen_name]),</span>
<span id="cb132-19"><a href="#cb132-19" aria-hidden="true" tabindex="-1"></a>     <span class="fu">paste0</span>(<span class="st">"fish_richness_combined_"</span>, scen_name),</span>
<span id="cb132-20"><a href="#cb132-20" aria-hidden="true" tabindex="-1"></a>     future_richness_maps_subdir</span>
<span id="cb132-21"><a href="#cb132-21" aria-hidden="true" tabindex="-1"></a>   )</span>
<span id="cb132-22"><a href="#cb132-22" aria-hidden="true" tabindex="-1"></a> }</span>
<span id="cb132-23"><a href="#cb132-23" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/load-future-species-predictions-3.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Plot saved to: /home/bi-server-kyoto/a0236995/sdm_anemonefish/figure_files/future_richness_projections/host_richness_ssp119_2050_ggplot.png </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/load-future-species-predictions-4.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Plot saved to: /home/bi-server-kyoto/a0236995/sdm_anemonefish/figure_files/future_richness_projections/fish_richness_combined_ssp119_2050_ggplot.png </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/load-future-species-predictions-5.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Plot saved to: /home/bi-server-kyoto/a0236995/sdm_anemonefish/figure_files/future_richness_projections/host_richness_ssp119_2100_ggplot.png </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/load-future-species-predictions-6.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Plot saved to: /home/bi-server-kyoto/a0236995/sdm_anemonefish/figure_files/future_richness_projections/fish_richness_combined_ssp119_2100_ggplot.png </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/load-future-species-predictions-7.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Plot saved to: /home/bi-server-kyoto/a0236995/sdm_anemonefish/figure_files/future_richness_projections/host_richness_ssp585_2050_ggplot.png </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/load-future-species-predictions-8.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Plot saved to: /home/bi-server-kyoto/a0236995/sdm_anemonefish/figure_files/future_richness_projections/fish_richness_combined_ssp585_2050_ggplot.png </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/load-future-species-predictions-9.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Plot saved to: /home/bi-server-kyoto/a0236995/sdm_anemonefish/figure_files/future_richness_projections/host_richness_ssp585_2100_ggplot.png </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/load-future-species-predictions-10.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Plot saved to: /home/bi-server-kyoto/a0236995/sdm_anemonefish/figure_files/future_richness_projections/fish_richness_combined_ssp585_2100_ggplot.png </code></pre>
</div>
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Finished generating final richness comparison plots. ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Finished generating final richness comparison plots. ---</code></pre>
</div>
</div>
</section>
<section id="future-environmental-predictors-pca" class="level2">
<h2 class="anchored" data-anchor-id="future-environmental-predictors-pca">Future Environmental Predictors (PCA)</h2>
<p>This section loads the PCA rasters for the future environmental conditions, corresponding to each future scenario and time step.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (config<span class="sc">$</span>use_pca_predictors) {</span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"--- Loading Future Environmental PCA Rasters ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"all_pca_raster_paths"</span>) <span class="sc">||</span> <span class="fu">is.null</span>(all_pca_raster_paths)) {</span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Warning: 'all_pca_raster_paths' not found from previous chunk. Attempting to reload.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb143-5"><a href="#cb143-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(config<span class="sc">$</span>pca_raster_paths_rds_path)) {</span>
<span id="cb143-6"><a href="#cb143-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="st">"PCA raster paths RDS file not found: "</span>, config<span class="sc">$</span>pca_raster_paths_rds_path)</span>
<span id="cb143-7"><a href="#cb143-7" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb143-8"><a href="#cb143-8" aria-hidden="true" tabindex="-1"></a>    all_pca_raster_paths <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(config<span class="sc">$</span>pca_raster_paths_rds_path)</span>
<span id="cb143-9"><a href="#cb143-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb143-10"><a href="#cb143-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb143-11"><a href="#cb143-11" aria-hidden="true" tabindex="-1"></a>  env_pca_future_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb143-12"><a href="#cb143-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb143-13"><a href="#cb143-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (scenario_name <span class="cf">in</span> future_scenarios_to_load) { <span class="co"># future_scenarios_to_load from previous chunk</span></span>
<span id="cb143-14"><a href="#cb143-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"  Loading PCA for future scenario:"</span>, scenario_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb143-15"><a href="#cb143-15" aria-hidden="true" tabindex="-1"></a>    future_pca_path <span class="ot">&lt;-</span> all_pca_raster_paths[[scenario_name]]</span>
<span id="cb143-16"><a href="#cb143-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb143-17"><a href="#cb143-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(future_pca_path) <span class="sc">||</span> <span class="sc">!</span><span class="fu">file.exists</span>(future_pca_path)) {</span>
<span id="cb143-18"><a href="#cb143-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"  Warning: Path for PCA raster not found for scenario:"</span>, scenario_name, <span class="st">"Path:"</span>, future_pca_path <span class="sc">%||%</span> <span class="st">"NULL"</span>, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb143-19"><a href="#cb143-19" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb143-20"><a href="#cb143-20" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb143-21"><a href="#cb143-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb143-22"><a href="#cb143-22" aria-hidden="true" tabindex="-1"></a>    env_pca_future_scenario <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb143-23"><a href="#cb143-23" aria-hidden="true" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">rast</span>(future_pca_path)</span>
<span id="cb143-24"><a href="#cb143-24" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb143-25"><a href="#cb143-25" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"  Error loading PCA raster for"</span>, scenario_name, <span class="st">"from:"</span>, future_pca_path, <span class="st">"</span><span class="sc">\n</span><span class="st">Error:"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb143-26"><a href="#cb143-26" aria-hidden="true" tabindex="-1"></a>      <span class="cn">NULL</span></span>
<span id="cb143-27"><a href="#cb143-27" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb143-28"><a href="#cb143-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb143-29"><a href="#cb143-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(env_pca_future_scenario)) {</span>
<span id="cb143-30"><a href="#cb143-30" aria-hidden="true" tabindex="-1"></a>      <span class="fu">names</span>(env_pca_future_scenario) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"Future Environmental PC"</span>, <span class="dv">1</span><span class="sc">:</span>terra<span class="sc">::</span><span class="fu">nlyr</span>(env_pca_future_scenario), <span class="st">" - "</span>, scenario_label_converter[scenario_name]) <span class="co"># Ensure standard names</span></span>
<span id="cb143-31"><a href="#cb143-31" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb143-32"><a href="#cb143-32" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (config<span class="sc">$</span>apply_indo_pacific_crop) {</span>
<span id="cb143-33"><a href="#cb143-33" aria-hidden="true" tabindex="-1"></a>        ip_extent <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">ext</span>(config<span class="sc">$</span>indo_pacific_bbox)</span>
<span id="cb143-34"><a href="#cb143-34" aria-hidden="true" tabindex="-1"></a>        env_pca_future_list[[scenario_name]] <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">crop</span>(env_pca_future_scenario, ip_extent)</span>
<span id="cb143-35"><a href="#cb143-35" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb143-36"><a href="#cb143-36" aria-hidden="true" tabindex="-1"></a>        env_pca_future_list[[scenario_name]] <span class="ot">&lt;-</span> env_pca_future_scenario</span>
<span id="cb143-37"><a href="#cb143-37" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb143-38"><a href="#cb143-38" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"    Loaded and processed PCA for"</span>, scenario_name, <span class="st">". Layers:"</span>, <span class="fu">paste</span>(<span class="fu">names</span>(env_pca_future_list[[scenario_name]]), <span class="at">collapse=</span><span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb143-39"><a href="#cb143-39" aria-hidden="true" tabindex="-1"></a>      <span class="fu">plot</span>(env_pca_future_list[[scenario_name]])</span>
<span id="cb143-40"><a href="#cb143-40" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb143-41"><a href="#cb143-41" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb143-42"><a href="#cb143-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb143-43"><a href="#cb143-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # Example: Plot one of the future PCA stacks</span></span>
<span id="cb143-44"><a href="#cb143-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># if (length(env_pca_future_list) &gt; 0 &amp;&amp; "ssp119_2050" %in% names(env_pca_future_list)) {</span></span>
<span id="cb143-45"><a href="#cb143-45" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   plot(env_pca_future_list[["ssp119_2050"]], main = "Future Env PCA - SSP1-1.9 (2050) - Cropped")</span></span>
<span id="cb143-46"><a href="#cb143-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># }</span></span>
<span id="cb143-47"><a href="#cb143-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb143-48"><a href="#cb143-48" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb143-49"><a href="#cb143-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"--- PCA predictors not used. Skipping loading of future PCA rasters. ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb143-50"><a href="#cb143-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"    You might need to load your VIF-selected future environmental rasters here if needed for specific analyses.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb143-51"><a href="#cb143-51" aria-hidden="true" tabindex="-1"></a>  env_pca_future_list <span class="ot">&lt;-</span> <span class="cn">NULL</span> <span class="co"># Ensure this object exists as NULL</span></span>
<span id="cb143-52"><a href="#cb143-52" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- Loading Future Environmental PCA Rasters ---
  Loading PCA for future scenario: ssp119_2050 
    Loaded and processed PCA for ssp119_2050 . Layers: Future Environmental PC1 - SSP1-1.9 (2050), Future Environmental PC2 - SSP1-1.9 (2050), Future Environmental PC3 - SSP1-1.9 (2050), Future Environmental PC4 - SSP1-1.9 (2050) </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/load-future-env-pca-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Loading PCA for future scenario: ssp119_2100 
    Loaded and processed PCA for ssp119_2100 . Layers: Future Environmental PC1 - SSP1-1.9 (2100), Future Environmental PC2 - SSP1-1.9 (2100), Future Environmental PC3 - SSP1-1.9 (2100), Future Environmental PC4 - SSP1-1.9 (2100) </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/load-future-env-pca-2.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Loading PCA for future scenario: ssp585_2050 
    Loaded and processed PCA for ssp585_2050 . Layers: Future Environmental PC1 - SSP5-8.5 (2050), Future Environmental PC2 - SSP5-8.5 (2050), Future Environmental PC3 - SSP5-8.5 (2050), Future Environmental PC4 - SSP5-8.5 (2050) </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/load-future-env-pca-3.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Loading PCA for future scenario: ssp585_2100 
    Loaded and processed PCA for ssp585_2100 . Layers: Future Environmental PC1 - SSP5-8.5 (2100), Future Environmental PC2 - SSP5-8.5 (2100), Future Environmental PC3 - SSP5-8.5 (2100), Future Environmental PC4 - SSP5-8.5 (2100) </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/load-future-env-pca-4.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The following objects are now available for subsequent analyses:</span></span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a><span class="co"># - env_pca_current_cropped: SpatRaster of current PCA env predictors</span></span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a><span class="co"># - host_richness_future_list: List of SpatRasters for host future richness, named by scenario</span></span>
<span id="cb148-4"><a href="#cb148-4" aria-hidden="true" tabindex="-1"></a><span class="co"># - fish_richness_future_list: List of SpatRasters for anemonefish (combined) future richness, named by scenario</span></span>
<span id="cb148-5"><a href="#cb148-5" aria-hidden="true" tabindex="-1"></a><span class="co"># - env_pca_future_list: List of SpatRasters for future PCA env predictors, named by scenario</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="environmental-shifts-pca-components" class="level2">
<h2 class="anchored" data-anchor-id="environmental-shifts-pca-components">Environmental Shifts (PCA Components)</h2>
<p>This section examines the projected changes in the principal environmental gradients (PCA components) between the current conditions and future climate scenarios. This helps understand how the fundamental environmental space is predicted to change.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb149"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span>config<span class="sc">$</span>use_pca_predictors) {</span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"PCA predictors not used in this configuration. Skipping PCA environmental shift analysis.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb149-4"><a href="#cb149-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(env_pca_current_cropped) <span class="sc">||</span> <span class="fu">is.null</span>(env_pca_future_list) <span class="sc">||</span> <span class="fu">length</span>(env_pca_future_list) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb149-5"><a href="#cb149-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Warning: Current or future PCA environmental rasters are not available. Cannot calculate shifts.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb149-6"><a href="#cb149-6" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb149-7"><a href="#cb149-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"--- Calculating and Plotting Shifts in PCA Environmental Gradients ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb149-8"><a href="#cb149-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb149-9"><a href="#cb149-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure current PCA stack is SpatRaster for subtraction</span></span>
<span id="cb149-10"><a href="#cb149-10" aria-hidden="true" tabindex="-1"></a>    current_pca_terra <span class="ot">&lt;-</span> <span class="cf">if</span>(<span class="fu">inherits</span>(env_pca_current_cropped, <span class="st">"SpatRaster"</span>)) env_pca_current_cropped <span class="cf">else</span> terra<span class="sc">::</span><span class="fu">rast</span>(env_pca_current_cropped)</span>
<span id="cb149-11"><a href="#cb149-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-12"><a href="#cb149-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (scenario_name <span class="cf">in</span> <span class="fu">names</span>(env_pca_future_list)) {</span>
<span id="cb149-13"><a href="#cb149-13" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (scenario_name <span class="sc">==</span> <span class="st">"current"</span>) {</span>
<span id="cb149-14"><a href="#cb149-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">next</span></span>
<span id="cb149-15"><a href="#cb149-15" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb149-16"><a href="#cb149-16" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb149-17"><a href="#cb149-17" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"  Processing shifts for scenario:"</span>, scenario_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb149-18"><a href="#cb149-18" aria-hidden="true" tabindex="-1"></a>      future_pca_stack <span class="ot">&lt;-</span> env_pca_future_list[[scenario_name]]</span>
<span id="cb149-19"><a href="#cb149-19" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb149-20"><a href="#cb149-20" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">is.null</span>(future_pca_stack)) {</span>
<span id="cb149-21"><a href="#cb149-21" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"  Skipping scenario"</span>, scenario_name, <span class="st">"- future PCA stack is NULL.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb149-22"><a href="#cb149-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">next</span></span>
<span id="cb149-23"><a href="#cb149-23" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb149-24"><a href="#cb149-24" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb149-25"><a href="#cb149-25" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Ensure layers match for subtraction (e.g., up to n_pca_components)</span></span>
<span id="cb149-26"><a href="#cb149-26" aria-hidden="true" tabindex="-1"></a>      <span class="co"># It's crucial that both current and future PCA stacks were generated with the same number of components</span></span>
<span id="cb149-27"><a href="#cb149-27" aria-hidden="true" tabindex="-1"></a>      <span class="co"># and represent the same underlying variables in the same order before PCA.</span></span>
<span id="cb149-28"><a href="#cb149-28" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb149-29"><a href="#cb149-29" aria-hidden="true" tabindex="-1"></a>      <span class="co"># If layer names don't match exactly but number of layers does for the first N components:</span></span>
<span id="cb149-30"><a href="#cb149-30" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (terra<span class="sc">::</span><span class="fu">nlyr</span>(current_pca_terra) <span class="sc">&gt;=</span> config<span class="sc">$</span>n_pca_components <span class="sc">&amp;&amp;</span> terra<span class="sc">::</span><span class="fu">nlyr</span>(future_pca_stack) <span class="sc">&gt;=</span> config<span class="sc">$</span>n_pca_components) {</span>
<span id="cb149-31"><a href="#cb149-31" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb149-32"><a href="#cb149-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Select the first N components (defined in config)</span></span>
<span id="cb149-33"><a href="#cb149-33" aria-hidden="true" tabindex="-1"></a>        current_pca_subset <span class="ot">&lt;-</span> current_pca_terra[[<span class="dv">1</span><span class="sc">:</span>config<span class="sc">$</span>n_pca_components]]</span>
<span id="cb149-34"><a href="#cb149-34" aria-hidden="true" tabindex="-1"></a>        future_pca_subset <span class="ot">&lt;-</span> future_pca_stack[[<span class="dv">1</span><span class="sc">:</span>config<span class="sc">$</span>n_pca_components]]</span>
<span id="cb149-35"><a href="#cb149-35" aria-hidden="true" tabindex="-1"></a>        <span class="fu">names</span>(current_pca_subset) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"PC"</span>, <span class="dv">1</span><span class="sc">:</span>config<span class="sc">$</span>n_pca_components) <span class="co"># Standardize names for safety</span></span>
<span id="cb149-36"><a href="#cb149-36" aria-hidden="true" tabindex="-1"></a>        <span class="fu">names</span>(future_pca_subset) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"PC"</span>, <span class="dv">1</span><span class="sc">:</span>config<span class="sc">$</span>n_pca_components)</span>
<span id="cb149-37"><a href="#cb149-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-38"><a href="#cb149-38" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate the difference (shift)</span></span>
<span id="cb149-39"><a href="#cb149-39" aria-hidden="true" tabindex="-1"></a>        <span class="co"># terra::`-.SpatRaster` works element-wise if names match or by layer order if names don't.</span></span>
<span id="cb149-40"><a href="#cb149-40" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Better to ensure consistent naming (done above)</span></span>
<span id="cb149-41"><a href="#cb149-41" aria-hidden="true" tabindex="-1"></a>        env_shift_scenario <span class="ot">&lt;-</span> future_pca_subset <span class="sc">-</span> current_pca_subset </span>
<span id="cb149-42"><a href="#cb149-42" aria-hidden="true" tabindex="-1"></a>        <span class="fu">names</span>(env_shift_scenario) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"Environmental PC"</span>, <span class="dv">1</span><span class="sc">:</span>config<span class="sc">$</span>n_pca_components, <span class="st">" Shifts (Future - Current): "</span>, scenario_label_converter[scenario_name])</span>
<span id="cb149-43"><a href="#cb149-43" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb149-44"><a href="#cb149-44" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"    Calculated PCA shifts for scenario:"</span>, scenario_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb149-45"><a href="#cb149-45" aria-hidden="true" tabindex="-1"></a>        <span class="fu">plot</span>(env_shift_scenario, <span class="at">nc =</span> <span class="dv">2</span>)</span>
<span id="cb149-46"><a href="#cb149-46" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb149-47"><a href="#cb149-47" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb149-48"><a href="#cb149-48" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"  Warning: Layer mismatch or insufficient layers for PCA shift calculation in scenario"</span>, scenario_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb149-49"><a href="#cb149-49" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"    Current PCA layers:"</span>, terra<span class="sc">::</span><span class="fu">nlyr</span>(current_pca_terra), <span class="st">" Future PCA layers:"</span>, terra<span class="sc">::</span><span class="fu">nlyr</span>(future_pca_stack), <span class="st">" Needed:"</span>, config<span class="sc">$</span>n_pca_components, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb149-50"><a href="#cb149-50" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb149-51"><a href="#cb149-51" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb149-52"><a href="#cb149-52" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb149-53"><a href="#cb149-53" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- Calculating and Plotting Shifts in PCA Environmental Gradients ---
  Processing shifts for scenario: ssp119_2050 
    Calculated PCA shifts for scenario: ssp119_2050 </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/plot-environmental-pca-shifts-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Processing shifts for scenario: ssp119_2100 
    Calculated PCA shifts for scenario: ssp119_2100 </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/plot-environmental-pca-shifts-2.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Processing shifts for scenario: ssp585_2050 
    Calculated PCA shifts for scenario: ssp585_2050 </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/plot-environmental-pca-shifts-3.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Processing shifts for scenario: ssp585_2100 
    Calculated PCA shifts for scenario: ssp585_2100 </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/plot-environmental-pca-shifts-4.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="load-future-individual-species-prediction-rasters" class="level2">
<h2 class="anchored" data-anchor-id="load-future-individual-species-prediction-rasters">Load Future Individual Species Prediction Rasters</h2>
<p>This section loads the individual species prediction rasters for host sea anemones and anemonefish (combined models) for each future scenario. These are needed for calculating Schoenerâ€™s D overlap and individual suitability shifts.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a><span class="co"># future_scenarios_to_load was defined in the "Future Species Richness Projections" chunk</span></span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"future_scenarios_to_load"</span>)) {</span>
<span id="cb154-3"><a href="#cb154-3" aria-hidden="true" tabindex="-1"></a>  future_scenarios_to_load <span class="ot">&lt;-</span> config<span class="sc">$</span>env_scenarios[config<span class="sc">$</span>env_scenarios <span class="sc">!=</span> <span class="st">"current"</span>]</span>
<span id="cb154-4"><a href="#cb154-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb154-5"><a href="#cb154-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-6"><a href="#cb154-6" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Set predictor suffixes for the correct model types ---</span></span>
<span id="cb154-7"><a href="#cb154-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Host models are based on environmental-only predictors</span></span>
<span id="cb154-8"><a href="#cb154-8" aria-hidden="true" tabindex="-1"></a>predictor_suffix_anemone_env <span class="ot">&lt;-</span> <span class="st">"_pca"</span></span>
<span id="cb154-9"><a href="#cb154-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Anemonefish models, for this analysis, should be the best-performing 'combined' models</span></span>
<span id="cb154-10"><a href="#cb154-10" aria-hidden="true" tabindex="-1"></a>predictor_suffix_anemonefish_combined <span class="ot">&lt;-</span> <span class="st">"_combined_pca"</span></span>
<span id="cb154-11"><a href="#cb154-11" aria-hidden="true" tabindex="-1"></a><span class="co"># NEW: Suffix for fish environmental-only models</span></span>
<span id="cb154-12"><a href="#cb154-12" aria-hidden="true" tabindex="-1"></a>predictor_suffix_anemonefish_env <span class="ot">&lt;-</span> <span class="st">"_pca"</span></span>
<span id="cb154-13"><a href="#cb154-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-14"><a href="#cb154-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-15"><a href="#cb154-15" aria-hidden="true" tabindex="-1"></a>host_pred_stacks_future_individual <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb154-16"><a href="#cb154-16" aria-hidden="true" tabindex="-1"></a>fish_pred_stacks_future_individual <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb154-17"><a href="#cb154-17" aria-hidden="true" tabindex="-1"></a><span class="co"># NEW: List to store future Env-Only fish predictions</span></span>
<span id="cb154-18"><a href="#cb154-18" aria-hidden="true" tabindex="-1"></a>fish_pred_stacks_future_env_only <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb154-19"><a href="#cb154-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-20"><a href="#cb154-20" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (scenario_name <span class="cf">in</span> future_scenarios_to_load) {</span>
<span id="cb154-21"><a href="#cb154-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Loading individual future predictions for Scenario:"</span>, scenario_name, <span class="st">"---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb154-22"><a href="#cb154-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb154-23"><a href="#cb154-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Host Anemones (Environmental-Only models) ---</span></span>
<span id="cb154-24"><a href="#cb154-24" aria-hidden="true" tabindex="-1"></a>  current_host_future_files <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb154-25"><a href="#cb154-25" aria-hidden="true" tabindex="-1"></a>  current_host_future_names <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb154-26"><a href="#cb154-26" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"anemone_species_df"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(anemone_species_df) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb154-27"><a href="#cb154-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(anemone_species_df)) {</span>
<span id="cb154-28"><a href="#cb154-28" aria-hidden="true" tabindex="-1"></a>      sp_name_sanitized <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">"_"</span>, anemone_species_df<span class="sc">$</span>scientificName[i])</span>
<span id="cb154-29"><a href="#cb154-29" aria-hidden="true" tabindex="-1"></a>      pred_file_path <span class="ot">&lt;-</span> <span class="fu">construct_mean_prediction_filename</span>(</span>
<span id="cb154-30"><a href="#cb154-30" aria-hidden="true" tabindex="-1"></a>        <span class="at">species_name_sanitized =</span> sp_name_sanitized,</span>
<span id="cb154-31"><a href="#cb154-31" aria-hidden="true" tabindex="-1"></a>        <span class="at">scenario_name =</span> scenario_name,</span>
<span id="cb154-32"><a href="#cb154-32" aria-hidden="true" tabindex="-1"></a>        <span class="at">predictor_type_suffix =</span> predictor_suffix_anemone_env,</span>
<span id="cb154-33"><a href="#cb154-33" aria-hidden="true" tabindex="-1"></a>        <span class="at">config =</span> config</span>
<span id="cb154-34"><a href="#cb154-34" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb154-35"><a href="#cb154-35" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">file.exists</span>(pred_file_path)) {</span>
<span id="cb154-36"><a href="#cb154-36" aria-hidden="true" tabindex="-1"></a>        current_host_future_files <span class="ot">&lt;-</span> <span class="fu">c</span>(current_host_future_files, pred_file_path)</span>
<span id="cb154-37"><a href="#cb154-37" aria-hidden="true" tabindex="-1"></a>        current_host_future_names <span class="ot">&lt;-</span> <span class="fu">c</span>(current_host_future_names, sp_name_sanitized)</span>
<span id="cb154-38"><a href="#cb154-38" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb154-39"><a href="#cb154-39" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"  Warning: Host future prediction file not found for"</span>, sp_name_sanitized, <span class="st">"in"</span>, scenario_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb154-40"><a href="#cb154-40" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb154-41"><a href="#cb154-41" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb154-42"><a href="#cb154-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(current_host_future_files) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb154-43"><a href="#cb154-43" aria-hidden="true" tabindex="-1"></a>      temp_stack <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(current_host_future_files)</span>
<span id="cb154-44"><a href="#cb154-44" aria-hidden="true" tabindex="-1"></a>      <span class="fu">names</span>(temp_stack) <span class="ot">&lt;-</span> current_host_future_names</span>
<span id="cb154-45"><a href="#cb154-45" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (config<span class="sc">$</span>apply_indo_pacific_crop) {</span>
<span id="cb154-46"><a href="#cb154-46" aria-hidden="true" tabindex="-1"></a>        ip_extent <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">ext</span>(config<span class="sc">$</span>indo_pacific_bbox)</span>
<span id="cb154-47"><a href="#cb154-47" aria-hidden="true" tabindex="-1"></a>        host_pred_stacks_future_individual[[scenario_name]] <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">crop</span>(temp_stack, ip_extent)</span>
<span id="cb154-48"><a href="#cb154-48" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb154-49"><a href="#cb154-49" aria-hidden="true" tabindex="-1"></a>        host_pred_stacks_future_individual[[scenario_name]] <span class="ot">&lt;-</span> temp_stack</span>
<span id="cb154-50"><a href="#cb154-50" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb154-51"><a href="#cb154-51" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"  Loaded and cropped"</span>, terra<span class="sc">::</span><span class="fu">nlyr</span>(host_pred_stacks_future_individual[[scenario_name]]), <span class="st">"host future predictions for"</span>, scenario_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb154-52"><a href="#cb154-52" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb154-53"><a href="#cb154-53" aria-hidden="true" tabindex="-1"></a>        host_pred_stacks_future_individual[[scenario_name]] <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb154-54"><a href="#cb154-54" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"  No host future prediction files found for"</span>, scenario_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb154-55"><a href="#cb154-55" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb154-56"><a href="#cb154-56" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb154-57"><a href="#cb154-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-58"><a href="#cb154-58" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Anemonefish (Combined models) ---</span></span>
<span id="cb154-59"><a href="#cb154-59" aria-hidden="true" tabindex="-1"></a>  current_fish_future_files <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb154-60"><a href="#cb154-60" aria-hidden="true" tabindex="-1"></a>  current_fish_future_names <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb154-61"><a href="#cb154-61" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"anemonefish_species_df"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(anemonefish_species_df) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb154-62"><a href="#cb154-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(anemonefish_species_df)) {</span>
<span id="cb154-63"><a href="#cb154-63" aria-hidden="true" tabindex="-1"></a>      sp_name_sanitized <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">"_"</span>, anemonefish_species_df<span class="sc">$</span>scientificName[i])</span>
<span id="cb154-64"><a href="#cb154-64" aria-hidden="true" tabindex="-1"></a>      pred_file_path <span class="ot">&lt;-</span> <span class="fu">construct_mean_prediction_filename</span>(</span>
<span id="cb154-65"><a href="#cb154-65" aria-hidden="true" tabindex="-1"></a>        <span class="at">species_name_sanitized =</span> sp_name_sanitized,</span>
<span id="cb154-66"><a href="#cb154-66" aria-hidden="true" tabindex="-1"></a>        <span class="at">scenario_name =</span> scenario_name,</span>
<span id="cb154-67"><a href="#cb154-67" aria-hidden="true" tabindex="-1"></a>        <span class="at">predictor_type_suffix =</span> predictor_suffix_anemonefish_combined,</span>
<span id="cb154-68"><a href="#cb154-68" aria-hidden="true" tabindex="-1"></a>        <span class="at">config =</span> config</span>
<span id="cb154-69"><a href="#cb154-69" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb154-70"><a href="#cb154-70" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">file.exists</span>(pred_file_path)) {</span>
<span id="cb154-71"><a href="#cb154-71" aria-hidden="true" tabindex="-1"></a>        current_fish_future_files <span class="ot">&lt;-</span> <span class="fu">c</span>(current_fish_future_files, pred_file_path)</span>
<span id="cb154-72"><a href="#cb154-72" aria-hidden="true" tabindex="-1"></a>        current_fish_future_names <span class="ot">&lt;-</span> <span class="fu">c</span>(current_fish_future_names, sp_name_sanitized)</span>
<span id="cb154-73"><a href="#cb154-73" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb154-74"><a href="#cb154-74" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"  Warning: Anemonefish (Combined) future prediction file not found for"</span>, sp_name_sanitized, <span class="st">"in"</span>, scenario_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb154-75"><a href="#cb154-75" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb154-76"><a href="#cb154-76" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb154-77"><a href="#cb154-77" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(current_fish_future_files) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb154-78"><a href="#cb154-78" aria-hidden="true" tabindex="-1"></a>      temp_stack_fish <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(current_fish_future_files)</span>
<span id="cb154-79"><a href="#cb154-79" aria-hidden="true" tabindex="-1"></a>      <span class="fu">names</span>(temp_stack_fish) <span class="ot">&lt;-</span> current_fish_future_names</span>
<span id="cb154-80"><a href="#cb154-80" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (config<span class="sc">$</span>apply_indo_pacific_crop) {</span>
<span id="cb154-81"><a href="#cb154-81" aria-hidden="true" tabindex="-1"></a>        ip_extent <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">ext</span>(config<span class="sc">$</span>indo_pacific_bbox)</span>
<span id="cb154-82"><a href="#cb154-82" aria-hidden="true" tabindex="-1"></a>        fish_pred_stacks_future_individual[[scenario_name]] <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">crop</span>(temp_stack_fish, ip_extent)</span>
<span id="cb154-83"><a href="#cb154-83" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb154-84"><a href="#cb154-84" aria-hidden="true" tabindex="-1"></a>        fish_pred_stacks_future_individual[[scenario_name]] <span class="ot">&lt;-</span> temp_stack_fish</span>
<span id="cb154-85"><a href="#cb154-85" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb154-86"><a href="#cb154-86" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"  Loaded and cropped"</span>, terra<span class="sc">::</span><span class="fu">nlyr</span>(fish_pred_stacks_future_individual[[scenario_name]]), <span class="st">"anemonefish (Combined) future predictions for"</span>, scenario_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb154-87"><a href="#cb154-87" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb154-88"><a href="#cb154-88" aria-hidden="true" tabindex="-1"></a>        fish_pred_stacks_future_individual[[scenario_name]] <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb154-89"><a href="#cb154-89" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"  No anemonefish (Combined) future prediction files found for"</span>, scenario_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb154-90"><a href="#cb154-90" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb154-91"><a href="#cb154-91" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb154-92"><a href="#cb154-92" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Loading individual future predictions for Scenario: ssp119_2050 ---
  Loaded and cropped 10 host future predictions for ssp119_2050 
  Warning: Anemonefish (Combined) future prediction file not found for Amphiprion_pacificus in ssp119_2050 
  Loaded and cropped 26 anemonefish (Combined) future predictions for ssp119_2050 

--- Loading individual future predictions for Scenario: ssp119_2100 ---
  Loaded and cropped 10 host future predictions for ssp119_2100 
  Warning: Anemonefish (Combined) future prediction file not found for Amphiprion_pacificus in ssp119_2100 
  Loaded and cropped 26 anemonefish (Combined) future predictions for ssp119_2100 

--- Loading individual future predictions for Scenario: ssp585_2050 ---
  Loaded and cropped 10 host future predictions for ssp585_2050 
  Warning: Anemonefish (Combined) future prediction file not found for Amphiprion_pacificus in ssp585_2050 
  Loaded and cropped 26 anemonefish (Combined) future predictions for ssp585_2050 

--- Loading individual future predictions for Scenario: ssp585_2100 ---
  Loaded and cropped 10 host future predictions for ssp585_2100 
  Warning: Anemonefish (Combined) future prediction file not found for Amphiprion_pacificus in ssp585_2100 
  Loaded and cropped 26 anemonefish (Combined) future predictions for ssp585_2100 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Result: host_pred_stacks_future_individual and fish_pred_stacks_future_individual</span></span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a><span class="co"># are lists of SpatRasters, named by scenario, containing individual species layers.</span></span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-4"><a href="#cb156-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-5"><a href="#cb156-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-6"><a href="#cb156-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-7"><a href="#cb156-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-8"><a href="#cb156-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-9"><a href="#cb156-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-10"><a href="#cb156-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-11"><a href="#cb156-11" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Anemonefish (Environmental-Only models) ---</span></span>
<span id="cb156-12"><a href="#cb156-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># NEW: Load these to calculate the "Potential Niche" vs "Realized Niche"</span></span>
<span id="cb156-13"><a href="#cb156-13" aria-hidden="true" tabindex="-1"></a>  current_fish_env_files <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb156-14"><a href="#cb156-14" aria-hidden="true" tabindex="-1"></a>  current_fish_env_names <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb156-15"><a href="#cb156-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-16"><a href="#cb156-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"anemonefish_species_df"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(anemonefish_species_df) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb156-17"><a href="#cb156-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(anemonefish_species_df)) {</span>
<span id="cb156-18"><a href="#cb156-18" aria-hidden="true" tabindex="-1"></a>      sp_name_sanitized <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">"_"</span>, anemonefish_species_df<span class="sc">$</span>scientificName[i])</span>
<span id="cb156-19"><a href="#cb156-19" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb156-20"><a href="#cb156-20" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Construct filename using the ENV suffix</span></span>
<span id="cb156-21"><a href="#cb156-21" aria-hidden="true" tabindex="-1"></a>      pred_file_path <span class="ot">&lt;-</span> <span class="fu">construct_mean_prediction_filename</span>(</span>
<span id="cb156-22"><a href="#cb156-22" aria-hidden="true" tabindex="-1"></a>        <span class="at">species_name_sanitized =</span> sp_name_sanitized,</span>
<span id="cb156-23"><a href="#cb156-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">scenario_name =</span> scenario_name,</span>
<span id="cb156-24"><a href="#cb156-24" aria-hidden="true" tabindex="-1"></a>        <span class="at">predictor_type_suffix =</span> predictor_suffix_anemonefish_env, <span class="co"># &lt;--- Using ENV suffix</span></span>
<span id="cb156-25"><a href="#cb156-25" aria-hidden="true" tabindex="-1"></a>        <span class="at">config =</span> config</span>
<span id="cb156-26"><a href="#cb156-26" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb156-27"><a href="#cb156-27" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb156-28"><a href="#cb156-28" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">file.exists</span>(pred_file_path)) {</span>
<span id="cb156-29"><a href="#cb156-29" aria-hidden="true" tabindex="-1"></a>        current_fish_env_files <span class="ot">&lt;-</span> <span class="fu">c</span>(current_fish_env_files, pred_file_path)</span>
<span id="cb156-30"><a href="#cb156-30" aria-hidden="true" tabindex="-1"></a>        current_fish_env_names <span class="ot">&lt;-</span> <span class="fu">c</span>(current_fish_env_names, sp_name_sanitized)</span>
<span id="cb156-31"><a href="#cb156-31" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb156-32"><a href="#cb156-32" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb156-33"><a href="#cb156-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb156-34"><a href="#cb156-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(current_fish_env_files) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb156-35"><a href="#cb156-35" aria-hidden="true" tabindex="-1"></a>      temp_stack_env <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(current_fish_env_files)</span>
<span id="cb156-36"><a href="#cb156-36" aria-hidden="true" tabindex="-1"></a>      <span class="fu">names</span>(temp_stack_env) <span class="ot">&lt;-</span> current_fish_env_names</span>
<span id="cb156-37"><a href="#cb156-37" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb156-38"><a href="#cb156-38" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (config<span class="sc">$</span>apply_indo_pacific_crop) {</span>
<span id="cb156-39"><a href="#cb156-39" aria-hidden="true" tabindex="-1"></a>        ip_extent <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">ext</span>(config<span class="sc">$</span>indo_pacific_bbox)</span>
<span id="cb156-40"><a href="#cb156-40" aria-hidden="true" tabindex="-1"></a>        fish_pred_stacks_future_env_only[[scenario_name]] <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">crop</span>(temp_stack_env, ip_extent)</span>
<span id="cb156-41"><a href="#cb156-41" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb156-42"><a href="#cb156-42" aria-hidden="true" tabindex="-1"></a>        fish_pred_stacks_future_env_only[[scenario_name]] <span class="ot">&lt;-</span> temp_stack_env</span>
<span id="cb156-43"><a href="#cb156-43" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb156-44"><a href="#cb156-44" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"  Loaded"</span>, terra<span class="sc">::</span><span class="fu">nlyr</span>(fish_pred_stacks_future_env_only[[scenario_name]]), <span class="st">"anemonefish (Env-Only) future predictions for"</span>, scenario_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb156-45"><a href="#cb156-45" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb156-46"><a href="#cb156-46" aria-hidden="true" tabindex="-1"></a>      fish_pred_stacks_future_env_only[[scenario_name]] <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb156-47"><a href="#cb156-47" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"  No anemonefish (Env-Only) future prediction files found for"</span>, scenario_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb156-48"><a href="#cb156-48" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb156-49"><a href="#cb156-49" aria-hidden="true" tabindex="-1"></a>  }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Loaded 23 anemonefish (Env-Only) future predictions for ssp585_2100 </code></pre>
</div>
</div>
</section>
<section id="individual-species-suitability-shifts" class="level2">
<h2 class="anchored" data-anchor-id="individual-species-suitability-shifts">Individual Species Suitability Shifts</h2>
<p>This section calculates the mean change in environmental suitability for each individual host sea anemone and anemonefish species between the current period and each future climate scenario. These shift values will be used to explore correlations with niche breadth.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb158"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prerequisites from previous chunks:</span></span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a><span class="co"># - host_pred_stack_cropped: Current individual host predictions (cropped)</span></span>
<span id="cb158-3"><a href="#cb158-3" aria-hidden="true" tabindex="-1"></a><span class="co"># - fish_pred_stack_cropped: Current individual fish (combined) predictions (cropped)</span></span>
<span id="cb158-4"><a href="#cb158-4" aria-hidden="true" tabindex="-1"></a><span class="co"># - host_pred_stacks_future_individual: List of future individual host predictions (cropped), named by scenario</span></span>
<span id="cb158-5"><a href="#cb158-5" aria-hidden="true" tabindex="-1"></a><span class="co"># - fish_pred_stacks_future_individual: List of future individual fish (combined) predictions (cropped), named by scenario</span></span>
<span id="cb158-6"><a href="#cb158-6" aria-hidden="true" tabindex="-1"></a><span class="co"># - future_scenarios_to_load: Vector of future scenario names (e.g., "ssp119_2050", "ssp585_2100")</span></span>
<span id="cb158-7"><a href="#cb158-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-8"><a href="#cb158-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"host_pred_stack_cropped"</span>) <span class="sc">||</span> <span class="sc">!</span><span class="fu">exists</span>(<span class="st">"fish_pred_stack_cropped"</span>) <span class="sc">||</span></span>
<span id="cb158-9"><a href="#cb158-9" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">exists</span>(<span class="st">"host_pred_stacks_future_individual"</span>) <span class="sc">||</span> <span class="sc">!</span><span class="fu">exists</span>(<span class="st">"fish_pred_stacks_future_individual"</span>) <span class="sc">||</span></span>
<span id="cb158-10"><a href="#cb158-10" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">exists</span>(<span class="st">"future_scenarios_to_load"</span>)) {</span>
<span id="cb158-11"><a href="#cb158-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"Prerequisite data for calculating suitability shifts is missing. Ensure previous chunks (loading current and future individual predictions) have run successfully."</span>)</span>
<span id="cb158-12"><a href="#cb158-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb158-13"><a href="#cb158-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-14"><a href="#cb158-14" aria-hidden="true" tabindex="-1"></a>suitability_shifts_list <span class="ot">&lt;-</span> <span class="fu">list</span>() <span class="co"># Initialize list to store results for all species and scenarios</span></span>
<span id="cb158-15"><a href="#cb158-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-16"><a href="#cb158-16" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"--- Calculating Mean Suitability Shifts for Individual Species ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- Calculating Mean Suitability Shifts for Individual Species ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (scenario_name_fut <span class="cf">in</span> future_scenarios_to_load) {</span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">  Processing Scenario:"</span>, scenario_name_fut, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-3"><a href="#cb160-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-4"><a href="#cb160-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Host Anemones Suitability Shifts ---</span></span>
<span id="cb160-5"><a href="#cb160-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"    Calculating shifts for Host Anemones...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-6"><a href="#cb160-6" aria-hidden="true" tabindex="-1"></a>  current_hosts_for_diff <span class="ot">&lt;-</span> host_pred_stack_cropped</span>
<span id="cb160-7"><a href="#cb160-7" aria-hidden="true" tabindex="-1"></a>  future_hosts_for_diff_raw <span class="ot">&lt;-</span> host_pred_stacks_future_individual[[scenario_name_fut]]</span>
<span id="cb160-8"><a href="#cb160-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-9"><a href="#cb160-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(current_hosts_for_diff) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">is.null</span>(future_hosts_for_diff_raw) <span class="sc">&amp;&amp;</span> </span>
<span id="cb160-10"><a href="#cb160-10" aria-hidden="true" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">nlyr</span>(current_hosts_for_diff) <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span> terra<span class="sc">::</span><span class="fu">nlyr</span>(future_hosts_for_diff_raw) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb160-11"><a href="#cb160-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb160-12"><a href="#cb160-12" aria-hidden="true" tabindex="-1"></a>    common_host_species <span class="ot">&lt;-</span> <span class="fu">intersect</span>(<span class="fu">names</span>(current_hosts_for_diff), <span class="fu">names</span>(future_hosts_for_diff_raw))</span>
<span id="cb160-13"><a href="#cb160-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb160-14"><a href="#cb160-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(common_host_species) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb160-15"><a href="#cb160-15" aria-hidden="true" tabindex="-1"></a>      current_hosts_subset <span class="ot">&lt;-</span> current_hosts_for_diff[[common_host_species]]</span>
<span id="cb160-16"><a href="#cb160-16" aria-hidden="true" tabindex="-1"></a>      future_hosts_subset_raw <span class="ot">&lt;-</span> future_hosts_for_diff_raw[[common_host_species]]</span>
<span id="cb160-17"><a href="#cb160-17" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb160-18"><a href="#cb160-18" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Ensure geometry matches for subtraction by resampling future to current if needed</span></span>
<span id="cb160-19"><a href="#cb160-19" aria-hidden="true" tabindex="-1"></a>      future_hosts_subset_aligned <span class="ot">&lt;-</span> future_hosts_subset_raw</span>
<span id="cb160-20"><a href="#cb160-20" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="sc">!</span>terra<span class="sc">::</span><span class="fu">compareGeom</span>(current_hosts_subset, future_hosts_subset_raw, <span class="at">stopOnError=</span><span class="cn">FALSE</span>, <span class="at">res=</span><span class="cn">TRUE</span>, <span class="at">crs=</span><span class="cn">TRUE</span>, <span class="at">ext=</span><span class="cn">TRUE</span>)){</span>
<span id="cb160-21"><a href="#cb160-21" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"      Resampling future host predictions for scenario '"</span>, scenario_name_fut, <span class="st">"' to match current geometry for shift calculation.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-22"><a href="#cb160-22" aria-hidden="true" tabindex="-1"></a>          future_hosts_subset_aligned <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb160-23"><a href="#cb160-23" aria-hidden="true" tabindex="-1"></a>            terra<span class="sc">::</span><span class="fu">resample</span>(future_hosts_subset_raw, current_hosts_subset, <span class="at">method=</span><span class="st">"bilinear"</span>),</span>
<span id="cb160-24"><a href="#cb160-24" aria-hidden="true" tabindex="-1"></a>            <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb160-25"><a href="#cb160-25" aria-hidden="true" tabindex="-1"></a>              <span class="fu">cat</span>(<span class="st">"      ERROR resampling future host stack for"</span>, scenario_name_fut, <span class="st">":"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>); <span class="cn">NULL</span></span>
<span id="cb160-26"><a href="#cb160-26" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb160-27"><a href="#cb160-27" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb160-28"><a href="#cb160-28" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb160-29"><a href="#cb160-29" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb160-30"><a href="#cb160-30" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(future_hosts_subset_aligned)) {</span>
<span id="cb160-31"><a href="#cb160-31" aria-hidden="true" tabindex="-1"></a>        diff_hosts_scenario_indiv <span class="ot">&lt;-</span> future_hosts_subset_aligned <span class="sc">-</span> current_hosts_subset</span>
<span id="cb160-32"><a href="#cb160-32" aria-hidden="true" tabindex="-1"></a>        mean_shifts_hosts_indiv <span class="ot">&lt;-</span> <span class="fu">global</span>(diff_hosts_scenario_indiv, <span class="st">"mean"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb160-33"><a href="#cb160-33" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rownames</span>(mean_shifts_hosts_indiv) <span class="ot">&lt;-</span> <span class="fu">names</span>(diff_hosts_scenario_indiv) <span class="co"># Should be common_host_species</span></span>
<span id="cb160-34"><a href="#cb160-34" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb160-35"><a href="#cb160-35" aria-hidden="true" tabindex="-1"></a>        suitability_shifts_list[[<span class="fu">paste0</span>(<span class="st">"hosts_"</span>, scenario_name_fut)]] <span class="ot">&lt;-</span> mean_shifts_hosts_indiv</span>
<span id="cb160-36"><a href="#cb160-36" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"      Mean suitability shifts for hosts in"</span>, scenario_name_fut, <span class="st">"calculated.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-37"><a href="#cb160-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(head(mean_shifts_hosts_indiv)) </span></span>
<span id="cb160-38"><a href="#cb160-38" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb160-39"><a href="#cb160-39" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb160-40"><a href="#cb160-40" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"      No common host species found between current and future stacks for scenario"</span>, scenario_name_fut, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-41"><a href="#cb160-41" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb160-42"><a href="#cb160-42" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb160-43"><a href="#cb160-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"    Skipping host anemones for scenario"</span>, scenario_name_fut, <span class="st">"- current or future individual prediction stack missing or empty.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-44"><a href="#cb160-44" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb160-45"><a href="#cb160-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-46"><a href="#cb160-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Anemonefish (Environmental-Only Models) Suitability Shifts ---</span></span>
<span id="cb160-47"><a href="#cb160-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"    Calculating shifts for Anemonefish (Combined)...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-48"><a href="#cb160-48" aria-hidden="true" tabindex="-1"></a>  current_fish_for_diff <span class="ot">&lt;-</span> fish_pred_stack_cropped </span>
<span id="cb160-49"><a href="#cb160-49" aria-hidden="true" tabindex="-1"></a>  future_fish_for_diff_raw <span class="ot">&lt;-</span> fish_pred_stacks_future_individual[[scenario_name_fut]] </span>
<span id="cb160-50"><a href="#cb160-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-51"><a href="#cb160-51" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(current_fish_for_diff) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">is.null</span>(future_fish_for_diff_raw) <span class="sc">&amp;&amp;</span></span>
<span id="cb160-52"><a href="#cb160-52" aria-hidden="true" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">nlyr</span>(current_fish_for_diff) <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span> terra<span class="sc">::</span><span class="fu">nlyr</span>(future_fish_for_diff_raw) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb160-53"><a href="#cb160-53" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb160-54"><a href="#cb160-54" aria-hidden="true" tabindex="-1"></a>    common_fish_species <span class="ot">&lt;-</span> <span class="fu">intersect</span>(<span class="fu">names</span>(current_fish_for_diff), <span class="fu">names</span>(future_fish_for_diff_raw))</span>
<span id="cb160-55"><a href="#cb160-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb160-56"><a href="#cb160-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(common_fish_species) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb160-57"><a href="#cb160-57" aria-hidden="true" tabindex="-1"></a>      current_fish_subset <span class="ot">&lt;-</span> current_fish_for_diff[[common_fish_species]]</span>
<span id="cb160-58"><a href="#cb160-58" aria-hidden="true" tabindex="-1"></a>      future_fish_subset_raw <span class="ot">&lt;-</span> future_fish_for_diff_raw[[common_fish_species]]</span>
<span id="cb160-59"><a href="#cb160-59" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb160-60"><a href="#cb160-60" aria-hidden="true" tabindex="-1"></a>      future_fish_subset_aligned <span class="ot">&lt;-</span> future_fish_subset_raw</span>
<span id="cb160-61"><a href="#cb160-61" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="sc">!</span>terra<span class="sc">::</span><span class="fu">compareGeom</span>(current_fish_subset, future_fish_subset_raw, <span class="at">stopOnError=</span><span class="cn">FALSE</span>, <span class="at">res=</span><span class="cn">TRUE</span>, <span class="at">crs=</span><span class="cn">TRUE</span>, <span class="at">ext=</span><span class="cn">TRUE</span>)){</span>
<span id="cb160-62"><a href="#cb160-62" aria-hidden="true" tabindex="-1"></a>         <span class="fu">cat</span>(<span class="st">"      Resampling future fish (combined) predictions for scenario '"</span>, scenario_name_fut, <span class="st">"' to match current geometry.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-63"><a href="#cb160-63" aria-hidden="true" tabindex="-1"></a>         future_fish_subset_aligned <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb160-64"><a href="#cb160-64" aria-hidden="true" tabindex="-1"></a>            terra<span class="sc">::</span><span class="fu">resample</span>(future_fish_subset_raw, current_fish_subset, <span class="at">method=</span><span class="st">"bilinear"</span>),</span>
<span id="cb160-65"><a href="#cb160-65" aria-hidden="true" tabindex="-1"></a>            <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb160-66"><a href="#cb160-66" aria-hidden="true" tabindex="-1"></a>              <span class="fu">cat</span>(<span class="st">"      ERROR resampling future fish stack for"</span>, scenario_name_fut, <span class="st">":"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>); <span class="cn">NULL</span></span>
<span id="cb160-67"><a href="#cb160-67" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb160-68"><a href="#cb160-68" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb160-69"><a href="#cb160-69" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb160-70"><a href="#cb160-70" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb160-71"><a href="#cb160-71" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(future_fish_subset_aligned)) {</span>
<span id="cb160-72"><a href="#cb160-72" aria-hidden="true" tabindex="-1"></a>        diff_fish_scenario_indiv <span class="ot">&lt;-</span> future_fish_subset_aligned <span class="sc">-</span> current_fish_subset</span>
<span id="cb160-73"><a href="#cb160-73" aria-hidden="true" tabindex="-1"></a>        mean_shifts_fish_indiv <span class="ot">&lt;-</span> <span class="fu">global</span>(diff_fish_scenario_indiv, <span class="st">"mean"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb160-74"><a href="#cb160-74" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rownames</span>(mean_shifts_fish_indiv) <span class="ot">&lt;-</span> <span class="fu">names</span>(diff_fish_scenario_indiv)</span>
<span id="cb160-75"><a href="#cb160-75" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb160-76"><a href="#cb160-76" aria-hidden="true" tabindex="-1"></a>        suitability_shifts_list[[<span class="fu">paste0</span>(<span class="st">"fish_env_only_"</span>, scenario_name_fut)]] <span class="ot">&lt;-</span> mean_shifts_fish_indiv</span>
<span id="cb160-77"><a href="#cb160-77" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"      Mean suitability shifts for anemonefish (combined) in"</span>, scenario_name_fut, <span class="st">"calculated.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-78"><a href="#cb160-78" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(head(mean_shifts_fish_indiv)) </span></span>
<span id="cb160-79"><a href="#cb160-79" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb160-80"><a href="#cb160-80" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb160-81"><a href="#cb160-81" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"      No common anemonefish species found between current and future stacks for scenario"</span>, scenario_name_fut, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-82"><a href="#cb160-82" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb160-83"><a href="#cb160-83" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb160-84"><a href="#cb160-84" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"    Skipping anemonefish (combined) for scenario"</span>, scenario_name_fut, <span class="st">"- current or future individual prediction stack missing or empty.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-85"><a href="#cb160-85" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb160-86"><a href="#cb160-86" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-87"><a href="#cb160-87" aria-hidden="true" tabindex="-1"></a>} <span class="co"># End loop through future scenarios</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
  Processing Scenario: ssp119_2050 
    Calculating shifts for Host Anemones...
      Mean suitability shifts for hosts in ssp119_2050 calculated.
    Calculating shifts for Anemonefish (Combined)...
      Mean suitability shifts for anemonefish (combined) in ssp119_2050 calculated.

  Processing Scenario: ssp119_2100 
    Calculating shifts for Host Anemones...
      Mean suitability shifts for hosts in ssp119_2100 calculated.
    Calculating shifts for Anemonefish (Combined)...
      Mean suitability shifts for anemonefish (combined) in ssp119_2100 calculated.

  Processing Scenario: ssp585_2050 
    Calculating shifts for Host Anemones...
      Mean suitability shifts for hosts in ssp585_2050 calculated.
    Calculating shifts for Anemonefish (Combined)...
      Mean suitability shifts for anemonefish (combined) in ssp585_2050 calculated.

  Processing Scenario: ssp585_2100 
    Calculating shifts for Host Anemones...
      Mean suitability shifts for hosts in ssp585_2100 calculated.
    Calculating shifts for Anemonefish (Combined)...
      Mean suitability shifts for anemonefish (combined) in ssp585_2100 calculated.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb162"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Individual species suitability shift calculations finished. ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Individual species suitability shift calculations finished. ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb164"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a>suitability_shifts_list</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$hosts_ssp119_2050
                                  mean
Entacmaea_quadricolor    -0.0025224455
Radianthus_crispa         0.0031421267
Radianthus_magnifica     -0.0012377732
Stichodactyla_gigantea    0.0007430928
Cryptodendrum_adhaesivum -0.0023126082
Macrodactyla_doreensis   -0.0009896069
Stichodactyla_mertensii   0.0054552807
Stichodactyla_haddoni    -0.0016663194
Radianthus_malu          -0.0048252268
Heteractis_aurora         0.0030785942

$fish_env_only_ssp119_2050
                                  mean
Amphiprion_clarkii        0.0057921728
Amphiprion_frenatus      -0.0026789599
Amphiprion_ocellaris      0.0084518673
Amphiprion_perideraion   -0.0031836799
Amphiprion_polymnus       0.0089754971
Amphiprion_sandaracinos   0.0169316775
Amphiprion_akallopisos    0.0026284685
Amphiprion_omanensis      0.0094764040
Amphiprion_akindynos     -0.0007346459
Amphiprion_allardi       -0.0023869898
Amphiprion_barberi       -0.0038256038
Amphiprion_bicinctus      0.0005709677
Amphiprion_chrysogaster   0.0019562390
Amphiprion_chrysopterus   0.0135454746
Amphiprion_ephippium      0.0061825280
Amphiprion_fuscocaudatus  0.0102334345
Amphiprion_latezonatus             NaN
Amphiprion_latifasciatus -0.0016338290
Amphiprion_leucokranos    0.0290571243
Amphiprion_melanopus     -0.0033470567
Amphiprion_nigripes      -0.0032653919
Amphiprion_percula       -0.0050822887
Amphiprion_rubrocinctus  -0.0034015361
Amphiprion_sebae          0.0043716725
Amphiprion_tricinctus     0.0049534951
Premnas_biaculeatus      -0.0024444900

$hosts_ssp119_2100
                                  mean
Entacmaea_quadricolor    -0.0025421505
Radianthus_crispa         0.0028652963
Radianthus_magnifica     -0.0009520958
Stichodactyla_gigantea    0.0007150268
Cryptodendrum_adhaesivum -0.0027163390
Macrodactyla_doreensis   -0.0006921525
Stichodactyla_mertensii   0.0055798617
Stichodactyla_haddoni    -0.0015846655
Radianthus_malu          -0.0054188334
Heteractis_aurora         0.0029733021

$fish_env_only_ssp119_2100
                                  mean
Amphiprion_clarkii        0.0059389709
Amphiprion_frenatus      -0.0022929005
Amphiprion_ocellaris      0.0085763745
Amphiprion_perideraion   -0.0028119914
Amphiprion_polymnus       0.0086557769
Amphiprion_sandaracinos   0.0168944018
Amphiprion_akallopisos    0.0030167373
Amphiprion_omanensis      0.0095938490
Amphiprion_akindynos     -0.0008487362
Amphiprion_allardi       -0.0023853057
Amphiprion_barberi       -0.0042474413
Amphiprion_bicinctus      0.0005935605
Amphiprion_chrysogaster   0.0024206230
Amphiprion_chrysopterus   0.0143875423
Amphiprion_ephippium      0.0063545152
Amphiprion_fuscocaudatus  0.0097671919
Amphiprion_latezonatus             NaN
Amphiprion_latifasciatus -0.0018177108
Amphiprion_leucokranos    0.0287658579
Amphiprion_melanopus     -0.0030823393
Amphiprion_nigripes      -0.0030745510
Amphiprion_percula       -0.0048866165
Amphiprion_rubrocinctus  -0.0034361559
Amphiprion_sebae          0.0046845902
Amphiprion_tricinctus     0.0052862021
Premnas_biaculeatus      -0.0023837457

$hosts_ssp585_2050
                                  mean
Entacmaea_quadricolor    -0.0026364227
Radianthus_crispa         0.0033319436
Radianthus_magnifica     -0.0014548349
Stichodactyla_gigantea    0.0007854103
Cryptodendrum_adhaesivum -0.0025075729
Macrodactyla_doreensis   -0.0012689969
Stichodactyla_mertensii   0.0056615059
Stichodactyla_haddoni    -0.0015474526
Radianthus_malu          -0.0047421360
Heteractis_aurora         0.0033568552

$fish_env_only_ssp585_2050
                                  mean
Amphiprion_clarkii        0.0061144707
Amphiprion_frenatus      -0.0022767068
Amphiprion_ocellaris      0.0088672697
Amphiprion_perideraion   -0.0033397792
Amphiprion_polymnus       0.0092780223
Amphiprion_sandaracinos   0.0172594669
Amphiprion_akallopisos    0.0024596748
Amphiprion_omanensis      0.0095573555
Amphiprion_akindynos     -0.0009054875
Amphiprion_allardi       -0.0024392072
Amphiprion_barberi       -0.0037663138
Amphiprion_bicinctus      0.0004910370
Amphiprion_chrysogaster   0.0017348091
Amphiprion_chrysopterus   0.0136606810
Amphiprion_ephippium      0.0062192434
Amphiprion_fuscocaudatus  0.0102748239
Amphiprion_latezonatus             NaN
Amphiprion_latifasciatus -0.0019761288
Amphiprion_leucokranos    0.0299114770
Amphiprion_melanopus     -0.0036808045
Amphiprion_nigripes      -0.0033368763
Amphiprion_percula       -0.0051971804
Amphiprion_rubrocinctus  -0.0034279796
Amphiprion_sebae          0.0047308817
Amphiprion_tricinctus     0.0050039712
Premnas_biaculeatus      -0.0026148235

$hosts_ssp585_2100
                                  mean
Entacmaea_quadricolor    -0.0022142096
Radianthus_crispa         0.0034431140
Radianthus_magnifica     -0.0007652718
Stichodactyla_gigantea    0.0015242355
Cryptodendrum_adhaesivum -0.0025538645
Macrodactyla_doreensis   -0.0011575960
Stichodactyla_mertensii   0.0064396508
Stichodactyla_haddoni     0.0002452402
Radianthus_malu          -0.0039415193
Heteractis_aurora         0.0036177870

$fish_env_only_ssp585_2100
                                  mean
Amphiprion_clarkii        0.0066586929
Amphiprion_frenatus      -0.0006243751
Amphiprion_ocellaris      0.0093639136
Amphiprion_perideraion   -0.0018158388
Amphiprion_polymnus       0.0094944935
Amphiprion_sandaracinos   0.0180557323
Amphiprion_akallopisos    0.0033660058
Amphiprion_omanensis      0.0083519577
Amphiprion_akindynos     -0.0012055295
Amphiprion_allardi       -0.0017311421
Amphiprion_barberi       -0.0026486402
Amphiprion_bicinctus      0.0006129325
Amphiprion_chrysogaster   0.0027686651
Amphiprion_chrysopterus   0.0146272423
Amphiprion_ephippium      0.0058953800
Amphiprion_fuscocaudatus  0.0070264177
Amphiprion_latezonatus             NaN
Amphiprion_latifasciatus -0.0019577743
Amphiprion_leucokranos    0.0295596687
Amphiprion_melanopus     -0.0019991344
Amphiprion_nigripes      -0.0028180928
Amphiprion_percula       -0.0028850489
Amphiprion_rubrocinctus  -0.0026442359
Amphiprion_sebae          0.0053393748
Amphiprion_tricinctus     0.0051437465
Premnas_biaculeatus      -0.0020280617</code></pre>
</div>
<div class="sourceCode cell-code" id="cb166"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The `suitability_shifts_list` object is now populated.</span></span>
<span id="cb166-2"><a href="#cb166-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Example access: suitability_shifts_list[["hosts_ssp119_2050"]]</span></span>
<span id="cb166-3"><a href="#cb166-3" aria-hidden="true" tabindex="-1"></a><span class="co"># It will contain data frames with rownames = species_name_sanitized and a column "mean" for the shift.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="plot-shifts" class="level1">
<h1>PLOT SHIFTS</h1>
<p>Plotting shifts</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb167"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb167-2"><a href="#cb167-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb167-3"><a href="#cb167-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb167-4"><a href="#cb167-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb167-5"><a href="#cb167-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-6"><a href="#cb167-6" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Generating plot for Mean Suitability Shifts ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Generating plot for Mean Suitability Shifts ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb169"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 1. Combine host and fish suitability shift data ---</span></span>
<span id="cb169-2"><a href="#cb169-2" aria-hidden="true" tabindex="-1"></a>all_shifts_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb169-3"><a href="#cb169-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-4"><a href="#cb169-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Process host shifts</span></span>
<span id="cb169-5"><a href="#cb169-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (scenario <span class="cf">in</span> <span class="fu">names</span>(suitability_shifts_list)[<span class="fu">grepl</span>(<span class="st">"^hosts_"</span>, <span class="fu">names</span>(suitability_shifts_list))]) {</span>
<span id="cb169-6"><a href="#cb169-6" aria-hidden="true" tabindex="-1"></a>  shift_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(suitability_shifts_list[[scenario]])</span>
<span id="cb169-7"><a href="#cb169-7" aria-hidden="true" tabindex="-1"></a>  shift_df<span class="sc">$</span>species <span class="ot">&lt;-</span> <span class="fu">rownames</span>(shift_df)</span>
<span id="cb169-8"><a href="#cb169-8" aria-hidden="true" tabindex="-1"></a>  shift_df<span class="sc">$</span>scenario_code <span class="ot">&lt;-</span> scenario</span>
<span id="cb169-9"><a href="#cb169-9" aria-hidden="true" tabindex="-1"></a>  shift_df<span class="sc">$</span>guild <span class="ot">&lt;-</span> <span class="st">"Host Anemones"</span></span>
<span id="cb169-10"><a href="#cb169-10" aria-hidden="true" tabindex="-1"></a>  all_shifts_df <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(all_shifts_df, shift_df)</span>
<span id="cb169-11"><a href="#cb169-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb169-12"><a href="#cb169-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-13"><a href="#cb169-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Process fish shifts</span></span>
<span id="cb169-14"><a href="#cb169-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (scenario <span class="cf">in</span> <span class="fu">names</span>(suitability_shifts_list)[<span class="fu">grepl</span>(<span class="st">"^fish_env_only_"</span>, <span class="fu">names</span>(suitability_shifts_list))]) {</span>
<span id="cb169-15"><a href="#cb169-15" aria-hidden="true" tabindex="-1"></a>  shift_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(suitability_shifts_list[[scenario]])</span>
<span id="cb169-16"><a href="#cb169-16" aria-hidden="true" tabindex="-1"></a>  shift_df<span class="sc">$</span>species <span class="ot">&lt;-</span> <span class="fu">rownames</span>(shift_df)</span>
<span id="cb169-17"><a href="#cb169-17" aria-hidden="true" tabindex="-1"></a>  shift_df<span class="sc">$</span>scenario_code <span class="ot">&lt;-</span> scenario</span>
<span id="cb169-18"><a href="#cb169-18" aria-hidden="true" tabindex="-1"></a>  shift_df<span class="sc">$</span>guild <span class="ot">&lt;-</span> <span class="st">"Anemonefish (Env-Only)"</span></span>
<span id="cb169-19"><a href="#cb169-19" aria-hidden="true" tabindex="-1"></a>  all_shifts_df <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(all_shifts_df, shift_df)</span>
<span id="cb169-20"><a href="#cb169-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb169-21"><a href="#cb169-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-22"><a href="#cb169-22" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 2. Clean and prepare data for plotting ---</span></span>
<span id="cb169-23"><a href="#cb169-23" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(all_shifts_df) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb169-24"><a href="#cb169-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add cleaner scenario labels for the plot</span></span>
<span id="cb169-25"><a href="#cb169-25" aria-hidden="true" tabindex="-1"></a>  all_shifts_df <span class="ot">&lt;-</span> all_shifts_df <span class="sc">%&gt;%</span></span>
<span id="cb169-26"><a href="#cb169-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb169-27"><a href="#cb169-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">scenario_display =</span> <span class="fu">str_replace</span>(scenario_code, <span class="st">"hosts_ssp119_2050"</span>, <span class="st">"SSP1-1.9 (2050)"</span>),</span>
<span id="cb169-28"><a href="#cb169-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">scenario_display =</span> <span class="fu">str_replace</span>(scenario_display, <span class="st">"hosts_ssp119_2100"</span>, <span class="st">"SSP1-1.9 (2100)"</span>),</span>
<span id="cb169-29"><a href="#cb169-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">scenario_display =</span> <span class="fu">str_replace</span>(scenario_display, <span class="st">"hosts_ssp585_2050"</span>, <span class="st">"SSP5-8.5 (2050)"</span>),</span>
<span id="cb169-30"><a href="#cb169-30" aria-hidden="true" tabindex="-1"></a>      <span class="at">scenario_display =</span> <span class="fu">str_replace</span>(scenario_display, <span class="st">"hosts_ssp585_2100"</span>, <span class="st">"SSP5-8.5 (2100)"</span>),</span>
<span id="cb169-31"><a href="#cb169-31" aria-hidden="true" tabindex="-1"></a>      <span class="at">scenario_display =</span> <span class="fu">str_replace</span>(scenario_display, <span class="st">"fish_env_only_ssp119_2050"</span>, <span class="st">"SSP1-1.9 (2050)"</span>),</span>
<span id="cb169-32"><a href="#cb169-32" aria-hidden="true" tabindex="-1"></a>      <span class="at">scenario_display =</span> <span class="fu">str_replace</span>(scenario_display, <span class="st">"fish_env_only_ssp119_2100"</span>, <span class="st">"SSP1-1.9 (2100)"</span>),</span>
<span id="cb169-33"><a href="#cb169-33" aria-hidden="true" tabindex="-1"></a>      <span class="at">scenario_display =</span> <span class="fu">str_replace</span>(scenario_display, <span class="st">"fish_env_only_ssp585_2050"</span>, <span class="st">"SSP5-8.5 (2050)"</span>),</span>
<span id="cb169-34"><a href="#cb169-34" aria-hidden="true" tabindex="-1"></a>      <span class="at">scenario_display =</span> <span class="fu">str_replace</span>(scenario_display, <span class="st">"fish_env_only_ssp585_2100"</span>, <span class="st">"SSP5-8.5 (2100)"</span>)</span>
<span id="cb169-35"><a href="#cb169-35" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb169-36"><a href="#cb169-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(mean)) <span class="co"># Remove any species where shift could not be calculated (e.g., NaN)</span></span>
<span id="cb169-37"><a href="#cb169-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-38"><a href="#cb169-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- 3. Generate the plot ---</span></span>
<span id="cb169-39"><a href="#cb169-39" aria-hidden="true" tabindex="-1"></a>  plot_mean_shifts <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(all_shifts_df, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(species, mean), <span class="at">y =</span> mean, <span class="at">fill =</span> guild)) <span class="sc">+</span></span>
<span id="cb169-40"><a href="#cb169-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">position =</span> <span class="st">"dodge"</span>) <span class="sc">+</span></span>
<span id="cb169-41"><a href="#cb169-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_flip</span>() <span class="sc">+</span> <span class="co"># Flip coordinates to make species names readable</span></span>
<span id="cb169-42"><a href="#cb169-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb169-43"><a href="#cb169-43" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Mean Projected Suitability Shifts for Individual Species"</span>,</span>
<span id="cb169-44"><a href="#cb169-44" aria-hidden="true" tabindex="-1"></a>      <span class="at">subtitle =</span> <span class="st">"Average change in suitability between future and current conditions"</span>,</span>
<span id="cb169-45"><a href="#cb169-45" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Species"</span>,</span>
<span id="cb169-46"><a href="#cb169-46" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"Mean Suitability Shift (Future - Current)"</span></span>
<span id="cb169-47"><a href="#cb169-47" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb169-48"><a href="#cb169-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span> scenario_display, <span class="at">ncol =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb169-49"><a href="#cb169-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Anemonefish (Env-Only)"</span> <span class="ot">=</span> <span class="st">"cornflowerblue"</span>, <span class="st">"Host Anemones"</span> <span class="ot">=</span> <span class="st">"darkorange"</span>)) <span class="sc">+</span></span>
<span id="cb169-50"><a href="#cb169-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb169-51"><a href="#cb169-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb169-52"><a href="#cb169-52" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">"top"</span>,</span>
<span id="cb169-53"><a href="#cb169-53" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"italic"</span>),</span>
<span id="cb169-54"><a href="#cb169-54" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.major.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb169-55"><a href="#cb169-55" aria-hidden="true" tabindex="-1"></a>      <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">10</span>)</span>
<span id="cb169-56"><a href="#cb169-56" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb169-57"><a href="#cb169-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-58"><a href="#cb169-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(plot_mean_shifts)</span>
<span id="cb169-59"><a href="#cb169-59" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb169-60"><a href="#cb169-60" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- 4. Save the plot ---</span></span>
<span id="cb169-61"><a href="#cb169-61" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"figure_output_dir"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">dir.exists</span>(figure_output_dir)) {</span>
<span id="cb169-62"><a href="#cb169-62" aria-hidden="true" tabindex="-1"></a>    plot_filename <span class="ot">&lt;-</span> <span class="fu">file.path</span>(figure_output_dir, <span class="st">"mean_suitability_shifts_by_species.png"</span>)</span>
<span id="cb169-63"><a href="#cb169-63" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggsave</span>(plot_filename, <span class="at">plot =</span> plot_mean_shifts, <span class="at">width =</span> <span class="dv">12</span>, <span class="at">height =</span> <span class="dv">8</span>, <span class="at">dpi =</span> <span class="dv">300</span>)</span>
<span id="cb169-64"><a href="#cb169-64" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Saved plot to:"</span>, plot_filename, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb169-65"><a href="#cb169-65" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb169-66"><a href="#cb169-66" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb169-67"><a href="#cb169-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Warning: Not enough data to generate mean suitability shifts plot.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb169-68"><a href="#cb169-68" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/plot-mean-suitability-shifts-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Saved plot to: /home/bi-server-kyoto/a0236995/sdm_anemonefish/figure_files/mean_suitability_shifts_by_species.png </code></pre>
</div>
</div>
<section id="quantifying-and-testing-mutualism-decoupling-hypothesis-3" class="level2">
<h2 class="anchored" data-anchor-id="quantifying-and-testing-mutualism-decoupling-hypothesis-3">Quantifying and Testing Mutualism Decoupling (Hypothesis 3)</h2>
<p>This script calculates the change in geographic overlap (Schoenerâ€™s D) between each anemonefish species and its hosts under future climate scenarios. It tests if the mutualism is at risk of spatial decoupling due to differential range shifts, and whether this effect varies by host specialization.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb171"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Niche Overlap Analysis for Hypothesis 3 ---</span></span>
<span id="cb171-2"><a href="#cb171-2" aria-hidden="true" tabindex="-1"></a><span class="co"># This section quantifies the change in niche overlap (Schoener's D) between</span></span>
<span id="cb171-3"><a href="#cb171-3" aria-hidden="true" tabindex="-1"></a><span class="co"># anemonefish and their hosts, and tests for a significant decrease over time.</span></span>
<span id="cb171-4"><a href="#cb171-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-5"><a href="#cb171-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb171-6"><a href="#cb171-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb171-7"><a href="#cb171-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb171-8"><a href="#cb171-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ENMTools) <span class="co"># For niche overlap metrics </span></span>
<span id="cb171-9"><a href="#cb171-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lmerTest) <span class="co"># For statistical testing</span></span>
<span id="cb171-10"><a href="#cb171-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)    <span class="co"># Ensure terra is loaded for global()</span></span>
<span id="cb171-11"><a href="#cb171-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-12"><a href="#cb171-12" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Niche Overlap Analysis for Hypothesis 3 ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Niche Overlap Analysis for Hypothesis 3 ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb173"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb173-1"><a href="#cb173-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 1. Load Host Associations &amp; Specialization Data ---</span></span>
<span id="cb173-2"><a href="#cb173-2" aria-hidden="true" tabindex="-1"></a><span class="co"># We'll use the same data preparation as in the specialization analysis section</span></span>
<span id="cb173-3"><a href="#cb173-3" aria-hidden="true" tabindex="-1"></a>association_file_path <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"processed_anemonefish_host_associations.csv"</span>)</span>
<span id="cb173-4"><a href="#cb173-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(association_file_path)) {</span>
<span id="cb173-5"><a href="#cb173-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"Anemonefish-host association file not found at: "</span>, association_file_path)</span>
<span id="cb173-6"><a href="#cb173-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb173-7"><a href="#cb173-7" aria-hidden="true" tabindex="-1"></a>host_associations_df <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(association_file_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb173-8"><a href="#cb173-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">AnemonefishScientificName =</span> <span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">"_"</span>, AnemonefishScientificName))</span>
<span id="cb173-9"><a href="#cb173-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-10"><a href="#cb173-10" aria-hidden="true" tabindex="-1"></a>anemonefish_host_counts <span class="ot">&lt;-</span> host_associations_df <span class="sc">%&gt;%</span></span>
<span id="cb173-11"><a href="#cb173-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(AnemonefishScientificName) <span class="sc">%&gt;%</span></span>
<span id="cb173-12"><a href="#cb173-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">n_hosts =</span> <span class="fu">n_distinct</span>(AssociatedAnemoneScientificName), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb173-13"><a href="#cb173-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-14"><a href="#cb173-14" aria-hidden="true" tabindex="-1"></a><span class="co"># We'll use the consistent threshold of &lt;=3 hosts for "Specialist"</span></span>
<span id="cb173-15"><a href="#cb173-15" aria-hidden="true" tabindex="-1"></a>anemonefish_specialization_df <span class="ot">&lt;-</span> anemonefish_host_counts <span class="sc">%&gt;%</span></span>
<span id="cb173-16"><a href="#cb173-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">specialization_type =</span> <span class="fu">factor</span>(<span class="fu">ifelse</span>(n_hosts <span class="sc">&lt;=</span> <span class="dv">3</span>, <span class="st">"Specialist"</span>, <span class="st">"Generalist"</span>),</span>
<span id="cb173-17"><a href="#cb173-17" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Generalist"</span>, <span class="st">"Specialist"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb173-18"><a href="#cb173-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">species =</span> AnemonefishScientificName)</span>
<span id="cb173-19"><a href="#cb173-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-20"><a href="#cb173-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a master list of all unique anemonefish-host pairs</span></span>
<span id="cb173-21"><a href="#cb173-21" aria-hidden="true" tabindex="-1"></a>all_anemonefish_host_pairs <span class="ot">&lt;-</span> host_associations_df <span class="sc">%&gt;%</span></span>
<span id="cb173-22"><a href="#cb173-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(anemonefish_specialization_df, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"AnemonefishScientificName"</span> <span class="ot">=</span> <span class="st">"species"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb173-23"><a href="#cb173-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">Anemonefish =</span> AnemonefishScientificName, <span class="at">HostAnemone =</span> AssociatedAnemoneScientificName) <span class="sc">%&gt;%</span></span>
<span id="cb173-24"><a href="#cb173-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(specialization_type))</span>
<span id="cb173-25"><a href="#cb173-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-26"><a href="#cb173-26" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Identified"</span>, <span class="fu">nrow</span>(all_anemonefish_host_pairs), <span class="st">"anemonefish-host pairs initially.</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Identified 77 anemonefish-host pairs initially.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb175"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 2. Filter pairs to include only species with valid model results ---</span></span>
<span id="cb175-2"><a href="#cb175-2" aria-hidden="true" tabindex="-1"></a><span class="co"># This is the critical step to prevent errors from missing files.</span></span>
<span id="cb175-3"><a href="#cb175-3" aria-hidden="true" tabindex="-1"></a><span class="co"># We'll get a list of species names that have corresponding raster files.</span></span>
<span id="cb175-4"><a href="#cb175-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-5"><a href="#cb175-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Define suffixes for models of interest</span></span>
<span id="cb175-6"><a href="#cb175-6" aria-hidden="true" tabindex="-1"></a>predictor_suffix_anemone_env <span class="ot">&lt;-</span> <span class="st">"_pca"</span></span>
<span id="cb175-7"><a href="#cb175-7" aria-hidden="true" tabindex="-1"></a>predictor_suffix_anemonefish_combined <span class="ot">&lt;-</span> <span class="st">"_combined_pca"</span></span>
<span id="cb175-8"><a href="#cb175-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-9"><a href="#cb175-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the list of species with available current combined model predictions</span></span>
<span id="cb175-10"><a href="#cb175-10" aria-hidden="true" tabindex="-1"></a>available_fish_species <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb175-11"><a href="#cb175-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (sp_name <span class="cf">in</span> <span class="fu">unique</span>(all_anemonefish_host_pairs<span class="sc">$</span>Anemonefish)) {</span>
<span id="cb175-12"><a href="#cb175-12" aria-hidden="true" tabindex="-1"></a>  pred_file_path <span class="ot">&lt;-</span> <span class="fu">construct_mean_prediction_filename</span>(</span>
<span id="cb175-13"><a href="#cb175-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">species_name_sanitized =</span> sp_name,</span>
<span id="cb175-14"><a href="#cb175-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">scenario_name =</span> <span class="st">"current"</span>,</span>
<span id="cb175-15"><a href="#cb175-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">predictor_type_suffix =</span> predictor_suffix_anemonefish_combined,</span>
<span id="cb175-16"><a href="#cb175-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">config =</span> config</span>
<span id="cb175-17"><a href="#cb175-17" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb175-18"><a href="#cb175-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">file.exists</span>(pred_file_path)) {</span>
<span id="cb175-19"><a href="#cb175-19" aria-hidden="true" tabindex="-1"></a>    available_fish_species <span class="ot">&lt;-</span> <span class="fu">c</span>(available_fish_species, sp_name)</span>
<span id="cb175-20"><a href="#cb175-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb175-21"><a href="#cb175-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb175-22"><a href="#cb175-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-23"><a href="#cb175-23" aria-hidden="true" tabindex="-1"></a>available_host_species <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb175-24"><a href="#cb175-24" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (sp_name <span class="cf">in</span> <span class="fu">unique</span>(all_anemonefish_host_pairs<span class="sc">$</span>HostAnemone)) {</span>
<span id="cb175-25"><a href="#cb175-25" aria-hidden="true" tabindex="-1"></a>  pred_file_path <span class="ot">&lt;-</span> <span class="fu">construct_mean_prediction_filename</span>(</span>
<span id="cb175-26"><a href="#cb175-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">species_name_sanitized =</span> <span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">"_"</span>, sp_name),</span>
<span id="cb175-27"><a href="#cb175-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">scenario_name =</span> <span class="st">"current"</span>,</span>
<span id="cb175-28"><a href="#cb175-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">predictor_type_suffix =</span> predictor_suffix_anemone_env,</span>
<span id="cb175-29"><a href="#cb175-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">config =</span> config</span>
<span id="cb175-30"><a href="#cb175-30" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb175-31"><a href="#cb175-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">file.exists</span>(pred_file_path)) {</span>
<span id="cb175-32"><a href="#cb175-32" aria-hidden="true" tabindex="-1"></a>    available_host_species <span class="ot">&lt;-</span> <span class="fu">c</span>(available_host_species, sp_name)</span>
<span id="cb175-33"><a href="#cb175-33" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb175-34"><a href="#cb175-34" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb175-35"><a href="#cb175-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-36"><a href="#cb175-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the list of pairs to only include pairs where both species have model files</span></span>
<span id="cb175-37"><a href="#cb175-37" aria-hidden="true" tabindex="-1"></a>filtered_anemonefish_host_pairs <span class="ot">&lt;-</span> all_anemonefish_host_pairs <span class="sc">%&gt;%</span></span>
<span id="cb175-38"><a href="#cb175-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Anemonefish <span class="sc">%in%</span> available_fish_species <span class="sc">&amp;</span> HostAnemone <span class="sc">%in%</span> available_host_species)</span>
<span id="cb175-39"><a href="#cb175-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-40"><a href="#cb175-40" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Found combined model predictions for"</span>, <span class="fu">length</span>(available_fish_species), <span class="st">"anemonefish species.</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Found combined model predictions for 26 anemonefish species.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb177"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Found environmental model predictions for"</span>, <span class="fu">length</span>(available_host_species), <span class="st">"host species.</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Found environmental model predictions for 9 host species.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb179"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Filtered down to"</span>, <span class="fu">nrow</span>(filtered_anemonefish_host_pairs), <span class="st">"pairs with available model predictions.</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Filtered down to 74 pairs with available model predictions.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb181"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb181-1"><a href="#cb181-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 3. Load Individual Species Prediction Rasters for all scenarios ---</span></span>
<span id="cb181-2"><a href="#cb181-2" aria-hidden="true" tabindex="-1"></a><span class="co"># We'll create the necessary raster stacks for the analysis from scratch,</span></span>
<span id="cb181-3"><a href="#cb181-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ensuring we have the right models for each guild.</span></span>
<span id="cb181-4"><a href="#cb181-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-5"><a href="#cb181-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Loading prediction rasters for overlap calculation... ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Loading prediction rasters for overlap calculation... ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb183"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb183-1"><a href="#cb183-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load current host predictions (Combined models)</span></span>
<span id="cb183-2"><a href="#cb183-2" aria-hidden="true" tabindex="-1"></a>current_host_rasters_paths <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">lapply</span>(</span>
<span id="cb183-3"><a href="#cb183-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>(filtered_anemonefish_host_pairs<span class="sc">$</span>HostAnemone),</span>
<span id="cb183-4"><a href="#cb183-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(sp_name) <span class="fu">construct_mean_prediction_filename</span>(<span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">"_"</span>, sp_name), <span class="st">"current"</span>, predictor_suffix_anemone_env, config)</span>
<span id="cb183-5"><a href="#cb183-5" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb183-6"><a href="#cb183-6" aria-hidden="true" tabindex="-1"></a>host_pred_stack_current <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(current_host_rasters_paths)</span>
<span id="cb183-7"><a href="#cb183-7" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(host_pred_stack_current) <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">"_"</span>, <span class="fu">unique</span>(filtered_anemonefish_host_pairs<span class="sc">$</span>HostAnemone))</span>
<span id="cb183-8"><a href="#cb183-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (config<span class="sc">$</span>apply_indo_pacific_crop) {</span>
<span id="cb183-9"><a href="#cb183-9" aria-hidden="true" tabindex="-1"></a>  ip_extent <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">ext</span>(config<span class="sc">$</span>indo_pacific_bbox)</span>
<span id="cb183-10"><a href="#cb183-10" aria-hidden="true" tabindex="-1"></a>  host_pred_stack_current <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">crop</span>(host_pred_stack_current, ip_extent)</span>
<span id="cb183-11"><a href="#cb183-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb183-12"><a href="#cb183-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-13"><a href="#cb183-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Load current anemonefish predictions (Combined models)</span></span>
<span id="cb183-14"><a href="#cb183-14" aria-hidden="true" tabindex="-1"></a>current_fish_rasters_paths <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">lapply</span>(</span>
<span id="cb183-15"><a href="#cb183-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>(filtered_anemonefish_host_pairs<span class="sc">$</span>Anemonefish),</span>
<span id="cb183-16"><a href="#cb183-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(sp_name) <span class="fu">construct_mean_prediction_filename</span>(sp_name, <span class="st">"current"</span>, predictor_suffix_anemonefish_combined, config)</span>
<span id="cb183-17"><a href="#cb183-17" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb183-18"><a href="#cb183-18" aria-hidden="true" tabindex="-1"></a>fish_pred_stack_current <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(current_fish_rasters_paths)</span>
<span id="cb183-19"><a href="#cb183-19" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(fish_pred_stack_current) <span class="ot">&lt;-</span> <span class="fu">unique</span>(filtered_anemonefish_host_pairs<span class="sc">$</span>Anemonefish)</span>
<span id="cb183-20"><a href="#cb183-20" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (config<span class="sc">$</span>apply_indo_pacific_crop) {</span>
<span id="cb183-21"><a href="#cb183-21" aria-hidden="true" tabindex="-1"></a>  ip_extent <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">ext</span>(config<span class="sc">$</span>indo_pacific_bbox)</span>
<span id="cb183-22"><a href="#cb183-22" aria-hidden="true" tabindex="-1"></a>  fish_pred_stack_current <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">crop</span>(fish_pred_stack_current, ip_extent)</span>
<span id="cb183-23"><a href="#cb183-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb183-24"><a href="#cb183-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-25"><a href="#cb183-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-26"><a href="#cb183-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Load future predictions (from previous chunks if they exist)</span></span>
<span id="cb183-27"><a href="#cb183-27" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"host_pred_stacks_future_individual"</span>) <span class="sc">||</span> <span class="sc">!</span><span class="fu">exists</span>(<span class="st">"fish_pred_stacks_future_individual"</span>)) {</span>
<span id="cb183-28"><a href="#cb183-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"Future individual prediction rasters not found. Please ensure the 'Load Future Individual Species Prediction Rasters' chunk ran successfully."</span>)</span>
<span id="cb183-29"><a href="#cb183-29" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb183-30"><a href="#cb183-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-31"><a href="#cb183-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-32"><a href="#cb183-32" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 4. Calculate Schoener's D Niche Overlap for all scenarios ---</span></span>
<span id="cb183-33"><a href="#cb183-33" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Calculating Schoener's D for all scenarios... This may take a while. ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Calculating Schoener's D for all scenarios... This may take a while. ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb185"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb185-1"><a href="#cb185-1" aria-hidden="true" tabindex="-1"></a>overlap_results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb185-2"><a href="#cb185-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb185-3"><a href="#cb185-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the full set of scenarios to loop through (current + future)</span></span>
<span id="cb185-4"><a href="#cb185-4" aria-hidden="true" tabindex="-1"></a>all_scenarios <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"current"</span>, <span class="fu">names</span>(host_pred_stacks_future_individual))</span>
<span id="cb185-5"><a href="#cb185-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb185-6"><a href="#cb185-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (scenario_name <span class="cf">in</span> all_scenarios) {</span>
<span id="cb185-7"><a href="#cb185-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"  Processing scenario:"</span>, scenario_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb185-8"><a href="#cb185-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb185-9"><a href="#cb185-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (scenario_name <span class="sc">==</span> <span class="st">"current"</span>) {</span>
<span id="cb185-10"><a href="#cb185-10" aria-hidden="true" tabindex="-1"></a>    host_stack <span class="ot">&lt;-</span> host_pred_stack_current</span>
<span id="cb185-11"><a href="#cb185-11" aria-hidden="true" tabindex="-1"></a>    fish_stack <span class="ot">&lt;-</span> fish_pred_stack_current</span>
<span id="cb185-12"><a href="#cb185-12" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb185-13"><a href="#cb185-13" aria-hidden="true" tabindex="-1"></a>    host_stack <span class="ot">&lt;-</span> host_pred_stacks_future_individual[[scenario_name]]</span>
<span id="cb185-14"><a href="#cb185-14" aria-hidden="true" tabindex="-1"></a>    fish_stack <span class="ot">&lt;-</span> fish_pred_stacks_future_individual[[scenario_name]]</span>
<span id="cb185-15"><a href="#cb185-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter the future stacks to match our list of species with valid models</span></span>
<span id="cb185-16"><a href="#cb185-16" aria-hidden="true" tabindex="-1"></a>    host_stack <span class="ot">&lt;-</span> host_stack[[<span class="fu">names</span>(host_stack) <span class="sc">%in%</span> <span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">"_"</span>, available_host_species)]]</span>
<span id="cb185-17"><a href="#cb185-17" aria-hidden="true" tabindex="-1"></a>    fish_stack <span class="ot">&lt;-</span> fish_stack[[<span class="fu">names</span>(fish_stack) <span class="sc">%in%</span> available_fish_species]]</span>
<span id="cb185-18"><a href="#cb185-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb185-19"><a href="#cb185-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb185-20"><a href="#cb185-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(host_stack) <span class="sc">||</span> <span class="fu">is.null</span>(fish_stack) <span class="sc">||</span> terra<span class="sc">::</span><span class="fu">nlyr</span>(host_stack) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">||</span> terra<span class="sc">::</span><span class="fu">nlyr</span>(fish_stack) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb185-21"><a href="#cb185-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"    Skipping scenario"</span>, scenario_name, <span class="st">"due to missing or filtered raster data.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb185-22"><a href="#cb185-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">next</span></span>
<span id="cb185-23"><a href="#cb185-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb185-24"><a href="#cb185-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb185-25"><a href="#cb185-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Now, loop through each *filtered* anemonefish-host pair to calculate overlap</span></span>
<span id="cb185-26"><a href="#cb185-26" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(filtered_anemonefish_host_pairs)) {</span>
<span id="cb185-27"><a href="#cb185-27" aria-hidden="true" tabindex="-1"></a>    fish_sp <span class="ot">&lt;-</span> filtered_anemonefish_host_pairs<span class="sc">$</span>Anemonefish[i]</span>
<span id="cb185-28"><a href="#cb185-28" aria-hidden="true" tabindex="-1"></a>    host_sp_original <span class="ot">&lt;-</span> filtered_anemonefish_host_pairs<span class="sc">$</span>HostAnemone[i]</span>
<span id="cb185-29"><a href="#cb185-29" aria-hidden="true" tabindex="-1"></a>    specialization <span class="ot">&lt;-</span> filtered_anemonefish_host_pairs<span class="sc">$</span>specialization_type[i]</span>
<span id="cb185-30"><a href="#cb185-30" aria-hidden="true" tabindex="-1"></a>    host_sp_sanitized <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">"_"</span>, host_sp_original)</span>
<span id="cb185-31"><a href="#cb185-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb185-32"><a href="#cb185-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if both species are in the raster stacks for this scenario</span></span>
<span id="cb185-33"><a href="#cb185-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (fish_sp <span class="sc">%in%</span> <span class="fu">names</span>(fish_stack) <span class="sc">&amp;&amp;</span> host_sp_sanitized <span class="sc">%in%</span> <span class="fu">names</span>(host_stack)) {</span>
<span id="cb185-34"><a href="#cb185-34" aria-hidden="true" tabindex="-1"></a>      fish_raster <span class="ot">&lt;-</span> fish_stack[[fish_sp]]</span>
<span id="cb185-35"><a href="#cb185-35" aria-hidden="true" tabindex="-1"></a>      host_raster <span class="ot">&lt;-</span> host_stack[[host_sp_sanitized]]</span>
<span id="cb185-36"><a href="#cb185-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb185-37"><a href="#cb185-37" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Safeguard to ensure both objects are valid SpatRasters before comparison</span></span>
<span id="cb185-38"><a href="#cb185-38" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">is.null</span>(fish_raster) <span class="sc">||</span> <span class="fu">is.null</span>(host_raster) <span class="sc">||</span> <span class="sc">!</span><span class="fu">inherits</span>(fish_raster, <span class="st">"SpatRaster"</span>) <span class="sc">||</span> <span class="sc">!</span><span class="fu">inherits</span>(host_raster, <span class="st">"SpatRaster"</span>)) {</span>
<span id="cb185-39"><a href="#cb185-39" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"    Warning: Skipping pair"</span>, fish_sp, <span class="st">"-"</span>, host_sp_original, <span class="st">"in"</span>, scenario_name, <span class="st">"due to an invalid raster object.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb185-40"><a href="#cb185-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">next</span></span>
<span id="cb185-41"><a href="#cb185-41" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb185-42"><a href="#cb185-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb185-43"><a href="#cb185-43" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Ensure rasters have the same extent and resolution for comparison</span></span>
<span id="cb185-44"><a href="#cb185-44" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span>terra<span class="sc">::</span><span class="fu">compareGeom</span>(fish_raster, host_raster)) {</span>
<span id="cb185-45"><a href="#cb185-45" aria-hidden="true" tabindex="-1"></a>        host_raster <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">resample</span>(host_raster, fish_raster, <span class="at">method =</span> <span class="st">"bilinear"</span>)</span>
<span id="cb185-46"><a href="#cb185-46" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb185-47"><a href="#cb185-47" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb185-48"><a href="#cb185-48" aria-hidden="true" tabindex="-1"></a>      sch_d <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb185-49"><a href="#cb185-49" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate max suitability to check for extinction</span></span>
<span id="cb185-50"><a href="#cb185-50" aria-hidden="true" tabindex="-1"></a>        fish_max <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">global</span>(fish_raster, <span class="st">"max"</span>, <span class="at">na.rm=</span><span class="cn">TRUE</span>)<span class="sc">$</span>max</span>
<span id="cb185-51"><a href="#cb185-51" aria-hidden="true" tabindex="-1"></a>        host_max <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">global</span>(host_raster, <span class="st">"max"</span>, <span class="at">na.rm=</span><span class="cn">TRUE</span>)<span class="sc">$</span>max</span>
<span id="cb185-52"><a href="#cb185-52" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb185-53"><a href="#cb185-53" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If either species is extinct (max suitability is 0 or NA), overlap is 0</span></span>
<span id="cb185-54"><a href="#cb185-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> ((<span class="sc">!</span><span class="fu">is.na</span>(fish_max) <span class="sc">&amp;&amp;</span> fish_max <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">||</span> (<span class="sc">!</span><span class="fu">is.na</span>(host_max) <span class="sc">&amp;&amp;</span> host_max <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">||</span> <span class="fu">is.na</span>(fish_max) <span class="sc">||</span> <span class="fu">is.na</span>(host_max)) {</span>
<span id="cb185-55"><a href="#cb185-55" aria-hidden="true" tabindex="-1"></a>          <span class="dv">0</span> </span>
<span id="cb185-56"><a href="#cb185-56" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb185-57"><a href="#cb185-57" aria-hidden="true" tabindex="-1"></a>          <span class="co"># Calculate overlap using ENMTools</span></span>
<span id="cb185-58"><a href="#cb185-58" aria-hidden="true" tabindex="-1"></a>          ENMTools<span class="sc">::</span><span class="fu">raster.overlap</span>(fish_raster, host_raster)<span class="sc">$</span>D</span>
<span id="cb185-59"><a href="#cb185-59" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb185-60"><a href="#cb185-60" aria-hidden="true" tabindex="-1"></a>      }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb185-61"><a href="#cb185-61" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If error occurs (likely due to one raster being effectively empty/all NA), return 0</span></span>
<span id="cb185-62"><a href="#cb185-62" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"    Note: Overlap calculation failed for"</span>, fish_sp, <span class="st">"and"</span>, host_sp_original, <span class="st">"in"</span>, scenario_name, <span class="st">"- assuming 0 overlap.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb185-63"><a href="#cb185-63" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="dv">0</span>)</span>
<span id="cb185-64"><a href="#cb185-64" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb185-65"><a href="#cb185-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb185-66"><a href="#cb185-66" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(sch_d)) {</span>
<span id="cb185-67"><a href="#cb185-67" aria-hidden="true" tabindex="-1"></a>        overlap_results <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(overlap_results, <span class="fu">data.frame</span>(</span>
<span id="cb185-68"><a href="#cb185-68" aria-hidden="true" tabindex="-1"></a>          <span class="at">scenario =</span> scenario_name,</span>
<span id="cb185-69"><a href="#cb185-69" aria-hidden="true" tabindex="-1"></a>          <span class="at">anemonefish_species =</span> fish_sp,</span>
<span id="cb185-70"><a href="#cb185-70" aria-hidden="true" tabindex="-1"></a>          <span class="at">host_species =</span> host_sp_original,</span>
<span id="cb185-71"><a href="#cb185-71" aria-hidden="true" tabindex="-1"></a>          <span class="at">specialization_type =</span> specialization,</span>
<span id="cb185-72"><a href="#cb185-72" aria-hidden="true" tabindex="-1"></a>          <span class="at">schoeners_d =</span> sch_d</span>
<span id="cb185-73"><a href="#cb185-73" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb185-74"><a href="#cb185-74" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb185-75"><a href="#cb185-75" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb185-76"><a href="#cb185-76" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"    Warning: Skipping pair"</span>, fish_sp, <span class="st">"-"</span>, host_sp_original, <span class="st">"in"</span>, scenario_name, <span class="st">"due to missing species raster.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb185-77"><a href="#cb185-77" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb185-78"><a href="#cb185-78" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb185-79"><a href="#cb185-79" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Processing scenario: current 
  Processing scenario: ssp119_2050 
  Processing scenario: ssp119_2100 
  Processing scenario: ssp585_2050 
  Processing scenario: ssp585_2100 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb187"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb187-1"><a href="#cb187-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 5. Summarize and Test for Significant Change in Overlap ---</span></span>
<span id="cb187-2"><a href="#cb187-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Summarizing Overlap Changes and Performing Statistical Tests ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Summarizing Overlap Changes and Performing Statistical Tests ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb189"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb189-1"><a href="#cb189-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(overlap_results) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb189-2"><a href="#cb189-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"No overlap data was calculated. Cannot proceed with analysis."</span>)</span>
<span id="cb189-3"><a href="#cb189-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb189-4"><a href="#cb189-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-5"><a href="#cb189-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Pivot the data to a wider format for easier comparison of current vs future</span></span>
<span id="cb189-6"><a href="#cb189-6" aria-hidden="true" tabindex="-1"></a>overlap_wide <span class="ot">&lt;-</span> overlap_results <span class="sc">%&gt;%</span></span>
<span id="cb189-7"><a href="#cb189-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> scenario, <span class="at">values_from =</span> schoeners_d)</span>
<span id="cb189-8"><a href="#cb189-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-9"><a href="#cb189-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the change in overlap (Delta D) for each future scenario</span></span>
<span id="cb189-10"><a href="#cb189-10" aria-hidden="true" tabindex="-1"></a>overlap_change_df <span class="ot">&lt;-</span> overlap_wide <span class="sc">%&gt;%</span></span>
<span id="cb189-11"><a href="#cb189-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb189-12"><a href="#cb189-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_D_ssp119_2050 =</span> ssp119_2050 <span class="sc">-</span> current,</span>
<span id="cb189-13"><a href="#cb189-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_D_ssp119_2100 =</span> ssp119_2100 <span class="sc">-</span> current,</span>
<span id="cb189-14"><a href="#cb189-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_D_ssp585_2050 =</span> ssp585_2050 <span class="sc">-</span> current,</span>
<span id="cb189-15"><a href="#cb189-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_D_ssp585_2100 =</span> ssp585_2100 <span class="sc">-</span> current</span>
<span id="cb189-16"><a href="#cb189-16" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb189-17"><a href="#cb189-17" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(anemonefish_species, host_species, specialization_type, <span class="fu">starts_with</span>(<span class="st">"delta_D"</span>))</span>
<span id="cb189-18"><a href="#cb189-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-19"><a href="#cb189-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Reshape back to long format for a single statistical model</span></span>
<span id="cb189-20"><a href="#cb189-20" aria-hidden="true" tabindex="-1"></a><span class="co"># We DO NOT filter out NAs here anymore to ensure extinction events (0 overlap) are counted</span></span>
<span id="cb189-21"><a href="#cb189-21" aria-hidden="true" tabindex="-1"></a>overlap_change_long <span class="ot">&lt;-</span> overlap_change_df <span class="sc">%&gt;%</span></span>
<span id="cb189-22"><a href="#cb189-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb189-23"><a href="#cb189-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">"delta_D"</span>),</span>
<span id="cb189-24"><a href="#cb189-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"scenario"</span>,</span>
<span id="cb189-25"><a href="#cb189-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"delta_D"</span></span>
<span id="cb189-26"><a href="#cb189-26" aria-hidden="true" tabindex="-1"></a>  ) </span>
<span id="cb189-27"><a href="#cb189-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-28"><a href="#cb189-28" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Paired t-test comparing current vs. future overlap ---</span></span>
<span id="cb189-29"><a href="#cb189-29" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Paired t-test comparing current vs. future overlap ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Paired t-test comparing current vs. future overlap ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb191"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We'll compare each future scenario to the current baseline</span></span>
<span id="cb191-2"><a href="#cb191-2" aria-hidden="true" tabindex="-1"></a><span class="co"># The names of your future scenario columns should be "ssp119_2050", "ssp119_2100", etc.</span></span>
<span id="cb191-3"><a href="#cb191-3" aria-hidden="true" tabindex="-1"></a>future_scenario_columns <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"ssp119_2050"</span>, <span class="st">"ssp119_2100"</span>, <span class="st">"ssp585_2050"</span>, <span class="st">"ssp585_2100"</span>)</span>
<span id="cb191-4"><a href="#cb191-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-5"><a href="#cb191-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (scen_name <span class="cf">in</span> future_scenario_columns) {</span>
<span id="cb191-6"><a href="#cb191-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (scen_name <span class="sc">%in%</span> <span class="fu">names</span>(overlap_wide)) {</span>
<span id="cb191-7"><a href="#cb191-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure both columns have data for the paired test</span></span>
<span id="cb191-8"><a href="#cb191-8" aria-hidden="true" tabindex="-1"></a>    test_data <span class="ot">&lt;-</span> overlap_wide <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(current) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(.data[[scen_name]]))</span>
<span id="cb191-9"><a href="#cb191-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb191-10"><a href="#cb191-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">nrow</span>(test_data) <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb191-11"><a href="#cb191-11" aria-hidden="true" tabindex="-1"></a>      test_result <span class="ot">&lt;-</span> <span class="fu">t.test</span>(test_data<span class="sc">$</span>current, test_data[[scen_name]], <span class="at">paired =</span> <span class="cn">TRUE</span>)</span>
<span id="cb191-12"><a href="#cb191-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Paired t-test for"</span>, scen_name, <span class="st">"vs. Current:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb191-13"><a href="#cb191-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(test_result)</span>
<span id="cb191-14"><a href="#cb191-14" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb191-15"><a href="#cb191-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Skipping t-test for"</span>, scen_name, <span class="st">"due to insufficient data.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb191-16"><a href="#cb191-16" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb191-17"><a href="#cb191-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb191-18"><a href="#cb191-18" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Paired t-test for ssp119_2050 vs. Current:

    Paired t-test

data:  test_data$current and test_data[[scen_name]]
t = 1.8299, df = 73, p-value = 0.07135
alternative hypothesis: true mean difference is not equal to 0
95 percent confidence interval:
 -0.0003469831  0.0081312630
sample estimates:
mean difference 
     0.00389214 


Paired t-test for ssp119_2100 vs. Current:

    Paired t-test

data:  test_data$current and test_data[[scen_name]]
t = 2.0492, df = 73, p-value = 0.04404
alternative hypothesis: true mean difference is not equal to 0
95 percent confidence interval:
 0.0001162031 0.0083605766
sample estimates:
mean difference 
     0.00423839 


Paired t-test for ssp585_2050 vs. Current:

    Paired t-test

data:  test_data$current and test_data[[scen_name]]
t = 1.6879, df = 73, p-value = 0.0957
alternative hypothesis: true mean difference is not equal to 0
95 percent confidence interval:
 -0.0006758702  0.0081534416
sample estimates:
mean difference 
    0.003738786 


Paired t-test for ssp585_2100 vs. Current:

    Paired t-test

data:  test_data$current and test_data[[scen_name]]
t = 1.598, df = 73, p-value = 0.1144
alternative hypothesis: true mean difference is not equal to 0
95 percent confidence interval:
 -0.0007388884  0.0067181540
sample estimates:
mean difference 
    0.002989633 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb193"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Test for interaction with specialization (Hypothesis 2, revisited)</span></span>
<span id="cb193-2"><a href="#cb193-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- LMM to test if specialization affects overlap change ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- LMM to test if specialization affects overlap change ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb195"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">nrow</span>(overlap_change_long) <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(<span class="fu">unique</span>(overlap_change_long<span class="sc">$</span>specialization_type)) <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb195-2"><a href="#cb195-2" aria-hidden="true" tabindex="-1"></a>  lmm_overlap_change <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb195-3"><a href="#cb195-3" aria-hidden="true" tabindex="-1"></a>    lmerTest<span class="sc">::</span><span class="fu">lmer</span>(delta_D <span class="sc">~</span> specialization_type <span class="sc">*</span> scenario <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> anemonefish_species), <span class="at">data =</span> overlap_change_long)</span>
<span id="cb195-4"><a href="#cb195-4" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb195-5"><a href="#cb195-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Error fitting LMM for overlap change:"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>); <span class="cn">NULL</span></span>
<span id="cb195-6"><a href="#cb195-6" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb195-7"><a href="#cb195-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb195-8"><a href="#cb195-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(lmm_overlap_change)) {</span>
<span id="cb195-9"><a href="#cb195-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">summary</span>(lmm_overlap_change))</span>
<span id="cb195-10"><a href="#cb195-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb195-11"><a href="#cb195-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save the summary table</span></span>
<span id="cb195-12"><a href="#cb195-12" aria-hidden="true" tabindex="-1"></a>    summary_table_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(config<span class="sc">$</span>base_dir, <span class="st">"outputs_for_analysis"</span>, <span class="st">"schoeners_d_lmm_summary.csv"</span>)</span>
<span id="cb195-13"><a href="#cb195-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write.csv</span>(<span class="fu">as.data.frame</span>(<span class="fu">summary</span>(lmm_overlap_change)<span class="sc">$</span>coefficients), summary_table_path, <span class="at">row.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb195-14"><a href="#cb195-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Saved LMM summary for overlap change to:"</span>, summary_table_path, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb195-15"><a href="#cb195-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb195-16"><a href="#cb195-16" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb195-17"><a href="#cb195-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Skipping LMM as data is insufficient or only one specialization type is present.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb195-18"><a href="#cb195-18" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML. t-tests use Satterthwaite's method [
lmerModLmerTest]
Formula: delta_D ~ specialization_type * scenario + (1 | anemonefish_species)
   Data: overlap_change_long

REML criterion at convergence: -1523

Scaled residuals: 
     Min       1Q   Median       3Q      Max 
-2.34658 -0.55746  0.01345  0.54114  2.74423 

Random effects:
 Groups              Name        Variance  Std.Dev.
 anemonefish_species (Intercept) 9.438e-05 0.009715
 Residual                        2.348e-04 0.015323
Number of obs: 296, groups:  anemonefish_species, 26

Fixed effects:
                                                            Estimate Std. Error
(Intercept)                                               -3.713e-03  4.771e-03
specialization_typeSpecialist                              9.215e-05  5.796e-03
scenariodelta_D_ssp119_2100                               -8.044e-04  3.716e-03
scenariodelta_D_ssp585_2050                                2.855e-04  3.716e-03
scenariodelta_D_ssp585_2100                                1.248e-03  3.716e-03
specialization_typeSpecialist:scenariodelta_D_ssp119_2100  8.476e-04  5.055e-03
specialization_typeSpecialist:scenariodelta_D_ssp585_2050 -2.444e-04  5.055e-03
specialization_typeSpecialist:scenariodelta_D_ssp585_2100 -6.386e-04  5.055e-03
                                                                  df t value
(Intercept)                                                3.003e+01  -0.778
specialization_typeSpecialist                              3.824e+01   0.016
scenariodelta_D_ssp119_2100                                2.644e+02  -0.216
scenariodelta_D_ssp585_2050                                2.644e+02   0.077
scenariodelta_D_ssp585_2100                                2.644e+02   0.336
specialization_typeSpecialist:scenariodelta_D_ssp119_2100  2.644e+02   0.168
specialization_typeSpecialist:scenariodelta_D_ssp585_2050  2.644e+02  -0.048
specialization_typeSpecialist:scenariodelta_D_ssp585_2100  2.644e+02  -0.126
                                                          Pr(&gt;|t|)
(Intercept)                                                  0.442
specialization_typeSpecialist                                0.987
scenariodelta_D_ssp119_2100                                  0.829
scenariodelta_D_ssp585_2050                                  0.939
scenariodelta_D_ssp585_2100                                  0.737
specialization_typeSpecialist:scenariodelta_D_ssp119_2100    0.867
specialization_typeSpecialist:scenariodelta_D_ssp585_2050    0.961
specialization_typeSpecialist:scenariodelta_D_ssp585_2100    0.900

Correlation of Fixed Effects:
              (Intr) spcl_S s_D_11 s_D_585_20 s_D_585_21 s_S:_D_1 s_S:_D_585_20
spclztn_tyS   -0.823                                                           
s_D_119_210   -0.389  0.321                                                    
s_D_585_205   -0.389  0.321  0.500                                             
s_D_585_210   -0.389  0.321  0.500  0.500                                      
s_S:_D_119_    0.286 -0.436 -0.735 -0.368     -0.368                           
s_S:_D_585_20  0.286 -0.436 -0.368 -0.735     -0.368      0.500                
s_S:_D_585_21  0.286 -0.436 -0.368 -0.368     -0.735      0.500    0.500       
Saved LMM summary for overlap change to: /home/bi-server-kyoto/a0236995/sdm_anemonefish/outputs_for_analysis/schoeners_d_lmm_summary.csv </code></pre>
</div>
<div class="sourceCode cell-code" id="cb197"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb197-1"><a href="#cb197-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Niche overlap analysis finished. ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Niche overlap analysis finished. ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb199"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb199-1"><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 5. Analysis of Response Heterogeneity (Variance of Delta D) ---</span></span>
<span id="cb199-2"><a href="#cb199-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Analyzing Variance of Overlap Change (Non-Linear Response) ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Analyzing Variance of Overlap Change (Non-Linear Response) ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb201"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb201-1"><a href="#cb201-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(car)</span>
<span id="cb201-2"><a href="#cb201-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb201-3"><a href="#cb201-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb201-4"><a href="#cb201-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb201-5"><a href="#cb201-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-6"><a href="#cb201-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Prepare Data: Calculate Delta D for all pairs</span></span>
<span id="cb201-7"><a href="#cb201-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Assumption: 'overlap_wide' exists from previous chunk (rows=pairs, cols=scenarios)</span></span>
<span id="cb201-8"><a href="#cb201-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"overlap_wide"</span>)) <span class="fu">stop</span>(<span class="st">"overlap_wide dataframe missing."</span>)</span>
<span id="cb201-9"><a href="#cb201-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-10"><a href="#cb201-10" aria-hidden="true" tabindex="-1"></a>delta_df <span class="ot">&lt;-</span> overlap_wide <span class="sc">%&gt;%</span></span>
<span id="cb201-11"><a href="#cb201-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb201-12"><a href="#cb201-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">Delta_SSP119_2050 =</span> ssp119_2050 <span class="sc">-</span> current,</span>
<span id="cb201-13"><a href="#cb201-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">Delta_SSP119_2100 =</span> ssp119_2100 <span class="sc">-</span> current,</span>
<span id="cb201-14"><a href="#cb201-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">Delta_SSP585_2050 =</span> ssp585_2050 <span class="sc">-</span> current,</span>
<span id="cb201-15"><a href="#cb201-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">Delta_SSP585_2100 =</span> ssp585_2100 <span class="sc">-</span> current</span>
<span id="cb201-16"><a href="#cb201-16" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb201-17"><a href="#cb201-17" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(anemonefish_species, host_species, <span class="fu">starts_with</span>(<span class="st">"Delta_"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb201-18"><a href="#cb201-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">"Delta_"</span>), </span>
<span id="cb201-19"><a href="#cb201-19" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"Scenario"</span>, </span>
<span id="cb201-20"><a href="#cb201-20" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"Change_in_Overlap"</span>)</span>
<span id="cb201-21"><a href="#cb201-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-22"><a href="#cb201-22" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Calculate Variance Statistics</span></span>
<span id="cb201-23"><a href="#cb201-23" aria-hidden="true" tabindex="-1"></a>variance_table <span class="ot">&lt;-</span> delta_df <span class="sc">%&gt;%</span></span>
<span id="cb201-24"><a href="#cb201-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Scenario) <span class="sc">%&gt;%</span></span>
<span id="cb201-25"><a href="#cb201-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb201-26"><a href="#cb201-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">Mean_Change =</span> <span class="fu">mean</span>(Change_in_Overlap, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb201-27"><a href="#cb201-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">Variance =</span> <span class="fu">var</span>(Change_in_Overlap, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb201-28"><a href="#cb201-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">SD =</span> <span class="fu">sd</span>(Change_in_Overlap, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb201-29"><a href="#cb201-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">Min =</span> <span class="fu">min</span>(Change_in_Overlap, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb201-30"><a href="#cb201-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">Max =</span> <span class="fu">max</span>(Change_in_Overlap, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb201-31"><a href="#cb201-31" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb201-32"><a href="#cb201-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-33"><a href="#cb201-33" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(knitr<span class="sc">::</span><span class="fu">kable</span>(variance_table, <span class="at">caption =</span> <span class="st">"Descriptive Statistics of Overlap Change"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>

Table: Descriptive Statistics of Overlap Change

|Scenario          | Mean_Change|  Variance|        SD|        Min|       Max|
|:-----------------|-----------:|---------:|---------:|----------:|---------:|
|Delta_SSP119_2050 |  -0.0038921| 0.0003348| 0.0182972| -0.0431225| 0.0391967|
|Delta_SSP119_2100 |  -0.0042384| 0.0003166| 0.0177925| -0.0423838| 0.0372943|
|Delta_SSP585_2050 |  -0.0037388| 0.0003631| 0.0190549| -0.0436317| 0.0412901|
|Delta_SSP585_2100 |  -0.0029896| 0.0002590| 0.0160933| -0.0373330| 0.0313982|</code></pre>
</div>
<div class="sourceCode cell-code" id="cb203"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb203-1"><a href="#cb203-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Statistical Test: Levene's Test for Homogeneity of Variance</span></span>
<span id="cb203-2"><a href="#cb203-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Comparing End-of-Century Scenarios (SSP1-1.9 vs SSP5-8.5)</span></span>
<span id="cb203-3"><a href="#cb203-3" aria-hidden="true" tabindex="-1"></a>delta_2100 <span class="ot">&lt;-</span> delta_df <span class="sc">%&gt;%</span> </span>
<span id="cb203-4"><a href="#cb203-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Scenario <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Delta_SSP119_2100"</span>, <span class="st">"Delta_SSP585_2100"</span>))</span>
<span id="cb203-5"><a href="#cb203-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb203-6"><a href="#cb203-6" aria-hidden="true" tabindex="-1"></a>levene_res <span class="ot">&lt;-</span> car<span class="sc">::</span><span class="fu">leveneTest</span>(Change_in_Overlap <span class="sc">~</span> Scenario, <span class="at">data =</span> delta_2100)</span>
<span id="cb203-7"><a href="#cb203-7" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Levene's Test for Homogeneity of Variance (2100 Scenarios):</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Levene's Test for Homogeneity of Variance (2100 Scenarios):</code></pre>
</div>
<div class="sourceCode cell-code" id="cb205"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb205-1"><a href="#cb205-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(levene_res)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Levene's Test for Homogeneity of Variance (center = median)
       Df F value Pr(&gt;F)
group   1  1.2965 0.2567
      146               </code></pre>
</div>
<div class="sourceCode cell-code" id="cb207"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb207-1"><a href="#cb207-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Visualization: Density Plot</span></span>
<span id="cb207-2"><a href="#cb207-2" aria-hidden="true" tabindex="-1"></a><span class="co"># This visualizes the 'spread' or chaos of the response</span></span>
<span id="cb207-3"><a href="#cb207-3" aria-hidden="true" tabindex="-1"></a>p_var <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(delta_df, <span class="fu">aes</span>(<span class="at">x =</span> Change_in_Overlap, <span class="at">fill =</span> Scenario)) <span class="sc">+</span></span>
<span id="cb207-4"><a href="#cb207-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb207-5"><a href="#cb207-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb207-6"><a href="#cb207-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Dark2"</span>) <span class="sc">+</span></span>
<span id="cb207-7"><a href="#cb207-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb207-8"><a href="#cb207-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Distribution of Niche Overlap Change"</span>,</span>
<span id="cb207-9"><a href="#cb207-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Broader curves indicate higher variability (destabilization) in guild response"</span>,</span>
<span id="cb207-10"><a href="#cb207-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Change in Schoener's D (Future - Current)"</span>,</span>
<span id="cb207-11"><a href="#cb207-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Density"</span></span>
<span id="cb207-12"><a href="#cb207-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb207-13"><a href="#cb207-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb207-14"><a href="#cb207-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span>
<span id="cb207-15"><a href="#cb207-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb207-16"><a href="#cb207-16" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(p_var)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/sch-d-overlap-analysis-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb208"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb208-1"><a href="#cb208-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"figure_output_dir"</span>)) {</span>
<span id="cb208-2"><a href="#cb208-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="fu">file.path</span>(figure_output_dir, <span class="st">"variance_overlap_density.png"</span>), p_var, <span class="at">width =</span> <span class="dv">8</span>, <span class="at">height =</span> <span class="dv">6</span>)</span>
<span id="cb208-3"><a href="#cb208-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="niche-overlap-change-histogram" class="level2">
<h2 class="anchored" data-anchor-id="niche-overlap-change-histogram">Niche Overlap Change Histogram</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb209"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb209-1"><a href="#cb209-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb209-2"><a href="#cb209-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb209-3"><a href="#cb209-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb209-4"><a href="#cb209-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb209-5"><a href="#cb209-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Generating Distribution of Overlap Changes (Sanity Check) ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Generating Distribution of Overlap Changes (Sanity Check) ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb211"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb211-1"><a href="#cb211-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure overlap_wide is available from the previous chunk</span></span>
<span id="cb211-2"><a href="#cb211-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"overlap_wide"</span>) <span class="sc">||</span> <span class="fu">is.null</span>(overlap_wide)) {</span>
<span id="cb211-3"><a href="#cb211-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"`overlap_wide` not found. Run 'sch-d-overlap-analysis' chunk first."</span>)</span>
<span id="cb211-4"><a href="#cb211-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb211-5"><a href="#cb211-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-6"><a href="#cb211-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate deltas (Current - Future)</span></span>
<span id="cb211-7"><a href="#cb211-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: A negative result here means Future &lt; Current (Loss of Overlap)</span></span>
<span id="cb211-8"><a href="#cb211-8" aria-hidden="true" tabindex="-1"></a>plot_data_hist <span class="ot">&lt;-</span> overlap_wide <span class="sc">%&gt;%</span></span>
<span id="cb211-9"><a href="#cb211-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb211-10"><a href="#cb211-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_SSP119_2100 =</span> ssp119_2100 <span class="sc">-</span> current,</span>
<span id="cb211-11"><a href="#cb211-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_SSP585_2100 =</span> ssp585_2100 <span class="sc">-</span> current</span>
<span id="cb211-12"><a href="#cb211-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb211-13"><a href="#cb211-13" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(anemonefish_species, host_species, delta_SSP119_2100, delta_SSP585_2100) <span class="sc">%&gt;%</span></span>
<span id="cb211-14"><a href="#cb211-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">"delta"</span>), <span class="at">names_to =</span> <span class="st">"Scenario_Raw"</span>, <span class="at">values_to =</span> <span class="st">"Delta_D"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb211-15"><a href="#cb211-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb211-16"><a href="#cb211-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">Scenario =</span> <span class="fu">case_when</span>(</span>
<span id="cb211-17"><a href="#cb211-17" aria-hidden="true" tabindex="-1"></a>      Scenario_Raw <span class="sc">==</span> <span class="st">"delta_SSP119_2100"</span> <span class="sc">~</span> <span class="st">"SSP1-1.9 (2100) - Low Emission"</span>,</span>
<span id="cb211-18"><a href="#cb211-18" aria-hidden="true" tabindex="-1"></a>      Scenario_Raw <span class="sc">==</span> <span class="st">"delta_SSP585_2100"</span> <span class="sc">~</span> <span class="st">"SSP5-8.5 (2100) - High Emission"</span></span>
<span id="cb211-19"><a href="#cb211-19" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb211-20"><a href="#cb211-20" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb211-21"><a href="#cb211-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-22"><a href="#cb211-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the histogram</span></span>
<span id="cb211-23"><a href="#cb211-23" aria-hidden="true" tabindex="-1"></a>hist_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(plot_data_hist, <span class="fu">aes</span>(<span class="at">x =</span> Delta_D, <span class="at">fill =</span> Scenario)) <span class="sc">+</span></span>
<span id="cb211-24"><a href="#cb211-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">alpha =</span> <span class="fl">0.7</span>, <span class="at">position =</span> <span class="st">"identity"</span>, <span class="at">bins =</span> <span class="dv">30</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb211-25"><a href="#cb211-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"grey30"</span>) <span class="sc">+</span></span>
<span id="cb211-26"><a href="#cb211-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>Scenario, <span class="at">ncol =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb211-27"><a href="#cb211-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"SSP1-1.9 (2100) - Low Emission"</span> <span class="ot">=</span> <span class="st">"forestgreen"</span>, </span>
<span id="cb211-28"><a href="#cb211-28" aria-hidden="true" tabindex="-1"></a>                               <span class="st">"SSP5-8.5 (2100) - High Emission"</span> <span class="ot">=</span> <span class="st">"firebrick"</span>)) <span class="sc">+</span></span>
<span id="cb211-29"><a href="#cb211-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb211-30"><a href="#cb211-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Distribution of Changes in Niche Overlap (Future - Current)"</span>,</span>
<span id="cb211-31"><a href="#cb211-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Low emissions show consistent slight decline; High emissions show high variance."</span>,</span>
<span id="cb211-32"><a href="#cb211-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Change in Schoener's D (Negative = Loss of Overlap)"</span>,</span>
<span id="cb211-33"><a href="#cb211-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Frequency (Number of Pairs)"</span></span>
<span id="cb211-34"><a href="#cb211-34" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb211-35"><a href="#cb211-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb211-36"><a href="#cb211-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>,</span>
<span id="cb211-37"><a href="#cb211-37" aria-hidden="true" tabindex="-1"></a>        <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">11</span>))</span>
<span id="cb211-38"><a href="#cb211-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-39"><a href="#cb211-39" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(hist_plot)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/overlap-change-histogram-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb212"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb212-1"><a href="#cb212-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the plot</span></span>
<span id="cb212-2"><a href="#cb212-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"figure_output_dir"</span>)) {</span>
<span id="cb212-3"><a href="#cb212-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="fu">file.path</span>(figure_output_dir, <span class="st">"Figure7_Overlap_Change_Histogram.png"</span>), </span>
<span id="cb212-4"><a href="#cb212-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">plot =</span> hist_plot, <span class="at">width =</span> <span class="dv">8</span>, <span class="at">height =</span> <span class="dv">6</span>, <span class="at">dpi =</span> <span class="dv">300</span>)</span>
<span id="cb212-5"><a href="#cb212-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Saved histogram to Figure7_Overlap_Change_Histogram.png</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb212-6"><a href="#cb212-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Saved histogram to Figure7_Overlap_Change_Histogram.png</code></pre>
</div>
</div>
</section>
<section id="relationship-between-host-and-anemonefish-richness-current" class="level2">
<h2 class="anchored" data-anchor-id="relationship-between-host-and-anemonefish-richness-current">Relationship between Host and Anemonefish Richness (Current)</h2>
<p>This section explores the relationship between the current predicted richness of host sea anemones and their mutualistic anemonefish (based on environmental-only models). We use variance partitioning to determine the independent and shared contributions of host richness and environmental factors (PCA components) to anemonefish richness.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb214"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb214-1"><a href="#cb214-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ADD NEW SAMPLING SACK HERE</span></span>
<span id="cb214-2"><a href="#cb214-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-3"><a href="#cb214-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-4"><a href="#cb214-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-5"><a href="#cb214-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-6"><a href="#cb214-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-7"><a href="#cb214-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-8"><a href="#cb214-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-9"><a href="#cb214-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(vegan) <span class="co"># For varpart and rda/anova.cca</span></span>
<span id="cb214-10"><a href="#cb214-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb214-11"><a href="#cb214-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)</span>
<span id="cb214-12"><a href="#cb214-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-13"><a href="#cb214-13" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.null</span>(host_richness_sum_cropped) <span class="sc">||</span> <span class="fu">is.null</span>(fish_richness_sum_cropped) <span class="sc">||</span> </span>
<span id="cb214-14"><a href="#cb214-14" aria-hidden="true" tabindex="-1"></a>    (config<span class="sc">$</span>use_pca_predictors <span class="sc">&amp;&amp;</span> <span class="fu">is.null</span>(env_pca_current_cropped))) {</span>
<span id="cb214-15"><a href="#cb214-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Warning: Necessary raster data is missing. Skipping variance partitioning.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb214-16"><a href="#cb214-16" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb214-17"><a href="#cb214-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"--- Preparing Data for Variance Partitioning ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb214-18"><a href="#cb214-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb214-19"><a href="#cb214-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- 1. Align and Stack Raster Layers ---</span></span>
<span id="cb214-20"><a href="#cb214-20" aria-hidden="true" tabindex="-1"></a>  layers_for_sampling <span class="ot">&lt;-</span> <span class="fu">c</span>(host_richness_sum_cropped, fish_richness_sum_cropped)</span>
<span id="cb214-21"><a href="#cb214-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb214-22"><a href="#cb214-22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (config<span class="sc">$</span>use_pca_predictors <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">is.null</span>(env_pca_current_cropped)) {</span>
<span id="cb214-23"><a href="#cb214-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Resample PCA layers if their geometry doesn't match the richness rasters</span></span>
<span id="cb214-24"><a href="#cb214-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span>terra<span class="sc">::</span><span class="fu">compareGeom</span>(layers_for_sampling[[<span class="dv">1</span>]], env_pca_current_cropped[[<span class="dv">1</span>]], <span class="at">stopOnError=</span><span class="cn">FALSE</span>)) {</span>
<span id="cb214-25"><a href="#cb214-25" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"  Resampling current PCA environmental layers to match richness map geometry...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb214-26"><a href="#cb214-26" aria-hidden="true" tabindex="-1"></a>      env_pca_current_for_sampling <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">resample</span>(env_pca_current_cropped, layers_for_sampling[[<span class="dv">1</span>]], <span class="at">method=</span><span class="st">"bilinear"</span>)</span>
<span id="cb214-27"><a href="#cb214-27" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb214-28"><a href="#cb214-28" aria-hidden="true" tabindex="-1"></a>      env_pca_current_for_sampling <span class="ot">&lt;-</span> env_pca_current_cropped</span>
<span id="cb214-29"><a href="#cb214-29" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb214-30"><a href="#cb214-30" aria-hidden="true" tabindex="-1"></a>    layers_for_sampling <span class="ot">&lt;-</span> <span class="fu">c</span>(layers_for_sampling, env_pca_current_for_sampling[[<span class="dv">1</span><span class="sc">:</span>config<span class="sc">$</span>n_pca_components]])</span>
<span id="cb214-31"><a href="#cb214-31" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb214-32"><a href="#cb214-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb214-33"><a href="#cb214-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Rename layers for clarity</span></span>
<span id="cb214-34"><a href="#cb214-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(layers_for_sampling)[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="st">"HostRichness"</span></span>
<span id="cb214-35"><a href="#cb214-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(layers_for_sampling)[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="st">"AnemonefishRichness"</span></span>
<span id="cb214-36"><a href="#cb214-36" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (config<span class="sc">$</span>use_pca_predictors) {</span>
<span id="cb214-37"><a href="#cb214-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(layers_for_sampling)[<span class="dv">3</span><span class="sc">:</span><span class="fu">nlyr</span>(layers_for_sampling)] <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"PC"</span>, <span class="dv">1</span><span class="sc">:</span>config<span class="sc">$</span>n_pca_components)</span>
<span id="cb214-38"><a href="#cb214-38" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb214-39"><a href="#cb214-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb214-40"><a href="#cb214-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Stack for sampling has layers:"</span>, <span class="fu">paste</span>(<span class="fu">names</span>(layers_for_sampling), <span class="at">collapse=</span><span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb214-41"><a href="#cb214-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-42"><a href="#cb214-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- 2. Sample Data from Rasters ---</span></span>
<span id="cb214-43"><a href="#cb214-43" aria-hidden="true" tabindex="-1"></a>  mask_all_valid <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(layers_for_sampling)) <span class="sc">==</span> <span class="fu">nlyr</span>(layers_for_sampling)</span>
<span id="cb214-44"><a href="#cb214-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb214-45"><a href="#cb214-45" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">global</span>(mask_all_valid, <span class="st">"sum"</span>, <span class="at">na.rm=</span><span class="cn">TRUE</span>)<span class="sc">$</span>sum <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb214-46"><a href="#cb214-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Error: No cells where all predictor layers have valid data.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb214-47"><a href="#cb214-47" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb214-48"><a href="#cb214-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set.seed</span>(<span class="dv">123</span>) <span class="co"># for reproducibility</span></span>
<span id="cb214-49"><a href="#cb214-49" aria-hidden="true" tabindex="-1"></a>    sampled_points <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">spatSample</span>(mask_all_valid, <span class="dv">5000</span>, <span class="at">method =</span> <span class="st">"random"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>, <span class="at">xy=</span><span class="cn">TRUE</span>, <span class="at">warn=</span><span class="cn">FALSE</span>)</span>
<span id="cb214-50"><a href="#cb214-50" aria-hidden="true" tabindex="-1"></a>    df_sampled_values <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(layers_for_sampling, sampled_points[, <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>)], <span class="at">ID =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> <span class="fu">na.omit</span>()</span>
<span id="cb214-51"><a href="#cb214-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb214-52"><a href="#cb214-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Sampled"</span>, <span class="fu">nrow</span>(sampled_points), <span class="st">"points, retaining"</span>, <span class="fu">nrow</span>(df_sampled_values), <span class="st">"complete cases for analysis.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb214-53"><a href="#cb214-53" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb214-54"><a href="#cb214-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- 3. Perform Variance Partitioning ---</span></span>
<span id="cb214-55"><a href="#cb214-55" aria-hidden="true" tabindex="-1"></a>    Y <span class="ot">&lt;-</span> df_sampled_values<span class="sc">$</span>AnemonefishRichness</span>
<span id="cb214-56"><a href="#cb214-56" aria-hidden="true" tabindex="-1"></a>    X1 <span class="ot">&lt;-</span> df_sampled_values <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(HostRichness)</span>
<span id="cb214-57"><a href="#cb214-57" aria-hidden="true" tabindex="-1"></a>    X2 <span class="ot">&lt;-</span> df_sampled_values <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"PC"</span>))</span>
<span id="cb214-58"><a href="#cb214-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb214-59"><a href="#cb214-59" aria-hidden="true" tabindex="-1"></a>    varpart_result <span class="ot">&lt;-</span> vegan<span class="sc">::</span><span class="fu">varpart</span>(Y, X1, X2)</span>
<span id="cb214-60"><a href="#cb214-60" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb214-61"><a href="#cb214-61" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Variance Partitioning Results ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb214-62"><a href="#cb214-62" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(varpart_result)</span>
<span id="cb214-63"><a href="#cb214-63" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb214-64"><a href="#cb214-64" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- 4. Test Significance of Unique Fractions using RDA/ANOVA ---</span></span>
<span id="cb214-65"><a href="#cb214-65" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Significance Testing of Unique Fractions ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb214-66"><a href="#cb214-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb214-67"><a href="#cb214-67" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Test for fraction [a]: unique effect of Host Richness</span></span>
<span id="cb214-68"><a href="#cb214-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Testing unique contribution of Host Richness (Fraction [a])...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb214-69"><a href="#cb214-69" aria-hidden="true" tabindex="-1"></a>    rda_a <span class="ot">&lt;-</span> vegan<span class="sc">::</span><span class="fu">rda</span>(Y <span class="sc">~</span> HostRichness <span class="sc">+</span> <span class="fu">Condition</span>(PC1 <span class="sc">+</span> PC2 <span class="sc">+</span> PC3 <span class="sc">+</span> PC4), <span class="at">data =</span> df_sampled_values)</span>
<span id="cb214-70"><a href="#cb214-70" aria-hidden="true" tabindex="-1"></a>    anova_a <span class="ot">&lt;-</span> <span class="fu">anova.cca</span>(rda_a, <span class="at">permutations =</span> <span class="dv">999</span>)</span>
<span id="cb214-71"><a href="#cb214-71" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(anova_a)</span>
<span id="cb214-72"><a href="#cb214-72" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb214-73"><a href="#cb214-73" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Test for fraction [b]: unique effect of Environment</span></span>
<span id="cb214-74"><a href="#cb214-74" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Testing unique contribution of Environment (Fraction [b])...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb214-75"><a href="#cb214-75" aria-hidden="true" tabindex="-1"></a>    rda_b <span class="ot">&lt;-</span> vegan<span class="sc">::</span><span class="fu">rda</span>(Y <span class="sc">~</span> PC1 <span class="sc">+</span> PC2 <span class="sc">+</span> PC3 <span class="sc">+</span> PC4 <span class="sc">+</span> <span class="fu">Condition</span>(HostRichness), <span class="at">data =</span> df_sampled_values)</span>
<span id="cb214-76"><a href="#cb214-76" aria-hidden="true" tabindex="-1"></a>    anova_b <span class="ot">&lt;-</span> <span class="fu">anova.cca</span>(rda_b, <span class="at">permutations =</span> <span class="dv">999</span>)</span>
<span id="cb214-77"><a href="#cb214-77" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(anova_b)</span>
<span id="cb214-78"><a href="#cb214-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-79"><a href="#cb214-79" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- 5. Visualize the Results ---</span></span>
<span id="cb214-80"><a href="#cb214-80" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Plotting Variance Partitioning Diagram ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb214-81"><a href="#cb214-81" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb214-82"><a href="#cb214-82" aria-hidden="true" tabindex="-1"></a>    varpart_plot_filename <span class="ot">&lt;-</span> <span class="fu">file.path</span>(figure_output_dir, <span class="st">"variance_partitioning_richness_final.png"</span>)</span>
<span id="cb214-83"><a href="#cb214-83" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb214-84"><a href="#cb214-84" aria-hidden="true" tabindex="-1"></a>    <span class="fu">png</span>(<span class="at">filename =</span> varpart_plot_filename, <span class="at">width =</span> <span class="dv">800</span>, <span class="at">height =</span> <span class="dv">600</span>, <span class="at">res =</span> <span class="dv">100</span>)</span>
<span id="cb214-85"><a href="#cb214-85" aria-hidden="true" tabindex="-1"></a>    <span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>)) </span>
<span id="cb214-86"><a href="#cb214-86" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(varpart_result,</span>
<span id="cb214-87"><a href="#cb214-87" aria-hidden="true" tabindex="-1"></a>         <span class="at">Xnames =</span> <span class="fu">c</span>(<span class="st">"Biotic</span><span class="sc">\n</span><span class="st">(Host Richness)"</span>, <span class="st">"Abiotic</span><span class="sc">\n</span><span class="st">(Environment)"</span>),</span>
<span id="cb214-88"><a href="#cb214-88" aria-hidden="true" tabindex="-1"></a>         <span class="at">bg =</span> <span class="fu">c</span>(<span class="st">"skyblue"</span>, <span class="st">"lightgreen"</span>),</span>
<span id="cb214-89"><a href="#cb214-89" aria-hidden="true" tabindex="-1"></a>         <span class="at">main =</span> <span class="st">"Variance Partitioning of Anemonefish Richness"</span>,</span>
<span id="cb214-90"><a href="#cb214-90" aria-hidden="true" tabindex="-1"></a>         <span class="at">cex =</span> <span class="fl">1.7</span>, <span class="at">id.size =</span> <span class="dv">1</span>)</span>
<span id="cb214-91"><a href="#cb214-91" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dev.off</span>()</span>
<span id="cb214-92"><a href="#cb214-92" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb214-93"><a href="#cb214-93" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Display plot in R Markdown</span></span>
<span id="cb214-94"><a href="#cb214-94" aria-hidden="true" tabindex="-1"></a>    <span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>)) </span>
<span id="cb214-95"><a href="#cb214-95" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(varpart_result,</span>
<span id="cb214-96"><a href="#cb214-96" aria-hidden="true" tabindex="-1"></a>         <span class="at">Xnames =</span> <span class="fu">c</span>(<span class="st">"Biotic</span><span class="sc">\n</span><span class="st">(Host Richness)"</span>, <span class="st">"Abiotic</span><span class="sc">\n</span><span class="st">(Environment)"</span>),</span>
<span id="cb214-97"><a href="#cb214-97" aria-hidden="true" tabindex="-1"></a>         <span class="at">bg =</span> <span class="fu">c</span>(<span class="st">"skyblue"</span>, <span class="st">"lightgreen"</span>),</span>
<span id="cb214-98"><a href="#cb214-98" aria-hidden="true" tabindex="-1"></a>         <span class="at">main =</span> <span class="st">"Variance Partitioning of Anemonefish Richness"</span>,</span>
<span id="cb214-99"><a href="#cb214-99" aria-hidden="true" tabindex="-1"></a>         <span class="at">cex =</span> <span class="fl">1.7</span>, <span class="at">id.size =</span> <span class="dv">1</span>)</span>
<span id="cb214-100"><a href="#cb214-100" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb214-101"><a href="#cb214-101" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Saved variance partitioning plot to:"</span>, varpart_plot_filename, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb214-102"><a href="#cb214-102" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb214-103"><a href="#cb214-103" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- Preparing Data for Variance Partitioning ---
Stack for sampling has layers: HostRichness, AnemonefishRichness, PC1, PC2, PC3, PC4 
Sampled 5000 points, retaining 3505 complete cases for analysis.

--- Variance Partitioning Results ---

Partition of variance in RDA 

Call: vegan::varpart(Y = Y, X = X1, X2)

Explanatory tables:
X1:  X1
X2:  X2 

No. of explanatory tables: 2 
Total variation (SS): 39543 
            Variance: 11.285 
No. of observations: 3505 

Partition table:
                     Df R.squared Adj.R.squared Testable
[a+c] = X1            1   0.92674       0.92672     TRUE
[b+c] = X2            4   0.59582       0.59536     TRUE
[a+b+c] = X1+X2       5   0.94310       0.94302     TRUE
Individual fractions                                    
[a] = X1|X2           1                 0.34766     TRUE
[b] = X2|X1           4                 0.01630     TRUE
[c]                   0                 0.57906    FALSE
[d] = Residuals                         0.05698    FALSE
---
Use function 'rda' to test significance of fractions of interest

--- Significance Testing of Unique Fractions ---
Testing unique contribution of Host Richness (Fraction [a])...
Permutation test for rda under reduced model
Permutation: free
Number of permutations: 999

Model: rda(formula = Y ~ HostRichness + Condition(PC1 + PC2 + PC3 + PC4), data = df_sampled_values)
           Df Variance     F Pr(&gt;F)    
Model       1   3.9191 21357  0.001 ***
Residual 3499   0.6421                 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Testing unique contribution of Environment (Fraction [b])...
Permutation test for rda under reduced model
Permutation: free
Number of permutations: 999

Model: rda(formula = Y ~ PC1 + PC2 + PC3 + PC4 + Condition(HostRichness), data = df_sampled_values)
           Df Variance      F Pr(&gt;F)    
Model       4  0.18465 251.57  0.001 ***
Residual 3499  0.64207                  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

--- Plotting Variance Partitioning Diagram ---</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/richness-sampling-and-varpart-final-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Saved variance partitioning plot to: /home/bi-server-kyoto/a0236995/sdm_anemonefish/figure_files/variance_partitioning_richness_final.png </code></pre>
</div>
</div>
<section id="levins-b-niche-breadth-current-predictions" class="level3">
<h3 class="anchored" data-anchor-id="levins-b-niche-breadth-current-predictions">Levinâ€™s B Niche Breadth (Current Predictions)</h3>
<p>This section calculates Levinâ€™s B (<span class="math inline">\(B_2\)</span>) niche breadth metric for each host sea anemone species and each anemonefish species (using their environmental-only model predictions for the current period). This metric quantifies the uniformity of a speciesâ€™ predicted suitability across its range. We then compare the mean niche breadth between the two guilds.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb217"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb217-1"><a href="#cb217-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ENMTools)</span>
<span id="cb217-2"><a href="#cb217-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb217-3"><a href="#cb217-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb217-4"><a href="#cb217-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure the current individual prediction stacks are available and cropped</span></span>
<span id="cb217-5"><a href="#cb217-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.null</span>(host_pred_stack_cropped) <span class="sc">||</span> <span class="sc">!</span><span class="fu">inherits</span>(host_pred_stack_cropped, <span class="st">"SpatRaster"</span>)) {</span>
<span id="cb217-6"><a href="#cb217-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"`host_pred_stack_cropped` is not available or not a SpatRaster. Run previous chunks."</span>)</span>
<span id="cb217-7"><a href="#cb217-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb217-8"><a href="#cb217-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.null</span>(fish_pred_stack_cropped) <span class="sc">||</span> <span class="sc">!</span><span class="fu">inherits</span>(fish_pred_stack_cropped, <span class="st">"SpatRaster"</span>)) {</span>
<span id="cb217-9"><a href="#cb217-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"`fish_pred_stack_cropped` (for combined fish models) is not available or not a SpatRaster. Run previous chunks."</span>)</span>
<span id="cb217-10"><a href="#cb217-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb217-11"><a href="#cb217-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb217-12"><a href="#cb217-12" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 1. Calculate Niche Breadth for Host Sea Anemones ---</span></span>
<span id="cb217-13"><a href="#cb217-13" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"--- Calculating Levin's B Niche Breadth for Host Sea Anemones (Current) ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- Calculating Levin's B Niche Breadth for Host Sea Anemones (Current) ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb219"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb219-1"><a href="#cb219-1" aria-hidden="true" tabindex="-1"></a>host_niche_breadth_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb219-2"><a href="#cb219-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">species_name_sanitized =</span> <span class="fu">character</span>(<span class="dv">0</span>),</span>
<span id="cb219-3"><a href="#cb219-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">levins_B1 =</span> <span class="fu">numeric</span>(<span class="dv">0</span>),</span>
<span id="cb219-4"><a href="#cb219-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">levins_B2 =</span> <span class="fu">numeric</span>(<span class="dv">0</span>),</span>
<span id="cb219-5"><a href="#cb219-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb219-6"><a href="#cb219-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb219-7"><a href="#cb219-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-8"><a href="#cb219-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (terra<span class="sc">::</span><span class="fu">nlyr</span>(host_pred_stack_cropped) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb219-9"><a href="#cb219-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>terra<span class="sc">::</span><span class="fu">nlyr</span>(host_pred_stack_cropped)) {</span>
<span id="cb219-10"><a href="#cb219-10" aria-hidden="true" tabindex="-1"></a>    species_raster_host <span class="ot">&lt;-</span> host_pred_stack_cropped[[i]]</span>
<span id="cb219-11"><a href="#cb219-11" aria-hidden="true" tabindex="-1"></a>    sp_name_host <span class="ot">&lt;-</span> <span class="fu">names</span>(species_raster_host)</span>
<span id="cb219-12"><a href="#cb219-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"  Calculating breadth for host:"</span>, sp_name_host, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb219-13"><a href="#cb219-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-14"><a href="#cb219-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- START: MODIFIED PLOTTING ---</span></span>
<span id="cb219-15"><a href="#cb219-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load the occurrence points for this specific host</span></span>
<span id="cb219-16"><a href="#cb219-16" aria-hidden="true" tabindex="-1"></a>    host_aphia_id <span class="ot">&lt;-</span> anemone_species_df<span class="sc">$</span>AphiaID[anemone_species_df<span class="sc">$</span>scientificName <span class="sc">==</span> <span class="fu">gsub</span>(<span class="st">"_"</span>, <span class="st">" "</span>, sp_name_host)]</span>
<span id="cb219-17"><a href="#cb219-17" aria-hidden="true" tabindex="-1"></a>    host_occ_sf <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb219-18"><a href="#cb219-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(host_aphia_id) <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb219-19"><a href="#cb219-19" aria-hidden="true" tabindex="-1"></a>        occ_file_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(config<span class="sc">$</span>anemone_occurrence_dir, <span class="fu">paste0</span>(host_aphia_id, <span class="st">".csv"</span>))</span>
<span id="cb219-20"><a href="#cb219-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">file.exists</span>(occ_file_path)) {</span>
<span id="cb219-21"><a href="#cb219-21" aria-hidden="true" tabindex="-1"></a>            host_occ_df <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(occ_file_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb219-22"><a href="#cb219-22" aria-hidden="true" tabindex="-1"></a>              <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(decimalLongitude) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(decimalLatitude))</span>
<span id="cb219-23"><a href="#cb219-23" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span>(<span class="fu">nrow</span>(host_occ_df) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb219-24"><a href="#cb219-24" aria-hidden="true" tabindex="-1"></a>              host_occ_sf <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_as_sf</span>(host_occ_df, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"decimalLongitude"</span>, <span class="st">"decimalLatitude"</span>), <span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb219-25"><a href="#cb219-25" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb219-26"><a href="#cb219-26" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb219-27"><a href="#cb219-27" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb219-28"><a href="#cb219-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-29"><a href="#cb219-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"plot_prediction_map"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">exists</span>(<span class="st">"world_map_sf"</span>)) {</span>
<span id="cb219-30"><a href="#cb219-30" aria-hidden="true" tabindex="-1"></a>      plot_title_host <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"Suitability - Host:"</span>, <span class="fu">gsub</span>(<span class="st">"_"</span>, <span class="st">" "</span>, sp_name_host))</span>
<span id="cb219-31"><a href="#cb219-31" aria-hidden="true" tabindex="-1"></a>      host_plot <span class="ot">&lt;-</span> <span class="fu">plot_prediction_map</span>(</span>
<span id="cb219-32"><a href="#cb219-32" aria-hidden="true" tabindex="-1"></a>        <span class="at">prediction_raster =</span> species_raster_host,</span>
<span id="cb219-33"><a href="#cb219-33" aria-hidden="true" tabindex="-1"></a>        <span class="at">species_name =</span> plot_title_host,</span>
<span id="cb219-34"><a href="#cb219-34" aria-hidden="true" tabindex="-1"></a>        <span class="at">world_basemap =</span> world_map_sf,</span>
<span id="cb219-35"><a href="#cb219-35" aria-hidden="true" tabindex="-1"></a>        <span class="at">occurrence_points_sf =</span> host_occ_sf <span class="co"># Pass the loaded points</span></span>
<span id="cb219-36"><a href="#cb219-36" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb219-37"><a href="#cb219-37" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(host_plot)</span>
<span id="cb219-38"><a href="#cb219-38" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb219-39"><a href="#cb219-39" aria-hidden="true" tabindex="-1"></a>      <span class="fu">plot</span>(species_raster_host, <span class="at">main =</span> <span class="fu">paste</span>(<span class="st">"Suitability - Host:"</span>, <span class="fu">gsub</span>(<span class="st">"_"</span>, <span class="st">" "</span>, sp_name_host)))</span>
<span id="cb219-40"><a href="#cb219-40" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb219-41"><a href="#cb219-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- </span><span class="re">END</span><span class="co">: MODIFIED PLOTTING ---</span></span>
<span id="cb219-42"><a href="#cb219-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-43"><a href="#cb219-43" aria-hidden="true" tabindex="-1"></a>    breadth_metrics_host <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb219-44"><a href="#cb219-44" aria-hidden="true" tabindex="-1"></a>      ENMTools<span class="sc">::</span><span class="fu">raster.breadth</span>(species_raster_host)</span>
<span id="cb219-45"><a href="#cb219-45" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb219-46"><a href="#cb219-46" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"  Warning: Could not calculate breadth for host"</span>, sp_name_host, <span class="st">":"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb219-47"><a href="#cb219-47" aria-hidden="true" tabindex="-1"></a>      <span class="cn">NULL</span></span>
<span id="cb219-48"><a href="#cb219-48" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb219-49"><a href="#cb219-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-50"><a href="#cb219-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(breadth_metrics_host)) {</span>
<span id="cb219-51"><a href="#cb219-51" aria-hidden="true" tabindex="-1"></a>      host_niche_breadth_df <span class="ot">&lt;-</span> <span class="fu">rbind</span>(host_niche_breadth_df,</span>
<span id="cb219-52"><a href="#cb219-52" aria-hidden="true" tabindex="-1"></a>                                     <span class="fu">data.frame</span>(<span class="at">species_name_sanitized =</span> sp_name_host,</span>
<span id="cb219-53"><a href="#cb219-53" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">levins_B1 =</span> breadth_metrics_host<span class="sc">$</span>B1,</span>
<span id="cb219-54"><a href="#cb219-54" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">levins_B2 =</span> breadth_metrics_host<span class="sc">$</span>B2))</span>
<span id="cb219-55"><a href="#cb219-55" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb219-56"><a href="#cb219-56" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb219-57"><a href="#cb219-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Finished calculating niche breadth for hosts.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb219-58"><a href="#cb219-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(host_niche_breadth_df)</span>
<span id="cb219-59"><a href="#cb219-59" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb219-60"><a href="#cb219-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"No host anemone prediction layers to calculate breadth for.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb219-61"><a href="#cb219-61" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for host: Entacmaea_quadricolor </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/levin-b-niche-breadth-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for host: Radianthus_crispa </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/levin-b-niche-breadth-2.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for host: Radianthus_magnifica </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/levin-b-niche-breadth-3.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for host: Stichodactyla_gigantea </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/levin-b-niche-breadth-4.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for host: Cryptodendrum_adhaesivum </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/levin-b-niche-breadth-5.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for host: Macrodactyla_doreensis </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/levin-b-niche-breadth-6.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for host: Stichodactyla_mertensii </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/levin-b-niche-breadth-7.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for host: Stichodactyla_haddoni </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/levin-b-niche-breadth-8.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for host: Radianthus_malu </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/levin-b-niche-breadth-9.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for host: Heteractis_aurora </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/levin-b-niche-breadth-10.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Finished calculating niche breadth for hosts.
     species_name_sanitized levins_B1  levins_B2
1     Entacmaea_quadricolor 0.8832633 0.09909694
2         Radianthus_crispa 0.9859543 0.58945211
3      Radianthus_magnifica 0.9150805 0.16363004
4    Stichodactyla_gigantea 0.9697815 0.30472228
5  Cryptodendrum_adhaesivum 0.9735046 0.42918133
6    Macrodactyla_doreensis 0.9091849 0.15074255
7   Stichodactyla_mertensii 0.9848459 0.57867840
8     Stichodactyla_haddoni 0.9384106 0.16306443
9           Radianthus_malu 0.9540615 0.26246512
10        Heteractis_aurora 0.9765100 0.45107519</code></pre>
</div>
<div class="sourceCode cell-code" id="cb231"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb231-1"><a href="#cb231-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 2. Calculate Niche Breadth for Anemonefish (Environmental-Only Models) ---</span></span>
<span id="cb231-2"><a href="#cb231-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Calculating Levin's B Niche Breadth for Anemonefish (Combined, Current) ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Calculating Levin's B Niche Breadth for Anemonefish (Combined, Current) ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb233"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb233-1"><a href="#cb233-1" aria-hidden="true" tabindex="-1"></a>fish_niche_breadth_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb233-2"><a href="#cb233-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">species_name_sanitized =</span> <span class="fu">character</span>(<span class="dv">0</span>),</span>
<span id="cb233-3"><a href="#cb233-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">levins_B1 =</span> <span class="fu">numeric</span>(<span class="dv">0</span>),</span>
<span id="cb233-4"><a href="#cb233-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">levins_B2 =</span> <span class="fu">numeric</span>(<span class="dv">0</span>),</span>
<span id="cb233-5"><a href="#cb233-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb233-6"><a href="#cb233-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb233-7"><a href="#cb233-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-8"><a href="#cb233-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (terra<span class="sc">::</span><span class="fu">nlyr</span>(fish_pred_stack_cropped) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb233-9"><a href="#cb233-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>terra<span class="sc">::</span><span class="fu">nlyr</span>(fish_pred_stack_cropped)) {</span>
<span id="cb233-10"><a href="#cb233-10" aria-hidden="true" tabindex="-1"></a>    species_raster_fish <span class="ot">&lt;-</span> fish_pred_stack_cropped[[i]]</span>
<span id="cb233-11"><a href="#cb233-11" aria-hidden="true" tabindex="-1"></a>    sp_name_fish <span class="ot">&lt;-</span> <span class="fu">names</span>(species_raster_fish)</span>
<span id="cb233-12"><a href="#cb233-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"  Calculating breadth for anemonefish:"</span>, sp_name_fish, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb233-13"><a href="#cb233-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-14"><a href="#cb233-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- START: MODIFIED PLOTTING ---</span></span>
<span id="cb233-15"><a href="#cb233-15" aria-hidden="true" tabindex="-1"></a>    fish_aphia_id <span class="ot">&lt;-</span> anemonefish_species_df<span class="sc">$</span>AphiaID[anemonefish_species_df<span class="sc">$</span>scientificName <span class="sc">==</span> <span class="fu">gsub</span>(<span class="st">"_"</span>, <span class="st">" "</span>, sp_name_fish)]</span>
<span id="cb233-16"><a href="#cb233-16" aria-hidden="true" tabindex="-1"></a>    fish_occ_sf <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb233-17"><a href="#cb233-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(fish_aphia_id) <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb233-18"><a href="#cb233-18" aria-hidden="true" tabindex="-1"></a>        occ_file_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(config<span class="sc">$</span>anemonefish_occurrence_dir, <span class="fu">paste0</span>(fish_aphia_id, <span class="st">".csv"</span>))</span>
<span id="cb233-19"><a href="#cb233-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">file.exists</span>(occ_file_path)) {</span>
<span id="cb233-20"><a href="#cb233-20" aria-hidden="true" tabindex="-1"></a>            fish_occ_df <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(occ_file_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb233-21"><a href="#cb233-21" aria-hidden="true" tabindex="-1"></a>              <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(decimalLongitude) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(decimalLatitude))</span>
<span id="cb233-22"><a href="#cb233-22" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span>(<span class="fu">nrow</span>(fish_occ_df) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb233-23"><a href="#cb233-23" aria-hidden="true" tabindex="-1"></a>              fish_occ_sf <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_as_sf</span>(fish_occ_df, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"decimalLongitude"</span>, <span class="st">"decimalLatitude"</span>), <span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb233-24"><a href="#cb233-24" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb233-25"><a href="#cb233-25" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb233-26"><a href="#cb233-26" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb233-27"><a href="#cb233-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-28"><a href="#cb233-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"plot_prediction_map"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">exists</span>(<span class="st">"world_map_sf"</span>)) {</span>
<span id="cb233-29"><a href="#cb233-29" aria-hidden="true" tabindex="-1"></a>      plot_title_fish <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"Suitability - Anemonefish:"</span>, <span class="fu">gsub</span>(<span class="st">"_"</span>, <span class="st">" "</span>, sp_name_fish))</span>
<span id="cb233-30"><a href="#cb233-30" aria-hidden="true" tabindex="-1"></a>      fish_plot <span class="ot">&lt;-</span> <span class="fu">plot_prediction_map</span>(</span>
<span id="cb233-31"><a href="#cb233-31" aria-hidden="true" tabindex="-1"></a>        <span class="at">prediction_raster =</span> species_raster_fish,</span>
<span id="cb233-32"><a href="#cb233-32" aria-hidden="true" tabindex="-1"></a>        <span class="at">species_name =</span> plot_title_fish,</span>
<span id="cb233-33"><a href="#cb233-33" aria-hidden="true" tabindex="-1"></a>        <span class="at">world_basemap =</span> world_map_sf,</span>
<span id="cb233-34"><a href="#cb233-34" aria-hidden="true" tabindex="-1"></a>        <span class="at">occurrence_points_sf =</span> fish_occ_sf <span class="co"># Pass the loaded points</span></span>
<span id="cb233-35"><a href="#cb233-35" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb233-36"><a href="#cb233-36" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(fish_plot)</span>
<span id="cb233-37"><a href="#cb233-37" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb233-38"><a href="#cb233-38" aria-hidden="true" tabindex="-1"></a>      <span class="fu">plot</span>(species_raster_fish, <span class="at">main =</span> <span class="fu">paste</span>(<span class="st">"Suitability - Anemonefish:"</span>, <span class="fu">gsub</span>(<span class="st">"_"</span>, <span class="st">" "</span>, sp_name_fish)))</span>
<span id="cb233-39"><a href="#cb233-39" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb233-40"><a href="#cb233-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- </span><span class="re">END</span><span class="co">: MODIFIED PLOTTING ---</span></span>
<span id="cb233-41"><a href="#cb233-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-42"><a href="#cb233-42" aria-hidden="true" tabindex="-1"></a>    breadth_metrics_fish <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb233-43"><a href="#cb233-43" aria-hidden="true" tabindex="-1"></a>      ENMTools<span class="sc">::</span><span class="fu">raster.breadth</span>(species_raster_fish)</span>
<span id="cb233-44"><a href="#cb233-44" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb233-45"><a href="#cb233-45" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"  Warning: Could not calculate breadth for fish"</span>, sp_name_fish, <span class="st">":"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb233-46"><a href="#cb233-46" aria-hidden="true" tabindex="-1"></a>      <span class="cn">NULL</span></span>
<span id="cb233-47"><a href="#cb233-47" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb233-48"><a href="#cb233-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-49"><a href="#cb233-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(breadth_metrics_fish)) {</span>
<span id="cb233-50"><a href="#cb233-50" aria-hidden="true" tabindex="-1"></a>      fish_niche_breadth_df <span class="ot">&lt;-</span> <span class="fu">rbind</span>(fish_niche_breadth_df,</span>
<span id="cb233-51"><a href="#cb233-51" aria-hidden="true" tabindex="-1"></a>                                     <span class="fu">data.frame</span>(<span class="at">species_name_sanitized =</span> sp_name_fish,</span>
<span id="cb233-52"><a href="#cb233-52" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">levins_B1 =</span> breadth_metrics_fish<span class="sc">$</span>B1,</span>
<span id="cb233-53"><a href="#cb233-53" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">levins_B2 =</span> breadth_metrics_fish<span class="sc">$</span>B2))</span>
<span id="cb233-54"><a href="#cb233-54" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb233-55"><a href="#cb233-55" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb233-56"><a href="#cb233-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Finished calculating niche breadth for anemonefish (combined).</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb233-57"><a href="#cb233-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(fish_niche_breadth_df)</span>
<span id="cb233-58"><a href="#cb233-58" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb233-59"><a href="#cb233-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"No anemonefish (combined) prediction layers to calculate breadth for.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb233-60"><a href="#cb233-60" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_clarkii </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/levin-b-niche-breadth-11.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_frenatus </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/levin-b-niche-breadth-12.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_ocellaris </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/levin-b-niche-breadth-13.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_perideraion </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/levin-b-niche-breadth-14.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_polymnus </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/levin-b-niche-breadth-15.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_sandaracinos </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/levin-b-niche-breadth-16.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_akallopisos </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/levin-b-niche-breadth-17.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_omanensis </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/levin-b-niche-breadth-18.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_akindynos </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/levin-b-niche-breadth-19.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_allardi </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/levin-b-niche-breadth-20.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_barberi </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/levin-b-niche-breadth-21.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_bicinctus </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/levin-b-niche-breadth-22.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_chrysogaster </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/levin-b-niche-breadth-23.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_chrysopterus </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/levin-b-niche-breadth-24.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_ephippium </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/levin-b-niche-breadth-25.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_fuscocaudatus </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/levin-b-niche-breadth-26.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_latezonatus </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/levin-b-niche-breadth-27.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Warning: Could not calculate breadth for fish Amphiprion_latezonatus : missing value where TRUE/FALSE needed 
  Calculating breadth for anemonefish: Amphiprion_latifasciatus </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/levin-b-niche-breadth-28.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_leucokranos </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/levin-b-niche-breadth-29.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_melanopus </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/levin-b-niche-breadth-30.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_nigripes </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/levin-b-niche-breadth-31.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_percula </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/levin-b-niche-breadth-32.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_rubrocinctus </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/levin-b-niche-breadth-33.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_sebae </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/levin-b-niche-breadth-34.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_tricinctus </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/levin-b-niche-breadth-35.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Premnas_biaculeatus </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/levin-b-niche-breadth-36.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Finished calculating niche breadth for anemonefish (combined).
     species_name_sanitized levins_B1  levins_B2
1        Amphiprion_clarkii 0.9156893 0.16855573
2       Amphiprion_frenatus 0.9260953 0.15518835
3      Amphiprion_ocellaris 0.9132149 0.15841845
4    Amphiprion_perideraion 0.9401089 0.20229228
5       Amphiprion_polymnus 0.9483661 0.25673533
6   Amphiprion_sandaracinos 0.9032486 0.14087516
7    Amphiprion_akallopisos 0.9198552 0.16248444
8      Amphiprion_omanensis 0.9714976 0.38921636
9      Amphiprion_akindynos 0.7752804 0.01460635
10       Amphiprion_allardi 0.7798264 0.02324953
11       Amphiprion_barberi 0.9602659 0.27449700
12     Amphiprion_bicinctus 0.7641116 0.01246312
13  Amphiprion_chrysogaster 0.9793202 0.45316631
14  Amphiprion_chrysopterus 0.9664554 0.36578032
15     Amphiprion_ephippium 0.9528502 0.26945771
16 Amphiprion_fuscocaudatus 0.9873569 0.64651584
17 Amphiprion_latifasciatus 0.8570075 0.05171353
18   Amphiprion_leucokranos 0.9756997 0.50012773
19     Amphiprion_melanopus 0.9276171 0.14477146
20      Amphiprion_nigripes 0.9186231 0.14414588
21       Amphiprion_percula 0.9368468 0.17482779
22  Amphiprion_rubrocinctus 0.8194611 0.02767565
23         Amphiprion_sebae 0.9708571 0.38323210
24    Amphiprion_tricinctus 0.8960367 0.08848325
25      Premnas_biaculeatus 0.9404717 0.18544295</code></pre>
</div>
<div class="sourceCode cell-code" id="cb261"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb261-1"><a href="#cb261-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 3. Compare Mean Niche Breadth (Levin's B2) ---</span></span>
<span id="cb261-2"><a href="#cb261-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(host_niche_breadth_df) <span class="sc">&gt;</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(fish_niche_breadth_df) <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb261-3"><a href="#cb261-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Comparing Mean Niche Breadth (Levin's B2) between Guilds ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb261-4"><a href="#cb261-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb261-5"><a href="#cb261-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"levins_B2"</span> <span class="sc">%in%</span> <span class="fu">names</span>(host_niche_breadth_df) <span class="sc">&amp;&amp;</span> <span class="st">"levins_B2"</span> <span class="sc">%in%</span> <span class="fu">names</span>(fish_niche_breadth_df)) {</span>
<span id="cb261-6"><a href="#cb261-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb261-7"><a href="#cb261-7" aria-hidden="true" tabindex="-1"></a>    valid_hosts_b2 <span class="ot">&lt;-</span> host_niche_breadth_df<span class="sc">$</span>levins_B2[<span class="sc">!</span><span class="fu">is.na</span>(host_niche_breadth_df<span class="sc">$</span>levins_B2)]</span>
<span id="cb261-8"><a href="#cb261-8" aria-hidden="true" tabindex="-1"></a>    valid_fish_b2 <span class="ot">&lt;-</span> fish_niche_breadth_df<span class="sc">$</span>levins_B2[<span class="sc">!</span><span class="fu">is.na</span>(fish_niche_breadth_df<span class="sc">$</span>levins_B2)]</span>
<span id="cb261-9"><a href="#cb261-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb261-10"><a href="#cb261-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(valid_hosts_b2) <span class="sc">&gt;</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(valid_fish_b2) <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb261-11"><a href="#cb261-11" aria-hidden="true" tabindex="-1"></a>      ttest_breadth_b2 <span class="ot">&lt;-</span> <span class="fu">t.test</span>(valid_hosts_b2, valid_fish_b2)</span>
<span id="cb261-12"><a href="#cb261-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"Welch Two Sample t-test for Levin's B2 (Hosts vs. Fish Combined):</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb261-13"><a href="#cb261-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(ttest_breadth_b2)</span>
<span id="cb261-14"><a href="#cb261-14" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb261-15"><a href="#cb261-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"Not enough valid B2 values for t-test after removing NAs.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb261-16"><a href="#cb261-16" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb261-17"><a href="#cb261-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb261-18"><a href="#cb261-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Standard Deviation of Levin's B2:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb261-19"><a href="#cb261-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"  Hosts:"</span>, <span class="fu">sd</span>(valid_hosts_b2, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb261-20"><a href="#cb261-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"  Anemonefish:"</span>, <span class="fu">sd</span>(valid_fish_b2, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb261-21"><a href="#cb261-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb261-22"><a href="#cb261-22" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb261-23"><a href="#cb261-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Levin's B2 column not found in one or both breadth data frames.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb261-24"><a href="#cb261-24" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb261-25"><a href="#cb261-25" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb261-26"><a href="#cb261-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Not enough data to compare niche breadths between hosts and anemonefish.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb261-27"><a href="#cb261-27" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Comparing Mean Niche Breadth (Levin's B2) between Guilds ---
Welch Two Sample t-test for Levin's B2 (Hosts vs. Fish Combined):

    Welch Two Sample t-test

data:  valid_hosts_b2 and valid_fish_b2
t = 1.5624, df = 15.123, p-value = 0.1389
alternative hypothesis: true difference in means is not equal to 0
95 percent confidence interval:
 -0.03757814  0.24448601
sample estimates:
mean of x mean of y 
0.3192108 0.2157569 


Standard Deviation of Levin's B2:
  Hosts: 0.1821734 
  Anemonefish: 0.1632156 </code></pre>
</div>
</div>
</section>
</section>
<section id="niche-breadth-vs.-suitability-shifts-a-comparative-analysis" class="level2">
<h2 class="anchored" data-anchor-id="niche-breadth-vs.-suitability-shifts-a-comparative-analysis">Niche Breadth vs.&nbsp;Suitability Shifts: A Comparative Analysis</h2>
<p>This section explores the relationship between current environmental niche breadth (Levinâ€™s B2) and projected mean suitability shifts under future climate scenarios. The analysis is performed separately for host sea anemones and for anemonefish. For anemonefish, a further distinction is made based on their host specialization (Generalist: &gt;3 host species; Specialist: â‰¤3 host species) to investigate if the degree of host dependency influences their response patterns. Correlation tests are performed for each group and scenario, and the relationships are visualized to identify potential links between a speciesâ€™ current niche characteristics and its vulnerability or resilience to environmental change.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb263"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb263-1"><a href="#cb263-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Load necessary libraries ---</span></span>
<span id="cb263-2"><a href="#cb263-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb263-3"><a href="#cb263-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb263-4"><a href="#cb263-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb263-5"><a href="#cb263-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb263-6"><a href="#cb263-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tibble)</span>
<span id="cb263-7"><a href="#cb263-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-8"><a href="#cb263-8" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Ensure prerequisite data is available ---</span></span>
<span id="cb263-9"><a href="#cb263-9" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"host_niche_breadth_df"</span>) <span class="sc">||</span> <span class="sc">!</span><span class="fu">exists</span>(<span class="st">"fish_niche_breadth_df"</span>)) {</span>
<span id="cb263-10"><a href="#cb263-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"Niche breadth data frames not found. Run the 'levin-b-niche-breadth' chunk first."</span>)</span>
<span id="cb263-11"><a href="#cb263-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb263-12"><a href="#cb263-12" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"suitability_shifts_list"</span>) <span class="sc">||</span> <span class="fu">length</span>(suitability_shifts_list) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb263-13"><a href="#cb263-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"`suitability_shifts_list` not found or empty. Run the 'calculate-suitability-shifts' chunk."</span>)</span>
<span id="cb263-14"><a href="#cb263-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb263-15"><a href="#cb263-15" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"anemonefish_specialization_df"</span>)) {</span>
<span id="cb263-16"><a href="#cb263-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"`anemonefish_specialization_df` not found. Run the specialization analysis chunk."</span>)</span>
<span id="cb263-17"><a href="#cb263-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb263-18"><a href="#cb263-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-19"><a href="#cb263-19" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"--- Correlating Niche Breadth with Future Suitability Shifts (Hypothesis 3) ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- Correlating Niche Breadth with Future Suitability Shifts (Hypothesis 3) ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb265"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb265-1"><a href="#cb265-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 1. Prepare Host Data ---</span></span>
<span id="cb265-2"><a href="#cb265-2" aria-hidden="true" tabindex="-1"></a>host_breadth_shifts_df <span class="ot">&lt;-</span> host_niche_breadth_df <span class="sc">%&gt;%</span></span>
<span id="cb265-3"><a href="#cb265-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(species_name_sanitized, <span class="at">breadth_B2 =</span> levins_B2)</span>
<span id="cb265-4"><a href="#cb265-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-5"><a href="#cb265-5" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 2. Prepare Anemonefish Data ---</span></span>
<span id="cb265-6"><a href="#cb265-6" aria-hidden="true" tabindex="-1"></a>fish_breadth_shifts_df <span class="ot">&lt;-</span> fish_niche_breadth_df <span class="sc">%&gt;%</span></span>
<span id="cb265-7"><a href="#cb265-7" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(species_name_sanitized, <span class="at">breadth_B2 =</span> levins_B2) <span class="sc">%&gt;%</span></span>
<span id="cb265-8"><a href="#cb265-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(anemonefish_specialization_df, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"species_name_sanitized"</span> <span class="ot">=</span> <span class="st">"species"</span>))</span>
<span id="cb265-9"><a href="#cb265-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-10"><a href="#cb265-10" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 3. Combine Breadth and Shift Data for All Species and Scenarios ---</span></span>
<span id="cb265-11"><a href="#cb265-11" aria-hidden="true" tabindex="-1"></a>all_scenarios <span class="ot">&lt;-</span> <span class="fu">names</span>(suitability_shifts_list)</span>
<span id="cb265-12"><a href="#cb265-12" aria-hidden="true" tabindex="-1"></a>all_breadth_shifts_long_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb265-13"><a href="#cb265-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-14"><a href="#cb265-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (scenario_name <span class="cf">in</span> all_scenarios) {</span>
<span id="cb265-15"><a href="#cb265-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Determine guild from the list name</span></span>
<span id="cb265-16"><a href="#cb265-16" aria-hidden="true" tabindex="-1"></a>  guild <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">grepl</span>(<span class="st">"hosts_"</span>, scenario_name), <span class="st">"Host Anemones"</span>, <span class="st">"Anemonefish"</span>)</span>
<span id="cb265-17"><a href="#cb265-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb265-18"><a href="#cb265-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get the appropriate breadth data frame</span></span>
<span id="cb265-19"><a href="#cb265-19" aria-hidden="true" tabindex="-1"></a>  breadth_df <span class="ot">&lt;-</span> <span class="cf">if</span> (guild <span class="sc">==</span> <span class="st">"Host Anemones"</span>) host_breadth_shifts_df <span class="cf">else</span> fish_breadth_shifts_df</span>
<span id="cb265-20"><a href="#cb265-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb265-21"><a href="#cb265-21" aria-hidden="true" tabindex="-1"></a>  shift_data <span class="ot">&lt;-</span> suitability_shifts_list[[scenario_name]]</span>
<span id="cb265-22"><a href="#cb265-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb265-23"><a href="#cb265-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(shift_data) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(shift_data) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb265-24"><a href="#cb265-24" aria-hidden="true" tabindex="-1"></a>    temp_shift_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(shift_data) <span class="sc">%&gt;%</span></span>
<span id="cb265-25"><a href="#cb265-25" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rownames_to_column</span>(<span class="st">"species_name_sanitized"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb265-26"><a href="#cb265-26" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">suitability_shift =</span> mean)</span>
<span id="cb265-27"><a href="#cb265-27" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb265-28"><a href="#cb265-28" aria-hidden="true" tabindex="-1"></a>    combined_df <span class="ot">&lt;-</span> breadth_df <span class="sc">%&gt;%</span></span>
<span id="cb265-29"><a href="#cb265-29" aria-hidden="true" tabindex="-1"></a>      <span class="fu">left_join</span>(temp_shift_df, <span class="at">by =</span> <span class="st">"species_name_sanitized"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb265-30"><a href="#cb265-30" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">guild =</span> guild, <span class="at">scenario =</span> scenario_name)</span>
<span id="cb265-31"><a href="#cb265-31" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb265-32"><a href="#cb265-32" aria-hidden="true" tabindex="-1"></a>    all_breadth_shifts_long_df <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(all_breadth_shifts_long_df, combined_df)</span>
<span id="cb265-33"><a href="#cb265-33" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb265-34"><a href="#cb265-34" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb265-35"><a href="#cb265-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-36"><a href="#cb265-36" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 4. Final Data Cleaning and Labeling for Plot ---</span></span>
<span id="cb265-37"><a href="#cb265-37" aria-hidden="true" tabindex="-1"></a>plot_data <span class="ot">&lt;-</span> all_breadth_shifts_long_df <span class="sc">%&gt;%</span></span>
<span id="cb265-38"><a href="#cb265-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(breadth_B2), <span class="sc">!</span><span class="fu">is.na</span>(suitability_shift)) <span class="sc">%&gt;%</span></span>
<span id="cb265-39"><a href="#cb265-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create clean labels for scenarios</span></span>
<span id="cb265-40"><a href="#cb265-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb265-41"><a href="#cb265-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">scenario_display =</span> <span class="fu">gsub</span>(<span class="st">"hosts_|fish_env_only_"</span>, <span class="st">""</span>, scenario),</span>
<span id="cb265-42"><a href="#cb265-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">scenario_display =</span> <span class="fu">gsub</span>(<span class="st">"ssp|_"</span>, <span class="st">""</span>, scenario_display),</span>
<span id="cb265-43"><a href="#cb265-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">scenario_display =</span> <span class="fu">paste0</span>(<span class="st">"SSP"</span>, <span class="fu">substr</span>(scenario_display, <span class="dv">1</span>, <span class="dv">3</span>), <span class="st">"."</span>, <span class="fu">substr</span>(scenario_display, <span class="dv">3</span>, <span class="dv">3</span>), <span class="st">" ("</span>, <span class="fu">substr</span>(scenario_display, <span class="dv">4</span>, <span class="dv">7</span>), <span class="st">")"</span>)</span>
<span id="cb265-44"><a href="#cb265-44" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb265-45"><a href="#cb265-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-46"><a href="#cb265-46" aria-hidden="true" tabindex="-1"></a><span class="co"># For anemonefish, ensure specialization_type is available, otherwise set to NA</span></span>
<span id="cb265-47"><a href="#cb265-47" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="st">"specialization_type"</span> <span class="sc">%in%</span> <span class="fu">names</span>(plot_data)) {</span>
<span id="cb265-48"><a href="#cb265-48" aria-hidden="true" tabindex="-1"></a>  plot_data<span class="sc">$</span>specialization_type <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb265-49"><a href="#cb265-49" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb265-50"><a href="#cb265-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-51"><a href="#cb265-51" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Final combined data for plotting ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Final combined data for plotting ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb267"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb267-1"><a href="#cb267-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">head</span>(plot_data))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    species_name_sanitized breadth_B2 suitability_shift         guild
1    Entacmaea_quadricolor 0.09909694     -0.0025224455 Host Anemones
2        Radianthus_crispa 0.58945211      0.0031421267 Host Anemones
3     Radianthus_magnifica 0.16363004     -0.0012377732 Host Anemones
4   Stichodactyla_gigantea 0.30472228      0.0007430928 Host Anemones
5 Cryptodendrum_adhaesivum 0.42918133     -0.0023126082 Host Anemones
6   Macrodactyla_doreensis 0.15074255     -0.0009896069 Host Anemones
           scenario n_hosts specialization_type scenario_display
1 hosts_ssp119_2050      NA                &lt;NA&gt;  SSP119.9 (2050)
2 hosts_ssp119_2050      NA                &lt;NA&gt;  SSP119.9 (2050)
3 hosts_ssp119_2050      NA                &lt;NA&gt;  SSP119.9 (2050)
4 hosts_ssp119_2050      NA                &lt;NA&gt;  SSP119.9 (2050)
5 hosts_ssp119_2050      NA                &lt;NA&gt;  SSP119.9 (2050)
6 hosts_ssp119_2050      NA                &lt;NA&gt;  SSP119.9 (2050)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb269"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb269-1"><a href="#cb269-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 5. Statistical Analysis: Run Correlations for each group ---</span></span>
<span id="cb269-2"><a href="#cb269-2" aria-hidden="true" tabindex="-1"></a>correlation_results <span class="ot">&lt;-</span> plot_data <span class="sc">%&gt;%</span></span>
<span id="cb269-3"><a href="#cb269-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(guild, scenario_display) <span class="sc">%&gt;%</span></span>
<span id="cb269-4"><a href="#cb269-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb269-5"><a href="#cb269-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">correlation =</span> <span class="fu">cor.test</span>(breadth_B2, suitability_shift)<span class="sc">$</span>estimate,</span>
<span id="cb269-6"><a href="#cb269-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">p_value =</span> <span class="fu">cor.test</span>(breadth_B2, suitability_shift)<span class="sc">$</span>p.value,</span>
<span id="cb269-7"><a href="#cb269-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb269-8"><a href="#cb269-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb269-9"><a href="#cb269-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb269-10"><a href="#cb269-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Pearson Correlation Results: Niche Breadth vs. Suitability Shift ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Pearson Correlation Results: Niche Breadth vs. Suitability Shift ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb271"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb271-1"><a href="#cb271-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(knitr<span class="sc">::</span><span class="fu">kable</span>(correlation_results, <span class="at">digits =</span> <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>

|guild         |scenario_display | correlation| p_value|
|:-------------|:----------------|-----------:|-------:|
|Anemonefish   |SSP119.9 (2050)  |       0.556|   0.004|
|Anemonefish   |SSP119.9 (2100)  |       0.556|   0.004|
|Anemonefish   |SSP585.5 (2050)  |       0.555|   0.004|
|Anemonefish   |SSP585.5 (2100)  |       0.520|   0.008|
|Host Anemones |SSP119.9 (2050)  |       0.744|   0.014|
|Host Anemones |SSP119.9 (2100)  |       0.690|   0.027|
|Host Anemones |SSP585.5 (2050)  |       0.754|   0.012|
|Host Anemones |SSP585.5 (2100)  |       0.704|   0.023|</code></pre>
</div>
<div class="sourceCode cell-code" id="cb273"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb273-1"><a href="#cb273-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 6. Create the Final Publication-Quality Plot ---</span></span>
<span id="cb273-2"><a href="#cb273-2" aria-hidden="true" tabindex="-1"></a>final_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(plot_data, <span class="fu">aes</span>(<span class="at">x =</span> breadth_B2, <span class="at">y =</span> suitability_shift, <span class="at">color =</span> guild)) <span class="sc">+</span></span>
<span id="cb273-3"><a href="#cb273-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.8</span>, <span class="at">size =</span> <span class="fl">2.5</span>) <span class="sc">+</span></span>
<span id="cb273-4"><a href="#cb273-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">TRUE</span>, <span class="fu">aes</span>(<span class="at">fill =</span> guild), <span class="at">alpha =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb273-5"><a href="#cb273-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> scenario_display, <span class="at">scales =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb273-6"><a href="#cb273-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"grey40"</span>) <span class="sc">+</span></span>
<span id="cb273-7"><a href="#cb273-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb273-8"><a href="#cb273-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Relationship Between Niche Breadth and Projected Suitability Shifts"</span>,</span>
<span id="cb273-9"><a href="#cb273-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Testing if broader niches are associated with greater resilience to climate change"</span>,</span>
<span id="cb273-10"><a href="#cb273-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Current Environmental Niche Breadth (Levin's B2)"</span>,</span>
<span id="cb273-11"><a href="#cb273-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Mean Change in Suitability (Future vs. Current)"</span></span>
<span id="cb273-12"><a href="#cb273-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb273-13"><a href="#cb273-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Anemonefish"</span> <span class="ot">=</span> <span class="st">"#d95f02"</span>, <span class="st">"Host Anemones"</span> <span class="ot">=</span> <span class="st">"#1b9e77"</span>), <span class="at">name =</span> <span class="st">"Guild"</span>) <span class="sc">+</span></span>
<span id="cb273-14"><a href="#cb273-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Anemonefish"</span> <span class="ot">=</span> <span class="st">"#d95f02"</span>, <span class="st">"Host Anemones"</span> <span class="ot">=</span> <span class="st">"#1b9e77"</span>), <span class="at">name =</span> <span class="st">"Guild"</span>) <span class="sc">+</span></span>
<span id="cb273-15"><a href="#cb273-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb273-16"><a href="#cb273-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb273-17"><a href="#cb273-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb273-18"><a href="#cb273-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"grey90"</span>, <span class="at">color =</span> <span class="st">"grey90"</span>),</span>
<span id="cb273-19"><a href="#cb273-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb273-20"><a href="#cb273-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb273-21"><a href="#cb273-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">10</span>)</span>
<span id="cb273-22"><a href="#cb273-22" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb273-23"><a href="#cb273-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb273-24"><a href="#cb273-24" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(final_plot)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/breadth-vs-shift-final-analysis-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb274"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb274-1"><a href="#cb274-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the plot</span></span>
<span id="cb274-2"><a href="#cb274-2" aria-hidden="true" tabindex="-1"></a>plot_filename <span class="ot">&lt;-</span> <span class="fu">file.path</span>(figure_output_dir, <span class="st">"niche_breadth_vs_suitability_shift_all_scenarios.png"</span>)</span>
<span id="cb274-3"><a href="#cb274-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(plot_filename, <span class="at">plot =</span> final_plot, <span class="at">width =</span> <span class="dv">11</span>, <span class="at">height =</span> <span class="dv">8</span>, <span class="at">dpi =</span> <span class="dv">300</span>)</span>
<span id="cb274-4"><a href="#cb274-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Saved final plot to:"</span>, plot_filename, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Saved final plot to: /home/bi-server-kyoto/a0236995/sdm_anemonefish/figure_files/niche_breadth_vs_suitability_shift_all_scenarios.png </code></pre>
</div>
</div>
</section>
<section id="variable-importance-comparison" class="level2">
<h2 class="anchored" data-anchor-id="variable-importance-comparison">Variable Importance Comparison</h2>
<p>This section loads the variable importance (VI) scores from the environmental-only SDMs for host sea anemones and anemonefish. It then compares the importance of each environmental predictor (PCA components if used) between the two guilds.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb276"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb276-1"><a href="#cb276-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb276-2"><a href="#cb276-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr) <span class="co"># Not strictly needed for this chunk as is, but good to have if you modify</span></span>
<span id="cb276-3"><a href="#cb276-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb276-4"><a href="#cb276-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr) <span class="co"># For str_remove if needed in species_sanitized, though seems done by filename</span></span>
<span id="cb276-5"><a href="#cb276-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)   <span class="co"># For read_csv</span></span>
<span id="cb276-6"><a href="#cb276-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)   <span class="co"># For map_df</span></span>
<span id="cb276-7"><a href="#cb276-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb276-8"><a href="#cb276-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine predictor suffix used for the environmental-only models</span></span>
<span id="cb276-9"><a href="#cb276-9" aria-hidden="true" tabindex="-1"></a>env_model_predictor_suffix <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(config<span class="sc">$</span>use_pca_predictors, <span class="st">"_pca"</span>, <span class="st">"_vif"</span>)</span>
<span id="cb276-10"><a href="#cb276-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb276-11"><a href="#cb276-11" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Load Host Anemone Variable Importance ---</span></span>
<span id="cb276-12"><a href="#cb276-12" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"--- Loading Host Anemone Variable Importance ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- Loading Host Anemone Variable Importance ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb278"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb278-1"><a href="#cb278-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Original logic for finding host_vi_dir and host_vi_files</span></span>
<span id="cb278-2"><a href="#cb278-2" aria-hidden="true" tabindex="-1"></a>host_vi_subdir_name <span class="ot">&lt;-</span> config<span class="sc">$</span>model_output_subdir_map[[env_model_predictor_suffix]] <span class="sc">%||%</span> </span>
<span id="cb278-3"><a href="#cb278-3" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">ifelse</span>(config<span class="sc">$</span>use_pca_predictors, <span class="st">"anemone_pca"</span>, <span class="st">"anemone_vif"</span>)</span>
<span id="cb278-4"><a href="#cb278-4" aria-hidden="true" tabindex="-1"></a>host_vi_dir_base <span class="ot">&lt;-</span> <span class="fu">file.path</span>(config<span class="sc">$</span>target_vi_base, host_vi_subdir_name)</span>
<span id="cb278-5"><a href="#cb278-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb278-6"><a href="#cb278-6" aria-hidden="true" tabindex="-1"></a>host_vi_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path =</span> host_vi_dir_base, <span class="at">pattern =</span> <span class="st">"^VI_.*</span><span class="sc">\\</span><span class="st">.csv$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb278-7"><a href="#cb278-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Fallback if subdirectory structure is slightly different (e.g., .../anemone_pca/anemone_pca)</span></span>
<span id="cb278-8"><a href="#cb278-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(host_vi_files) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span> env_model_predictor_suffix <span class="sc">==</span> <span class="st">"_pca"</span>) { </span>
<span id="cb278-9"><a href="#cb278-9" aria-hidden="true" tabindex="-1"></a>    host_vi_dir_alt <span class="ot">&lt;-</span> <span class="fu">file.path</span>(config<span class="sc">$</span>target_vi_base, <span class="st">"anemone_pca"</span>) <span class="co"># Check one level up from expected subdir</span></span>
<span id="cb278-10"><a href="#cb278-10" aria-hidden="true" tabindex="-1"></a>    host_vi_files_alt_check <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path =</span> host_vi_dir_alt, <span class="at">pattern =</span> <span class="st">"^VI_.*</span><span class="sc">\\</span><span class="st">.csv$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb278-11"><a href="#cb278-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">length</span>(host_vi_files_alt_check) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb278-12"><a href="#cb278-12" aria-hidden="true" tabindex="-1"></a>        host_vi_files <span class="ot">&lt;-</span> host_vi_files_alt_check</span>
<span id="cb278-13"><a href="#cb278-13" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"  Found host VI files in alternative directory:"</span>, host_vi_dir_alt, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb278-14"><a href="#cb278-14" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> { <span class="co"># Check if it's nested further</span></span>
<span id="cb278-15"><a href="#cb278-15" aria-hidden="true" tabindex="-1"></a>        host_vi_dir_nested <span class="ot">&lt;-</span> <span class="fu">file.path</span>(host_vi_dir_base, <span class="st">"anemone_pca"</span>) <span class="co"># Original had host_vi_dir/anemone_pca</span></span>
<span id="cb278-16"><a href="#cb278-16" aria-hidden="true" tabindex="-1"></a>        host_vi_files_nested_check <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path =</span> host_vi_dir_nested, <span class="at">pattern =</span> <span class="st">"^VI_.*</span><span class="sc">\\</span><span class="st">.csv$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb278-17"><a href="#cb278-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">length</span>(host_vi_files_nested_check) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb278-18"><a href="#cb278-18" aria-hidden="true" tabindex="-1"></a>            host_vi_files <span class="ot">&lt;-</span> host_vi_files_nested_check</span>
<span id="cb278-19"><a href="#cb278-19" aria-hidden="true" tabindex="-1"></a>            <span class="fu">cat</span>(<span class="st">"  Found host VI files in nested directory:"</span>, host_vi_dir_nested, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb278-20"><a href="#cb278-20" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb278-21"><a href="#cb278-21" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb278-22"><a href="#cb278-22" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Found host VI files in alternative directory: /home/bi-server-kyoto/a0236995/sdm_anemonefish/data/output/anemone_pca </code></pre>
</div>
<div class="sourceCode cell-code" id="cb280"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb280-1"><a href="#cb280-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(host_vi_files) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb280-2"><a href="#cb280-2" aria-hidden="true" tabindex="-1"></a>  host_vi_data <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map_df</span>(host_vi_files, </span>
<span id="cb280-3"><a href="#cb280-3" aria-hidden="true" tabindex="-1"></a>                <span class="sc">~</span>readr<span class="sc">::</span><span class="fu">read_csv</span>(.x, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb280-4"><a href="#cb280-4" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">mutate</span>(<span class="at">filename =</span> <span class="fu">basename</span>(.x))) <span class="sc">%&gt;%</span></span>
<span id="cb280-5"><a href="#cb280-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb280-6"><a href="#cb280-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">species_sanitized =</span> <span class="fu">str_remove</span>(<span class="fu">str_remove</span>(filename, <span class="st">"^VI_"</span>), <span class="st">"</span><span class="sc">\\</span><span class="st">.csv$"</span>),</span>
<span id="cb280-7"><a href="#cb280-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">guild =</span> <span class="st">"Host Anemones"</span> <span class="co"># Consistent naming with scale_fill_manual later</span></span>
<span id="cb280-8"><a href="#cb280-8" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb280-9"><a href="#cb280-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">Permutation_Importance =</span> Importance) </span>
<span id="cb280-10"><a href="#cb280-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb280-11"><a href="#cb280-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Loaded VI data for"</span>, <span class="fu">length</span>(<span class="fu">unique</span>(host_vi_data<span class="sc">$</span>species_sanitized)), <span class="st">"host species.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb280-12"><a href="#cb280-12" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb280-13"><a href="#cb280-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Warning: No Variable Importance CSV files found for host anemones. Checked:"</span>, host_vi_dir_base, <span class="st">"and potential alternatives.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb280-14"><a href="#cb280-14" aria-hidden="true" tabindex="-1"></a>  host_vi_data <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb280-15"><a href="#cb280-15" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Loaded VI data for 10 host species.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb282"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb282-1"><a href="#cb282-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Load Anemonefish (Environmental-Only Models) Variable Importance ---</span></span>
<span id="cb282-2"><a href="#cb282-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Loading Anemonefish (Combined) Variable Importance ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Loading Anemonefish (Combined) Variable Importance ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb284"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb284-1"><a href="#cb284-1" aria-hidden="true" tabindex="-1"></a>fish_vi_subdir_name <span class="ot">&lt;-</span> config<span class="sc">$</span>model_output_subdir_map[[env_model_predictor_suffix]] <span class="sc">%||%</span> </span>
<span id="cb284-2"><a href="#cb284-2" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">ifelse</span>(config<span class="sc">$</span>use_pca_predictors, <span class="st">"anemonefish_pca"</span>, <span class="st">"anemonefish_vif"</span>)</span>
<span id="cb284-3"><a href="#cb284-3" aria-hidden="true" tabindex="-1"></a>fish_vi_dir_base <span class="ot">&lt;-</span> <span class="fu">file.path</span>(config<span class="sc">$</span>target_vi_base, fish_vi_subdir_name)</span>
<span id="cb284-4"><a href="#cb284-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb284-5"><a href="#cb284-5" aria-hidden="true" tabindex="-1"></a>fish_vi_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path =</span> fish_vi_dir_base, <span class="at">pattern =</span> <span class="st">"^VI_.*</span><span class="sc">\\</span><span class="st">.csv$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb284-6"><a href="#cb284-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(fish_vi_files) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span> env_model_predictor_suffix <span class="sc">==</span> <span class="st">"_pca"</span>) { </span>
<span id="cb284-7"><a href="#cb284-7" aria-hidden="true" tabindex="-1"></a>    fish_vi_dir_alt <span class="ot">&lt;-</span> <span class="fu">file.path</span>(config<span class="sc">$</span>target_vi_base, <span class="st">"anemonefish_pca"</span>)</span>
<span id="cb284-8"><a href="#cb284-8" aria-hidden="true" tabindex="-1"></a>    fish_vi_files_alt_check <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path =</span> fish_vi_dir_alt, <span class="at">pattern =</span> <span class="st">"^VI_.*</span><span class="sc">\\</span><span class="st">.csv$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb284-9"><a href="#cb284-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">length</span>(fish_vi_files_alt_check) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb284-10"><a href="#cb284-10" aria-hidden="true" tabindex="-1"></a>        fish_vi_files <span class="ot">&lt;-</span> fish_vi_files_alt_check</span>
<span id="cb284-11"><a href="#cb284-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"  Found fish VI files in alternative directory:"</span>, fish_vi_dir_alt, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb284-12"><a href="#cb284-12" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb284-13"><a href="#cb284-13" aria-hidden="true" tabindex="-1"></a>        fish_vi_dir_nested <span class="ot">&lt;-</span> <span class="fu">file.path</span>(fish_vi_dir_base, <span class="st">"anemonefish_pca"</span>)</span>
<span id="cb284-14"><a href="#cb284-14" aria-hidden="true" tabindex="-1"></a>        fish_vi_files_nested_check <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path =</span> fish_vi_dir_nested, <span class="at">pattern =</span> <span class="st">"^VI_.*</span><span class="sc">\\</span><span class="st">.csv$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb284-15"><a href="#cb284-15" aria-hidden="true" tabindex="-1"></a>         <span class="cf">if</span>(<span class="fu">length</span>(fish_vi_files_nested_check) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb284-16"><a href="#cb284-16" aria-hidden="true" tabindex="-1"></a>            fish_vi_files <span class="ot">&lt;-</span> fish_vi_files_nested_check</span>
<span id="cb284-17"><a href="#cb284-17" aria-hidden="true" tabindex="-1"></a>            <span class="fu">cat</span>(<span class="st">"  Found fish VI files in nested directory:"</span>, fish_vi_dir_nested, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb284-18"><a href="#cb284-18" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb284-19"><a href="#cb284-19" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb284-20"><a href="#cb284-20" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Found fish VI files in alternative directory: /home/bi-server-kyoto/a0236995/sdm_anemonefish/data/output/anemonefish_pca </code></pre>
</div>
<div class="sourceCode cell-code" id="cb286"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb286-1"><a href="#cb286-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(fish_vi_files) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb286-2"><a href="#cb286-2" aria-hidden="true" tabindex="-1"></a>  fish_vi_data <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map_df</span>(fish_vi_files, </span>
<span id="cb286-3"><a href="#cb286-3" aria-hidden="true" tabindex="-1"></a>                <span class="sc">~</span>readr<span class="sc">::</span><span class="fu">read_csv</span>(.x, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb286-4"><a href="#cb286-4" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">mutate</span>(<span class="at">filename =</span> <span class="fu">basename</span>(.x))) <span class="sc">%&gt;%</span></span>
<span id="cb286-5"><a href="#cb286-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb286-6"><a href="#cb286-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">species_sanitized =</span> <span class="fu">str_remove</span>(<span class="fu">str_remove</span>(filename, <span class="st">"^VI_"</span>), <span class="st">"</span><span class="sc">\\</span><span class="st">.csv$"</span>),</span>
<span id="cb286-7"><a href="#cb286-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">guild =</span> <span class="st">"Anemonefish (Combined)"</span> <span class="co"># Consistent naming</span></span>
<span id="cb286-8"><a href="#cb286-8" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb286-9"><a href="#cb286-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">Permutation_Importance =</span> Importance) </span>
<span id="cb286-10"><a href="#cb286-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Loaded VI data for"</span>, <span class="fu">length</span>(<span class="fu">unique</span>(fish_vi_data<span class="sc">$</span>species_sanitized)), <span class="st">"anemonefish (combined) species.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb286-11"><a href="#cb286-11" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb286-12"><a href="#cb286-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Warning: No Variable Importance CSV files found for anemonefish (combined). Checked:"</span>, fish_vi_dir_base, <span class="st">"and potential alternatives.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb286-13"><a href="#cb286-13" aria-hidden="true" tabindex="-1"></a>  fish_vi_data <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb286-14"><a href="#cb286-14" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Loaded VI data for 27 anemonefish (combined) species.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb288"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb288-1"><a href="#cb288-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Combine and Compare VI ---</span></span>
<span id="cb288-2"><a href="#cb288-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(host_vi_data) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">is.null</span>(fish_vi_data) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(host_vi_data) <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(fish_vi_data) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb288-3"><a href="#cb288-3" aria-hidden="true" tabindex="-1"></a>  combined_vi_data <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(host_vi_data, fish_vi_data) <span class="sc">%&gt;%</span></span>
<span id="cb288-4"><a href="#cb288-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Permutation_Importance)) </span>
<span id="cb288-5"><a href="#cb288-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb288-6"><a href="#cb288-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="st">"Variable"</span> <span class="sc">%in%</span> <span class="fu">names</span>(combined_vi_data)) {</span>
<span id="cb288-7"><a href="#cb288-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"The 'Variable' column is missing from the loaded VI data. Check the output of SDMtune::varImp or your VI calculation script."</span>)</span>
<span id="cb288-8"><a href="#cb288-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb288-9"><a href="#cb288-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb288-10"><a href="#cb288-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Combined VI data for comparison:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb288-11"><a href="#cb288-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">head</span>(combined_vi_data))</span>
<span id="cb288-12"><a href="#cb288-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb288-13"><a href="#cb288-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ensure guild is a factor for consistent plotting order and legend</span></span>
<span id="cb288-14"><a href="#cb288-14" aria-hidden="true" tabindex="-1"></a>  combined_vi_data<span class="sc">$</span>guild <span class="ot">&lt;-</span> <span class="fu">factor</span>(combined_vi_data<span class="sc">$</span>guild, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Anemonefish (Combined)"</span>, <span class="st">"Host Anemones"</span>))</span>
<span id="cb288-15"><a href="#cb288-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb288-16"><a href="#cb288-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb288-17"><a href="#cb288-17" aria-hidden="true" tabindex="-1"></a>  plot_vi_comparison <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(combined_vi_data, <span class="fu">aes</span>(<span class="at">x =</span> Variable, <span class="at">y =</span> Permutation_Importance, <span class="at">fill =</span> guild)) <span class="sc">+</span></span>
<span id="cb288-18"><a href="#cb288-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_boxplot</span>(<span class="at">alpha =</span> <span class="fl">0.8</span>, <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">preserve =</span> <span class="st">"single"</span>)) <span class="sc">+</span></span>
<span id="cb288-19"><a href="#cb288-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb288-20"><a href="#cb288-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Variable Importance Comparison between Guilds"</span>,</span>
<span id="cb288-21"><a href="#cb288-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Predictor Variable (PCA Component)"</span>, <span class="co"># Clarified x-axis</span></span>
<span id="cb288-22"><a href="#cb288-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"Permutation Importance (%)"</span></span>
<span id="cb288-23"><a href="#cb288-23" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb288-24"><a href="#cb288-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Host Anemones"</span> <span class="ot">=</span> <span class="st">"coral"</span>, <span class="st">"Anemonefish (Combined)"</span> <span class="ot">=</span> <span class="st">"steelblue"</span>), <span class="at">name =</span> <span class="st">"Guild"</span>) <span class="sc">+</span> <span class="co"># Matched factor levels</span></span>
<span id="cb288-25"><a href="#cb288-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb288-26"><a href="#cb288-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>), <span class="at">legend.position =</span> <span class="st">"top"</span>)</span>
<span id="cb288-27"><a href="#cb288-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb288-28"><a href="#cb288-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Print plot to RMarkdown output</span></span>
<span id="cb288-29"><a href="#cb288-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(plot_vi_comparison)</span>
<span id="cb288-30"><a href="#cb288-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb288-31"><a href="#cb288-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- ADD THIS SECTION TO SAVE plot_vi_comparison ---</span></span>
<span id="cb288-32"><a href="#cb288-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ensure figure_output_dir is defined (should be from setup chunk)</span></span>
<span id="cb288-33"><a href="#cb288-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"figure_output_dir"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">dir.exists</span>(figure_output_dir)) {</span>
<span id="cb288-34"><a href="#cb288-34" aria-hidden="true" tabindex="-1"></a>    vi_comparison_plot_filename <span class="ot">&lt;-</span> <span class="fu">file.path</span>(figure_output_dir, <span class="st">"variable_importance_comparison_guilds.png"</span>)</span>
<span id="cb288-35"><a href="#cb288-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggsave</span>(<span class="at">filename =</span> vi_comparison_plot_filename, </span>
<span id="cb288-36"><a href="#cb288-36" aria-hidden="true" tabindex="-1"></a>           <span class="at">plot =</span> plot_vi_comparison, </span>
<span id="cb288-37"><a href="#cb288-37" aria-hidden="true" tabindex="-1"></a>           <span class="at">width =</span> <span class="dv">8</span>, <span class="at">height =</span> <span class="dv">6</span>, <span class="at">units =</span> <span class="st">"in"</span>, <span class="at">dpi =</span> <span class="dv">300</span>) <span class="co"># Adjust dimensions/dpi as needed</span></span>
<span id="cb288-38"><a href="#cb288-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Saved variable importance comparison plot to:"</span>, vi_comparison_plot_filename, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb288-39"><a href="#cb288-39" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb288-40"><a href="#cb288-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Warning: 'figure_output_dir' not defined or does not exist. Variable importance plot not saved to file.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb288-41"><a href="#cb288-41" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb288-42"><a href="#cb288-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- </span><span class="re">END</span><span class="co"> OF ADDED SECTION ---</span></span>
<span id="cb288-43"><a href="#cb288-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb288-44"><a href="#cb288-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Perform t-tests for each predictor variable</span></span>
<span id="cb288-45"><a href="#cb288-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- T-tests for difference in Variable Importance between Guilds ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb288-46"><a href="#cb288-46" aria-hidden="true" tabindex="-1"></a>  predictor_vars_to_test <span class="ot">&lt;-</span> <span class="fu">unique</span>(combined_vi_data<span class="sc">$</span>Variable)</span>
<span id="cb288-47"><a href="#cb288-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb288-48"><a href="#cb288-48" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (var_name <span class="cf">in</span> predictor_vars_to_test) {</span>
<span id="cb288-49"><a href="#cb288-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"  Testing variable:"</span>, var_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb288-50"><a href="#cb288-50" aria-hidden="true" tabindex="-1"></a>    data_for_ttest <span class="ot">&lt;-</span> combined_vi_data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Variable <span class="sc">==</span> var_name)</span>
<span id="cb288-51"><a href="#cb288-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb288-52"><a href="#cb288-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if both guild levels are present with more than 1 observation each for the current variable</span></span>
<span id="cb288-53"><a href="#cb288-53" aria-hidden="true" tabindex="-1"></a>    guild_counts_for_var <span class="ot">&lt;-</span> data_for_ttest <span class="sc">%&gt;%</span> </span>
<span id="cb288-54"><a href="#cb288-54" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">group_by</span>(guild) <span class="sc">%&gt;%</span> </span>
<span id="cb288-55"><a href="#cb288-55" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">summarise</span>(<span class="at">n_obs =</span> <span class="fu">n</span>(), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb288-56"><a href="#cb288-56" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">filter</span>(n_obs <span class="sc">&gt;</span> <span class="dv">1</span>)</span>
<span id="cb288-57"><a href="#cb288-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb288-58"><a href="#cb288-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">nrow</span>(guild_counts_for_var) <span class="sc">==</span> <span class="dv">2</span>) { <span class="co"># Needs exactly two groups with &gt;1 obs each</span></span>
<span id="cb288-59"><a href="#cb288-59" aria-hidden="true" tabindex="-1"></a>      ttest_vi_result <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb288-60"><a href="#cb288-60" aria-hidden="true" tabindex="-1"></a>        <span class="fu">t.test</span>(Permutation_Importance <span class="sc">~</span> guild, <span class="at">data =</span> data_for_ttest)</span>
<span id="cb288-61"><a href="#cb288-61" aria-hidden="true" tabindex="-1"></a>      }, <span class="at">error =</span> <span class="cf">function</span>(e){</span>
<span id="cb288-62"><a href="#cb288-62" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"    Error in t-test for"</span>, var_name, <span class="st">":"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>); <span class="cn">NULL</span></span>
<span id="cb288-63"><a href="#cb288-63" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb288-64"><a href="#cb288-64" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(ttest_vi_result)) <span class="fu">print</span>(ttest_vi_result)</span>
<span id="cb288-65"><a href="#cb288-65" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb288-66"><a href="#cb288-66" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb288-67"><a href="#cb288-67" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"    Skipping t-test for"</span>, var_name, <span class="st">"- insufficient data or only one guild present for this variable after filtering.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb288-68"><a href="#cb288-68" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(data_for_ttest <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(guild) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">Count=</span><span class="fu">n</span>())) <span class="co"># Show counts for debugging</span></span>
<span id="cb288-69"><a href="#cb288-69" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb288-70"><a href="#cb288-70" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb288-71"><a href="#cb288-71" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb288-72"><a href="#cb288-72" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb288-73"><a href="#cb288-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Not enough variable importance data to compare between guilds.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb288-74"><a href="#cb288-74" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Combined VI data for comparison:
# A tibble: 6 Ã— 5
  Variable Permutation_Importance filename               species_sanitized guild
  &lt;chr&gt;                     &lt;dbl&gt; &lt;chr&gt;                  &lt;chr&gt;             &lt;chr&gt;
1 PC1                        75.4 VI_Cryptodendrum_adhaâ€¦ Cryptodendrum_adâ€¦ Hostâ€¦
2 PC2                        17.5 VI_Cryptodendrum_adhaâ€¦ Cryptodendrum_adâ€¦ Hostâ€¦
3 PC4                         6.1 VI_Cryptodendrum_adhaâ€¦ Cryptodendrum_adâ€¦ Hostâ€¦
4 PC3                         0.9 VI_Cryptodendrum_adhaâ€¦ Cryptodendrum_adâ€¦ Hostâ€¦
5 PC1                        78.5 VI_Entacmaea_quadricoâ€¦ Entacmaea_quadriâ€¦ Hostâ€¦
6 PC2                        10.1 VI_Entacmaea_quadricoâ€¦ Entacmaea_quadriâ€¦ Hostâ€¦</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="post_analysis_files/figure-html/variable-importance-comparison-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Saved variable importance comparison plot to: /home/bi-server-kyoto/a0236995/sdm_anemonefish/figure_files/variable_importance_comparison_guilds.png 

--- T-tests for difference in Variable Importance between Guilds ---
  Testing variable: PC1 

    Welch Two Sample t-test

data:  Permutation_Importance by guild
t = -3.0751, df = 34.118, p-value = 0.004126
alternative hypothesis: true difference in means between group Anemonefish (Combined) and group Host Anemones is not equal to 0
95 percent confidence interval:
 -30.514988  -6.232419
sample estimates:
mean in group Anemonefish (Combined)          mean in group Host Anemones 
                             64.1963                              82.5700 

  Testing variable: PC2 

    Welch Two Sample t-test

data:  Permutation_Importance by guild
t = 1.3376, df = 33.688, p-value = 0.19
alternative hypothesis: true difference in means between group Anemonefish (Combined) and group Host Anemones is not equal to 0
95 percent confidence interval:
 -3.265165 15.826646
sample estimates:
mean in group Anemonefish (Combined)          mean in group Host Anemones 
                            16.54074                             10.26000 

  Testing variable: PC4 

    Welch Two Sample t-test

data:  Permutation_Importance by guild
t = 1.3099, df = 33.684, p-value = 0.1991
alternative hypothesis: true difference in means between group Anemonefish (Combined) and group Host Anemones is not equal to 0
95 percent confidence interval:
 -2.016450  9.322376
sample estimates:
mean in group Anemonefish (Combined)          mean in group Host Anemones 
                            8.862963                             5.210000 

  Testing variable: PC3 

    Welch Two Sample t-test

data:  Permutation_Importance by guild
t = 2.3588, df = 28.522, p-value = 0.02541
alternative hypothesis: true difference in means between group Anemonefish (Combined) and group Host Anemones is not equal to 0
95 percent confidence interval:
  1.118441 15.788966
sample estimates:
mean in group Anemonefish (Combined)          mean in group Host Anemones 
                             10.4037                               1.9500 </code></pre>
</div>
</div>
</section>
<section id="variance-destabilization" class="level2">
<h2 class="anchored" data-anchor-id="variance-destabilization">Variance &amp; Destabilization</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb291"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb291-1"><a href="#cb291-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 5. Analysis of Response Heterogeneity (Variance of Delta D) ---</span></span>
<span id="cb291-2"><a href="#cb291-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Analyzing Variance of Overlap Change (Non-Linear Response) ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Analyzing Variance of Overlap Change (Non-Linear Response) ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb293"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb293-1"><a href="#cb293-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(car)</span>
<span id="cb293-2"><a href="#cb293-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb293-3"><a href="#cb293-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb293-4"><a href="#cb293-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb293-5"><a href="#cb293-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb293-6"><a href="#cb293-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb293-7"><a href="#cb293-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Prepare Data</span></span>
<span id="cb293-8"><a href="#cb293-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"overlap_wide"</span>)) <span class="fu">stop</span>(<span class="st">"overlap_wide dataframe missing. Run overlap calculation first."</span>)</span>
<span id="cb293-9"><a href="#cb293-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb293-10"><a href="#cb293-10" aria-hidden="true" tabindex="-1"></a>delta_df <span class="ot">&lt;-</span> overlap_wide <span class="sc">%&gt;%</span></span>
<span id="cb293-11"><a href="#cb293-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb293-12"><a href="#cb293-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">Delta_SSP119_2100 =</span> ssp119_2100 <span class="sc">-</span> current,</span>
<span id="cb293-13"><a href="#cb293-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">Delta_SSP585_2100 =</span> ssp585_2100 <span class="sc">-</span> current</span>
<span id="cb293-14"><a href="#cb293-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb293-15"><a href="#cb293-15" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(anemonefish_species, host_species, <span class="fu">starts_with</span>(<span class="st">"Delta_"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb293-16"><a href="#cb293-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">"Delta_"</span>), </span>
<span id="cb293-17"><a href="#cb293-17" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"Scenario"</span>, </span>
<span id="cb293-18"><a href="#cb293-18" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"Change_in_Overlap"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb293-19"><a href="#cb293-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Scenario_Label =</span> <span class="fu">ifelse</span>(<span class="fu">grepl</span>(<span class="st">"SSP585"</span>, Scenario), <span class="st">"High Emission (SSP5-8.5)"</span>, <span class="st">"Low Emission (SSP1-1.9)"</span>))</span>
<span id="cb293-20"><a href="#cb293-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb293-21"><a href="#cb293-21" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Statistical Test</span></span>
<span id="cb293-22"><a href="#cb293-22" aria-hidden="true" tabindex="-1"></a>levene_res <span class="ot">&lt;-</span> car<span class="sc">::</span><span class="fu">leveneTest</span>(Change_in_Overlap <span class="sc">~</span> Scenario, <span class="at">data =</span> delta_df)</span>
<span id="cb293-23"><a href="#cb293-23" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(levene_res)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Levene's Test for Homogeneity of Variance (center = median)
       Df F value Pr(&gt;F)
group   1  1.2965 0.2567
      146               </code></pre>
</div>
<div class="sourceCode cell-code" id="cb295"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb295-1"><a href="#cb295-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Visualization</span></span>
<span id="cb295-2"><a href="#cb295-2" aria-hidden="true" tabindex="-1"></a>p_stability <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(delta_df, <span class="fu">aes</span>(<span class="at">x =</span> Change_in_Overlap, <span class="at">fill =</span> Scenario_Label)) <span class="sc">+</span></span>
<span id="cb295-3"><a href="#cb295-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb295-4"><a href="#cb295-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">size =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb295-5"><a href="#cb295-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"High Emission (SSP5-8.5)"</span> <span class="ot">=</span> <span class="st">"#D55E00"</span>, <span class="st">"Low Emission (SSP1-1.9)"</span> <span class="ot">=</span> <span class="st">"#009E73"</span>)) <span class="sc">+</span></span>
<span id="cb295-6"><a href="#cb295-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb295-7"><a href="#cb295-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Destabilization of Mutualist Niches"</span>,</span>
<span id="cb295-8"><a href="#cb295-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Comparing variance in overlap change between emission scenarios"</span>,</span>
<span id="cb295-9"><a href="#cb295-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Change in Niche Overlap (Schoener's D)"</span>,</span>
<span id="cb295-10"><a href="#cb295-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Density"</span>,</span>
<span id="cb295-11"><a href="#cb295-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Scenario"</span></span>
<span id="cb295-12"><a href="#cb295-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb295-13"><a href="#cb295-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">14</span>) <span class="sc">+</span></span>
<span id="cb295-14"><a href="#cb295-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span>
<span id="cb295-15"><a href="#cb295-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-16"><a href="#cb295-16" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(p_stability)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="post_analysis_files/figure-html/variance-and-destabilization-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Analysis of response heterogeneity across emission scenarios.</figcaption>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb296"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb296-1"><a href="#cb296-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"figure_output_dir"</span>)) {</span>
<span id="cb296-2"><a href="#cb296-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="fu">file.path</span>(figure_output_dir, <span class="st">"Figure7_Destabilization_Analysis.png"</span>), p_stability, <span class="at">width =</span> <span class="dv">9</span>, <span class="at">height =</span> <span class="dv">6</span>)</span>
<span id="cb296-3"><a href="#cb296-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="centroid-shift" class="level2">
<h2 class="anchored" data-anchor-id="centroid-shift">Centroid Shift</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb297"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb297-1"><a href="#cb297-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 6. Centroid Shift Analysis ---</span></span>
<span id="cb297-2"><a href="#cb297-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Analyzing Range Centroid Shifts ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Analyzing Range Centroid Shifts ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb299"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb299-1"><a href="#cb299-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)</span>
<span id="cb299-2"><a href="#cb299-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(geosphere)</span>
<span id="cb299-3"><a href="#cb299-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb299-4"><a href="#cb299-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Helper function</span></span>
<span id="cb299-5"><a href="#cb299-5" aria-hidden="true" tabindex="-1"></a>get_centroid <span class="ot">&lt;-</span> <span class="cf">function</span>(raster_layer) {</span>
<span id="cb299-6"><a href="#cb299-6" aria-hidden="true" tabindex="-1"></a>  coords <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">xyFromCell</span>(raster_layer, <span class="dv">1</span><span class="sc">:</span><span class="fu">ncell</span>(raster_layer))</span>
<span id="cb299-7"><a href="#cb299-7" aria-hidden="true" tabindex="-1"></a>  vals <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">values</span>(raster_layer)</span>
<span id="cb299-8"><a href="#cb299-8" aria-hidden="true" tabindex="-1"></a>  valid <span class="ot">&lt;-</span> <span class="sc">!</span><span class="fu">is.na</span>(vals)</span>
<span id="cb299-9"><a href="#cb299-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">sum</span>(valid) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">return</span>(<span class="fu">c</span>(<span class="at">lon=</span><span class="cn">NA</span>, <span class="at">lat=</span><span class="cn">NA</span>))</span>
<span id="cb299-10"><a href="#cb299-10" aria-hidden="true" tabindex="-1"></a>  coords <span class="ot">&lt;-</span> coords[valid,]</span>
<span id="cb299-11"><a href="#cb299-11" aria-hidden="true" tabindex="-1"></a>  vals <span class="ot">&lt;-</span> vals[valid]</span>
<span id="cb299-12"><a href="#cb299-12" aria-hidden="true" tabindex="-1"></a>  w_lon <span class="ot">&lt;-</span> <span class="fu">sum</span>(coords[,<span class="dv">1</span>] <span class="sc">*</span> vals) <span class="sc">/</span> <span class="fu">sum</span>(vals)</span>
<span id="cb299-13"><a href="#cb299-13" aria-hidden="true" tabindex="-1"></a>  w_lat <span class="ot">&lt;-</span> <span class="fu">sum</span>(coords[,<span class="dv">2</span>] <span class="sc">*</span> vals) <span class="sc">/</span> <span class="fu">sum</span>(vals)</span>
<span id="cb299-14"><a href="#cb299-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">c</span>(<span class="at">lon =</span> w_lon, <span class="at">lat =</span> w_lat))</span>
<span id="cb299-15"><a href="#cb299-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb299-16"><a href="#cb299-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb299-17"><a href="#cb299-17" aria-hidden="true" tabindex="-1"></a>results_centroid <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb299-18"><a href="#cb299-18" aria-hidden="true" tabindex="-1"></a>test_scenario <span class="ot">&lt;-</span> <span class="st">"ssp585_2100"</span> </span>
<span id="cb299-19"><a href="#cb299-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb299-20"><a href="#cb299-20" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">exists</span>(<span class="st">"filtered_anemonefish_host_pairs"</span>)) {</span>
<span id="cb299-21"><a href="#cb299-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(filtered_anemonefish_host_pairs)) {</span>
<span id="cb299-22"><a href="#cb299-22" aria-hidden="true" tabindex="-1"></a>    fish_name <span class="ot">&lt;-</span> filtered_anemonefish_host_pairs<span class="sc">$</span>Anemonefish[i]</span>
<span id="cb299-23"><a href="#cb299-23" aria-hidden="true" tabindex="-1"></a>    host_name <span class="ot">&lt;-</span> filtered_anemonefish_host_pairs<span class="sc">$</span>HostAnemone[i]</span>
<span id="cb299-24"><a href="#cb299-24" aria-hidden="true" tabindex="-1"></a>    host_name_sanitized <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">"_"</span>, host_name)</span>
<span id="cb299-25"><a href="#cb299-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb299-26"><a href="#cb299-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(host_pred_stack_current[[host_name_sanitized]]) <span class="sc">&amp;&amp;</span> </span>
<span id="cb299-27"><a href="#cb299-27" aria-hidden="true" tabindex="-1"></a>       <span class="sc">!</span><span class="fu">is.null</span>(fish_pred_stack_current[[fish_name]])) {</span>
<span id="cb299-28"><a href="#cb299-28" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb299-29"><a href="#cb299-29" aria-hidden="true" tabindex="-1"></a>      c_host_curr <span class="ot">&lt;-</span> <span class="fu">get_centroid</span>(host_pred_stack_current[[host_name_sanitized]])</span>
<span id="cb299-30"><a href="#cb299-30" aria-hidden="true" tabindex="-1"></a>      c_fish_curr <span class="ot">&lt;-</span> <span class="fu">get_centroid</span>(fish_pred_stack_current[[fish_name]])</span>
<span id="cb299-31"><a href="#cb299-31" aria-hidden="true" tabindex="-1"></a>      c_host_fut <span class="ot">&lt;-</span> <span class="fu">get_centroid</span>(host_pred_stacks_future_individual[[test_scenario]][[host_name_sanitized]])</span>
<span id="cb299-32"><a href="#cb299-32" aria-hidden="true" tabindex="-1"></a>      c_fish_fut <span class="ot">&lt;-</span> <span class="fu">get_centroid</span>(fish_pred_stacks_future_individual[[test_scenario]][[fish_name]])</span>
<span id="cb299-33"><a href="#cb299-33" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb299-34"><a href="#cb299-34" aria-hidden="true" tabindex="-1"></a>      dist_host <span class="ot">&lt;-</span> <span class="fu">distVincentySphere</span>(c_host_curr, c_host_fut) <span class="sc">/</span> <span class="dv">1000</span></span>
<span id="cb299-35"><a href="#cb299-35" aria-hidden="true" tabindex="-1"></a>      dist_fish <span class="ot">&lt;-</span> <span class="fu">distVincentySphere</span>(c_fish_curr, c_fish_fut) <span class="sc">/</span> <span class="dv">1000</span></span>
<span id="cb299-36"><a href="#cb299-36" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb299-37"><a href="#cb299-37" aria-hidden="true" tabindex="-1"></a>      results_centroid <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results_centroid, <span class="fu">data.frame</span>(</span>
<span id="cb299-38"><a href="#cb299-38" aria-hidden="true" tabindex="-1"></a>        <span class="at">fish =</span> fish_name, <span class="at">host =</span> host_name, <span class="at">dist_host_km =</span> dist_host, <span class="at">dist_fish_km =</span> dist_fish</span>
<span id="cb299-39"><a href="#cb299-39" aria-hidden="true" tabindex="-1"></a>      ))</span>
<span id="cb299-40"><a href="#cb299-40" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb299-41"><a href="#cb299-41" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb299-42"><a href="#cb299-42" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb299-43"><a href="#cb299-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb299-44"><a href="#cb299-44" aria-hidden="true" tabindex="-1"></a>p_migration <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(results_centroid, <span class="fu">aes</span>(<span class="at">x =</span> dist_host_km, <span class="at">y =</span> dist_fish_km)) <span class="sc">+</span></span>
<span id="cb299-45"><a href="#cb299-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb299-46"><a href="#cb299-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb299-47"><a href="#cb299-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb299-48"><a href="#cb299-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Co-Migration of Anemonefish and Hosts"</span>,</span>
<span id="cb299-49"><a href="#cb299-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Comparison of centroid shifts under SSP5-8.5 (2100)"</span>,</span>
<span id="cb299-50"><a href="#cb299-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Host Range Shift (km)"</span>, <span class="at">y =</span> <span class="st">"Fish Range Shift (km)"</span></span>
<span id="cb299-51"><a href="#cb299-51" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb299-52"><a href="#cb299-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb299-53"><a href="#cb299-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb299-54"><a href="#cb299-54" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(p_migration)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="post_analysis_files/figure-html/centroid-shift-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Co-migration analysis of host and fish centroids.</figcaption>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb300"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb300-1"><a href="#cb300-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"figure_output_dir"</span>)) {</span>
<span id="cb300-2"><a href="#cb300-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="fu">file.path</span>(figure_output_dir, <span class="st">"Figure8_Centroid_Shift.png"</span>), p_migration, <span class="at">width =</span> <span class="dv">7</span>, <span class="at">height =</span> <span class="dv">6</span>)</span>
<span id="cb300-3"><a href="#cb300-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="analyzing-the-biotic-brake-env-vs.-combined-centroids" class="level2">
<h2 class="anchored" data-anchor-id="analyzing-the-biotic-brake-env-vs.-combined-centroids">Analyzing The Biotic Brake (Env vs.&nbsp;Combined Centroids)</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb301"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb301-1"><a href="#cb301-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Analyzing The Biotic Brake ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Analyzing The Biotic Brake ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb303"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb303-1"><a href="#cb303-1" aria-hidden="true" tabindex="-1"></a>brake_results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb303-2"><a href="#cb303-2" aria-hidden="true" tabindex="-1"></a>common_species <span class="ot">&lt;-</span> <span class="fu">intersect</span>(<span class="fu">names</span>(fish_pred_stack_current), </span>
<span id="cb303-3"><a href="#cb303-3" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">intersect</span>(<span class="fu">names</span>(fish_pred_stacks_future_individual[[test_scenario]]), </span>
<span id="cb303-4"><a href="#cb303-4" aria-hidden="true" tabindex="-1"></a>                                      <span class="fu">names</span>(fish_pred_stacks_future_env_only[[test_scenario]])))</span>
<span id="cb303-5"><a href="#cb303-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb303-6"><a href="#cb303-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(sp <span class="cf">in</span> common_species) {</span>
<span id="cb303-7"><a href="#cb303-7" aria-hidden="true" tabindex="-1"></a>  c_current <span class="ot">&lt;-</span> <span class="fu">get_centroid</span>(fish_pred_stack_current[[sp]])</span>
<span id="cb303-8"><a href="#cb303-8" aria-hidden="true" tabindex="-1"></a>  c_potential <span class="ot">&lt;-</span> <span class="fu">get_centroid</span>(fish_pred_stacks_future_env_only[[test_scenario]][[sp]])</span>
<span id="cb303-9"><a href="#cb303-9" aria-hidden="true" tabindex="-1"></a>  c_realized <span class="ot">&lt;-</span> <span class="fu">get_centroid</span>(fish_pred_stacks_future_individual[[test_scenario]][[sp]])</span>
<span id="cb303-10"><a href="#cb303-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb303-11"><a href="#cb303-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">any</span>(<span class="fu">is.na</span>(c_current)) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">any</span>(<span class="fu">is.na</span>(c_potential)) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">any</span>(<span class="fu">is.na</span>(c_realized))) {</span>
<span id="cb303-12"><a href="#cb303-12" aria-hidden="true" tabindex="-1"></a>    dist_pot <span class="ot">&lt;-</span> <span class="fu">distVincentySphere</span>(c_current, c_potential) <span class="sc">/</span> <span class="dv">1000</span></span>
<span id="cb303-13"><a href="#cb303-13" aria-hidden="true" tabindex="-1"></a>    dist_real <span class="ot">&lt;-</span> <span class="fu">distVincentySphere</span>(c_current, c_realized) <span class="sc">/</span> <span class="dv">1000</span></span>
<span id="cb303-14"><a href="#cb303-14" aria-hidden="true" tabindex="-1"></a>    brake_results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(brake_results, <span class="fu">data.frame</span>(</span>
<span id="cb303-15"><a href="#cb303-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">species =</span> sp, <span class="at">dist_potential =</span> dist_pot, <span class="at">dist_realized =</span> dist_real, </span>
<span id="cb303-16"><a href="#cb303-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">biotic_brake =</span> dist_pot <span class="sc">-</span> dist_real</span>
<span id="cb303-17"><a href="#cb303-17" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb303-18"><a href="#cb303-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb303-19"><a href="#cb303-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb303-20"><a href="#cb303-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb303-21"><a href="#cb303-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot A: Scatter</span></span>
<span id="cb303-22"><a href="#cb303-22" aria-hidden="true" tabindex="-1"></a>p_brake_scatter <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(brake_results, <span class="fu">aes</span>(<span class="at">x =</span> dist_potential, <span class="at">y =</span> dist_realized)) <span class="sc">+</span></span>
<span id="cb303-23"><a href="#cb303-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>, <span class="at">color =</span> <span class="st">"firebrick"</span>) <span class="sc">+</span></span>
<span id="cb303-24"><a href="#cb303-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb303-25"><a href="#cb303-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"The Biotic Brake Effect"</span>, <span class="at">x =</span> <span class="st">"Potential Shift (Climate Only)"</span>, <span class="at">y =</span> <span class="st">"Realized Shift (With Host)"</span>) <span class="sc">+</span></span>
<span id="cb303-26"><a href="#cb303-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">14</span>)</span>
<span id="cb303-27"><a href="#cb303-27" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(p_brake_scatter)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="post_analysis_files/figure-html/biotic-brake-analysis-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Quantification of the Biotic Brake effect.</figcaption>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb304"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb304-1"><a href="#cb304-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot B: Bar Chart</span></span>
<span id="cb304-2"><a href="#cb304-2" aria-hidden="true" tabindex="-1"></a>top_braked <span class="ot">&lt;-</span> brake_results <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(<span class="fu">desc</span>(biotic_brake)) <span class="sc">%&gt;%</span> <span class="fu">head</span>(<span class="dv">10</span>) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">species =</span> <span class="fu">gsub</span>(<span class="st">"_"</span>, <span class="st">" "</span>, species))</span>
<span id="cb304-3"><a href="#cb304-3" aria-hidden="true" tabindex="-1"></a>p_brake_bar <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(top_braked, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(species, biotic_brake), <span class="at">y =</span> biotic_brake)) <span class="sc">+</span></span>
<span id="cb304-4"><a href="#cb304-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">fill =</span> <span class="st">"firebrick"</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb304-5"><a href="#cb304-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb304-6"><a href="#cb304-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Top 10 Constrained Species"</span>, <span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">"Range Loss (km)"</span>) <span class="sc">+</span></span>
<span id="cb304-7"><a href="#cb304-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb304-8"><a href="#cb304-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"italic"</span>))</span>
<span id="cb304-9"><a href="#cb304-9" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(p_brake_bar)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="post_analysis_files/figure-html/biotic-brake-analysis-2.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Quantification of the Biotic Brake effect.</figcaption>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb305"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb305-1"><a href="#cb305-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"figure_output_dir"</span>)) {</span>
<span id="cb305-2"><a href="#cb305-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="fu">file.path</span>(figure_output_dir, <span class="st">"Figure9a_Biotic_Brake_Scatter.png"</span>), p_brake_scatter, <span class="at">width =</span> <span class="dv">8</span>, <span class="at">height =</span> <span class="dv">6</span>)</span>
<span id="cb305-3"><a href="#cb305-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="fu">file.path</span>(figure_output_dir, <span class="st">"Figure9b_Biotic_Brake_Bar.png"</span>), p_brake_bar, <span class="at">width =</span> <span class="dv">8</span>, <span class="at">height =</span> <span class="dv">6</span>)</span>
<span id="cb305-4"><a href="#cb305-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="synthesis" class="level2">
<h2 class="anchored" data-anchor-id="synthesis">Synthesis</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb306"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb306-1"><a href="#cb306-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Synthesis: Ghost Habitats &amp; Specialist Test ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Synthesis: Ghost Habitats &amp; Specialist Test ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb308"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb308-1"><a href="#cb308-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Ghost Habitat Map</span></span>
<span id="cb308-2"><a href="#cb308-2" aria-hidden="true" tabindex="-1"></a>target_sp <span class="ot">&lt;-</span> <span class="st">"Amphiprion_melanopus"</span> <span class="co"># Top braked species</span></span>
<span id="cb308-3"><a href="#cb308-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(fish_pred_stacks_future_env_only[[test_scenario]][[target_sp]])) {</span>
<span id="cb308-4"><a href="#cb308-4" aria-hidden="true" tabindex="-1"></a>  r_pot <span class="ot">&lt;-</span> fish_pred_stacks_future_env_only[[test_scenario]][[target_sp]]</span>
<span id="cb308-5"><a href="#cb308-5" aria-hidden="true" tabindex="-1"></a>  r_real <span class="ot">&lt;-</span> fish_pred_stacks_future_individual[[test_scenario]][[target_sp]]</span>
<span id="cb308-6"><a href="#cb308-6" aria-hidden="true" tabindex="-1"></a>  r_ghost <span class="ot">&lt;-</span> r_pot <span class="sc">-</span> r_real</span>
<span id="cb308-7"><a href="#cb308-7" aria-hidden="true" tabindex="-1"></a>  r_ghost[r_ghost <span class="sc">&lt;</span> <span class="fl">0.2</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span> </span>
<span id="cb308-8"><a href="#cb308-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb308-9"><a href="#cb308-9" aria-hidden="true" tabindex="-1"></a>  p_ghost <span class="ot">&lt;-</span> <span class="fu">plot_prediction_map</span>(r_ghost, <span class="fu">paste</span>(<span class="st">"Ghost Habitat:"</span>, target_sp), world_map_sf) <span class="sc">+</span></span>
<span id="cb308-10"><a href="#cb308-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_viridis_c</span>(<span class="at">option =</span> <span class="st">"magma"</span>, <span class="at">name =</span> <span class="st">"Lost Suitability"</span>, <span class="at">na.value =</span> <span class="st">"transparent"</span>)</span>
<span id="cb308-11"><a href="#cb308-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(p_ghost)</span>
<span id="cb308-12"><a href="#cb308-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb308-13"><a href="#cb308-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"figure_output_dir"</span>)) {</span>
<span id="cb308-14"><a href="#cb308-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggsave</span>(<span class="fu">file.path</span>(figure_output_dir, <span class="st">"Figure10_Ghost_Habitat.png"</span>), p_ghost, <span class="at">width =</span> <span class="dv">10</span>, <span class="at">height =</span> <span class="dv">7</span>)</span>
<span id="cb308-15"><a href="#cb308-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb308-16"><a href="#cb308-16" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="post_analysis_files/figure-html/synthesis-overhaul-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Spatial visualization of lost habitat and test of specialization effect.</figcaption>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb309"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb309-1"><a href="#cb309-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Specialist Trap Test</span></span>
<span id="cb309-2"><a href="#cb309-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">exists</span>(<span class="st">"anemonefish_specialization_df"</span>)) {</span>
<span id="cb309-3"><a href="#cb309-3" aria-hidden="true" tabindex="-1"></a>  brake_analysis_df <span class="ot">&lt;-</span> brake_results <span class="sc">%&gt;%</span></span>
<span id="cb309-4"><a href="#cb309-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(anemonefish_specialization_df, <span class="at">by =</span> <span class="st">"species"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb309-5"><a href="#cb309-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(specialization_type))</span>
<span id="cb309-6"><a href="#cb309-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb309-7"><a href="#cb309-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Visualization</span></span>
<span id="cb309-8"><a href="#cb309-8" aria-hidden="true" tabindex="-1"></a>  p_guild <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(brake_analysis_df, <span class="fu">aes</span>(<span class="at">x =</span> specialization_type, <span class="at">y =</span> biotic_brake, <span class="at">fill =</span> specialization_type)) <span class="sc">+</span></span>
<span id="cb309-9"><a href="#cb309-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_boxplot</span>(<span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span> <span class="fu">geom_jitter</span>(<span class="at">width =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb309-10"><a href="#cb309-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Biotic Brake by Guild"</span>, <span class="at">x =</span> <span class="st">"Guild"</span>, <span class="at">y =</span> <span class="st">"Range Loss (km)"</span>) <span class="sc">+</span></span>
<span id="cb309-11"><a href="#cb309-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="cb309-12"><a href="#cb309-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(p_guild)</span>
<span id="cb309-13"><a href="#cb309-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb309-14"><a href="#cb309-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Statistical Test</span></span>
<span id="cb309-15"><a href="#cb309-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">t.test</span>(biotic_brake <span class="sc">~</span> specialization_type, <span class="at">data =</span> brake_analysis_df))</span>
<span id="cb309-16"><a href="#cb309-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb309-17"><a href="#cb309-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"figure_output_dir"</span>)) {</span>
<span id="cb309-18"><a href="#cb309-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggsave</span>(<span class="fu">file.path</span>(figure_output_dir, <span class="st">"Figure11_Brake_vs_Specialization.png"</span>), p_guild, <span class="at">width =</span> <span class="dv">6</span>, <span class="at">height =</span> <span class="dv">6</span>)</span>
<span id="cb309-19"><a href="#cb309-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb309-20"><a href="#cb309-20" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Welch Two Sample t-test

data:  biotic_brake by specialization_type
t = 0.66738, df = 8.9483, p-value = 0.5214
alternative hypothesis: true difference in means between group Generalist and group Specialist is not equal to 0
95 percent confidence interval:
 -265.5847  487.5889
sample estimates:
mean in group Generalist mean in group Specialist 
                351.7483                 240.7462 </code></pre>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="post_analysis_files/figure-html/synthesis-overhaul-2.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Spatial visualization of lost habitat and test of specialization effect.</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "î§‹";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>