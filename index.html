<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Anemonefish Mutualism Analysis Results</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="index_files/libs/clipboard/clipboard.min.js"></script>
<script src="index_files/libs/quarto-html/quarto.js"></script>
<script src="index_files/libs/quarto-html/popper.min.js"></script>
<script src="index_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="index_files/libs/quarto-html/anchor.min.js"></script>
<link href="index_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="index_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="index_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="index_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="index_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Anemonefish Mutualism Analysis Results</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="drivers-of-host-sea-anemone-and-anemonefish-richness" class="level1">
<h1>Drivers of Host Sea Anemone and Anemonefish Richness</h1>
<p>This section replicates the initial data loading and processing steps from the desert ant paperâ€™s results section, adapted for the anemonefish-anemone mutualism. We load the current predicted suitability rasters for host sea anemones and anemonefish (environmental-only models), calculate community richness, and crop them to the Indo-Pacific study area.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Using pacman for streamlined package management</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"pacman"</span>)) <span class="fu">install.packages</span>(<span class="st">"pacman"</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(here, dplyr, terra, sf, stringr, ggplot2, readr, tools, naturalearth, tidyterra)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Load project configuration</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure your working directory is the root of your sdm_anemonefish project</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(<span class="st">"scripts/config.R"</span>)) {</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">source</span>(<span class="st">"scripts/config.R"</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">file.exists</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"scripts/config.R"</span>))) {</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">source</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"scripts/config.R"</span>))</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"FATAL: Configuration file 'scripts/config.R' not found. Please set your working directory to the project root."</span>)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Configuration loaded and bundled into 'config' list.
Base directory: /home/bi-server-kyoto/a0236995/sdm_anemonefish 
Intermediate SDM Output Dir: /home/bi-server-kyoto/a0236995/sdm_anemonefish/data/sdm_output_intermediate 
Intermediate Models Dir: /home/bi-server-kyoto/a0236995/sdm_anemonefish/data/sdm_output_intermediate/models 
Intermediate Results Dir: /home/bi-server-kyoto/a0236995/sdm_anemonefish/data/sdm_output_intermediate/results 
Target Prediction Base: /home/bi-server-kyoto/a0236995/sdm_anemonefish/data/output/predictions 
Target Results Base: /home/bi-server-kyoto/a0236995/sdm_anemonefish/predictions 
Logging to file: /home/bi-server-kyoto/a0236995/sdm_anemonefish/data/sdm_output_intermediate/logs_and_analysis/sdm_run_20250803_170906.log (Level: INFO Append: TRUE )
Logging to console: TRUE (Level: INFO )
Parallel execution: TRUE with 31 cores.
Using predictors: PCA </code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"config"</span>)) <span class="fu">stop</span>(<span class="st">"FATAL: 'config' list not found after sourcing config.R"</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Helper function for constructing prediction filenames (already in your sdm_modeling_helpers.R)</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Make sure this helper is sourced or defined if not running the full pipeline before this</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(config<span class="sc">$</span>helpers_dir, <span class="st">"sdm_modeling_helpers.R"</span>)) <span class="co"># If needed</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>construct_mean_prediction_filename <span class="ot">&lt;-</span> <span class="cf">function</span>(species_name_sanitized, scenario_name, predictor_type_suffix, config) {</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># base_filename &lt;- paste0(config$global_seed, "-pred_", species_name_sanitized) # Using SDMtune mean convention implicitly</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># base_filename &lt;- paste0("mean_pred_", species_name_sanitized) # Using SDMtune mean convention implicitly</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># base_filename &lt;- paste0("501-pred_", species_name_sanitized) # Using SDMtune mean convention implicitly</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  base_filename <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"1-pred_"</span>, species_name_sanitized) <span class="co"># Using SDMtune mean convention implicitly</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  target_dir <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  target_filename_stem <span class="ot">&lt;-</span> <span class="cn">NULL</span> <span class="co"># Filename without extension</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (scenario_name <span class="sc">==</span> <span class="st">"current"</span>) {</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    target_dir <span class="ot">&lt;-</span> config<span class="sc">$</span>target_predictions_current_dir</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    target_filename_stem <span class="ot">&lt;-</span> <span class="fu">paste0</span>(base_filename, predictor_type_suffix) <span class="co"># Add suffix</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    ssp_dir_name <span class="ot">&lt;-</span> config<span class="sc">$</span>ssp_scenario_map[[scenario_name]]</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(ssp_dir_name)) { <span class="fu">warning</span>(<span class="st">"No SSP directory mapping for scenario: "</span>, scenario_name, <span class="at">call. =</span> <span class="cn">FALSE</span>); <span class="fu">return</span>(<span class="cn">NULL</span>) }</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    target_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(config<span class="sc">$</span>target_predictions_future_base, ssp_dir_name)</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    time_tag_clean <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">grepl</span>(<span class="st">"2050$"</span>, scenario_name), <span class="st">"dec50"</span>, <span class="fu">ifelse</span>(<span class="fu">grepl</span>(<span class="st">"2100$"</span>, scenario_name), <span class="st">"dec100"</span>, <span class="st">"UNKNOWN"</span>))</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(time_tag_clean <span class="sc">==</span> <span class="st">"UNKNOWN"</span>) { <span class="fu">warning</span>(<span class="st">"Cannot extract time tag from scenario: "</span>, scenario_name, <span class="at">call. =</span> <span class="cn">FALSE</span>); <span class="fu">return</span>(<span class="cn">NULL</span>) }</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    target_filename_stem <span class="ot">&lt;-</span> <span class="fu">paste0</span>(base_filename, <span class="st">"_"</span>, ssp_dir_name, <span class="st">"_"</span>, time_tag_clean, predictor_type_suffix) <span class="co"># Add suffix</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(target_dir) <span class="sc">||</span> <span class="fu">is.null</span>(target_filename_stem)) { <span class="fu">warning</span>(<span class="st">"Could not construct target path components."</span>, <span class="at">call. =</span> <span class="cn">FALSE</span>); <span class="fu">return</span>(<span class="cn">NULL</span>) }</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>  target_filename <span class="ot">&lt;-</span> <span class="fu">paste0</span>(target_filename_stem, <span class="st">".tif"</span>)</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">file.path</span>(target_dir, target_filename))</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Create Essential Output Directories ---</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a><span class="co"># This assumes config$base_dir is correctly defined in your config.R as the project root</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a><span class="co"># and you want to create directories relative to that.</span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Directory for general analysis outputs (like CSV summaries)</span></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>analysis_output_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(config<span class="sc">$</span>base_dir, <span class="st">"outputs_for_analysis"</span>)</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(analysis_output_dir)) {</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dir.create</span>(analysis_output_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Created directory for analysis outputs at:"</span>, analysis_output_dir, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Directory for figures</span></span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>figure_output_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(config<span class="sc">$</span>base_dir, <span class="st">"figure_files"</span>)</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(figure_output_dir)) {</span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dir.create</span>(figure_output_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Created directory for figures at:"</span>, figure_output_dir, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a><span class="co"># You can add other commonly used output directories here if needed.</span></span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a><span class="co"># For example, if you have a specific place for model objects:</span></span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a><span class="co"># model_objects_dir &lt;- file.path(config$base_dir, "model_objects")</span></span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a><span class="co"># if (!dir.exists(model_objects_dir)) {</span></span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a><span class="co">#   dir.create(model_objects_dir, recursive = TRUE)</span></span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a><span class="co">#   cat("Created directory for model objects at:", model_objects_dir, "\n")</span></span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"--- Setup: Essential output directories checked/created. ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- Setup: Essential output directories checked/created. ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Scenario Label Converter (Good to have this defined early) ---</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>scenario_label_converter <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"current"</span>     <span class="ot">=</span> <span class="st">"Current"</span>,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ssp119_2050"</span> <span class="ot">=</span> <span class="st">"SSP1-1.9 (2050)"</span>,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ssp119_2100"</span> <span class="ot">=</span> <span class="st">"SSP1-1.9 (2100)"</span>,</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ssp245_2050"</span> <span class="ot">=</span> <span class="st">"SSP2-4.5 (2050)"</span>, </span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ssp245_2100"</span> <span class="ot">=</span> <span class="st">"SSP2-4.5 (2100)"</span>, </span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ssp370_2050"</span> <span class="ot">=</span> <span class="st">"SSP3-7.0 (2050)"</span>, </span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ssp370_2100"</span> <span class="ot">=</span> <span class="st">"SSP3-7.0 (2100)"</span>, </span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ssp585_2050"</span> <span class="ot">=</span> <span class="st">"SSP5-8.5 (2050)"</span>,</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ssp585_2100"</span> <span class="ot">=</span> <span class="st">"SSP5-8.5 (2100)"</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add any other scenarios your project uses</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="co">#' Construct Target Prediction Filename</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="co">#' Builds the expected filename and path for a prediction raster based on target structure.</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="co">#' Used for checking if a prediction file already exists.</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param species_name_sanitized Sanitized species name (e.g., "Genus_species").</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param scenario_name The name of the scenario (e.g., "current", "ssp119_2050").</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param predictor_type_suffix Suffix indicating model type (e.g., "_pca", "_combined_pca").</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param config The configuration list.</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return Character string with the full path to the expected prediction file.</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>construct_mean_prediction_filename <span class="ot">&lt;-</span> <span class="cf">function</span>(species_name_sanitized, scenario_name, predictor_type_suffix, config) {</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>  base_filename <span class="ot">&lt;-</span> <span class="fu">paste0</span>(config<span class="sc">$</span>global_seed, <span class="st">"-pred_"</span>, species_name_sanitized) <span class="co"># Using SDMtune mean convention implicitly</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># base_filename &lt;- paste0("mean_pred_", species_name_sanitized) # Using SDMtune mean convention implicitly</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># base_filename &lt;- paste0(501, "-pred_", species_name_sanitized)</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>  target_dir <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>  target_filename_stem <span class="ot">&lt;-</span> <span class="cn">NULL</span> <span class="co"># Filename without extension</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (scenario_name <span class="sc">==</span> <span class="st">"current"</span>) {</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>    target_dir <span class="ot">&lt;-</span> config<span class="sc">$</span>target_predictions_current_dir</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>    target_filename_stem <span class="ot">&lt;-</span> <span class="fu">paste0</span>(base_filename, predictor_type_suffix) <span class="co"># Add suffix</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>    ssp_dir_name <span class="ot">&lt;-</span> config<span class="sc">$</span>ssp_scenario_map[[scenario_name]]</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(ssp_dir_name)) { <span class="fu">warning</span>(<span class="st">"No SSP directory mapping for scenario: "</span>, scenario_name, <span class="at">call. =</span> <span class="cn">FALSE</span>); <span class="fu">return</span>(<span class="cn">NULL</span>) }</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>    target_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(config<span class="sc">$</span>target_predictions_future_base, ssp_dir_name)</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>    time_tag_clean <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">grepl</span>(<span class="st">"2050$"</span>, scenario_name), <span class="st">"dec50"</span>, <span class="fu">ifelse</span>(<span class="fu">grepl</span>(<span class="st">"2100$"</span>, scenario_name), <span class="st">"dec100"</span>, <span class="st">"UNKNOWN"</span>))</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(time_tag_clean <span class="sc">==</span> <span class="st">"UNKNOWN"</span>) { <span class="fu">warning</span>(<span class="st">"Cannot extract time tag from scenario: "</span>, scenario_name, <span class="at">call. =</span> <span class="cn">FALSE</span>); <span class="fu">return</span>(<span class="cn">NULL</span>) }</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>    target_filename_stem <span class="ot">&lt;-</span> <span class="fu">paste0</span>(base_filename, <span class="st">"_"</span>, ssp_dir_name, <span class="st">"_"</span>, time_tag_clean, predictor_type_suffix) <span class="co"># Add suffix</span></span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(target_dir) <span class="sc">||</span> <span class="fu">is.null</span>(target_filename_stem)) { <span class="fu">warning</span>(<span class="st">"Could not construct target path components."</span>, <span class="at">call. =</span> <span class="cn">FALSE</span>); <span class="fu">return</span>(<span class="cn">NULL</span>) }</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>  target_filename <span class="ot">&lt;-</span> <span class="fu">paste0</span>(target_filename_stem, <span class="st">".tif"</span>)</span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">file.path</span>(target_dir, target_filename))</span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"--- Setup: Scenario label converter defined. ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- Setup: Scenario label converter defined. ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Load a world map for plotting ---</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>world_map_sf <span class="ot">&lt;-</span> rnaturalearth<span class="sc">::</span><span class="fu">ne_countries</span>(<span class="at">scale =</span> <span class="st">"medium"</span>, <span class="at">returnclass =</span> <span class="st">"sf"</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"--- Setup: World map loaded for plotting. ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- Setup: World map loaded for plotting. ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>bathymetry_raster_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(config<span class="sc">$</span>base_dir, <span class="st">"data"</span>, <span class="st">"env"</span>, <span class="st">"terrain"</span>, <span class="st">"bathymetry_mean.tif"</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>global_bathymetry <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(bathymetry_raster_path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Master Species Lists for Analysis ---</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Comment out any species you wish to EXCLUDE from all subsequent analyses.</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co"># -- Host Anemone Species to Include --</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>include_anemones <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Entacmaea quadricolor"</span>,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Radianthus crispa"</span>,</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Radianthus magnifica"</span>,</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Stichodactyla gigantea"</span>,</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Cryptodendrum adhaesivum"</span>,</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Macrodactyla doreensis"</span>,</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Stichodactyla mertensii"</span>,</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Stichodactyla haddoni"</span>,</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Radianthus malu"</span>,</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Heteractis aurora"</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="co"># -- Anemonefish Species to Include --</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>include_anemonefish <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion clarkii"</span>,</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion frenatus"</span>,</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion ocellaris"</span>,</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion perideraion"</span>,</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion polymnus"</span>,</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion sandaracinos"</span>,</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion akallopisos"</span>,</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion omanensis"</span>,</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion akindynos"</span>,</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion allardi"</span>,</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion barberi"</span>,</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion bicinctus"</span>,</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion chagosensis"</span>,</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion chrysogaster"</span>,</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion chrysopterus"</span>,</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion ephippium"</span>,</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion fuscocaudatus"</span>,</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion latezonatus"</span>,</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion latifasciatus"</span>,</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion leucokranos"</span>,</span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion mccullochi"</span>,</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion melanopus"</span>,</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion nigripes"</span>,</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion percula"</span>,</span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion rubrocinctus"</span>,</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion sebae"</span>,</span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion tricinctus"</span>,</span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Premnas biaculeatus"</span>,</span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion pacificus"</span></span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Load and Filter the Main Data Frames ---</span></span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a><span class="co"># This part reads the full CSVs (created by script 02) and filters them.</span></span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a><span class="co"># The filtered data frames will be used by all subsequent chunks.</span></span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a><span class="co"># Load Anemones</span></span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>anemone_species_df_full <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(config<span class="sc">$</span>anemone_species_list_file, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>anemone_species_df <span class="ot">&lt;-</span> anemone_species_df_full <span class="sc">%&gt;%</span></span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(scientificName <span class="sc">%in%</span> include_anemones)</span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Filtered Host Anemones: Retaining %d of %d species for analysis.</span><span class="sc">\n</span><span class="st">"</span>, </span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a>            <span class="fu">nrow</span>(anemone_species_df), <span class="fu">nrow</span>(anemone_species_df_full)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Filtered Host Anemones: Retaining 10 of 10 species for analysis.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load Anemonefish</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>anemonefish_species_df_full <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(config<span class="sc">$</span>anemonefish_species_list_file, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>anemonefish_species_df <span class="ot">&lt;-</span> anemonefish_species_df_full <span class="sc">%&gt;%</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(scientificName <span class="sc">%in%</span> include_anemonefish)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Filtered Anemonefish: Retaining %d of %d species for analysis.</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>            <span class="fu">nrow</span>(anemonefish_species_df), <span class="fu">nrow</span>(anemonefish_species_df_full)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Filtered Anemonefish: Retaining 29 of 29 species for analysis.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Define Parameters ---</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>current_scenario_name <span class="ot">&lt;-</span> <span class="st">"current"</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co"># predictor_suffix &lt;- ifelse(config$use_pca_predictors, "_pca", "_vif")</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>predictor_suffix_anemone <span class="ot">&lt;-</span> <span class="st">"_pca"</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>predictor_suffix <span class="ot">&lt;-</span> <span class="st">"_combined_pca"</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 0. Create figure directory if it doesn't exist ---</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>figure_output_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(config<span class="sc">$</span>base_dir, <span class="st">"figure_files"</span>)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(figure_output_dir)) {</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dir.create</span>(figure_output_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Created directory for figures at:"</span>, figure_output_dir, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 1. Load Host Sea Anemone Data ---</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"--- Loading Host Sea Anemone Predictions (Current Scenario) ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- Loading Host Sea Anemone Predictions (Current Scenario) ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This assumes anemone_species_df is loaded and filtered from a previous chunk.</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>host_raster_files <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>host_short_names <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(anemone_species_df)) {</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  sp_name_sanitized <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">"_"</span>, anemone_species_df<span class="sc">$</span>scientificName[i])</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  pred_file_path <span class="ot">&lt;-</span> <span class="fu">construct_mean_prediction_filename</span>(</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">species_name_sanitized =</span> sp_name_sanitized,</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">scenario_name =</span> current_scenario_name,</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">predictor_type_suffix =</span> predictor_suffix_anemone, </span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">config =</span> config</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">file.exists</span>(pred_file_path)) {</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>    host_raster_files <span class="ot">&lt;-</span> <span class="fu">c</span>(host_raster_files, pred_file_path)</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    host_short_names <span class="ot">&lt;-</span> <span class="fu">c</span>(host_short_names, sp_name_sanitized) </span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Warning: Host prediction file not found for"</span>, sp_name_sanitized, <span class="st">"at"</span>, pred_file_path, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>host_pred_stack <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(host_raster_files) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>  host_pred_stack <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(host_raster_files)</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(host_pred_stack) <span class="ot">&lt;-</span> host_short_names</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Loaded"</span>, terra<span class="sc">::</span><span class="fu">nlyr</span>(host_pred_stack), <span class="st">"host anemone prediction rasters.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>  host_richness_sum <span class="ot">&lt;-</span> <span class="fu">sum</span>(host_pred_stack, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(host_richness_sum) <span class="ot">&lt;-</span> <span class="st">"HostAnemoneRichness"</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Calculated host anemone summed richness.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Error: No host anemone prediction rasters found. Cannot proceed with host richness.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>  host_richness_sum <span class="ot">&lt;-</span> <span class="cn">NULL</span> </span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Loaded 10 host anemone prediction rasters.
Calculated host anemone summed richness.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 2. Load Anemonefish (Environmental-Only Models) Data ---</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Loading Anemonefish (Env-Only) Predictions (Current Scenario) ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Loading Anemonefish (Env-Only) Predictions (Current Scenario) ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This assumes anemonefish_species_df is loaded and filtered from a previous chunk.</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>fish_raster_files <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>fish_short_names <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(anemonefish_species_df)) {</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  sp_name_sanitized <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">"_"</span>, anemonefish_species_df<span class="sc">$</span>scientificName[i])</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  pred_file_path <span class="ot">&lt;-</span> <span class="fu">construct_mean_prediction_filename</span>(</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">species_name_sanitized =</span> sp_name_sanitized,</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">scenario_name =</span> current_scenario_name,</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">predictor_type_suffix =</span> predictor_suffix, </span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">config =</span> config</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">file.exists</span>(pred_file_path)) {</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    fish_raster_files <span class="ot">&lt;-</span> <span class="fu">c</span>(fish_raster_files, pred_file_path)</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    fish_short_names <span class="ot">&lt;-</span> <span class="fu">c</span>(fish_short_names, sp_name_sanitized)</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Warning: Anemonefish (env-only) prediction file not found for"</span>, sp_name_sanitized, <span class="st">"at"</span>, pred_file_path, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Warning: Anemonefish (env-only) prediction file not found for Amphiprion_chagosensis at /home/bi-server-kyoto/a0236995/sdm_anemonefish/data/output/predictions/1-pred_Amphiprion_chagosensis_combined_pca.tif 
Warning: Anemonefish (env-only) prediction file not found for Amphiprion_mccullochi at /home/bi-server-kyoto/a0236995/sdm_anemonefish/data/output/predictions/1-pred_Amphiprion_mccullochi_combined_pca.tif 
Warning: Anemonefish (env-only) prediction file not found for Amphiprion_pacificus at /home/bi-server-kyoto/a0236995/sdm_anemonefish/data/output/predictions/1-pred_Amphiprion_pacificus_combined_pca.tif </code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>fish_pred_stack <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(fish_raster_files) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  fish_pred_stack <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(fish_raster_files)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(fish_pred_stack) <span class="ot">&lt;-</span> fish_short_names</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Loaded"</span>, terra<span class="sc">::</span><span class="fu">nlyr</span>(fish_pred_stack), <span class="st">"anemonefish (env-only) prediction rasters.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  fish_richness_sum <span class="ot">&lt;-</span> <span class="fu">sum</span>(fish_pred_stack, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(fish_richness_sum) <span class="ot">&lt;-</span> <span class="st">"AnemonefishRichness_EnvOnly"</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Calculated anemonefish (env-only) summed richness.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Error: No anemonefish (env-only) prediction rasters found. Cannot proceed with fish richness.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>  fish_richness_sum <span class="ot">&lt;-</span> <span class="cn">NULL</span> </span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Loaded 26 anemonefish (env-only) prediction rasters.
Calculated anemonefish (env-only) summed richness.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 3. Crop to Indo-Pacific Extent (if rasters were successfully loaded) ---</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Cropping Rasters to Indo-Pacific Extent ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Cropping Rasters to Indo-Pacific Extent ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (config<span class="sc">$</span>apply_indo_pacific_crop) {</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  ip_extent <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">ext</span>(config<span class="sc">$</span>indo_pacific_bbox)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Using Indo-Pacific Bounding Box for cropping:"</span>, <span class="fu">paste</span>(config<span class="sc">$</span>indo_pacific_bbox, <span class="at">collapse=</span><span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(host_pred_stack)) {</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    host_pred_stack_cropped <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(terra<span class="sc">::</span><span class="fu">crop</span>(host_pred_stack, ip_extent), <span class="at">error =</span> <span class="cf">function</span>(e) { <span class="fu">cat</span>(<span class="st">"Warning: Failed to crop host_pred_stack:"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>); host_pred_stack })</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> { host_pred_stack_cropped <span class="ot">&lt;-</span> <span class="cn">NULL</span> }</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(host_richness_sum)) {</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    host_richness_sum_cropped <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(terra<span class="sc">::</span><span class="fu">crop</span>(host_richness_sum, ip_extent), <span class="at">error =</span> <span class="cf">function</span>(e) { <span class="fu">cat</span>(<span class="st">"Warning: Failed to crop host_richness_sum:"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>); host_richness_sum })</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> { host_richness_sum_cropped <span class="ot">&lt;-</span> <span class="cn">NULL</span> }</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(fish_pred_stack)) {</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>    fish_pred_stack_cropped <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(terra<span class="sc">::</span><span class="fu">crop</span>(fish_pred_stack, ip_extent), <span class="at">error =</span> <span class="cf">function</span>(e) { <span class="fu">cat</span>(<span class="st">"Warning: Failed to crop fish_pred_stack:"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>); fish_pred_stack })</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> { fish_pred_stack_cropped <span class="ot">&lt;-</span> <span class="cn">NULL</span> }</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(fish_richness_sum)) {</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>    fish_richness_sum_cropped <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(terra<span class="sc">::</span><span class="fu">crop</span>(fish_richness_sum, ip_extent), <span class="at">error =</span> <span class="cf">function</span>(e) { <span class="fu">cat</span>(<span class="st">"Warning: Failed to crop fish_richness_sum:"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>); fish_richness_sum })</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> { fish_richness_sum_cropped <span class="ot">&lt;-</span> <span class="cn">NULL</span> }</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Cropping complete.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Skipping Indo-Pacific cropping based on config.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>  host_pred_stack_cropped <span class="ot">&lt;-</span> host_pred_stack</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>  host_richness_sum_cropped <span class="ot">&lt;-</span> host_richness_sum</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>  fish_pred_stack_cropped <span class="ot">&lt;-</span> fish_pred_stack</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>  fish_richness_sum_cropped <span class="ot">&lt;-</span> fish_richness_sum</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Using Indo-Pacific Bounding Box for cropping: 30, 180, -50, 50 
Cropping complete.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 4. Plot Cropped Richness Maps AND SAVE THEM ---</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Plotting and Saving Cropped Richness Maps ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Plotting and Saving Cropped Richness Maps ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(host_richness_sum_cropped)) {</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  host_plot_filename <span class="ot">&lt;-</span> <span class="fu">file.path</span>(figure_output_dir, <span class="st">"host_richness_current_cropped.png"</span>)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- MODIFIED: Use new plotting function for host richness ---</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Normalize richness values to a 0-1 scale for consistent coloring</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  max_host_rich <span class="ot">&lt;-</span> <span class="fu">global</span>(host_richness_sum_cropped, <span class="st">"max"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)<span class="sc">$</span>max</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>  host_richness_normalized <span class="ot">&lt;-</span> <span class="cf">if</span>(max_host_rich <span class="sc">&gt;</span> <span class="dv">0</span>) host_richness_sum_cropped <span class="sc">/</span> max_host_rich <span class="cf">else</span> host_richness_sum_cropped</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>  host_richness_plot <span class="ot">&lt;-</span> <span class="fu">plot_prediction_map</span>(</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">prediction_raster =</span> host_richness_normalized,</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">species_name =</span> <span class="st">"Summed Host Anemone Richness (Current, Cropped)"</span>,</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">world_basemap =</span> world_map_sf</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggsave</span>(host_plot_filename, <span class="at">plot =</span> host_richness_plot, <span class="at">width =</span> <span class="dv">10</span>, <span class="at">height =</span> <span class="dv">7</span>, <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">bg=</span><span class="st">"white"</span>)</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Saved host richness plot to:"</span>, host_plot_filename, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(host_richness_plot)</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Saved host richness plot to: /home/bi-server-kyoto/a0236995/sdm_anemonefish/figure_files/host_richness_current_cropped.png </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-and-process-rasters-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(fish_richness_sum_cropped)) {</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  fish_plot_filename <span class="ot">&lt;-</span> <span class="fu">file.path</span>(figure_output_dir, <span class="st">"fish_richness_current_env_only_cropped.png"</span>)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- MODIFIED: Use new plotting function for fish richness ---</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  max_fish_rich <span class="ot">&lt;-</span> <span class="fu">global</span>(fish_richness_sum_cropped, <span class="st">"max"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)<span class="sc">$</span>max</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>  fish_richness_normalized <span class="ot">&lt;-</span> <span class="cf">if</span>(max_fish_rich <span class="sc">&gt;</span> <span class="dv">0</span>) fish_richness_sum_cropped <span class="sc">/</span> max_fish_rich <span class="cf">else</span> fish_richness_sum_cropped</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>  fish_richness_plot <span class="ot">&lt;-</span> <span class="fu">plot_prediction_map</span>(</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">prediction_raster =</span> fish_richness_normalized,</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">species_name =</span> <span class="st">"Summed Anemonefish Richness (Current, Env-Only, Cropped)"</span>,</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">world_basemap =</span> world_map_sf</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggsave</span>(fish_plot_filename, <span class="at">plot =</span> fish_richness_plot, <span class="at">width =</span> <span class="dv">10</span>, <span class="at">height =</span> <span class="dv">7</span>, <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">bg=</span><span class="st">"white"</span>)</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Saved anemonefish richness plot to:"</span>, fish_plot_filename, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(fish_richness_plot)</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Saved anemonefish richness plot to: /home/bi-server-kyoto/a0236995/sdm_anemonefish/figure_files/fish_richness_current_env_only_cropped.png </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-and-process-rasters-2.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 5. Plot Cropped Individual Stacks with Occurrences (for display only) ---</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Displaying Individual Species Suitability Maps with Occurrences ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Displaying Individual Species Suitability Maps with Occurrences ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Optional: Plot cropped individual stacks if needed for visual check</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(host_pred_stack_cropped)) {</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">-- Host Anemone Individual Maps --</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nlyr</span>(host_pred_stack_cropped)) {</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    species_raster <span class="ot">&lt;-</span> host_pred_stack_cropped[[i]]</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    sp_name <span class="ot">&lt;-</span> <span class="fu">names</span>(species_raster)</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>    aphia_id <span class="ot">&lt;-</span> anemone_species_df<span class="sc">$</span>AphiaID[anemone_species_df<span class="sc">$</span>scientificName <span class="sc">==</span> <span class="fu">gsub</span>(<span class="st">"_"</span>, <span class="st">" "</span>, sp_name)]</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>    occ_sf <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(aphia_id) <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>      occ_file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(config<span class="sc">$</span>anemone_occurrence_dir, <span class="fu">paste0</span>(aphia_id, <span class="st">".csv"</span>))</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">file.exists</span>(occ_file)) {</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>        occ_df <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(occ_file, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(decimalLongitude) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(decimalLatitude))</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">nrow</span>(occ_df)<span class="sc">&gt;</span><span class="dv">0</span>) occ_sf <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_as_sf</span>(occ_df, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"decimalLongitude"</span>, <span class="st">"decimalLatitude"</span>), <span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="fu">plot_prediction_map</span>(species_raster, <span class="fu">gsub</span>(<span class="st">"_"</span>, <span class="st">" "</span>, sp_name), world_map_sf, occ_sf)</span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(p)</span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
-- Host Anemone Individual Maps --</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-and-process-rasters-3.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-and-process-rasters-4.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-and-process-rasters-5.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-and-process-rasters-6.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-and-process-rasters-7.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-and-process-rasters-8.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-and-process-rasters-9.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-and-process-rasters-10.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-and-process-rasters-11.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-and-process-rasters-12.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(fish_pred_stack_cropped)) {</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">-- Anemonefish (Env-Only) Individual Maps --</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nlyr</span>(fish_pred_stack_cropped)) {</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    species_raster <span class="ot">&lt;-</span> fish_pred_stack_cropped[[i]]</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    sp_name <span class="ot">&lt;-</span> <span class="fu">names</span>(species_raster)</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    aphia_id <span class="ot">&lt;-</span> anemonefish_species_df<span class="sc">$</span>AphiaID[anemonefish_species_df<span class="sc">$</span>scientificName <span class="sc">==</span> <span class="fu">gsub</span>(<span class="st">"_"</span>, <span class="st">" "</span>, sp_name)]</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    occ_sf <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(aphia_id) <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>      occ_file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(config<span class="sc">$</span>anemonefish_occurrence_dir, <span class="fu">paste0</span>(aphia_id, <span class="st">".csv"</span>))</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">file.exists</span>(occ_file)) {</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>        occ_df <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(occ_file, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(decimalLongitude) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(decimalLatitude))</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">nrow</span>(occ_df)<span class="sc">&gt;</span><span class="dv">0</span>) occ_sf <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_as_sf</span>(occ_df, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"decimalLongitude"</span>, <span class="st">"decimalLatitude"</span>), <span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="fu">plot_prediction_map</span>(species_raster, <span class="fu">gsub</span>(<span class="st">"_"</span>, <span class="st">" "</span>, sp_name), world_map_sf, occ_sf)</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(p)</span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
-- Anemonefish (Env-Only) Individual Maps --</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-and-process-rasters-13.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-and-process-rasters-14.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-and-process-rasters-15.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-and-process-rasters-16.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-and-process-rasters-17.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-and-process-rasters-18.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-and-process-rasters-19.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-and-process-rasters-20.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-and-process-rasters-21.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-and-process-rasters-22.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-and-process-rasters-23.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-and-process-rasters-24.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-and-process-rasters-25.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-and-process-rasters-26.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-and-process-rasters-27.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-and-process-rasters-28.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-and-process-rasters-29.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-and-process-rasters-30.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-and-process-rasters-31.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-and-process-rasters-32.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-and-process-rasters-33.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-and-process-rasters-34.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-and-process-rasters-35.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-and-process-rasters-36.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-and-process-rasters-37.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-and-process-rasters-38.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- First section of results processing finished. ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- First section of results processing finished. ---</code></pre>
</div>
</div>
<section id="evaluate-models" class="level2">
<h2 class="anchored" data-anchor-id="evaluate-models">Evaluate models</h2>
<p>This section loads the cross-validation (CV) results from the various SDM runs for host sea anemones and different types of anemonefish models (environmental-only, biotic-only, and combined environmental + biotic), focusing on AUC.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr) <span class="co"># For map_df</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr) <span class="co"># For data manipulation</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr) <span class="co"># For read_csv</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr) <span class="co"># For str_extract, str_remove</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 1. Load Host Sea Anemone CV Results ("Plants" equivalent) ---</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>host_predictor_suffix <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(config<span class="sc">$</span>use_pca_predictors, <span class="st">"_pca"</span>, <span class="st">"_vif"</span>)</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>host_cv_results_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(config<span class="sc">$</span>target_results_base, <span class="fu">paste0</span>(<span class="st">"anemone"</span>, host_predictor_suffix))</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Loading Host Sea Anemone CV results from:"</span>, host_cv_results_dir, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Loading Host Sea Anemone CV results from: /home/bi-server-kyoto/a0236995/sdm_anemonefish/predictions/anemone_pca </code></pre>
</div>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>host_cv_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(host_cv_results_dir,</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>                            <span class="at">pattern =</span> <span class="st">"^CV_Results_.*_depth_-750</span><span class="sc">\\</span><span class="st">.csv$"</span>,</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>                            <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(host_cv_files) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>  host_cv_data <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map_df</span>(host_cv_files, </span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>                <span class="sc">~</span>readr<span class="sc">::</span><span class="fu">read_csv</span>(.x, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">mutate</span>(<span class="at">filename_full =</span> .x, </span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>                          <span class="at">filename =</span> <span class="fu">basename</span>(.x),</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>                          <span class="at">SpeciesName =</span> <span class="fu">str_remove</span>(<span class="fu">str_extract</span>(<span class="fu">basename</span>(.x), <span class="st">"(?&lt;=CV_Results_).*(?=_depth)"</span>), <span class="st">"_pca|_vif"</span>))) <span class="co"># Extract species name cleanly</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>  host_model_evals <span class="ot">&lt;-</span> host_cv_data <span class="sc">%&gt;%</span></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(SpeciesName) <span class="sc">%&gt;%</span> <span class="co"># Group by SpeciesName for summary</span></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_AUC_test_CV =</span> <span class="fu">mean</span>(AUC_test_CV, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">sd_AUC_test_CV =</span> <span class="fu">sd</span>(AUC_test_CV, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_TSS_test_CV =</span> <span class="fu">mean</span>(TSS_test_CV, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="co"># ADDED TSS</span></span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">sd_TSS_test_CV =</span> <span class="fu">sd</span>(TSS_test_CV, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)     <span class="co"># ADDED TSS</span></span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), <span class="sc">~</span><span class="fu">round</span>(., <span class="dv">3</span>))) </span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">First few rows of Host Sea Anemone Model Evaluations (AUC and TSS):</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">head</span>(host_model_evals))</span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a>  host_cv_summary_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(config<span class="sc">$</span>base_dir, <span class="st">"outputs_for_analysis"</span>, <span class="st">"host_anemone_CV_summary_auc_tss.csv"</span>) <span class="co"># Renamed output file</span></span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dir.create</span>(<span class="fu">dirname</span>(host_cv_summary_path), <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>)</span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write.csv</span>(host_model_evals, host_cv_summary_path, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb44-28"><a href="#cb44-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Host Sea Anemone CV summary (AUC and TSS) saved to:"</span>, host_cv_summary_path, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb44-29"><a href="#cb44-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-30"><a href="#cb44-30" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb44-31"><a href="#cb44-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Warning: No CV_Results CSV files found for host sea anemones in"</span>, host_cv_results_dir, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb44-32"><a href="#cb44-32" aria-hidden="true" tabindex="-1"></a>  host_cv_data <span class="ot">&lt;-</span> <span class="cn">NULL</span> </span>
<span id="cb44-33"><a href="#cb44-33" aria-hidden="true" tabindex="-1"></a>  host_model_evals <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb44-34"><a href="#cb44-34" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
First few rows of Host Sea Anemone Model Evaluations (AUC and TSS):
# A tibble: 6 Ã— 5
  SpeciesName    mean_AUC_test_CV sd_AUC_test_CV mean_TSS_test_CV sd_TSS_test_CV
  &lt;chr&gt;                     &lt;dbl&gt;          &lt;dbl&gt;            &lt;dbl&gt;          &lt;dbl&gt;
1 Cryptodendrumâ€¦            0.896          0.033            0.701          0.053
2 Entacmaea_quaâ€¦            0.952          0.013            0.823          0.019
3 Heteractis_auâ€¦            0.896          0.012            0.773          0.023
4 Macrodactyla_â€¦            0.936          0.01             0.779          0.009
5 Radianthus_crâ€¦            0.867          0.025            0.696          0.045
6 Radianthus_maâ€¦            0.934          0.011            0.796          0.014

Host Sea Anemone CV summary (AUC and TSS) saved to: /home/bi-server-kyoto/a0236995/sdm_anemonefish/outputs_for_analysis/host_anemone_CV_summary_auc_tss.csv </code></pre>
</div>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 2. Load Anemonefish Environmental-Only CV Results ("Ants Climate-Only" equivalent) ---</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>fish_env_predictor_suffix <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(config<span class="sc">$</span>use_pca_predictors, <span class="st">"_pca"</span>, <span class="st">"_vif"</span>)</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>fish_env_cv_results_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(config<span class="sc">$</span>target_results_base, <span class="fu">paste0</span>(<span class="st">"anemonefish"</span>, fish_env_predictor_suffix))</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Loading Anemonefish (Environmental-Only) CV results from:"</span>, fish_env_cv_results_dir, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Loading Anemonefish (Environmental-Only) CV results from: /home/bi-server-kyoto/a0236995/sdm_anemonefish/predictions/anemonefish_pca </code></pre>
</div>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>fish_env_cv_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(fish_env_cv_results_dir,</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>                                <span class="at">pattern =</span> <span class="st">"^CV_Results_.*_depth_-750</span><span class="sc">\\</span><span class="st">.csv$"</span>,</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>                                <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(fish_env_cv_files) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>  fish_env_cv_data <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map_df</span>(fish_env_cv_files, </span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>                  <span class="sc">~</span>readr<span class="sc">::</span><span class="fu">read_csv</span>(.x, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">mutate</span>(<span class="at">filename_full =</span> .x,</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>                            <span class="at">filename =</span> <span class="fu">basename</span>(.x)))</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Loaded"</span>, <span class="fu">nrow</span>(fish_env_cv_data), <span class="st">"rows from"</span>, <span class="fu">length</span>(fish_env_cv_files), <span class="st">"anemonefish (env-only) CV files.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Showing a sample including TSS</span></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">head</span>(fish_env_cv_data <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(filename, AUC_test_CV, TSS_test_CV) <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(filename) <span class="sc">%&gt;%</span> <span class="fu">slice_head</span>(<span class="at">n=</span><span class="dv">1</span>), <span class="at">n=</span><span class="dv">3</span>)) </span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Warning: No CV_Results CSV files found for anemonefish (env-only) in"</span>, fish_env_cv_results_dir, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>  fish_env_cv_data <span class="ot">&lt;-</span> <span class="cn">NULL</span> </span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Loaded 408 rows from 27 anemonefish (env-only) CV files.
# A tibble: 3 Ã— 3
# Groups:   filename [3]
  filename                                         AUC_test_CV TSS_test_CV
  &lt;chr&gt;                                                  &lt;dbl&gt;       &lt;dbl&gt;
1 CV_Results_Amphiprion_akallopisos_depth_-750.csv       0.931       0.799
2 CV_Results_Amphiprion_akindynos_depth_-750.csv         0.973       0.919
3 CV_Results_Amphiprion_allardi_depth_-750.csv           0.984       0.955</code></pre>
</div>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 3. Load Anemonefish Biotic Model CV Results (Equivalent to "Ant Contrasts") ---</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>fish_biotic_only_suffix_config <span class="ot">&lt;-</span> <span class="st">"_biotic_only"</span> </span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>fish_biotic_only_cv_results_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(config<span class="sc">$</span>target_results_base, <span class="fu">paste0</span>(<span class="st">"anemonefish"</span>, fish_biotic_only_suffix_config))</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Loading Anemonefish (Biotic-Only) CV results from:"</span>, fish_biotic_only_cv_results_dir, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Loading Anemonefish (Biotic-Only) CV results from: /home/bi-server-kyoto/a0236995/sdm_anemonefish/predictions/anemonefish_biotic_only </code></pre>
</div>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>fish_biotic_only_cv_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(fish_biotic_only_cv_results_dir,</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">pattern =</span> <span class="st">"^CV_Results_.*</span><span class="sc">\\</span><span class="st">.csv$"</span>,</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(fish_biotic_only_cv_files) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>  anemonefish_biotic_cv_data <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map_df</span>(fish_biotic_only_cv_files, </span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>                <span class="sc">~</span>readr<span class="sc">::</span><span class="fu">read_csv</span>(.x, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">mutate</span>(<span class="at">filename_full =</span> .x,</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>                          <span class="at">filename =</span> <span class="fu">basename</span>(.x)))</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Loaded"</span>, <span class="fu">nrow</span>(anemonefish_biotic_cv_data), <span class="st">"rows from"</span>, <span class="fu">length</span>(fish_biotic_only_cv_files), <span class="st">"anemonefish (biotic-only) CV files.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Showing a sample including TSS</span></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">head</span>(anemonefish_biotic_cv_data <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(filename, AUC_test_CV, TSS_test_CV) <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(filename) <span class="sc">%&gt;%</span> <span class="fu">slice_head</span>(<span class="at">n=</span><span class="dv">1</span>), <span class="at">n=</span><span class="dv">3</span>)) </span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Warning: No CV_Results CSV files found for anemonefish (biotic-only) in"</span>, fish_biotic_only_cv_results_dir, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>  anemonefish_biotic_cv_data <span class="ot">&lt;-</span> <span class="cn">NULL</span> </span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Loaded 413 rows from 27 anemonefish (biotic-only) CV files.
# A tibble: 3 Ã— 3
# Groups:   filename [3]
  filename                                         AUC_test_CV TSS_test_CV
  &lt;chr&gt;                                                  &lt;dbl&gt;       &lt;dbl&gt;
1 CV_Results_Amphiprion_akallopisos_depth_-750.csv       0.912       0.765
2 CV_Results_Amphiprion_akindynos_depth_-750.csv         0.947       0.825
3 CV_Results_Amphiprion_allardi_depth_-750.csv           0.988       0.916</code></pre>
</div>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 3b. Combined Env+Biotic CV Results (from 06d)</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>fish_combined_suffix_config <span class="ot">&lt;-</span> <span class="st">"_combined_pca"</span> <span class="co"># Assuming this suffix for combined models</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>fish_combined_cv_results_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(config<span class="sc">$</span>target_results_base, <span class="fu">paste0</span>(<span class="st">"anemonefish"</span>, fish_combined_suffix_config))</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Loading Anemonefish (Combined Env+Biotic) CV results from:"</span>, fish_combined_cv_results_dir, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Loading Anemonefish (Combined Env+Biotic) CV results from: /home/bi-server-kyoto/a0236995/sdm_anemonefish/predictions/anemonefish_combined_pca </code></pre>
</div>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>fish_combined_cv_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(fish_combined_cv_results_dir,</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">pattern =</span> <span class="st">"^CV_Results_.*</span><span class="sc">\\</span><span class="st">.csv$"</span>,</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(fish_combined_cv_files) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>  anemonefish_combined_cv_data <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map_df</span>(fish_combined_cv_files, </span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>                <span class="sc">~</span>readr<span class="sc">::</span><span class="fu">read_csv</span>(.x, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">mutate</span>(<span class="at">filename_full =</span> .x,</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>                          <span class="at">filename =</span> <span class="fu">basename</span>(.x)))</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Loaded"</span>, <span class="fu">nrow</span>(anemonefish_combined_cv_data), <span class="st">"rows from"</span>, <span class="fu">length</span>(fish_combined_cv_files), <span class="st">"anemonefish (combined) CV files.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Showing a sample including TSS</span></span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">head</span>(anemonefish_combined_cv_data <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(filename, AUC_test_CV, TSS_test_CV) <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(filename) <span class="sc">%&gt;%</span> <span class="fu">slice_head</span>(<span class="at">n=</span><span class="dv">1</span>), <span class="at">n=</span><span class="dv">3</span>)) </span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Warning: No CV_Results CSV files found for anemonefish (combined) in"</span>, fish_combined_cv_results_dir, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>  anemonefish_combined_cv_data <span class="ot">&lt;-</span> <span class="cn">NULL</span> </span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Loaded 404 rows from 27 anemonefish (combined) CV files.
# A tibble: 3 Ã— 3
# Groups:   filename [3]
  filename                                         AUC_test_CV TSS_test_CV
  &lt;chr&gt;                                                  &lt;dbl&gt;       &lt;dbl&gt;
1 CV_Results_Amphiprion_akallopisos_depth_-750.csv       0.917       0.743
2 CV_Results_Amphiprion_akindynos_depth_-750.csv         0.977       0.924
3 CV_Results_Amphiprion_allardi_depth_-750.csv           0.994       0.945</code></pre>
</div>
</div>
</section>
<section id="collect-and-prepare-anemonefish-model-evaluation-data" class="level2">
<h2 class="anchored" data-anchor-id="collect-and-prepare-anemonefish-model-evaluation-data">Collect and Prepare Anemonefish Model Evaluation Data</h2>
<p>This section gathers the CV results from the different anemonefish model types (environmental-only, biotic-only, and combined host+environment), cleans the species names, and standardizes a â€˜model_typeâ€™ column for comparison.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr) <span class="co"># For separate (though not directly used in the final version, good to keep if you had other tidyr ops)</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr) <span class="co"># For string manipulation</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure df_fish_comparison is available from previous chunks or initialize as NULL</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a><span class="co"># This is a safeguard, but typically it should come from 'load-cv-results'</span></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"fish_env_cv_data"</span>)) fish_env_cv_data <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"anemonefish_biotic_cv_data"</span>)) anemonefish_biotic_cv_data <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"anemonefish_combined_cv_data"</span>)) anemonefish_combined_cv_data <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 1. Prepare Anemonefish Environmental-Only Data ---</span></span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(fish_env_cv_data) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(fish_env_cv_data) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>  fish_env_processed <span class="ot">&lt;-</span> fish_env_cv_data <span class="sc">%&gt;%</span></span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">species =</span> SpeciesName, <span class="co"># Assuming SpeciesName is already derived in load-cv-results</span></span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">model_type =</span> <span class="st">"env_only"</span></span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(species, model_type, AUC_test_CV, TSS_test_CV, filename_full)</span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Processed anemonefish environmental-only CV data.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Warning: fish_env_cv_data is empty or NULL. Cannot process environmental-only models.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb58-23"><a href="#cb58-23" aria-hidden="true" tabindex="-1"></a>  fish_env_processed <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb58-24"><a href="#cb58-24" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Processed anemonefish environmental-only CV data.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 2. Prepare Anemonefish Biotic-Only Data ---</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(anemonefish_biotic_cv_data) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(anemonefish_biotic_cv_data) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>  fish_biotic_processed <span class="ot">&lt;-</span> anemonefish_biotic_cv_data <span class="sc">%&gt;%</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">species =</span> SpeciesName, <span class="co"># Assuming SpeciesName is already derived</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">model_type =</span> <span class="st">"biotic_only"</span></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(species, model_type, AUC_test_CV, TSS_test_CV, filename_full)</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Processed anemonefish biotic-only CV data.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Warning: anemonefish_biotic_cv_data is empty or NULL. Cannot process biotic-only models.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>  fish_biotic_processed <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Processed anemonefish biotic-only CV data.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 3. Prepare Anemonefish Combined (Host + Env) Data ---</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(anemonefish_combined_cv_data) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(anemonefish_combined_cv_data) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>  fish_combined_processed <span class="ot">&lt;-</span> anemonefish_combined_cv_data <span class="sc">%&gt;%</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">species =</span> SpeciesName, <span class="co"># Assuming SpeciesName is already derived</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">model_type =</span> <span class="st">"combined_host_env"</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(species, model_type, AUC_test_CV, TSS_test_CV, filename_full)</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Processed anemonefish combined (host+env) CV data.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Warning: anemonefish_combined_cv_data is empty or NULL. Cannot process combined models.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>  fish_combined_processed <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Processed anemonefish combined (host+env) CV data.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 4. Combine all processed anemonefish model data ---</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>df_fish_comparison <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>  fish_env_processed,</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>  fish_biotic_processed,</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>  fish_combined_processed</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(df_fish_comparison) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(df_fish_comparison) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Removed: The left_join for specialization_type from this chunk.</span></span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Specialization will now be joined in the 'compare-model-performance-by-specialization' chunk.</span></span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Combined data frame 'df_fish_comparison' created with"</span>, <span class="fu">nrow</span>(df_fish_comparison), <span class="st">"rows.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Summary of model types and counts:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">table</span>(df_fish_comparison<span class="sc">$</span>model_type))</span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">First few rows of combined data (with AUC and TSS):</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">head</span>(df_fish_comparison))</span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb64-18"><a href="#cb64-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Error: 'df_fish_comparison' is empty. No anemonefish CV data was successfully processed.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb64-19"><a href="#cb64-19" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Combined data frame 'df_fish_comparison' created with 1225 rows.
Summary of model types and counts:

      biotic_only combined_host_env          env_only 
              413               404               408 

First few rows of combined data (with AUC and TSS):
# A tibble: 6 Ã— 5
  species                model_type AUC_test_CV TSS_test_CV filename_full       
  &lt;chr&gt;                  &lt;chr&gt;            &lt;dbl&gt;       &lt;dbl&gt; &lt;chr&gt;               
1 Amphiprion_akallopisos env_only         0.931       0.799 /home/bi-server-kyoâ€¦
2 Amphiprion_akallopisos env_only         0.906       0.721 /home/bi-server-kyoâ€¦
3 Amphiprion_akallopisos env_only         0.943       0.785 /home/bi-server-kyoâ€¦
4 Amphiprion_akallopisos env_only         0.92        0.782 /home/bi-server-kyoâ€¦
5 Amphiprion_akallopisos env_only         0.917       0.791 /home/bi-server-kyoâ€¦
6 Amphiprion_akallopisos env_only         0.922       0.755 /home/bi-server-kyoâ€¦</code></pre>
</div>
</div>
</section>
<section id="auc-improvement-by-host-specialization-broadened-specialist-definition" class="level2">
<h2 class="anchored" data-anchor-id="auc-improvement-by-host-specialization-broadened-specialist-definition">AUC Improvement by Host Specialization (Broadened Specialist Definition)</h2>
<p>This section investigates whether the inclusion of host anemone distribution data (in â€œcombined host+environmentâ€ models) provides a differential improvement in predictive performance (Test AUC) compared to â€œenvironment-onlyâ€ models for anemonefish species. Species are classified based on their number of documented host anemones from `data/processed_anemonefish_host_associations.csv`: â€œSpecialistsâ€ are defined as those associating with 3 or fewer host species, and â€œGeneralistsâ€ as those associating with more than 3 host species. We then calculate the AUC improvement for each species and test for significant differences in this improvement between the two specialization groups.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stats) <span class="co"># For t.test, wilcox.test</span></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here) <span class="co"># Ensure 'here' package is loaded for file paths</span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Defining Anemonefish Specialization (&lt;=3 hosts = Specialist) from CSV and Calculating Model Performance Improvement ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Defining Anemonefish Specialization (&lt;=3 hosts = Specialist) from CSV and Calculating Model Performance Improvement ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure df_fish_comparison is available and has the required columns</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"df_fish_comparison"</span>) <span class="sc">||</span> <span class="fu">is.null</span>(df_fish_comparison) <span class="sc">||</span> </span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">all</span>(<span class="fu">c</span>(<span class="st">"species"</span>, <span class="st">"model_type"</span>, <span class="st">"AUC_test_CV"</span>, <span class="st">"TSS_test_CV"</span>) <span class="sc">%in%</span> <span class="fu">names</span>(df_fish_comparison))) {</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"df_fish_comparison is not available or is missing required columns. Please ensure previous chunks have run successfully."</span>)</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Define anemonefish specialization based on the association CSV ---</span></span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a><span class="co"># This part is crucial and should ensure 'anemonefish_specialization_df' is created</span></span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>association_file_path <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"processed_anemonefish_host_associations.csv"</span>)</span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(association_file_path)) {</span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"Anemonefish-host association file not found at: "</span>, association_file_path)</span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>host_associations_df <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(association_file_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">AnemonefishScientificName =</span> <span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">"_"</span>, AnemonefishScientificName),</span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a>         <span class="at">AssociatedAnemoneScientificName =</span> <span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">"_"</span>, AssociatedAnemoneScientificName))</span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true" tabindex="-1"></a>anemonefish_host_counts <span class="ot">&lt;-</span> host_associations_df <span class="sc">%&gt;%</span></span>
<span id="cb68-20"><a href="#cb68-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(AnemonefishScientificName) <span class="sc">%&gt;%</span></span>
<span id="cb68-21"><a href="#cb68-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">n_hosts =</span> <span class="fu">n_distinct</span>(AssociatedAnemoneScientificName), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb68-22"><a href="#cb68-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-23"><a href="#cb68-23" aria-hidden="true" tabindex="-1"></a>anemonefish_specialization_df <span class="ot">&lt;-</span> anemonefish_host_counts <span class="sc">%&gt;%</span></span>
<span id="cb68-24"><a href="#cb68-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">specialization_type =</span> <span class="fu">factor</span>(<span class="fu">ifelse</span>(n_hosts <span class="sc">&lt;=</span> <span class="dv">1</span>, <span class="st">"Specialist"</span>, <span class="st">"Generalist"</span>), <span class="co"># Changed from &lt;3 to &lt;=3 to match previous example's logic (if "3 or fewer")</span></span>
<span id="cb68-25"><a href="#cb68-25" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Generalist"</span>, <span class="st">"Specialist"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb68-26"><a href="#cb68-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">species =</span> AnemonefishScientificName)</span>
<span id="cb68-27"><a href="#cb68-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-28"><a href="#cb68-28" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Anemonefish Specialization (&lt;=3 hosts = Specialist):</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Anemonefish Specialization (&lt;=3 hosts = Specialist):</code></pre>
</div>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(anemonefish_specialization_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 29 Ã— 3
   species                 n_hosts specialization_type
   &lt;chr&gt;                     &lt;int&gt; &lt;fct&gt;              
 1 Amphiprion_akallopisos        2 Generalist         
 2 Amphiprion_akindynos          6 Generalist         
 3 Amphiprion_allardi            3 Generalist         
 4 Amphiprion_barberi            2 Generalist         
 5 Amphiprion_bicinctus          5 Generalist         
 6 Amphiprion_chagosensis        1 Specialist         
 7 Amphiprion_chrysogaster       3 Generalist         
 8 Amphiprion_chrysopterus       6 Generalist         
 9 Amphiprion_clarkii            9 Generalist         
10 Amphiprion_ephippium          2 Generalist         
# â„¹ 19 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge specialization info into the main comparison dataframe</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>df_fish_comparison_specialization <span class="ot">&lt;-</span> df_fish_comparison <span class="sc">%&gt;%</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(anemonefish_specialization_df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(species, specialization_type, n_hosts), <span class="at">by =</span> <span class="st">"species"</span>)</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a><span class="co"># --- IMPORTANT: Add check for specialization_type and n_hosts columns ---</span></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a><span class="co"># This check is now robust as the join should correctly add these columns without suffixes</span></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(<span class="fu">c</span>(<span class="st">"specialization_type"</span>, <span class="st">"n_hosts"</span>) <span class="sc">%in%</span> <span class="fu">names</span>(df_fish_comparison_specialization))) {</span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"Error: 'specialization_type' or 'n_hosts' columns not found in df_fish_comparison_specialization after joining with specialization data. This indicates an issue with the join (e.g., no matching species or empty specialization data). Please check `anemonefish_specialization_df` and species names in `df_fish_comparison`."</span>)</span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a><span class="co"># --- </span><span class="re">END</span><span class="co"> IMPORTANT CHECK ---</span></span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">any</span>(<span class="fu">is.na</span>(df_fish_comparison_specialization<span class="sc">$</span>specialization_type))) {</span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a>  unclassified_species <span class="ot">&lt;-</span> <span class="fu">unique</span>(df_fish_comparison_specialization<span class="sc">$</span>species[<span class="fu">is.na</span>(df_fish_comparison_specialization<span class="sc">$</span>specialization_type)])</span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Warning: The following species from df_fish_comparison were not found in the generated specialization list from the CSV and will have NA for specialization_type:</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">paste</span>(unclassified_species, <span class="at">collapse=</span><span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">These species will be excluded from specialist vs generalist comparisons.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true" tabindex="-1"></a>  df_fish_comparison_specialization <span class="ot">&lt;-</span> df_fish_comparison_specialization <span class="sc">%&gt;%</span></span>
<span id="cb72-17"><a href="#cb72-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(specialization_type))</span>
<span id="cb72-18"><a href="#cb72-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb72-19"><a href="#cb72-19" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">nrow</span>(df_fish_comparison_specialization) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb72-20"><a href="#cb72-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"No species remaining after attempting to merge specialization type. Check species name consistency between df_fish_comparison and the association list CSV."</span>)</span>
<span id="cb72-21"><a href="#cb72-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb72-22"><a href="#cb72-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-23"><a href="#cb72-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate mean performance metrics per species and model type for improvement calculation</span></span>
<span id="cb72-24"><a href="#cb72-24" aria-hidden="true" tabindex="-1"></a>mean_performance_per_species_model <span class="ot">&lt;-</span> df_fish_comparison_specialization <span class="sc">%&gt;%</span></span>
<span id="cb72-25"><a href="#cb72-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(model_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"env_only"</span>, <span class="st">"combined_host_env"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb72-26"><a href="#cb72-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(species, specialization_type, n_hosts, model_type) <span class="sc">%&gt;%</span></span>
<span id="cb72-27"><a href="#cb72-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb72-28"><a href="#cb72-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_AUC_test_CV =</span> <span class="fu">mean</span>(AUC_test_CV, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb72-29"><a href="#cb72-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_TSS_test_CV =</span> <span class="fu">mean</span>(TSS_test_CV, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="co"># ADDED TSS</span></span>
<span id="cb72-30"><a href="#cb72-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb72-31"><a href="#cb72-31" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb72-32"><a href="#cb72-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-33"><a href="#cb72-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate AUC improvement: Combined - Env-Only</span></span>
<span id="cb72-34"><a href="#cb72-34" aria-hidden="true" tabindex="-1"></a>auc_improvement_df <span class="ot">&lt;-</span> mean_performance_per_species_model <span class="sc">%&gt;%</span></span>
<span id="cb72-35"><a href="#cb72-35" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(species, specialization_type, n_hosts, model_type, mean_AUC_test_CV) <span class="sc">%&gt;%</span></span>
<span id="cb72-36"><a href="#cb72-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> model_type, <span class="at">values_from =</span> mean_AUC_test_CV) <span class="sc">%&gt;%</span></span>
<span id="cb72-37"><a href="#cb72-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(env_only) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(combined_host_env)) <span class="sc">%&gt;%</span></span>
<span id="cb72-38"><a href="#cb72-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">AUC_improvement =</span> combined_host_env <span class="sc">-</span> env_only) <span class="sc">%&gt;%</span></span>
<span id="cb72-39"><a href="#cb72-39" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(species, specialization_type, n_hosts, AUC_improvement) <span class="sc">%&gt;%</span></span>
<span id="cb72-40"><a href="#cb72-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>() <span class="co"># Ensure unique species-specialization-improvement rows for AUC</span></span>
<span id="cb72-41"><a href="#cb72-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-42"><a href="#cb72-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate TSS improvement: Combined - Env-Only</span></span>
<span id="cb72-43"><a href="#cb72-43" aria-hidden="true" tabindex="-1"></a>tss_improvement_df <span class="ot">&lt;-</span> mean_performance_per_species_model <span class="sc">%&gt;%</span></span>
<span id="cb72-44"><a href="#cb72-44" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(species, specialization_type, n_hosts, model_type, mean_TSS_test_CV) <span class="sc">%&gt;%</span> <span class="co"># Use mean_TSS_test_CV</span></span>
<span id="cb72-45"><a href="#cb72-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> model_type, <span class="at">values_from =</span> mean_TSS_test_CV) <span class="sc">%&gt;%</span> <span class="co"># Pivot on TSS</span></span>
<span id="cb72-46"><a href="#cb72-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(env_only) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(combined_host_env)) <span class="sc">%&gt;%</span></span>
<span id="cb72-47"><a href="#cb72-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">TSS_improvement =</span> combined_host_env <span class="sc">-</span> env_only) <span class="sc">%&gt;%</span> <span class="co"># Calculate TSS improvement</span></span>
<span id="cb72-48"><a href="#cb72-48" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(species, specialization_type, n_hosts, TSS_improvement) <span class="sc">%&gt;%</span></span>
<span id="cb72-49"><a href="#cb72-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>() <span class="co"># Ensure unique species-specialization-improvement rows for TSS</span></span>
<span id="cb72-50"><a href="#cb72-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-51"><a href="#cb72-51" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">AUC Improvement data (first few rows):</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
AUC Improvement data (first few rows):</code></pre>
</div>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">head</span>(auc_improvement_df))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 Ã— 4
  species                 specialization_type n_hosts AUC_improvement
  &lt;chr&gt;                   &lt;fct&gt;                 &lt;int&gt;           &lt;dbl&gt;
1 Amphiprion_akallopisos  Generalist                2         0.00555
2 Amphiprion_akindynos    Generalist                6         0.00162
3 Amphiprion_allardi      Generalist                3         0.0143 
4 Amphiprion_barberi      Generalist                2         0.0251 
5 Amphiprion_bicinctus    Generalist                5         0.00364
6 Amphiprion_chrysogaster Generalist                3         0.0498 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">TSS Improvement data (first few rows):</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
TSS Improvement data (first few rows):</code></pre>
</div>
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">head</span>(tss_improvement_df))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 Ã— 4
  species                 specialization_type n_hosts TSS_improvement
  &lt;chr&gt;                   &lt;fct&gt;                 &lt;int&gt;           &lt;dbl&gt;
1 Amphiprion_akallopisos  Generalist                2         0.00777
2 Amphiprion_akindynos    Generalist                6         0.00225
3 Amphiprion_allardi      Generalist                3         0.0146 
4 Amphiprion_barberi      Generalist                2         0.0407 
5 Amphiprion_bicinctus    Generalist                5         0.00107
6 Amphiprion_chrysogaster Generalist                3         0.0782 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Statistical Tests and Plots for AUC Improvement ---</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(auc_improvement_df) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(auc_improvement_df) <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span> </span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">unique</span>(auc_improvement_df<span class="sc">$</span>specialization_type[<span class="sc">!</span><span class="fu">is.na</span>(auc_improvement_df<span class="sc">$</span>specialization_type)])) <span class="sc">==</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> </span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(auc_improvement_df<span class="sc">$</span>specialization_type <span class="sc">==</span> <span class="st">"Generalist"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">&gt;</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> </span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(auc_improvement_df<span class="sc">$</span>specialization_type <span class="sc">==</span> <span class="st">"Specialist"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Statistical Test for AUC Improvement ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>  ttest_auc_improvement <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">t.test</span>(AUC_improvement <span class="sc">~</span> specialization_type, <span class="at">data =</span> auc_improvement_df)</span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Error in t-test for AUC improvement:"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">Attempting Wilcoxon test.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tryCatch</span>({</span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">wilcox.test</span>(AUC_improvement <span class="sc">~</span> specialization_type, <span class="at">data =</span> auc_improvement_df)</span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e2) {</span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"Error in Wilcoxon test as well:"</span>, e2<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>); <span class="cn">NULL</span></span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb80-18"><a href="#cb80-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Test for difference in AUC Improvement between Generalist and Specialist Anemonefish (Specialist &lt;=3 hosts):</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb80-19"><a href="#cb80-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(ttest_auc_improvement)) <span class="fu">print</span>(ttest_auc_improvement)</span>
<span id="cb80-20"><a href="#cb80-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb80-21"><a href="#cb80-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot AUC Improvement</span></span>
<span id="cb80-22"><a href="#cb80-22" aria-hidden="true" tabindex="-1"></a>  plot_auc_improvement <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(auc_improvement_df, <span class="fu">aes</span>(<span class="at">x =</span> specialization_type, <span class="at">y =</span> AUC_improvement, <span class="at">fill =</span> specialization_type)) <span class="sc">+</span></span>
<span id="cb80-23"><a href="#cb80-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_boxplot</span>(<span class="at">alpha =</span> <span class="fl">0.8</span>, <span class="at">width=</span><span class="fl">0.6</span>, <span class="at">outlier.shape =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb80-24"><a href="#cb80-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_jitter</span>(<span class="at">width =</span> <span class="fl">0.15</span>, <span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">size=</span><span class="fl">2.5</span>) <span class="sc">+</span></span>
<span id="cb80-25"><a href="#cb80-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_summary</span>(<span class="at">fun =</span> mean, <span class="at">geom =</span> <span class="st">"point"</span>, <span class="at">shape =</span> <span class="dv">18</span>, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">color =</span> <span class="st">"black"</span>,</span>
<span id="cb80-26"><a href="#cb80-26" aria-hidden="true" tabindex="-1"></a>                 <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">width =</span> <span class="fl">0.6</span>)) <span class="sc">+</span></span>
<span id="cb80-27"><a href="#cb80-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"AUC Improvement by Host Specialization"</span>,</span>
<span id="cb80-28"><a href="#cb80-28" aria-hidden="true" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="st">"Combined model AUC - Environmental-only model AUC"</span>,</span>
<span id="cb80-29"><a href="#cb80-29" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Anemonefish Specialization"</span>,</span>
<span id="cb80-30"><a href="#cb80-30" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="fu">expression</span>(Delta <span class="sc">*</span> <span class="st">" AUC (Combined - Env-Only)"</span>)) <span class="sc">+</span></span>
<span id="cb80-31"><a href="#cb80-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Generalist"</span> <span class="ot">=</span> <span class="st">"cornflowerblue"</span>, <span class="st">"Specialist"</span> <span class="ot">=</span> <span class="st">"darkorange"</span>),</span>
<span id="cb80-32"><a href="#cb80-32" aria-hidden="true" tabindex="-1"></a>                      <span class="at">name =</span> <span class="st">"Specialization Type"</span>,</span>
<span id="cb80-33"><a href="#cb80-33" aria-hidden="true" tabindex="-1"></a>                      <span class="at">na.translate =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb80-34"><a href="#cb80-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb80-35"><a href="#cb80-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>,</span>
<span id="cb80-36"><a href="#cb80-36" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">11</span>, <span class="at">face=</span><span class="st">"bold"</span>),</span>
<span id="cb80-37"><a href="#cb80-37" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face=</span><span class="st">"bold"</span>),</span>
<span id="cb80-38"><a href="#cb80-38" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb80-39"><a href="#cb80-39" aria-hidden="true" tabindex="-1"></a>          <span class="at">panel.grid.major.x =</span> <span class="fu">element_blank</span>())</span>
<span id="cb80-40"><a href="#cb80-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb80-41"><a href="#cb80-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(plot_auc_improvement)</span>
<span id="cb80-42"><a href="#cb80-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb80-43"><a href="#cb80-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Save AUC improvement plot</span></span>
<span id="cb80-44"><a href="#cb80-44" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"figure_output_dir"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">dir.exists</span>(figure_output_dir)) {</span>
<span id="cb80-45"><a href="#cb80-45" aria-hidden="true" tabindex="-1"></a>    improvement_plot_filename <span class="ot">&lt;-</span> <span class="fu">file.path</span>(figure_output_dir, <span class="st">"auc_improvement_by_specialization.png"</span>)</span>
<span id="cb80-46"><a href="#cb80-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggsave</span>(<span class="at">filename =</span> improvement_plot_filename, <span class="at">plot =</span> plot_auc_improvement, <span class="at">width =</span> <span class="dv">8</span>, <span class="at">height =</span> <span class="dv">6</span>, <span class="at">units =</span> <span class="st">"in"</span>, <span class="at">dpi =</span> <span class="dv">300</span>)</span>
<span id="cb80-47"><a href="#cb80-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Saved AUC improvement by specialization plot to:"</span>, improvement_plot_filename, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb80-48"><a href="#cb80-48" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb80-49"><a href="#cb80-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Warning: 'figure_output_dir' not defined or does not exist. AUC improvement plot not saved to file.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb80-50"><a href="#cb80-50" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb80-51"><a href="#cb80-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb80-52"><a href="#cb80-52" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb80-53"><a href="#cb80-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Not enough data or distinct groups (Generalist/Specialist with &gt;1 observation each) to perform statistical test or plot on AUC improvement.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb80-54"><a href="#cb80-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Number of Generalists with AUC improvement data:"</span>, <span class="fu">sum</span>(auc_improvement_df<span class="sc">$</span>specialization_type <span class="sc">==</span> <span class="st">"Generalist"</span>, <span class="at">na.rm=</span><span class="cn">TRUE</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb80-55"><a href="#cb80-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Number of Specialists with AUC improvement data:"</span>, <span class="fu">sum</span>(auc_improvement_df<span class="sc">$</span>specialization_type <span class="sc">==</span> <span class="st">"Specialist"</span>, <span class="at">na.rm=</span><span class="cn">TRUE</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb80-56"><a href="#cb80-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Unique specialization types found in auc_improvement_df:"</span>, <span class="fu">paste</span>(<span class="fu">unique</span>(<span class="fu">na.omit</span>(auc_improvement_df<span class="sc">$</span>specialization_type)), <span class="at">collapse=</span><span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb80-57"><a href="#cb80-57" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Statistical Test for AUC Improvement ---
Test for difference in AUC Improvement between Generalist and Specialist Anemonefish (Specialist &lt;=3 hosts):

    Welch Two Sample t-test

data:  AUC_improvement by specialization_type
t = -1.5576, df = 8.5063, p-value = 0.1557
alternative hypothesis: true difference in means between group Generalist and group Specialist is not equal to 0
95 percent confidence interval:
 -0.05585389  0.01054099
sample estimates:
mean in group Generalist mean in group Specialist 
              0.01830091               0.04095736 </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/compare-model-performance-by-specialization-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Saved AUC improvement by specialization plot to: /home/bi-server-kyoto/a0236995/sdm_anemonefish/figure_files/auc_improvement_by_specialization.png </code></pre>
</div>
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Statistical Tests and Plots for TSS Improvement ---</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(tss_improvement_df) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(tss_improvement_df) <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span> </span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">unique</span>(tss_improvement_df<span class="sc">$</span>specialization_type[<span class="sc">!</span><span class="fu">is.na</span>(tss_improvement_df<span class="sc">$</span>specialization_type)])) <span class="sc">==</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> </span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(tss_improvement_df<span class="sc">$</span>specialization_type <span class="sc">==</span> <span class="st">"Generalist"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">&gt;</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> </span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(tss_improvement_df<span class="sc">$</span>specialization_type <span class="sc">==</span> <span class="st">"Specialist"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Statistical Test for TSS Improvement ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>  ttest_tss_improvement <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">t.test</span>(TSS_improvement <span class="sc">~</span> specialization_type, <span class="at">data =</span> tss_improvement_df)</span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Error in t-test for TSS improvement:"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">Attempting Wilcoxon test.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tryCatch</span>({</span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">wilcox.test</span>(TSS_improvement <span class="sc">~</span> specialization_type, <span class="at">data =</span> tss_improvement_df)</span>
<span id="cb83-14"><a href="#cb83-14" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e2) {</span>
<span id="cb83-15"><a href="#cb83-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"Error in Wilcoxon test as well:"</span>, e2<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>); <span class="cn">NULL</span></span>
<span id="cb83-16"><a href="#cb83-16" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb83-17"><a href="#cb83-17" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb83-18"><a href="#cb83-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Test for difference in TSS Improvement between Generalist and Specialist Anemonefish (Specialist &lt;=3 hosts):</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb83-19"><a href="#cb83-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(ttest_tss_improvement)) <span class="fu">print</span>(ttest_tss_improvement)</span>
<span id="cb83-20"><a href="#cb83-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb83-21"><a href="#cb83-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot TSS Improvement</span></span>
<span id="cb83-22"><a href="#cb83-22" aria-hidden="true" tabindex="-1"></a>  plot_tss_improvement <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(tss_improvement_df, <span class="fu">aes</span>(<span class="at">x =</span> specialization_type, <span class="at">y =</span> TSS_improvement, <span class="at">fill =</span> specialization_type)) <span class="sc">+</span></span>
<span id="cb83-23"><a href="#cb83-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_boxplot</span>(<span class="at">alpha =</span> <span class="fl">0.8</span>, <span class="at">width=</span><span class="fl">0.6</span>, <span class="at">outlier.shape =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb83-24"><a href="#cb83-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_jitter</span>(<span class="at">width =</span> <span class="fl">0.15</span>, <span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">size=</span><span class="fl">2.5</span>) <span class="sc">+</span></span>
<span id="cb83-25"><a href="#cb83-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_summary</span>(<span class="at">fun =</span> mean, <span class="at">geom =</span> <span class="st">"point"</span>, <span class="at">shape =</span> <span class="dv">18</span>, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">color =</span> <span class="st">"black"</span>,</span>
<span id="cb83-26"><a href="#cb83-26" aria-hidden="true" tabindex="-1"></a>                 <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">width =</span> <span class="fl">0.6</span>)) <span class="sc">+</span></span>
<span id="cb83-27"><a href="#cb83-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"TSS Improvement by Host Specialization"</span>,</span>
<span id="cb83-28"><a href="#cb83-28" aria-hidden="true" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="st">"Combined model TSS - Environmental-only model TSS"</span>,</span>
<span id="cb83-29"><a href="#cb83-29" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Anemonefish Specialization"</span>,</span>
<span id="cb83-30"><a href="#cb83-30" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="fu">expression</span>(Delta <span class="sc">*</span> <span class="st">" TSS (Combined - Env-Only)"</span>)) <span class="sc">+</span></span>
<span id="cb83-31"><a href="#cb83-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Generalist"</span> <span class="ot">=</span> <span class="st">"lightcoral"</span>, <span class="st">"Specialist"</span> <span class="ot">=</span> <span class="st">"lightblue"</span>),</span>
<span id="cb83-32"><a href="#cb83-32" aria-hidden="true" tabindex="-1"></a>                      <span class="at">name =</span> <span class="st">"Specialization Type"</span>,</span>
<span id="cb83-33"><a href="#cb83-33" aria-hidden="true" tabindex="-1"></a>                      <span class="at">na.translate =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb83-34"><a href="#cb83-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb83-35"><a href="#cb83-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>,</span>
<span id="cb83-36"><a href="#cb83-36" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">11</span>, <span class="at">face=</span><span class="st">"bold"</span>),</span>
<span id="cb83-37"><a href="#cb83-37" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face=</span><span class="st">"bold"</span>),</span>
<span id="cb83-38"><a href="#cb83-38" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb83-39"><a href="#cb83-39" aria-hidden="true" tabindex="-1"></a>          <span class="at">panel.grid.major.x =</span> <span class="fu">element_blank</span>())</span>
<span id="cb83-40"><a href="#cb83-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb83-41"><a href="#cb83-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(plot_tss_improvement)</span>
<span id="cb83-42"><a href="#cb83-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb83-43"><a href="#cb83-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Save TSS improvement plot</span></span>
<span id="cb83-44"><a href="#cb83-44" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"figure_output_dir"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">dir.exists</span>(figure_output_dir)) {</span>
<span id="cb83-45"><a href="#cb83-45" aria-hidden="true" tabindex="-1"></a>    tss_improvement_plot_filename <span class="ot">&lt;-</span> <span class="fu">file.path</span>(figure_output_dir, <span class="st">"tss_improvement_by_specialization.png"</span>)</span>
<span id="cb83-46"><a href="#cb83-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggsave</span>(<span class="at">filename =</span> tss_improvement_plot_filename, <span class="at">plot =</span> plot_tss_improvement, <span class="at">width =</span> <span class="dv">8</span>, <span class="at">height =</span> <span class="dv">6</span>, <span class="at">units =</span> <span class="st">"in"</span>, <span class="at">dpi =</span> <span class="dv">300</span>)</span>
<span id="cb83-47"><a href="#cb83-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Saved TSS improvement by specialization plot to:"</span>, tss_improvement_plot_filename, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb83-48"><a href="#cb83-48" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb83-49"><a href="#cb83-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Warning: 'figure_output_dir' not defined or does not exist. TSS improvement plot not saved to file.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb83-50"><a href="#cb83-50" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb83-51"><a href="#cb83-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb83-52"><a href="#cb83-52" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb83-53"><a href="#cb83-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Not enough data or distinct groups (Generalist/Specialist with &gt;1 observation each) to perform statistical test or plot on TSS improvement.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb83-54"><a href="#cb83-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Number of Generalists with TSS improvement data:"</span>, <span class="fu">sum</span>(tss_improvement_df<span class="sc">$</span>specialization_type <span class="sc">==</span> <span class="st">"Generalist"</span>, <span class="at">na.rm=</span><span class="cn">TRUE</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb83-55"><a href="#cb83-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Number of Specialists with TSS improvement data:"</span>, <span class="fu">sum</span>(tss_improvement_df<span class="sc">$</span>specialization_type <span class="sc">==</span> <span class="st">"Specialist"</span>, <span class="at">na.rm=</span><span class="cn">TRUE</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb83-56"><a href="#cb83-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Unique specialization types found in tss_improvement_df:"</span>, <span class="fu">paste</span>(<span class="fu">unique</span>(<span class="fu">na.omit</span>(tss_improvement_df<span class="sc">$</span>specialization_type)), <span class="at">collapse=</span><span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb83-57"><a href="#cb83-57" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Statistical Test for TSS Improvement ---
Test for difference in TSS Improvement between Generalist and Specialist Anemonefish (Specialist &lt;=3 hosts):

    Welch Two Sample t-test

data:  TSS_improvement by specialization_type
t = -1.0896, df = 8.8075, p-value = 0.3048
alternative hypothesis: true difference in means between group Generalist and group Specialist is not equal to 0
95 percent confidence interval:
 -0.08035541  0.02822900
sample estimates:
mean in group Generalist mean in group Specialist 
              0.02177624               0.04783944 </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/compare-model-performance-by-specialization-2.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Saved TSS improvement by specialization plot to: /home/bi-server-kyoto/a0236995/sdm_anemonefish/figure_files/tss_improvement_by_specialization.png </code></pre>
</div>
</div>
</section>
<section id="compare-anemonefish-model-performance" class="level2">
<h2 class="anchored" data-anchor-id="compare-anemonefish-model-performance">Compare anemonefish model performance</h2>
<p>This section statistically compares the performance (test AUC) of the different anemonefish model types (environmental-only, biotic-only, combined host+environment) using a linear mixed model. It also visualizes these comparisons.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glmmTMB)</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr) <span class="co"># For kable</span></span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a><span class="co"># library(performance) # Optional, for model_performance() if needed later</span></span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure dplyr, stringr, knitr are loaded if you use them later in the chunk for the summary table</span></span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a><span class="co"># pacman::p_load(dplyr, stringr, knitr) # Or ensure they are loaded in setup</span></span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(df_fish_comparison) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(df_fish_comparison) <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span> </span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"AUC_test_CV"</span> <span class="sc">%in%</span> <span class="fu">names</span>(df_fish_comparison) <span class="sc">&amp;&amp;</span> <span class="st">"TSS_test_CV"</span> <span class="sc">%in%</span> <span class="fu">names</span>(df_fish_comparison)) {</span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ensure model_type is a factor for the GLMM</span></span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This assumes your df_fish_comparison$model_type has values like "env_only", "biotic_only", "combined_host_env"</span></span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># OR if you renamed them in a previous step to "env", "host_env", "host_only", adjust levels accordingly.</span></span>
<span id="cb86-16"><a href="#cb86-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># For consistency with the ant paper structure and direct comparison to env_only:</span></span>
<span id="cb86-17"><a href="#cb86-17" aria-hidden="true" tabindex="-1"></a>  df_fish_comparison<span class="sc">$</span>model_type <span class="ot">&lt;-</span> <span class="fu">factor</span>(df_fish_comparison<span class="sc">$</span>model_type, </span>
<span id="cb86-18"><a href="#cb86-18" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"env_only"</span>, <span class="st">"combined_host_env"</span>, <span class="st">"biotic_only"</span>))</span>
<span id="cb86-19"><a href="#cb86-19" aria-hidden="true" tabindex="-1"></a>                                          <span class="co"># Reference: env_only</span></span>
<span id="cb86-20"><a href="#cb86-20" aria-hidden="true" tabindex="-1"></a>                                          <span class="co"># Second Coeff: combined_host_env vs env_only</span></span>
<span id="cb86-21"><a href="#cb86-21" aria-hidden="true" tabindex="-1"></a>                                          <span class="co"># Third Coeff: biotic_only vs env_only</span></span>
<span id="cb86-22"><a href="#cb86-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-23"><a href="#cb86-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Statistical Comparison for AUC_test_CV using GLMM ---</span></span>
<span id="cb86-24"><a href="#cb86-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Fitting GLMM to compare AUC_test_CV across model types ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-25"><a href="#cb86-25" aria-hidden="true" tabindex="-1"></a>  m1_fish_auc <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb86-26"><a href="#cb86-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">glmmTMB</span>(AUC_test_CV <span class="sc">~</span> model_type <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>species), <span class="at">data =</span> df_fish_comparison)</span>
<span id="cb86-27"><a href="#cb86-27" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb86-28"><a href="#cb86-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Error fitting GLMM for AUC:"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-29"><a href="#cb86-29" aria-hidden="true" tabindex="-1"></a>    <span class="cn">NULL</span></span>
<span id="cb86-30"><a href="#cb86-30" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb86-31"><a href="#cb86-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-32"><a href="#cb86-32" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(m1_fish_auc)) {</span>
<span id="cb86-33"><a href="#cb86-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Summary of GLMM for AUC_test_CV:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-34"><a href="#cb86-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">summary</span>(m1_fish_auc))</span>
<span id="cb86-35"><a href="#cb86-35" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb86-36"><a href="#cb86-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-37"><a href="#cb86-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Statistical Comparison for TSS_test_CV using GLMM ---</span></span>
<span id="cb86-38"><a href="#cb86-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Fitting GLMM to compare TSS_test_CV across model types ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-39"><a href="#cb86-39" aria-hidden="true" tabindex="-1"></a>  m1_fish_tss <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb86-40"><a href="#cb86-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">glmmTMB</span>(TSS_test_CV <span class="sc">~</span> model_type <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>species), <span class="at">data =</span> df_fish_comparison)</span>
<span id="cb86-41"><a href="#cb86-41" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb86-42"><a href="#cb86-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Error fitting GLMM for TSS:"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-43"><a href="#cb86-43" aria-hidden="true" tabindex="-1"></a>    <span class="cn">NULL</span></span>
<span id="cb86-44"><a href="#cb86-44" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb86-45"><a href="#cb86-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-46"><a href="#cb86-46" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(m1_fish_tss)) {</span>
<span id="cb86-47"><a href="#cb86-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Summary of GLMM for TSS_test_CV:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-48"><a href="#cb86-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">summary</span>(m1_fish_tss))</span>
<span id="cb86-49"><a href="#cb86-49" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb86-50"><a href="#cb86-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-51"><a href="#cb86-51" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- PREPARING DATA FOR PLOTTING ---</span></span>
<span id="cb86-52"><a href="#cb86-52" aria-hidden="true" tabindex="-1"></a>  df_fish_comparison_for_overall_plot <span class="ot">&lt;-</span> df_fish_comparison <span class="sc">%&gt;%</span></span>
<span id="cb86-53"><a href="#cb86-53" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">model_type_display =</span> <span class="fu">factor</span>(model_type,</span>
<span id="cb86-54"><a href="#cb86-54" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"env_only"</span>, <span class="st">"biotic_only"</span>, <span class="st">"combined_host_env"</span>), <span class="co"># Order for plot x-axis</span></span>
<span id="cb86-55"><a href="#cb86-55" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Environmental Only"</span>, <span class="st">"Biotic (Host) Only"</span>, <span class="st">"Combined (Host+Env)"</span>))) <span class="co"># Labels for plot legend</span></span>
<span id="cb86-56"><a href="#cb86-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-57"><a href="#cb86-57" aria-hidden="true" tabindex="-1"></a>  df_fish_comparison_plot_species <span class="ot">&lt;-</span> df_fish_comparison <span class="sc">%&gt;%</span></span>
<span id="cb86-58"><a href="#cb86-58" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">species_display =</span> <span class="fu">str_replace</span>(species, <span class="st">"_"</span>, <span class="st">" "</span>),</span>
<span id="cb86-59"><a href="#cb86-59" aria-hidden="true" tabindex="-1"></a>           <span class="at">model_type_display =</span> <span class="fu">factor</span>(model_type, <span class="co"># Ensure consistent factor for plotting</span></span>
<span id="cb86-60"><a href="#cb86-60" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"env_only"</span>, <span class="st">"biotic_only"</span>, <span class="st">"combined_host_env"</span>),</span>
<span id="cb86-61"><a href="#cb86-61" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Environmental Only"</span>, <span class="st">"Biotic (Host) Only"</span>, <span class="st">"Combined (Host+Env)"</span>)))</span>
<span id="cb86-62"><a href="#cb86-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-63"><a href="#cb86-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-64"><a href="#cb86-64" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Visualization for AUC_test_CV ---</span></span>
<span id="cb86-65"><a href="#cb86-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Generating boxplot of AUC_test_CV by model type ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-66"><a href="#cb86-66" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-67"><a href="#cb86-67" aria-hidden="true" tabindex="-1"></a>  plot_auc_comparison <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df_fish_comparison_for_overall_plot, <span class="fu">aes</span>(<span class="at">x =</span> model_type_display, <span class="at">y =</span> AUC_test_CV, <span class="at">fill =</span> model_type_display)) <span class="sc">+</span></span>
<span id="cb86-68"><a href="#cb86-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_boxplot</span>(<span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb86-69"><a href="#cb86-69" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_summary</span>(<span class="at">fun =</span> mean, <span class="at">geom =</span> <span class="st">"point"</span>, <span class="at">shape =</span> <span class="dv">18</span>, <span class="at">size =</span> <span class="dv">3</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb86-70"><a href="#cb86-70" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb86-71"><a href="#cb86-71" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Anemonefish Model Performance Comparison (AUC)"</span>,</span>
<span id="cb86-72"><a href="#cb86-72" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Model Type"</span>,</span>
<span id="cb86-73"><a href="#cb86-73" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"Test AUC (Predictive Accuracy)"</span></span>
<span id="cb86-74"><a href="#cb86-74" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb86-75"><a href="#cb86-75" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_manual</span>(</span>
<span id="cb86-76"><a href="#cb86-76" aria-hidden="true" tabindex="-1"></a>      <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Environmental Only"</span> <span class="ot">=</span> <span class="st">"grey70"</span>, <span class="st">"Biotic (Host) Only"</span> <span class="ot">=</span> <span class="st">"skyblue"</span>, <span class="st">"Combined (Host+Env)"</span> <span class="ot">=</span> <span class="st">"salmon"</span>),</span>
<span id="cb86-77"><a href="#cb86-77" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="st">"Model Type"</span></span>
<span id="cb86-78"><a href="#cb86-78" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb86-79"><a href="#cb86-79" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb86-80"><a href="#cb86-80" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb86-81"><a href="#cb86-81" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.major.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb86-82"><a href="#cb86-82" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.minor.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb86-83"><a href="#cb86-83" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb86-84"><a href="#cb86-84" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>) </span>
<span id="cb86-85"><a href="#cb86-85" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb86-86"><a href="#cb86-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(plot_auc_comparison)</span>
<span id="cb86-87"><a href="#cb86-87" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-88"><a href="#cb86-88" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Save overall AUC comparison plot</span></span>
<span id="cb86-89"><a href="#cb86-89" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"figure_output_dir"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">dir.exists</span>(figure_output_dir)) {</span>
<span id="cb86-90"><a href="#cb86-90" aria-hidden="true" tabindex="-1"></a>    overall_auc_comparison_plot_filename <span class="ot">&lt;-</span> <span class="fu">file.path</span>(figure_output_dir, <span class="st">"anemonefish_model_auc_comparison_overall.png"</span>)</span>
<span id="cb86-91"><a href="#cb86-91" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggsave</span>(<span class="at">filename =</span> overall_auc_comparison_plot_filename, </span>
<span id="cb86-92"><a href="#cb86-92" aria-hidden="true" tabindex="-1"></a>           <span class="at">plot =</span> plot_auc_comparison, </span>
<span id="cb86-93"><a href="#cb86-93" aria-hidden="true" tabindex="-1"></a>           <span class="at">width =</span> <span class="dv">8</span>, <span class="at">height =</span> <span class="dv">6</span>, <span class="at">units =</span> <span class="st">"in"</span>, <span class="at">dpi =</span> <span class="dv">300</span>)</span>
<span id="cb86-94"><a href="#cb86-94" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Saved overall model AUC comparison plot to:"</span>, overall_auc_comparison_plot_filename, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-95"><a href="#cb86-95" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb86-96"><a href="#cb86-96" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Warning: 'figure_output_dir' not defined or does not exist. Overall AUC comparison plot not saved to file.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-97"><a href="#cb86-97" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb86-98"><a href="#cb86-98" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-99"><a href="#cb86-99" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Detailed boxplot per species for AUC</span></span>
<span id="cb86-100"><a href="#cb86-100" aria-hidden="true" tabindex="-1"></a>  plot_auc_per_species <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df_fish_comparison_plot_species, <span class="fu">aes</span>(<span class="at">x =</span> species_display, <span class="at">y =</span> AUC_test_CV, <span class="at">fill =</span> model_type_display)) <span class="sc">+</span></span>
<span id="cb86-101"><a href="#cb86-101" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_boxplot</span>(<span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">preserve =</span> <span class="st">"single"</span>)) <span class="sc">+</span> </span>
<span id="cb86-102"><a href="#cb86-102" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_summary</span>(<span class="at">fun =</span> mean, <span class="at">geom =</span> <span class="st">"point"</span>, <span class="at">shape =</span> <span class="dv">23</span>, <span class="at">size =</span> <span class="dv">2</span>, <span class="at">fill =</span> <span class="st">"red"</span>, <span class="at">color =</span> <span class="st">"black"</span>,</span>
<span id="cb86-103"><a href="#cb86-103" aria-hidden="true" tabindex="-1"></a>                 <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">width =</span> <span class="fl">0.75</span>, <span class="at">preserve =</span> <span class="st">"single"</span>), </span>
<span id="cb86-104"><a href="#cb86-104" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">aes</span>(<span class="at">group =</span> model_type_display)) <span class="sc">+</span> </span>
<span id="cb86-105"><a href="#cb86-105" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb86-106"><a href="#cb86-106" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Anemonefish Model Performance by Species and Type (AUC)"</span>,</span>
<span id="cb86-107"><a href="#cb86-107" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Anemonefish Species"</span>,</span>
<span id="cb86-108"><a href="#cb86-108" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"Test AUC (Predictive Accuracy)"</span></span>
<span id="cb86-109"><a href="#cb86-109" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb86-110"><a href="#cb86-110" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_manual</span>(</span>
<span id="cb86-111"><a href="#cb86-111" aria-hidden="true" tabindex="-1"></a>      <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Environmental Only"</span> <span class="ot">=</span> <span class="st">"grey70"</span>, <span class="st">"Biotic (Host) Only"</span> <span class="ot">=</span> <span class="st">"skyblue"</span>, <span class="st">"Combined (Host+Env)"</span> <span class="ot">=</span> <span class="st">"salmon"</span>),</span>
<span id="cb86-112"><a href="#cb86-112" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="st">"Model Type:"</span></span>
<span id="cb86-113"><a href="#cb86-113" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb86-114"><a href="#cb86-114" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">11</span>) <span class="sc">+</span></span>
<span id="cb86-115"><a href="#cb86-115" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb86-116"><a href="#cb86-116" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.major.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb86-117"><a href="#cb86-117" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb86-118"><a href="#cb86-118" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">"top"</span>,</span>
<span id="cb86-119"><a href="#cb86-119" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">60</span>, <span class="at">hjust =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="dv">8</span>), </span>
<span id="cb86-120"><a href="#cb86-120" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb86-121"><a href="#cb86-121" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>)</span>
<span id="cb86-122"><a href="#cb86-122" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb86-123"><a href="#cb86-123" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="dv">1</span>) </span>
<span id="cb86-124"><a href="#cb86-124" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(plot_auc_per_species)</span>
<span id="cb86-125"><a href="#cb86-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-126"><a href="#cb86-126" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Save per-species AUC comparison plot</span></span>
<span id="cb86-127"><a href="#cb86-127" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"figure_output_dir"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">dir.exists</span>(figure_output_dir)) {</span>
<span id="cb86-128"><a href="#cb86-128" aria-hidden="true" tabindex="-1"></a>    per_species_auc_comparison_plot_filename <span class="ot">&lt;-</span> <span class="fu">file.path</span>(figure_output_dir, <span class="st">"anemonefish_model_auc_comparison_per_species.png"</span>)</span>
<span id="cb86-129"><a href="#cb86-129" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggsave</span>(<span class="at">filename =</span> per_species_auc_comparison_plot_filename, </span>
<span id="cb86-130"><a href="#cb86-130" aria-hidden="true" tabindex="-1"></a>           <span class="at">plot =</span> plot_auc_per_species, </span>
<span id="cb86-131"><a href="#cb86-131" aria-hidden="true" tabindex="-1"></a>           <span class="at">width =</span> <span class="dv">12</span>, <span class="at">height =</span> <span class="dv">8</span>, <span class="at">units =</span> <span class="st">"in"</span>, <span class="at">dpi =</span> <span class="dv">300</span>) <span class="co"># Increased size for better readability</span></span>
<span id="cb86-132"><a href="#cb86-132" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Saved per-species model AUC comparison plot to:"</span>, per_species_auc_comparison_plot_filename, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-133"><a href="#cb86-133" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb86-134"><a href="#cb86-134" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Warning: 'figure_output_dir' not defined or does not exist. Per-species AUC comparison plot not saved to file.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-135"><a href="#cb86-135" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb86-136"><a href="#cb86-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-137"><a href="#cb86-137" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Visualization for TSS_test_CV ---</span></span>
<span id="cb86-138"><a href="#cb86-138" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Generating boxplot of TSS_test_CV by model type ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-139"><a href="#cb86-139" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-140"><a href="#cb86-140" aria-hidden="true" tabindex="-1"></a>  plot_tss_comparison <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df_fish_comparison_for_overall_plot, <span class="fu">aes</span>(<span class="at">x =</span> model_type_display, <span class="at">y =</span> TSS_test_CV, <span class="at">fill =</span> model_type_display)) <span class="sc">+</span></span>
<span id="cb86-141"><a href="#cb86-141" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_boxplot</span>(<span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb86-142"><a href="#cb86-142" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_summary</span>(<span class="at">fun =</span> mean, <span class="at">geom =</span> <span class="st">"point"</span>, <span class="at">shape =</span> <span class="dv">18</span>, <span class="at">size =</span> <span class="dv">3</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb86-143"><a href="#cb86-143" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb86-144"><a href="#cb86-144" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Anemonefish Model Performance Comparison (TSS)"</span>,</span>
<span id="cb86-145"><a href="#cb86-145" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Model Type"</span>,</span>
<span id="cb86-146"><a href="#cb86-146" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"Test TSS (Predictive Accuracy)"</span></span>
<span id="cb86-147"><a href="#cb86-147" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb86-148"><a href="#cb86-148" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_manual</span>(</span>
<span id="cb86-149"><a href="#cb86-149" aria-hidden="true" tabindex="-1"></a>      <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Environmental Only"</span> <span class="ot">=</span> <span class="st">"grey70"</span>, <span class="st">"Biotic (Host) Only"</span> <span class="ot">=</span> <span class="st">"lightgreen"</span>, <span class="st">"Combined (Host+Env)"</span> <span class="ot">=</span> <span class="st">"purple"</span>), <span class="co"># New colors for TSS</span></span>
<span id="cb86-150"><a href="#cb86-150" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="st">"Model Type"</span></span>
<span id="cb86-151"><a href="#cb86-151" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb86-152"><a href="#cb86-152" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb86-153"><a href="#cb86-153" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb86-154"><a href="#cb86-154" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.major.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb86-155"><a href="#cb86-155" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.minor.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb86-156"><a href="#cb86-156" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb86-157"><a href="#cb86-157" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>) </span>
<span id="cb86-158"><a href="#cb86-158" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb86-159"><a href="#cb86-159" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(plot_tss_comparison)</span>
<span id="cb86-160"><a href="#cb86-160" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-161"><a href="#cb86-161" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Save overall TSS comparison plot</span></span>
<span id="cb86-162"><a href="#cb86-162" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"figure_output_dir"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">dir.exists</span>(figure_output_dir)) {</span>
<span id="cb86-163"><a href="#cb86-163" aria-hidden="true" tabindex="-1"></a>    overall_tss_comparison_plot_filename <span class="ot">&lt;-</span> <span class="fu">file.path</span>(figure_output_dir, <span class="st">"anemonefish_model_tss_comparison_overall.png"</span>)</span>
<span id="cb86-164"><a href="#cb86-164" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggsave</span>(<span class="at">filename =</span> overall_tss_comparison_plot_filename, </span>
<span id="cb86-165"><a href="#cb86-165" aria-hidden="true" tabindex="-1"></a>           <span class="at">plot =</span> plot_tss_comparison, </span>
<span id="cb86-166"><a href="#cb86-166" aria-hidden="true" tabindex="-1"></a>           <span class="at">width =</span> <span class="dv">8</span>, <span class="at">height =</span> <span class="dv">6</span>, <span class="at">units =</span> <span class="st">"in"</span>, <span class="at">dpi =</span> <span class="dv">300</span>)</span>
<span id="cb86-167"><a href="#cb86-167" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Saved overall model TSS comparison plot to:"</span>, overall_tss_comparison_plot_filename, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-168"><a href="#cb86-168" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb86-169"><a href="#cb86-169" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Warning: 'figure_output_dir' not defined or does not exist. Overall TSS comparison plot not saved to file.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-170"><a href="#cb86-170" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb86-171"><a href="#cb86-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-172"><a href="#cb86-172" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Detailed boxplot per species for TSS</span></span>
<span id="cb86-173"><a href="#cb86-173" aria-hidden="true" tabindex="-1"></a>  plot_tss_per_species <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df_fish_comparison_plot_species, <span class="fu">aes</span>(<span class="at">x =</span> species_display, <span class="at">y =</span> TSS_test_CV, <span class="at">fill =</span> model_type_display)) <span class="sc">+</span></span>
<span id="cb86-174"><a href="#cb86-174" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_boxplot</span>(<span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">preserve =</span> <span class="st">"single"</span>)) <span class="sc">+</span> </span>
<span id="cb86-175"><a href="#cb86-175" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_summary</span>(<span class="at">fun =</span> mean, <span class="at">geom =</span> <span class="st">"point"</span>, <span class="at">shape =</span> <span class="dv">23</span>, <span class="at">size =</span> <span class="dv">2</span>, <span class="at">fill =</span> <span class="st">"red"</span>, <span class="at">color =</span> <span class="st">"black"</span>,</span>
<span id="cb86-176"><a href="#cb86-176" aria-hidden="true" tabindex="-1"></a>                 <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">width =</span> <span class="fl">0.75</span>, <span class="at">preserve =</span> <span class="st">"single"</span>), </span>
<span id="cb86-177"><a href="#cb86-177" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">aes</span>(<span class="at">group =</span> model_type_display)) <span class="sc">+</span> </span>
<span id="cb86-178"><a href="#cb86-178" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb86-179"><a href="#cb86-179" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Anemonefish Model Performance by Species and Type (TSS)"</span>,</span>
<span id="cb86-180"><a href="#cb86-180" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Anemonefish Species"</span>,</span>
<span id="cb86-181"><a href="#cb86-181" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"Test TSS (Predictive Accuracy)"</span></span>
<span id="cb86-182"><a href="#cb86-182" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb86-183"><a href="#cb86-183" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_manual</span>(</span>
<span id="cb86-184"><a href="#cb86-184" aria-hidden="true" tabindex="-1"></a>      <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Environmental Only"</span> <span class="ot">=</span> <span class="st">"grey70"</span>, <span class="st">"Biotic (Host) Only"</span> <span class="ot">=</span> <span class="st">"lightgreen"</span>, <span class="st">"Combined (Host+Env)"</span> <span class="ot">=</span> <span class="st">"purple"</span>), <span class="co"># New colors for TSS</span></span>
<span id="cb86-185"><a href="#cb86-185" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="st">"Model Type:"</span></span>
<span id="cb86-186"><a href="#cb86-186" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb86-187"><a href="#cb86-187" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">11</span>) <span class="sc">+</span></span>
<span id="cb86-188"><a href="#cb86-188" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb86-189"><a href="#cb86-189" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.major.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb86-190"><a href="#cb86-190" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb86-191"><a href="#cb86-191" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">"top"</span>,</span>
<span id="cb86-192"><a href="#cb86-192" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">60</span>, <span class="at">hjust =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="dv">8</span>), </span>
<span id="cb86-193"><a href="#cb86-193" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb86-194"><a href="#cb86-194" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>)</span>
<span id="cb86-195"><a href="#cb86-195" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb86-196"><a href="#cb86-196" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="dv">1</span>) <span class="co"># TSS can also range from -1 to 1, but typically 0-1 for good models</span></span>
<span id="cb86-197"><a href="#cb86-197" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(plot_tss_per_species)</span>
<span id="cb86-198"><a href="#cb86-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-199"><a href="#cb86-199" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Save per-species TSS comparison plot</span></span>
<span id="cb86-200"><a href="#cb86-200" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"figure_output_dir"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">dir.exists</span>(figure_output_dir)) {</span>
<span id="cb86-201"><a href="#cb86-201" aria-hidden="true" tabindex="-1"></a>    per_species_tss_comparison_plot_filename <span class="ot">&lt;-</span> <span class="fu">file.path</span>(figure_output_dir, <span class="st">"anemonefish_model_tss_comparison_per_species.png"</span>)</span>
<span id="cb86-202"><a href="#cb86-202" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggsave</span>(<span class="at">filename =</span> per_species_tss_comparison_plot_filename, </span>
<span id="cb86-203"><a href="#cb86-203" aria-hidden="true" tabindex="-1"></a>           <span class="at">plot =</span> plot_tss_per_species, </span>
<span id="cb86-204"><a href="#cb86-204" aria-hidden="true" tabindex="-1"></a>           <span class="at">width =</span> <span class="dv">12</span>, <span class="at">height =</span> <span class="dv">8</span>, <span class="at">units =</span> <span class="st">"in"</span>, <span class="at">dpi =</span> <span class="dv">300</span>) <span class="co"># Increased size for better readability</span></span>
<span id="cb86-205"><a href="#cb86-205" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Saved per-species model TSS comparison plot to:"</span>, per_species_tss_comparison_plot_filename, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-206"><a href="#cb86-206" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb86-207"><a href="#cb86-207" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Warning: 'figure_output_dir' not defined or does not exist. Per-species TSS comparison plot not saved to file.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-208"><a href="#cb86-208" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb86-209"><a href="#cb86-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-210"><a href="#cb86-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-211"><a href="#cb86-211" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Summary Table for AUC ---</span></span>
<span id="cb86-212"><a href="#cb86-212" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Mean and Standard Deviation of Test AUC per Anemonefish Species and Model Type ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-213"><a href="#cb86-213" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-214"><a href="#cb86-214" aria-hidden="true" tabindex="-1"></a>  anemonefish_auc_summary_table <span class="ot">&lt;-</span> df_fish_comparison <span class="sc">%&gt;%</span></span>
<span id="cb86-215"><a href="#cb86-215" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(species, model_type) <span class="sc">%&gt;%</span></span>
<span id="cb86-216"><a href="#cb86-216" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">summarize</span>(</span>
<span id="cb86-217"><a href="#cb86-217" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_AUC_test =</span> <span class="fu">mean</span>(AUC_test_CV, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb86-218"><a href="#cb86-218" aria-hidden="true" tabindex="-1"></a>      <span class="at">sd_AUC_test =</span> <span class="fu">sd</span>(AUC_test_CV, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb86-219"><a href="#cb86-219" aria-hidden="true" tabindex="-1"></a>      <span class="at">n_CV_folds =</span> <span class="fu">n</span>(), </span>
<span id="cb86-220"><a href="#cb86-220" aria-hidden="true" tabindex="-1"></a>      <span class="at">.groups =</span> <span class="st">'drop'</span></span>
<span id="cb86-221"><a href="#cb86-221" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb86-222"><a href="#cb86-222" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">species_display =</span> stringr<span class="sc">::</span><span class="fu">str_replace</span>(species, <span class="st">"_"</span>, <span class="st">" "</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb86-223"><a href="#cb86-223" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="at">Species =</span> species_display, <span class="at">Model_Type =</span> model_type, <span class="at">Mean_AUC =</span> mean_AUC_test, <span class="at">SD_AUC =</span> sd_AUC_test, <span class="at">N_Folds =</span> n_CV_folds) <span class="sc">%&gt;%</span></span>
<span id="cb86-224"><a href="#cb86-224" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Mean_AUC =</span> <span class="fu">round</span>(Mean_AUC, <span class="dv">3</span>),</span>
<span id="cb86-225"><a href="#cb86-225" aria-hidden="true" tabindex="-1"></a>           <span class="at">SD_AUC =</span> <span class="fu">round</span>(SD_AUC, <span class="dv">3</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb86-226"><a href="#cb86-226" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(Species, Model_Type)</span>
<span id="cb86-227"><a href="#cb86-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-228"><a href="#cb86-228" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"knitr"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(anemonefish_auc_summary_table) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb86-229"><a href="#cb86-229" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(knitr<span class="sc">::</span><span class="fu">kable</span>(anemonefish_auc_summary_table, </span>
<span id="cb86-230"><a href="#cb86-230" aria-hidden="true" tabindex="-1"></a>                        <span class="at">caption =</span> <span class="st">"Mean and Standard Deviation of Test AUC for Anemonefish Models by Species and Type."</span>))</span>
<span id="cb86-231"><a href="#cb86-231" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">nrow</span>(anemonefish_auc_summary_table) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb86-232"><a href="#cb86-232" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(anemonefish_auc_summary_table)</span>
<span id="cb86-233"><a href="#cb86-233" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb86-234"><a href="#cb86-234" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"No summary data to print for anemonefish AUC.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-235"><a href="#cb86-235" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb86-236"><a href="#cb86-236" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-237"><a href="#cb86-237" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Save AUC summary table to CSV</span></span>
<span id="cb86-238"><a href="#cb86-238" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"analysis_output_dir"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">dir.exists</span>(analysis_output_dir)) {</span>
<span id="cb86-239"><a href="#cb86-239" aria-hidden="true" tabindex="-1"></a>      anemonefish_cv_summary_auc_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(analysis_output_dir, <span class="st">"anemonefish_detailed_CV_summary_auc.csv"</span>)</span>
<span id="cb86-240"><a href="#cb86-240" aria-hidden="true" tabindex="-1"></a>      <span class="fu">write.csv</span>(anemonefish_auc_summary_table, anemonefish_cv_summary_auc_path, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb86-241"><a href="#cb86-241" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Anemonefish detailed CV summary (Mean &amp; SD AUC) saved to:"</span>, anemonefish_cv_summary_auc_path, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-242"><a href="#cb86-242" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb86-243"><a href="#cb86-243" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Warning: 'analysis_output_dir' not defined. Anemonefish detailed CV summary (AUC) not saved to CSV.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-244"><a href="#cb86-244" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb86-245"><a href="#cb86-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-246"><a href="#cb86-246" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Summary Table for TSS ---</span></span>
<span id="cb86-247"><a href="#cb86-247" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Mean and Standard Deviation of Test TSS per Anemonefish Species and Model Type ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-248"><a href="#cb86-248" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-249"><a href="#cb86-249" aria-hidden="true" tabindex="-1"></a>  anemonefish_tss_summary_table <span class="ot">&lt;-</span> df_fish_comparison <span class="sc">%&gt;%</span></span>
<span id="cb86-250"><a href="#cb86-250" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(species, model_type) <span class="sc">%&gt;%</span></span>
<span id="cb86-251"><a href="#cb86-251" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">summarize</span>(</span>
<span id="cb86-252"><a href="#cb86-252" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_TSS_test =</span> <span class="fu">mean</span>(TSS_test_CV, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="co"># Use TSS_test_CV</span></span>
<span id="cb86-253"><a href="#cb86-253" aria-hidden="true" tabindex="-1"></a>      <span class="at">sd_TSS_test =</span> <span class="fu">sd</span>(TSS_test_CV, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),     <span class="co"># Use TSS_test_CV</span></span>
<span id="cb86-254"><a href="#cb86-254" aria-hidden="true" tabindex="-1"></a>      <span class="at">n_CV_folds =</span> <span class="fu">n</span>(), </span>
<span id="cb86-255"><a href="#cb86-255" aria-hidden="true" tabindex="-1"></a>      <span class="at">.groups =</span> <span class="st">'drop'</span></span>
<span id="cb86-256"><a href="#cb86-256" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb86-257"><a href="#cb86-257" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">species_display =</span> stringr<span class="sc">::</span><span class="fu">str_replace</span>(species, <span class="st">"_"</span>, <span class="st">" "</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb86-258"><a href="#cb86-258" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="at">Species =</span> species_display, <span class="at">Model_Type =</span> model_type, <span class="at">Mean_TSS =</span> mean_TSS_test, <span class="at">SD_TSS =</span> sd_TSS_test, <span class="at">N_Folds =</span> n_CV_folds) <span class="sc">%&gt;%</span> <span class="co"># Rename columns for TSS</span></span>
<span id="cb86-259"><a href="#cb86-259" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Mean_TSS =</span> <span class="fu">round</span>(Mean_TSS, <span class="dv">3</span>),</span>
<span id="cb86-260"><a href="#cb86-260" aria-hidden="true" tabindex="-1"></a>           <span class="at">SD_TSS =</span> <span class="fu">round</span>(SD_TSS, <span class="dv">3</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb86-261"><a href="#cb86-261" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(Species, Model_Type)</span>
<span id="cb86-262"><a href="#cb86-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-263"><a href="#cb86-263" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"knitr"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(anemonefish_tss_summary_table) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb86-264"><a href="#cb86-264" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(knitr<span class="sc">::</span><span class="fu">kable</span>(anemonefish_tss_summary_table, </span>
<span id="cb86-265"><a href="#cb86-265" aria-hidden="true" tabindex="-1"></a>                        <span class="at">caption =</span> <span class="st">"Mean and Standard Deviation of Test TSS for Anemonefish Models by Species and Type."</span>))</span>
<span id="cb86-266"><a href="#cb86-266" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">nrow</span>(anemonefish_tss_summary_table) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb86-267"><a href="#cb86-267" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(anemonefish_tss_summary_table)</span>
<span id="cb86-268"><a href="#cb86-268" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb86-269"><a href="#cb86-269" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"No summary data to print for anemonefish TSS.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-270"><a href="#cb86-270" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb86-271"><a href="#cb86-271" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-272"><a href="#cb86-272" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Save TSS summary table to CSV</span></span>
<span id="cb86-273"><a href="#cb86-273" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"analysis_output_dir"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">dir.exists</span>(analysis_output_dir)) {</span>
<span id="cb86-274"><a href="#cb86-274" aria-hidden="true" tabindex="-1"></a>      anemonefish_cv_summary_tss_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(analysis_output_dir, <span class="st">"anemonefish_detailed_CV_summary_tss.csv"</span>)</span>
<span id="cb86-275"><a href="#cb86-275" aria-hidden="true" tabindex="-1"></a>      <span class="fu">write.csv</span>(anemonefish_tss_summary_table, anemonefish_cv_summary_tss_path, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb86-276"><a href="#cb86-276" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Anemonefish detailed CV summary (Mean &amp; SD TSS) saved to:"</span>, anemonefish_cv_summary_tss_path, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-277"><a href="#cb86-277" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb86-278"><a href="#cb86-278" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Warning: 'analysis_output_dir' not defined. Anemonefish detailed CV summary (TSS) not saved to CSV.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-279"><a href="#cb86-279" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb86-280"><a href="#cb86-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-281"><a href="#cb86-281" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb86-282"><a href="#cb86-282" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Skipping model comparison as 'df_fish_comparison' is empty or required CV columns (AUC_test_CV, TSS_test_CV) are missing.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-283"><a href="#cb86-283" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Fitting GLMM to compare AUC_test_CV across model types ---

Summary of GLMM for AUC_test_CV:
 Family: gaussian  ( identity )
Formula:          AUC_test_CV ~ model_type + (1 | species)
Data: df_fish_comparison

      AIC       BIC    logLik -2*log(L)  df.resid 
  -3805.3   -3779.7    1907.6   -3815.3      1220 

Random effects:

Conditional model:
 Groups   Name        Variance Std.Dev.
 species  (Intercept) 0.007504 0.08663 
 Residual             0.002332 0.04830 
Number of obs: 1225, groups:  species, 27

Dispersion estimate for gaussian family (sigma^2): 0.00233 

Conditional model:
                             Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)                  0.894265   0.016873   53.00  &lt; 2e-16 ***
model_typecombined_host_env  0.021677   0.003407    6.36 1.99e-10 ***
model_typebiotic_only       -0.012437   0.003395   -3.66 0.000249 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

--- Fitting GLMM to compare TSS_test_CV across model types ---

Summary of GLMM for TSS_test_CV:
 Family: gaussian  ( identity )
Formula:          TSS_test_CV ~ model_type + (1 | species)
Data: df_fish_comparison

      AIC       BIC    logLik -2*log(L)  df.resid 
  -2609.4   -2583.8    1309.7   -2619.4      1220 

Random effects:

Conditional model:
 Groups   Name        Variance Std.Dev.
 species  (Intercept) 0.008527 0.09234 
 Residual             0.006309 0.07943 
Number of obs: 1225, groups:  species, 27

Dispersion estimate for gaussian family (sigma^2): 0.00631 

Conditional model:
                             Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)                  0.765913   0.018272   41.92  &lt; 2e-16 ***
model_typecombined_host_env  0.024375   0.005603    4.35 1.36e-05 ***
model_typebiotic_only       -0.031895   0.005583   -5.71 1.11e-08 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

--- Generating boxplot of AUC_test_CV by model type ---</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/compare-fish-model-performance-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Saved overall model AUC comparison plot to: /home/bi-server-kyoto/a0236995/sdm_anemonefish/figure_files/anemonefish_model_auc_comparison_overall.png </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/compare-fish-model-performance-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Saved per-species model AUC comparison plot to: /home/bi-server-kyoto/a0236995/sdm_anemonefish/figure_files/anemonefish_model_auc_comparison_per_species.png 

--- Generating boxplot of TSS_test_CV by model type ---</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/compare-fish-model-performance-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Saved overall model TSS comparison plot to: /home/bi-server-kyoto/a0236995/sdm_anemonefish/figure_files/anemonefish_model_tss_comparison_overall.png </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/compare-fish-model-performance-4.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Saved per-species model TSS comparison plot to: /home/bi-server-kyoto/a0236995/sdm_anemonefish/figure_files/anemonefish_model_tss_comparison_per_species.png 

--- Mean and Standard Deviation of Test AUC per Anemonefish Species and Model Type ---


Table: Mean and Standard Deviation of Test AUC for Anemonefish Models by Species and Type.

|Species                  |Model_Type        | Mean_AUC| SD_AUC| N_Folds|
|:------------------------|:-----------------|--------:|------:|-------:|
|Amphiprion akallopisos   |env_only          |    0.922|  0.015|      13|
|Amphiprion akallopisos   |combined_host_env |    0.928|  0.010|      16|
|Amphiprion akallopisos   |biotic_only       |    0.917|  0.019|      17|
|Amphiprion akindynos     |env_only          |    0.969|  0.016|      18|
|Amphiprion akindynos     |combined_host_env |    0.970|  0.014|      17|
|Amphiprion akindynos     |biotic_only       |    0.946|  0.006|      17|
|Amphiprion allardi       |env_only          |    0.969|  0.024|       7|
|Amphiprion allardi       |combined_host_env |    0.983|  0.011|      17|
|Amphiprion allardi       |biotic_only       |    0.969|  0.014|      17|
|Amphiprion barberi       |env_only          |    0.916|  0.026|      16|
|Amphiprion barberi       |combined_host_env |    0.941|  0.034|      15|
|Amphiprion barberi       |biotic_only       |    0.904|  0.045|      16|
|Amphiprion bicinctus     |env_only          |    0.980|  0.007|      15|
|Amphiprion bicinctus     |combined_host_env |    0.983|  0.006|      13|
|Amphiprion bicinctus     |biotic_only       |    0.973|  0.005|       7|
|Amphiprion chrysogaster  |env_only          |    0.824|  0.045|      17|
|Amphiprion chrysogaster  |combined_host_env |    0.874|  0.055|      13|
|Amphiprion chrysogaster  |biotic_only       |    0.840|  0.044|      17|
|Amphiprion chrysopterus  |env_only          |    0.920|  0.013|      18|
|Amphiprion chrysopterus  |combined_host_env |    0.927|  0.014|      17|
|Amphiprion chrysopterus  |biotic_only       |    0.832|  0.018|      17|
|Amphiprion clarkii       |env_only          |    0.930|  0.009|      18|
|Amphiprion clarkii       |combined_host_env |    0.929|  0.005|      17|
|Amphiprion clarkii       |biotic_only       |    0.913|  0.007|      17|
|Amphiprion ephippium     |env_only          |    0.935|  0.032|      17|
|Amphiprion ephippium     |combined_host_env |    0.932|  0.045|      17|
|Amphiprion ephippium     |biotic_only       |    0.891|  0.060|      16|
|Amphiprion frenatus      |env_only          |    0.904|  0.030|      13|
|Amphiprion frenatus      |combined_host_env |    0.921|  0.025|      17|
|Amphiprion frenatus      |biotic_only       |    0.875|  0.026|      17|
|Amphiprion fuscocaudatus |env_only          |    0.734|  0.120|      14|
|Amphiprion fuscocaudatus |combined_host_env |    0.839|  0.117|      13|
|Amphiprion fuscocaudatus |biotic_only       |    0.771|  0.139|      13|
|Amphiprion latezonatus   |env_only          |    0.923|  0.032|      18|
|Amphiprion latezonatus   |combined_host_env |    0.953|  0.023|       7|
|Amphiprion latezonatus   |biotic_only       |    0.941|  0.016|       7|
|Amphiprion latifasciatus |env_only          |    0.947|  0.039|      13|
|Amphiprion latifasciatus |combined_host_env |    0.972|  0.026|      16|
|Amphiprion latifasciatus |biotic_only       |    0.959|  0.028|      16|
|Amphiprion leucokranos   |env_only          |    0.790|  0.148|      15|
|Amphiprion leucokranos   |combined_host_env |    0.848|  0.103|      17|
|Amphiprion leucokranos   |biotic_only       |    0.828|  0.101|      17|
|Amphiprion mccullochi    |env_only          |    0.447|     NA|       1|
|Amphiprion mccullochi    |combined_host_env |    0.548|     NA|       1|
|Amphiprion mccullochi    |biotic_only       |    0.433|     NA|       1|
|Amphiprion melanopus     |env_only          |    0.923|  0.025|      17|
|Amphiprion melanopus     |combined_host_env |    0.942|  0.010|      17|
|Amphiprion melanopus     |biotic_only       |    0.924|  0.009|      17|
|Amphiprion nigripes      |env_only          |    0.930|  0.031|      17|
|Amphiprion nigripes      |combined_host_env |    0.945|  0.025|      17|
|Amphiprion nigripes      |biotic_only       |    0.921|  0.020|      17|
|Amphiprion ocellaris     |env_only          |    0.925|  0.010|       8|
|Amphiprion ocellaris     |combined_host_env |    0.926|  0.008|      12|
|Amphiprion ocellaris     |biotic_only       |    0.889|  0.013|      17|
|Amphiprion omanensis     |env_only          |    0.920|  0.082|      17|
|Amphiprion omanensis     |combined_host_env |    0.936|  0.059|      15|
|Amphiprion omanensis     |biotic_only       |    0.882|  0.114|      16|
|Amphiprion percula       |env_only          |    0.886|  0.024|      15|
|Amphiprion percula       |combined_host_env |    0.914|  0.015|      14|
|Amphiprion percula       |biotic_only       |    0.901|  0.014|      17|
|Amphiprion perideraion   |env_only          |    0.923|  0.015|      18|
|Amphiprion perideraion   |combined_host_env |    0.947|  0.011|      17|
|Amphiprion perideraion   |biotic_only       |    0.923|  0.011|      17|
|Amphiprion polymnus      |env_only          |    0.882|  0.034|      18|
|Amphiprion polymnus      |combined_host_env |    0.911|  0.020|      17|
|Amphiprion polymnus      |biotic_only       |    0.877|  0.035|      17|
|Amphiprion rubrocinctus  |env_only          |    0.976|  0.009|      17|
|Amphiprion rubrocinctus  |combined_host_env |    0.977|  0.011|      17|
|Amphiprion rubrocinctus  |biotic_only       |    0.959|  0.011|      17|
|Amphiprion sandaracinos  |env_only          |    0.910|  0.030|      18|
|Amphiprion sandaracinos  |combined_host_env |    0.920|  0.021|      15|
|Amphiprion sandaracinos  |biotic_only       |    0.870|  0.029|      16|
|Amphiprion sebae         |env_only          |    0.892|  0.056|      17|
|Amphiprion sebae         |combined_host_env |    0.896|  0.050|      17|
|Amphiprion sebae         |biotic_only       |    0.877|  0.056|      17|
|Amphiprion tricinctus    |env_only          |    0.906|  0.091|      17|
|Amphiprion tricinctus    |combined_host_env |    0.965|  0.023|      16|
|Amphiprion tricinctus    |biotic_only       |    0.837|  0.077|      16|
|Premnas biaculeatus      |env_only          |    0.894|  0.021|      16|
|Premnas biaculeatus      |combined_host_env |    0.925|  0.010|      17|
|Premnas biaculeatus      |biotic_only       |    0.912|  0.016|      17|

Anemonefish detailed CV summary (Mean &amp; SD AUC) saved to: /home/bi-server-kyoto/a0236995/sdm_anemonefish/outputs_for_analysis/anemonefish_detailed_CV_summary_auc.csv 

--- Mean and Standard Deviation of Test TSS per Anemonefish Species and Model Type ---


Table: Mean and Standard Deviation of Test TSS for Anemonefish Models by Species and Type.

|Species                  |Model_Type        | Mean_TSS| SD_TSS| N_Folds|
|:------------------------|:-----------------|--------:|------:|-------:|
|Amphiprion akallopisos   |env_only          |    0.771|  0.032|      13|
|Amphiprion akallopisos   |combined_host_env |    0.779|  0.021|      16|
|Amphiprion akallopisos   |biotic_only       |    0.767|  0.029|      17|
|Amphiprion akindynos     |env_only          |    0.891|  0.033|      18|
|Amphiprion akindynos     |combined_host_env |    0.893|  0.030|      17|
|Amphiprion akindynos     |biotic_only       |    0.827|  0.017|      17|
|Amphiprion allardi       |env_only          |    0.908|  0.053|       7|
|Amphiprion allardi       |combined_host_env |    0.923|  0.030|      17|
|Amphiprion allardi       |biotic_only       |    0.873|  0.029|      17|
|Amphiprion barberi       |env_only          |    0.774|  0.050|      16|
|Amphiprion barberi       |combined_host_env |    0.815|  0.070|      15|
|Amphiprion barberi       |biotic_only       |    0.756|  0.065|      16|
|Amphiprion bicinctus     |env_only          |    0.921|  0.015|      15|
|Amphiprion bicinctus     |combined_host_env |    0.922|  0.015|      13|
|Amphiprion bicinctus     |biotic_only       |    0.877|  0.021|       7|
|Amphiprion chrysogaster  |env_only          |    0.641|  0.072|      17|
|Amphiprion chrysogaster  |combined_host_env |    0.719|  0.071|      13|
|Amphiprion chrysogaster  |biotic_only       |    0.649|  0.065|      17|
|Amphiprion chrysopterus  |env_only          |    0.750|  0.027|      18|
|Amphiprion chrysopterus  |combined_host_env |    0.748|  0.032|      17|
|Amphiprion chrysopterus  |biotic_only       |    0.583|  0.037|      17|
|Amphiprion clarkii       |env_only          |    0.783|  0.014|      18|
|Amphiprion clarkii       |combined_host_env |    0.793|  0.014|      17|
|Amphiprion clarkii       |biotic_only       |    0.752|  0.019|      17|
|Amphiprion ephippium     |env_only          |    0.825|  0.068|      17|
|Amphiprion ephippium     |combined_host_env |    0.815|  0.078|      17|
|Amphiprion ephippium     |biotic_only       |    0.777|  0.083|      16|
|Amphiprion frenatus      |env_only          |    0.756|  0.031|      13|
|Amphiprion frenatus      |combined_host_env |    0.750|  0.032|      17|
|Amphiprion frenatus      |biotic_only       |    0.720|  0.032|      17|
|Amphiprion fuscocaudatus |env_only          |    0.594|  0.184|      14|
|Amphiprion fuscocaudatus |combined_host_env |    0.744|  0.192|      13|
|Amphiprion fuscocaudatus |biotic_only       |    0.645|  0.198|      13|
|Amphiprion latezonatus   |env_only          |    0.799|  0.063|      18|
|Amphiprion latezonatus   |combined_host_env |    0.814|  0.049|       7|
|Amphiprion latezonatus   |biotic_only       |    0.787|  0.026|       7|
|Amphiprion latifasciatus |env_only          |    0.889|  0.052|      13|
|Amphiprion latifasciatus |combined_host_env |    0.916|  0.051|      16|
|Amphiprion latifasciatus |biotic_only       |    0.878|  0.040|      16|
|Amphiprion leucokranos   |env_only          |    0.688|  0.179|      15|
|Amphiprion leucokranos   |combined_host_env |    0.714|  0.173|      17|
|Amphiprion leucokranos   |biotic_only       |    0.677|  0.167|      17|
|Amphiprion mccullochi    |env_only          |    0.349|     NA|       1|
|Amphiprion mccullochi    |combined_host_env |    0.498|     NA|       1|
|Amphiprion mccullochi    |biotic_only       |    0.328|     NA|       1|
|Amphiprion melanopus     |env_only          |    0.761|  0.033|      17|
|Amphiprion melanopus     |combined_host_env |    0.767|  0.031|      17|
|Amphiprion melanopus     |biotic_only       |    0.737|  0.019|      17|
|Amphiprion nigripes      |env_only          |    0.791|  0.087|      17|
|Amphiprion nigripes      |combined_host_env |    0.820|  0.056|      17|
|Amphiprion nigripes      |biotic_only       |    0.775|  0.033|      17|
|Amphiprion ocellaris     |env_only          |    0.748|  0.021|       8|
|Amphiprion ocellaris     |combined_host_env |    0.761|  0.018|      12|
|Amphiprion ocellaris     |biotic_only       |    0.713|  0.020|      17|
|Amphiprion omanensis     |env_only          |    0.857|  0.150|      17|
|Amphiprion omanensis     |combined_host_env |    0.884|  0.121|      15|
|Amphiprion omanensis     |biotic_only       |    0.810|  0.194|      16|
|Amphiprion percula       |env_only          |    0.710|  0.025|      15|
|Amphiprion percula       |combined_host_env |    0.715|  0.029|      14|
|Amphiprion percula       |biotic_only       |    0.709|  0.028|      17|
|Amphiprion perideraion   |env_only          |    0.764|  0.019|      18|
|Amphiprion perideraion   |combined_host_env |    0.805|  0.023|      17|
|Amphiprion perideraion   |biotic_only       |    0.769|  0.021|      17|
|Amphiprion polymnus      |env_only          |    0.735|  0.040|      18|
|Amphiprion polymnus      |combined_host_env |    0.733|  0.050|      17|
|Amphiprion polymnus      |biotic_only       |    0.693|  0.062|      17|
|Amphiprion rubrocinctus  |env_only          |    0.915|  0.021|      17|
|Amphiprion rubrocinctus  |combined_host_env |    0.918|  0.023|      17|
|Amphiprion rubrocinctus  |biotic_only       |    0.885|  0.022|      17|
|Amphiprion sandaracinos  |env_only          |    0.730|  0.029|      18|
|Amphiprion sandaracinos  |combined_host_env |    0.743|  0.031|      15|
|Amphiprion sandaracinos  |biotic_only       |    0.662|  0.056|      16|
|Amphiprion sebae         |env_only          |    0.729|  0.103|      17|
|Amphiprion sebae         |combined_host_env |    0.740|  0.083|      17|
|Amphiprion sebae         |biotic_only       |    0.718|  0.101|      17|
|Amphiprion tricinctus    |env_only          |    0.741|  0.196|      17|
|Amphiprion tricinctus    |combined_host_env |    0.879|  0.051|      16|
|Amphiprion tricinctus    |biotic_only       |    0.635|  0.117|      16|
|Premnas biaculeatus      |env_only          |    0.738|  0.024|      16|
|Premnas biaculeatus      |combined_host_env |    0.743|  0.020|      17|
|Premnas biaculeatus      |biotic_only       |    0.726|  0.024|      17|

Anemonefish detailed CV summary (Mean &amp; SD TSS) saved to: /home/bi-server-kyoto/a0236995/sdm_anemonefish/outputs_for_analysis/anemonefish_detailed_CV_summary_tss.csv </code></pre>
</div>
</div>
</section>
<section id="species-specific-anemonefish-model-performance-comparison" class="level2">
<h2 class="anchored" data-anchor-id="species-specific-anemonefish-model-performance-comparison">Species-Specific Anemonefish Model Performance Comparison</h2>
<p>This section performs a model comparison (environmental-only vs.&nbsp;biotic-only vs.&nbsp;combined) for each anemonefish species individually. For each species, an ANOVA is used to test for significant differences in mean Test AUC values across the model types, followed by Tukeyâ€™s HSD post-hoc tests if the ANOVA is significant. Boxplots illustrate these comparisons for each species.</p>
<div class="cell" data-cap="Comparison of Anemonefish Model Performance (Test AUC and TSS) for Each Species. For each species, boxplots show the distribution of Test AUC and TSS values from replicate runs for each model type (environmental-only, biotic-only, combined host+environment). Individual points represent single model runs (jittered), and large black/white points indicate the mean for each model type. ANOVA and Tukey's HSD tests (where appropriate) are performed to assess significant differences between model types within each species.">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="co"># # Ensure df_fish_comparison is available from the previous chunk</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a><span class="co"># if (!is.null(df_fish_comparison) &amp;&amp; nrow(df_fish_comparison) &gt; 0 &amp;&amp;</span></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a><span class="co">#     "AUC_test_CV" %in% names(df_fish_comparison) &amp;&amp; "TSS_test_CV" %in% names(df_fish_comparison)) {</span></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a><span class="co">#   # Create a working version of the dataframe with a cleaned species column for this specific analysis.</span></span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a><span class="co">#   # This avoids modifying the original df_fish_comparison if it's used later in its original state.</span></span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a><span class="co">#   # It also handles cases where species names might have .csv suffixes.</span></span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a><span class="co">#   df_fish_comparison_for_species_analysis &lt;- df_fish_comparison %&gt;%</span></span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a><span class="co">#     mutate(species_cleaned_for_loop = stringr::str_remove(species, "\\.csv$")) # Remove .csv suffix</span></span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true" tabindex="-1"></a><span class="co">#   # Get unique cleaned species names for the loop</span></span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true" tabindex="-1"></a><span class="co">#   all_anemonefish_species_for_loop &lt;- unique(df_fish_comparison_for_species_analysis$species_cleaned_for_loop)</span></span>
<span id="cb92-13"><a href="#cb92-13" aria-hidden="true" tabindex="-1"></a><span class="co">#   cat("\nPerforming species-specific model performance comparisons for anemonefish...\n")</span></span>
<span id="cb92-14"><a href="#cb92-14" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb92-15"><a href="#cb92-15" aria-hidden="true" tabindex="-1"></a><span class="co">#   # Loop through each unique anemonefish species</span></span>
<span id="cb92-16"><a href="#cb92-16" aria-hidden="true" tabindex="-1"></a><span class="co">#   for (current_species_name_sanitized in all_anemonefish_species_for_loop) {</span></span>
<span id="cb92-17"><a href="#cb92-17" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb92-18"><a href="#cb92-18" aria-hidden="true" tabindex="-1"></a><span class="co">#     # Create a more readable species name for output</span></span>
<span id="cb92-19"><a href="#cb92-19" aria-hidden="true" tabindex="-1"></a><span class="co">#     current_species_display_name &lt;- gsub("_", " ", current_species_name_sanitized)</span></span>
<span id="cb92-20"><a href="#cb92-20" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb92-21"><a href="#cb92-21" aria-hidden="true" tabindex="-1"></a><span class="co">#     cat("\n\n---\n") # Horizontal rule for separation in output</span></span>
<span id="cb92-22"><a href="#cb92-22" aria-hidden="true" tabindex="-1"></a><span class="co">#     cat(paste0("### Statistical Comparison for: *", current_species_display_name, "*\n")) # Markdown sub-header</span></span>
<span id="cb92-23"><a href="#cb92-23" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb92-24"><a href="#cb92-24" aria-hidden="true" tabindex="-1"></a><span class="co">#     # Subset data for the current species</span></span>
<span id="cb92-25"><a href="#cb92-25" aria-hidden="true" tabindex="-1"></a><span class="co">#     species_data_subset &lt;- df_fish_comparison %&gt;%</span></span>
<span id="cb92-26"><a href="#cb92-26" aria-hidden="true" tabindex="-1"></a><span class="co">#       filter(species == current_species_name_sanitized) %&gt;%</span></span>
<span id="cb92-27"><a href="#cb92-27" aria-hidden="true" tabindex="-1"></a><span class="co">#       mutate(model_type = factor(model_type,</span></span>
<span id="cb92-28"><a href="#cb92-28" aria-hidden="true" tabindex="-1"></a><span class="co">#                                  levels = c("env_only", "biotic_only", "combined_host_env"))) # Ensure factor levels</span></span>
<span id="cb92-29"><a href="#cb92-29" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb92-30"><a href="#cb92-30" aria-hidden="true" tabindex="-1"></a><span class="co">#     # Check if there's enough data to proceed for either AUC or TSS</span></span>
<span id="cb92-31"><a href="#cb92-31" aria-hidden="true" tabindex="-1"></a><span class="co">#     if (nrow(species_data_subset) &lt; 3 || length(unique(species_data_subset$model_type)) &lt; 2) {</span></span>
<span id="cb92-32"><a href="#cb92-32" aria-hidden="true" tabindex="-1"></a><span class="co">#       cat(paste0("Not enough data or distinct model types for ", current_species_display_name, " to perform comparison. Skipping.\n"))</span></span>
<span id="cb92-33"><a href="#cb92-33" aria-hidden="true" tabindex="-1"></a><span class="co">#       next</span></span>
<span id="cb92-34"><a href="#cb92-34" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb92-35"><a href="#cb92-35" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb92-36"><a href="#cb92-36" aria-hidden="true" tabindex="-1"></a><span class="co">#     # Check for sufficient replicates per model type</span></span>
<span id="cb92-37"><a href="#cb92-37" aria-hidden="true" tabindex="-1"></a><span class="co">#     replicates_summary &lt;- species_data_subset %&gt;%</span></span>
<span id="cb92-38"><a href="#cb92-38" aria-hidden="true" tabindex="-1"></a><span class="co">#         group_by(model_type) %&gt;%</span></span>
<span id="cb92-39"><a href="#cb92-39" aria-hidden="true" tabindex="-1"></a><span class="co">#         summarise(n_runs = n(), .groups = 'drop')</span></span>
<span id="cb92-40"><a href="#cb92-40" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb92-41"><a href="#cb92-41" aria-hidden="true" tabindex="-1"></a><span class="co">#     cat("\nNumber of runs per model type:\n")</span></span>
<span id="cb92-42"><a href="#cb92-42" aria-hidden="true" tabindex="-1"></a><span class="co">#     print(knitr::kable(replicates_summary, caption = paste("Replicates for", current_species_display_name)))</span></span>
<span id="cb92-43"><a href="#cb92-43" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb92-44"><a href="#cb92-44" aria-hidden="true" tabindex="-1"></a><span class="co">#     if (any(replicates_summary$n_runs &lt; 2) &amp;&amp; length(unique(replicates_summary$model_type)) &gt; 1) {</span></span>
<span id="cb92-45"><a href="#cb92-45" aria-hidden="true" tabindex="-1"></a><span class="co">#         cat(paste0("\n*Warning: At least one model type for ", current_species_display_name, " has fewer than 2 replicate runs. Statistical test results may not be robust.*\n"))</span></span>
<span id="cb92-46"><a href="#cb92-46" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb92-47"><a href="#cb92-47" aria-hidden="true" tabindex="-1"></a><span class="co">#     if (length(unique(replicates_summary$model_type[replicates_summary$n_runs &gt; 0])) &lt; 2) { # Check model types with actual data</span></span>
<span id="cb92-48"><a href="#cb92-48" aria-hidden="true" tabindex="-1"></a><span class="co">#         cat(paste0("\n*Warning: ", current_species_display_name, " does not have at least two different model types with data. Skipping statistical tests for this species.*\n"))</span></span>
<span id="cb92-49"><a href="#cb92-49" aria-hidden="true" tabindex="-1"></a><span class="co">#         next</span></span>
<span id="cb92-50"><a href="#cb92-50" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb92-51"><a href="#cb92-51" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb92-52"><a href="#cb92-52" aria-hidden="true" tabindex="-1"></a><span class="co">#     # --- Statistical Comparison using ANOVA for AUC_test_CV ---</span></span>
<span id="cb92-53"><a href="#cb92-53" aria-hidden="true" tabindex="-1"></a><span class="co">#     cat("\n**ANOVA: Test AUC vs. Model Type**\n")</span></span>
<span id="cb92-54"><a href="#cb92-54" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb92-55"><a href="#cb92-55" aria-hidden="true" tabindex="-1"></a><span class="co">#     # Check if AUC_test_CV has any variance for this species</span></span>
<span id="cb92-56"><a href="#cb92-56" aria-hidden="true" tabindex="-1"></a><span class="co">#     if (length(unique(na.omit(species_data_subset$AUC_test_CV))) &lt; 2) {</span></span>
<span id="cb92-57"><a href="#cb92-57" aria-hidden="true" tabindex="-1"></a><span class="co">#         cat(paste0("AUC_test_CV values are constant (or all NA) for ", current_species_display_name, ". Skipping ANOVA.\n"))</span></span>
<span id="cb92-58"><a href="#cb92-58" aria-hidden="true" tabindex="-1"></a><span class="co">#     } else {</span></span>
<span id="cb92-59"><a href="#cb92-59" aria-hidden="true" tabindex="-1"></a><span class="co">#         anova_model_species_auc &lt;- tryCatch({</span></span>
<span id="cb92-60"><a href="#cb92-60" aria-hidden="true" tabindex="-1"></a><span class="co">#           aov(AUC_test_CV ~ model_type, data = species_data_subset)</span></span>
<span id="cb92-61"><a href="#cb92-61" aria-hidden="true" tabindex="-1"></a><span class="co">#         }, error = function(e) {</span></span>
<span id="cb92-62"><a href="#cb92-62" aria-hidden="true" tabindex="-1"></a><span class="co">#           cat(paste0("Error performing ANOVA for AUC for ", current_species_display_name, ": ", e$message, "\n"))</span></span>
<span id="cb92-63"><a href="#cb92-63" aria-hidden="true" tabindex="-1"></a><span class="co">#           NULL</span></span>
<span id="cb92-64"><a href="#cb92-64" aria-hidden="true" tabindex="-1"></a><span class="co">#         })</span></span>
<span id="cb92-65"><a href="#cb92-65" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb92-66"><a href="#cb92-66" aria-hidden="true" tabindex="-1"></a><span class="co">#         if (!is.null(anova_model_species_auc)) {</span></span>
<span id="cb92-67"><a href="#cb92-67" aria-hidden="true" tabindex="-1"></a><span class="co">#           # Print ANOVA summary</span></span>
<span id="cb92-68"><a href="#cb92-68" aria-hidden="true" tabindex="-1"></a><span class="co">#           print(summary(anova_model_species_auc))</span></span>
<span id="cb92-69"><a href="#cb92-69" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb92-70"><a href="#cb92-70" aria-hidden="true" tabindex="-1"></a><span class="co">#           # Perform Tukey's HSD for pairwise comparisons if ANOVA is significant</span></span>
<span id="cb92-71"><a href="#cb92-71" aria-hidden="true" tabindex="-1"></a><span class="co">#           anova_summary_table_auc &lt;- summary(anova_model_species_auc)[[1]] # This is a list containing the table</span></span>
<span id="cb92-72"><a href="#cb92-72" aria-hidden="true" tabindex="-1"></a><span class="co">#           p_value_from_anova_auc &lt;- anova_summary_table_auc$"Pr(&gt;F)"[1] # Get the p-value for model_type</span></span>
<span id="cb92-73"><a href="#cb92-73" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb92-74"><a href="#cb92-74" aria-hidden="true" tabindex="-1"></a><span class="co">#           if (!is.na(p_value_from_anova_auc) &amp;&amp; p_value_from_anova_auc &lt; 0.05) {</span></span>
<span id="cb92-75"><a href="#cb92-75" aria-hidden="true" tabindex="-1"></a><span class="co">#             cat("\n**Tukey's HSD Post-Hoc Test (Pairwise Comparisons) for AUC**\n")</span></span>
<span id="cb92-76"><a href="#cb92-76" aria-hidden="true" tabindex="-1"></a><span class="co">#             tukey_hsd_results_auc &lt;- TukeyHSD(anova_model_species_auc)</span></span>
<span id="cb92-77"><a href="#cb92-77" aria-hidden="true" tabindex="-1"></a><span class="co">#             print(tukey_hsd_results_auc)</span></span>
<span id="cb92-78"><a href="#cb92-78" aria-hidden="true" tabindex="-1"></a><span class="co">#           } else {</span></span>
<span id="cb92-79"><a href="#cb92-79" aria-hidden="true" tabindex="-1"></a><span class="co">#             if (!is.na(p_value_from_anova_auc)) {</span></span>
<span id="cb92-80"><a href="#cb92-80" aria-hidden="true" tabindex="-1"></a><span class="co">#               cat(paste0("\nANOVA for AUC model_type not significant (p = ", round(p_value_from_anova_auc, 4), "), skipping Tukey's HSD for AUC.\n"))</span></span>
<span id="cb92-81"><a href="#cb92-81" aria-hidden="true" tabindex="-1"></a><span class="co">#             } else {</span></span>
<span id="cb92-82"><a href="#cb92-82" aria-hidden="true" tabindex="-1"></a><span class="co">#               cat("\nCould not determine AUC ANOVA significance, skipping Tukey's HSD for AUC.\n")</span></span>
<span id="cb92-83"><a href="#cb92-83" aria-hidden="true" tabindex="-1"></a><span class="co">#             }</span></span>
<span id="cb92-84"><a href="#cb92-84" aria-hidden="true" tabindex="-1"></a><span class="co">#           }</span></span>
<span id="cb92-85"><a href="#cb92-85" aria-hidden="true" tabindex="-1"></a><span class="co">#         }</span></span>
<span id="cb92-86"><a href="#cb92-86" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb92-87"><a href="#cb92-87" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb92-88"><a href="#cb92-88" aria-hidden="true" tabindex="-1"></a><span class="co">#     # --- Statistical Comparison using ANOVA for TSS_test_CV ---</span></span>
<span id="cb92-89"><a href="#cb92-89" aria-hidden="true" tabindex="-1"></a><span class="co">#     cat("\n**ANOVA: Test TSS vs. Model Type**\n")</span></span>
<span id="cb92-90"><a href="#cb92-90" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb92-91"><a href="#cb92-91" aria-hidden="true" tabindex="-1"></a><span class="co">#     # Check if TSS_test_CV has any variance for this species</span></span>
<span id="cb92-92"><a href="#cb92-92" aria-hidden="true" tabindex="-1"></a><span class="co">#     if (length(unique(na.omit(species_data_subset$TSS_test_CV))) &lt; 2) {</span></span>
<span id="cb92-93"><a href="#cb92-93" aria-hidden="true" tabindex="-1"></a><span class="co">#         cat(paste0("TSS_test_CV values are constant (or all NA) for ", current_species_display_name, ". Skipping ANOVA.\n"))</span></span>
<span id="cb92-94"><a href="#cb92-94" aria-hidden="true" tabindex="-1"></a><span class="co">#     } else {</span></span>
<span id="cb92-95"><a href="#cb92-95" aria-hidden="true" tabindex="-1"></a><span class="co">#         anova_model_species_tss &lt;- tryCatch({</span></span>
<span id="cb92-96"><a href="#cb92-96" aria-hidden="true" tabindex="-1"></a><span class="co">#           aov(TSS_test_CV ~ model_type, data = species_data_subset)</span></span>
<span id="cb92-97"><a href="#cb92-97" aria-hidden="true" tabindex="-1"></a><span class="co">#         }, error = function(e) {</span></span>
<span id="cb92-98"><a href="#cb92-98" aria-hidden="true" tabindex="-1"></a><span class="co">#           cat(paste0("Error performing ANOVA for TSS for ", current_species_display_name, ": ", e$message, "\n"))</span></span>
<span id="cb92-99"><a href="#cb92-99" aria-hidden="true" tabindex="-1"></a><span class="co">#           NULL</span></span>
<span id="cb92-100"><a href="#cb92-100" aria-hidden="true" tabindex="-1"></a><span class="co">#         })</span></span>
<span id="cb92-101"><a href="#cb92-101" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb92-102"><a href="#cb92-102" aria-hidden="true" tabindex="-1"></a><span class="co">#         if (!is.null(anova_model_species_tss)) {</span></span>
<span id="cb92-103"><a href="#cb92-103" aria-hidden="true" tabindex="-1"></a><span class="co">#           # Print ANOVA summary</span></span>
<span id="cb92-104"><a href="#cb92-104" aria-hidden="true" tabindex="-1"></a><span class="co">#           print(summary(anova_model_species_tss))</span></span>
<span id="cb92-105"><a href="#cb92-105" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb92-106"><a href="#cb92-106" aria-hidden="true" tabindex="-1"></a><span class="co">#           # Perform Tukey's HSD for pairwise comparisons if ANOVA is significant</span></span>
<span id="cb92-107"><a href="#cb92-107" aria-hidden="true" tabindex="-1"></a><span class="co">#           anova_summary_table_tss &lt;- summary(anova_model_species_tss)[[1]]</span></span>
<span id="cb92-108"><a href="#cb92-108" aria-hidden="true" tabindex="-1"></a><span class="co">#           p_value_from_anova_tss &lt;- anova_summary_table_tss$"Pr(&gt;F)"[1]</span></span>
<span id="cb92-109"><a href="#cb92-109" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb92-110"><a href="#cb92-110" aria-hidden="true" tabindex="-1"></a><span class="co">#           if (!is.na(p_value_from_anova_tss) &amp;&amp; p_value_from_anova_tss &lt; 0.05) {</span></span>
<span id="cb92-111"><a href="#cb92-111" aria-hidden="true" tabindex="-1"></a><span class="co">#             cat("\n**Tukey's HSD Post-Hoc Test (Pairwise Comparisons) for TSS**\n")</span></span>
<span id="cb92-112"><a href="#cb92-112" aria-hidden="true" tabindex="-1"></a><span class="co">#             tukey_hsd_results_tss &lt;- TukeyHSD(anova_model_species_tss)</span></span>
<span id="cb92-113"><a href="#cb92-113" aria-hidden="true" tabindex="-1"></a><span class="co">#             print(tukey_hsd_results_tss)</span></span>
<span id="cb92-114"><a href="#cb92-114" aria-hidden="true" tabindex="-1"></a><span class="co">#           } else {</span></span>
<span id="cb92-115"><a href="#cb92-115" aria-hidden="true" tabindex="-1"></a><span class="co">#             if (!is.na(p_value_from_anova_tss)) {</span></span>
<span id="cb92-116"><a href="#cb92-116" aria-hidden="true" tabindex="-1"></a><span class="co">#               cat(paste0("\nANOVA for TSS model_type not significant (p = ", round(p_value_from_anova_tss, 4), "), skipping Tukey's HSD for TSS.\n"))</span></span>
<span id="cb92-117"><a href="#cb92-117" aria-hidden="true" tabindex="-1"></a><span class="co">#             } else {</span></span>
<span id="cb92-118"><a href="#cb92-118" aria-hidden="true" tabindex="-1"></a><span class="co">#               cat("\nCould not determine TSS ANOVA significance, skipping Tukey's HSD for TSS.\n")</span></span>
<span id="cb92-119"><a href="#cb92-119" aria-hidden="true" tabindex="-1"></a><span class="co">#             }</span></span>
<span id="cb92-120"><a href="#cb92-120" aria-hidden="true" tabindex="-1"></a><span class="co">#           }</span></span>
<span id="cb92-121"><a href="#cb92-121" aria-hidden="true" tabindex="-1"></a><span class="co">#         }</span></span>
<span id="cb92-122"><a href="#cb92-122" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb92-123"><a href="#cb92-123" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb92-124"><a href="#cb92-124" aria-hidden="true" tabindex="-1"></a><span class="co">#     # --- Visualization for AUC_test_CV for the current species ---</span></span>
<span id="cb92-125"><a href="#cb92-125" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb92-126"><a href="#cb92-126" aria-hidden="true" tabindex="-1"></a><span class="co">#     # Determine dynamic y-axis limits, ensuring they are sensible for AUC</span></span>
<span id="cb92-127"><a href="#cb92-127" aria-hidden="true" tabindex="-1"></a><span class="co">#     min_auc_val &lt;- min(species_data_subset$AUC_test_CV, na.rm = TRUE)</span></span>
<span id="cb92-128"><a href="#cb92-128" aria-hidden="true" tabindex="-1"></a><span class="co">#     max_auc_val &lt;- max(species_data_subset$AUC_test_CV, na.rm = TRUE)</span></span>
<span id="cb92-129"><a href="#cb92-129" aria-hidden="true" tabindex="-1"></a><span class="co">#     y_lower_limit_auc &lt;- max(0, min(0.4, min_auc_val - 0.05)) # Not below 0, and give some space</span></span>
<span id="cb92-130"><a href="#cb92-130" aria-hidden="true" tabindex="-1"></a><span class="co">#     y_upper_limit_auc &lt;- min(1, max_auc_val + 0.05)             # Not above 1, and give some space</span></span>
<span id="cb92-131"><a href="#cb92-131" aria-hidden="true" tabindex="-1"></a><span class="co">#     if (is.infinite(y_lower_limit_auc) || is.infinite(y_upper_limit_auc) || y_lower_limit_auc &gt;= y_upper_limit_auc) {</span></span>
<span id="cb92-132"><a href="#cb92-132" aria-hidden="true" tabindex="-1"></a><span class="co">#         y_lower_limit_auc &lt;- 0.4</span></span>
<span id="cb92-133"><a href="#cb92-133" aria-hidden="true" tabindex="-1"></a><span class="co">#         y_upper_limit_auc &lt;- 1.0</span></span>
<span id="cb92-134"><a href="#cb92-134" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb92-135"><a href="#cb92-135" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb92-136"><a href="#cb92-136" aria-hidden="true" tabindex="-1"></a><span class="co">#     plot_auc_species_specific &lt;- ggplot(species_data_subset, aes(x = model_type, y = AUC_test_CV, fill = model_type)) +</span></span>
<span id="cb92-137"><a href="#cb92-137" aria-hidden="true" tabindex="-1"></a><span class="co">#       geom_boxplot(alpha = 0.7, outlier.shape = NA) + # Hiding default outliers as geom_jitter shows all points</span></span>
<span id="cb92-138"><a href="#cb92-138" aria-hidden="true" tabindex="-1"></a><span class="co">#       geom_jitter(width = 0.15, alpha = 0.6, height = 0, size = 1.5) + # Show individual run points</span></span>
<span id="cb92-139"><a href="#cb92-139" aria-hidden="true" tabindex="-1"></a><span class="co">#       stat_summary(fun = mean, geom = "point", shape = 23, size = 3, fill = "white", color="black", # Diamond for mean</span></span>
<span id="cb92-140"><a href="#cb92-140" aria-hidden="true" tabindex="-1"></a><span class="co">#                    position = position_dodge(width = 0.75)) +</span></span>
<span id="cb92-141"><a href="#cb92-141" aria-hidden="true" tabindex="-1"></a><span class="co">#       labs(</span></span>
<span id="cb92-142"><a href="#cb92-142" aria-hidden="true" tabindex="-1"></a><span class="co">#         title = paste("Model Performance (Test AUC) for", current_species_display_name),</span></span>
<span id="cb92-143"><a href="#cb92-143" aria-hidden="true" tabindex="-1"></a><span class="co">#         x = "Model Type",</span></span>
<span id="cb92-144"><a href="#cb92-144" aria-hidden="true" tabindex="-1"></a><span class="co">#         y = "Test AUC Score"</span></span>
<span id="cb92-145"><a href="#cb92-145" aria-hidden="true" tabindex="-1"></a><span class="co">#       ) +</span></span>
<span id="cb92-146"><a href="#cb92-146" aria-hidden="true" tabindex="-1"></a><span class="co">#       scale_fill_manual(</span></span>
<span id="cb92-147"><a href="#cb92-147" aria-hidden="true" tabindex="-1"></a><span class="co">#         values = c("env_only" = "grey70", "biotic_only" = "skyblue", "combined_host_env" = "salmon"),</span></span>
<span id="cb92-148"><a href="#cb92-148" aria-hidden="true" tabindex="-1"></a><span class="co">#         name = "Model Type:",</span></span>
<span id="cb92-149"><a href="#cb92-149" aria-hidden="true" tabindex="-1"></a><span class="co">#         labels = c("Environmental Only", "Biotic (Host) Only", "Combined (Host+Env)")</span></span>
<span id="cb92-150"><a href="#cb92-150" aria-hidden="true" tabindex="-1"></a><span class="co">#       ) +</span></span>
<span id="cb92-151"><a href="#cb92-151" aria-hidden="true" tabindex="-1"></a><span class="co">#       theme_bw(base_size = 11) +</span></span>
<span id="cb92-152"><a href="#cb92-152" aria-hidden="true" tabindex="-1"></a><span class="co">#       theme(</span></span>
<span id="cb92-153"><a href="#cb92-153" aria-hidden="true" tabindex="-1"></a><span class="co">#         legend.position = "top",</span></span>
<span id="cb92-154"><a href="#cb92-154" aria-hidden="true" tabindex="-1"></a><span class="co">#         axis.text.x = element_text(angle = 45, hjust = 1, size = 9),</span></span>
<span id="cb92-155"><a href="#cb92-155" aria-hidden="true" tabindex="-1"></a><span class="co">#         plot.title = element_text(size = 13, hjust = 0.5),</span></span>
<span id="cb92-156"><a href="#cb92-156" aria-hidden="true" tabindex="-1"></a><span class="co">#         panel.grid.minor = element_blank()</span></span>
<span id="cb92-157"><a href="#cb92-157" aria-hidden="true" tabindex="-1"></a><span class="co">#       ) +</span></span>
<span id="cb92-158"><a href="#cb92-158" aria-hidden="true" tabindex="-1"></a><span class="co">#       coord_cartesian(ylim = c(y_lower_limit_auc, y_upper_limit_auc)) # Apply dynamic y-limits</span></span>
<span id="cb92-159"><a href="#cb92-159" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb92-160"><a href="#cb92-160" aria-hidden="true" tabindex="-1"></a><span class="co">#     species_specific_auc_figure_output_dir &lt;- paste0(figure_output_dir, "/AUC_boxplots")</span></span>
<span id="cb92-161"><a href="#cb92-161" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb92-162"><a href="#cb92-162" aria-hidden="true" tabindex="-1"></a><span class="co">#     if (!dir.exists(species_specific_auc_figure_output_dir)) {</span></span>
<span id="cb92-163"><a href="#cb92-163" aria-hidden="true" tabindex="-1"></a><span class="co">#       dir.create(species_specific_auc_figure_output_dir, recursive = TRUE)</span></span>
<span id="cb92-164"><a href="#cb92-164" aria-hidden="true" tabindex="-1"></a><span class="co">#       cat("Created directory for AUC figures at:", species_specific_auc_figure_output_dir, "\n")</span></span>
<span id="cb92-165"><a href="#cb92-165" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb92-166"><a href="#cb92-166" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb92-167"><a href="#cb92-167" aria-hidden="true" tabindex="-1"></a><span class="co">#     # Define filename for AUC plot</span></span>
<span id="cb92-168"><a href="#cb92-168" aria-hidden="true" tabindex="-1"></a><span class="co">#     auc_plot_filename &lt;- file.path(species_specific_auc_figure_output_dir, paste0("AUC_boxplot_", current_species_name_sanitized, ".png"))</span></span>
<span id="cb92-169"><a href="#cb92-169" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb92-170"><a href="#cb92-170" aria-hidden="true" tabindex="-1"></a><span class="co">#     # Save AUC plot using ggsave for better quality control</span></span>
<span id="cb92-171"><a href="#cb92-171" aria-hidden="true" tabindex="-1"></a><span class="co">#     ggsave(filename = auc_plot_filename, plot = plot_auc_species_specific,</span></span>
<span id="cb92-172"><a href="#cb92-172" aria-hidden="true" tabindex="-1"></a><span class="co">#            width = 7, height = 5.5, units = "in", dpi = 300)</span></span>
<span id="cb92-173"><a href="#cb92-173" aria-hidden="true" tabindex="-1"></a><span class="co">#     cat("Saved species specific AUC plot to:", auc_plot_filename, "\n")</span></span>
<span id="cb92-174"><a href="#cb92-174" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb92-175"><a href="#cb92-175" aria-hidden="true" tabindex="-1"></a><span class="co">#     print(plot_auc_species_specific)</span></span>
<span id="cb92-176"><a href="#cb92-176" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb92-177"><a href="#cb92-177" aria-hidden="true" tabindex="-1"></a><span class="co">#     # --- Visualization for TSS_test_CV for the current species ---</span></span>
<span id="cb92-178"><a href="#cb92-178" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb92-179"><a href="#cb92-179" aria-hidden="true" tabindex="-1"></a><span class="co">#     # Determine dynamic y-axis limits, ensuring they are sensible for TSS</span></span>
<span id="cb92-180"><a href="#cb92-180" aria-hidden="true" tabindex="-1"></a><span class="co">#     min_tss_val &lt;- min(species_data_subset$TSS_test_CV, na.rm = TRUE)</span></span>
<span id="cb92-181"><a href="#cb92-181" aria-hidden="true" tabindex="-1"></a><span class="co">#     max_tss_val &lt;- max(species_data_subset$TSS_test_CV, na.rm = TRUE)</span></span>
<span id="cb92-182"><a href="#cb92-182" aria-hidden="true" tabindex="-1"></a><span class="co">#     y_lower_limit_tss &lt;- max(0, min(0.1, min_tss_val - 0.05)) # Not below 0, and give some space (TSS can be low)</span></span>
<span id="cb92-183"><a href="#cb92-183" aria-hidden="true" tabindex="-1"></a><span class="co">#     y_upper_limit_tss &lt;- min(1, max_tss_val + 0.05)             # Not above 1, and give some space</span></span>
<span id="cb92-184"><a href="#cb92-184" aria-hidden="true" tabindex="-1"></a><span class="co">#     if (is.infinite(y_lower_limit_tss) || is.infinite(y_upper_limit_tss) || y_lower_limit_tss &gt;= y_upper_limit_tss) {</span></span>
<span id="cb92-185"><a href="#cb92-185" aria-hidden="true" tabindex="-1"></a><span class="co">#         y_lower_limit_tss &lt;- 0.1</span></span>
<span id="cb92-186"><a href="#cb92-186" aria-hidden="true" tabindex="-1"></a><span class="co">#         y_upper_limit_tss &lt;- 1.0</span></span>
<span id="cb92-187"><a href="#cb92-187" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb92-188"><a href="#cb92-188" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb92-189"><a href="#cb92-189" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb92-190"><a href="#cb92-190" aria-hidden="true" tabindex="-1"></a><span class="co">#     plot_tss_species_specific &lt;- ggplot(species_data_subset, aes(x = model_type, y = TSS_test_CV, fill = model_type)) +</span></span>
<span id="cb92-191"><a href="#cb92-191" aria-hidden="true" tabindex="-1"></a><span class="co">#       geom_boxplot(alpha = 0.7, outlier.shape = NA) +</span></span>
<span id="cb92-192"><a href="#cb92-192" aria-hidden="true" tabindex="-1"></a><span class="co">#       geom_jitter(width = 0.15, alpha = 0.6, height = 0, size = 1.5) +</span></span>
<span id="cb92-193"><a href="#cb92-193" aria-hidden="true" tabindex="-1"></a><span class="co">#       stat_summary(fun = mean, geom = "point", shape = 23, size = 3, fill = "white", color="black",</span></span>
<span id="cb92-194"><a href="#cb92-194" aria-hidden="true" tabindex="-1"></a><span class="co">#                    position = position_dodge(width = 0.75)) +</span></span>
<span id="cb92-195"><a href="#cb92-195" aria-hidden="true" tabindex="-1"></a><span class="co">#       labs(</span></span>
<span id="cb92-196"><a href="#cb92-196" aria-hidden="true" tabindex="-1"></a><span class="co">#         title = paste("Model Performance (Test TSS) for", current_species_display_name),</span></span>
<span id="cb92-197"><a href="#cb92-197" aria-hidden="true" tabindex="-1"></a><span class="co">#         x = "Model Type",</span></span>
<span id="cb92-198"><a href="#cb92-198" aria-hidden="true" tabindex="-1"></a><span class="co">#         y = "Test TSS Score"</span></span>
<span id="cb92-199"><a href="#cb92-199" aria-hidden="true" tabindex="-1"></a><span class="co">#       ) +</span></span>
<span id="cb92-200"><a href="#cb92-200" aria-hidden="true" tabindex="-1"></a><span class="co">#       scale_fill_manual(</span></span>
<span id="cb92-201"><a href="#cb92-201" aria-hidden="true" tabindex="-1"></a><span class="co">#         values = c("env_only" = "grey70", "biotic_only" = "lightgreen", "combined_host_env" = "purple"), # Different colors for TSS</span></span>
<span id="cb92-202"><a href="#cb92-202" aria-hidden="true" tabindex="-1"></a><span class="co">#         name = "Model Type:",</span></span>
<span id="cb92-203"><a href="#cb92-203" aria-hidden="true" tabindex="-1"></a><span class="co">#         labels = c("Environmental Only", "Biotic (Host) Only", "Combined (Host+Env)")</span></span>
<span id="cb92-204"><a href="#cb92-204" aria-hidden="true" tabindex="-1"></a><span class="co">#       ) +</span></span>
<span id="cb92-205"><a href="#cb92-205" aria-hidden="true" tabindex="-1"></a><span class="co">#       theme_bw(base_size = 11) +</span></span>
<span id="cb92-206"><a href="#cb92-206" aria-hidden="true" tabindex="-1"></a><span class="co">#       theme(</span></span>
<span id="cb92-207"><a href="#cb92-207" aria-hidden="true" tabindex="-1"></a><span class="co">#         legend.position = "top",</span></span>
<span id="cb92-208"><a href="#cb92-208" aria-hidden="true" tabindex="-1"></a><span class="co">#         axis.text.x = element_text(angle = 45, hjust = 1, size = 9),</span></span>
<span id="cb92-209"><a href="#cb92-209" aria-hidden="true" tabindex="-1"></a><span class="co">#         plot.title = element_text(size = 13, hjust = 0.5),</span></span>
<span id="cb92-210"><a href="#cb92-210" aria-hidden="true" tabindex="-1"></a><span class="co">#         panel.grid.minor = element_blank()</span></span>
<span id="cb92-211"><a href="#cb92-211" aria-hidden="true" tabindex="-1"></a><span class="co">#       ) +</span></span>
<span id="cb92-212"><a href="#cb92-212" aria-hidden="true" tabindex="-1"></a><span class="co">#       coord_cartesian(ylim = c(y_lower_limit_tss, y_upper_limit_tss)) # Apply dynamic y-limits</span></span>
<span id="cb92-213"><a href="#cb92-213" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb92-214"><a href="#cb92-214" aria-hidden="true" tabindex="-1"></a><span class="co">#     species_specific_tss_figure_output_dir &lt;- paste0(figure_output_dir, "/TSS_boxplots")</span></span>
<span id="cb92-215"><a href="#cb92-215" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb92-216"><a href="#cb92-216" aria-hidden="true" tabindex="-1"></a><span class="co">#     if (!dir.exists(species_specific_tss_figure_output_dir)) {</span></span>
<span id="cb92-217"><a href="#cb92-217" aria-hidden="true" tabindex="-1"></a><span class="co">#       dir.create(species_specific_tss_figure_output_dir, recursive = TRUE)</span></span>
<span id="cb92-218"><a href="#cb92-218" aria-hidden="true" tabindex="-1"></a><span class="co">#       cat("Created directory for TSS figures at:", species_specific_tss_figure_output_dir, "\n")</span></span>
<span id="cb92-219"><a href="#cb92-219" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb92-220"><a href="#cb92-220" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb92-221"><a href="#cb92-221" aria-hidden="true" tabindex="-1"></a><span class="co">#     # Define filename for TSS plot</span></span>
<span id="cb92-222"><a href="#cb92-222" aria-hidden="true" tabindex="-1"></a><span class="co">#     tss_plot_filename &lt;- file.path(species_specific_tss_figure_output_dir, paste0("TSS_boxplot_", current_species_name_sanitized, ".png"))</span></span>
<span id="cb92-223"><a href="#cb92-223" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb92-224"><a href="#cb92-224" aria-hidden="true" tabindex="-1"></a><span class="co">#     # Save TSS plot using ggsave</span></span>
<span id="cb92-225"><a href="#cb92-225" aria-hidden="true" tabindex="-1"></a><span class="co">#     ggsave(filename = tss_plot_filename, plot = plot_tss_species_specific,</span></span>
<span id="cb92-226"><a href="#cb92-226" aria-hidden="true" tabindex="-1"></a><span class="co">#            width = 7, height = 5.5, units = "in", dpi = 300)</span></span>
<span id="cb92-227"><a href="#cb92-227" aria-hidden="true" tabindex="-1"></a><span class="co">#     cat("Saved species specific TSS plot to:", tss_plot_filename, "\n")</span></span>
<span id="cb92-228"><a href="#cb92-228" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb92-229"><a href="#cb92-229" aria-hidden="true" tabindex="-1"></a><span class="co">#     print(plot_tss_species_specific)</span></span>
<span id="cb92-230"><a href="#cb92-230" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb92-231"><a href="#cb92-231" aria-hidden="true" tabindex="-1"></a><span class="co">#   } # End loop through species</span></span>
<span id="cb92-232"><a href="#cb92-232" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb92-233"><a href="#cb92-233" aria-hidden="true" tabindex="-1"></a><span class="co"># } else {</span></span>
<span id="cb92-234"><a href="#cb92-234" aria-hidden="true" tabindex="-1"></a><span class="co">#   cat("\nSkipping species-specific anemonefish model comparison as 'df_fish_comparison' is not available, empty, or 'AUC_test_CV' or 'TSS_test_CV' columns are missing.\n")</span></span>
<span id="cb92-235"><a href="#cb92-235" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="current-environmental-predictors-pca" class="level2">
<h2 class="anchored" data-anchor-id="current-environmental-predictors-pca">Current Environmental Predictors (PCA)</h2>
<p>This section loads the Principal Component Analysis (PCA) rasters for the current environmental conditions. These PCA rasters were generated by script <code>05_preprocess_env_pca_only.R</code> (if PCA was used) and represent the primary environmental gradients used in the SDMs.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (config<span class="sc">$</span>use_pca_predictors) {</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"--- Loading Current Environmental PCA Rasters ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># The rds file stores a list of paths, one for each scenario's PCA .tif file</span></span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(config<span class="sc">$</span>pca_raster_paths_rds_path)) {</span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"PCA raster paths RDS file not found: "</span>, config<span class="sc">$</span>pca_raster_paths_rds_path, </span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a>         <span class="st">"</span><span class="sc">\n</span><span class="st">Please ensure script 05 (PCA preprocessing) ran successfully."</span>)</span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a>  all_pca_raster_paths <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(config<span class="sc">$</span>pca_raster_paths_rds_path)</span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb93-10"><a href="#cb93-10" aria-hidden="true" tabindex="-1"></a>  current_pca_path <span class="ot">&lt;-</span> all_pca_raster_paths[[<span class="st">"current"</span>]]</span>
<span id="cb93-11"><a href="#cb93-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(current_pca_path) <span class="sc">||</span> <span class="sc">!</span><span class="fu">file.exists</span>(current_pca_path)) {</span>
<span id="cb93-12"><a href="#cb93-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Path for 'current' PCA raster not found in RDS or file does not exist: "</span>, current_pca_path <span class="sc">%||%</span> <span class="st">"NULL"</span>)</span>
<span id="cb93-13"><a href="#cb93-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb93-14"><a href="#cb93-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb93-15"><a href="#cb93-15" aria-hidden="true" tabindex="-1"></a>  env_pca_current <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb93-16"><a href="#cb93-16" aria-hidden="true" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">rast</span>(current_pca_path)</span>
<span id="cb93-17"><a href="#cb93-17" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb93-18"><a href="#cb93-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Error loading current PCA raster from:"</span>, current_pca_path, <span class="st">"</span><span class="sc">\n</span><span class="st">Error:"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb93-19"><a href="#cb93-19" aria-hidden="true" tabindex="-1"></a>    <span class="cn">NULL</span></span>
<span id="cb93-20"><a href="#cb93-20" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb93-21"><a href="#cb93-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb93-22"><a href="#cb93-22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(env_pca_current)) {</span>
<span id="cb93-23"><a href="#cb93-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(env_pca_current) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"Current Environmental PC"</span>, <span class="dv">1</span><span class="sc">:</span>terra<span class="sc">::</span><span class="fu">nlyr</span>(env_pca_current)) <span class="co"># Ensure standard names</span></span>
<span id="cb93-24"><a href="#cb93-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Loaded current environmental PCA rasters. Layers:"</span>, <span class="fu">paste</span>(<span class="fu">names</span>(env_pca_current), <span class="at">collapse=</span><span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb93-25"><a href="#cb93-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb93-26"><a href="#cb93-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Crop if configured (should match how other current rasters were handled)</span></span>
<span id="cb93-27"><a href="#cb93-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (config<span class="sc">$</span>apply_indo_pacific_crop) {</span>
<span id="cb93-28"><a href="#cb93-28" aria-hidden="true" tabindex="-1"></a>      ip_extent <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">ext</span>(config<span class="sc">$</span>indo_pacific_bbox)</span>
<span id="cb93-29"><a href="#cb93-29" aria-hidden="true" tabindex="-1"></a>      env_pca_current_cropped <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">crop</span>(env_pca_current, ip_extent)</span>
<span id="cb93-30"><a href="#cb93-30" aria-hidden="true" tabindex="-1"></a>      <span class="fu">plot</span>(env_pca_current_cropped)</span>
<span id="cb93-31"><a href="#cb93-31" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb93-32"><a href="#cb93-32" aria-hidden="true" tabindex="-1"></a>      env_pca_current_cropped <span class="ot">&lt;-</span> env_pca_current <span class="co"># Use uncropped if not configured</span></span>
<span id="cb93-33"><a href="#cb93-33" aria-hidden="true" tabindex="-1"></a>      <span class="fu">plot</span>(env_pca_current_cropped)</span>
<span id="cb93-34"><a href="#cb93-34" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb93-35"><a href="#cb93-35" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb93-36"><a href="#cb93-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Error: Could not load current environmental PCA rasters.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb93-37"><a href="#cb93-37" aria-hidden="true" tabindex="-1"></a>    env_pca_current_cropped <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb93-38"><a href="#cb93-38" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb93-39"><a href="#cb93-39" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb93-40"><a href="#cb93-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"--- PCA predictors not used. Skipping loading of current PCA rasters. ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb93-41"><a href="#cb93-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"    You might need to load your VIF-selected current environmental rasters here if needed for specific analyses.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb93-42"><a href="#cb93-42" aria-hidden="true" tabindex="-1"></a>  env_pca_current_cropped <span class="ot">&lt;-</span> <span class="cn">NULL</span> <span class="co"># Ensure this object exists as NULL if PCA not used</span></span>
<span id="cb93-43"><a href="#cb93-43" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- Loading Current Environmental PCA Rasters ---
Loaded current environmental PCA rasters. Layers: Current Environmental PC1, Current Environmental PC2, Current Environmental PC3, Current Environmental PC4 </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-current-env-pca-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="future-species-richness-projections" class="level2">
<h2 class="anchored" data-anchor-id="future-species-richness-projections">Future Species Richness Projections</h2>
<p>This section loads the predicted future suitability rasters for host sea anemones and anemonefish (from environmental-only models) for each future scenario and time step, and calculates the summed richness.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the future scenarios and time steps from your config</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Your config$env_scenarios already includes "current", so we filter that out</span></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>future_scenarios_to_load <span class="ot">&lt;-</span> config<span class="sc">$</span>env_scenarios[config<span class="sc">$</span>env_scenarios <span class="sc">!=</span> <span class="st">"current"</span>]</span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(future_scenarios_to_load) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"No future scenarios defined in config$env_scenarios to load predictions for.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Lists to store the summed richness rasters for each future scenario</span></span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a>host_richness_future_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb95-10"><a href="#cb95-10" aria-hidden="true" tabindex="-1"></a>fish_richness_future_list <span class="ot">&lt;-</span> <span class="fu">list</span>() <span class="co"># For env-only fish models</span></span>
<span id="cb95-11"><a href="#cb95-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-12"><a href="#cb95-12" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Create subdirectory for these specific future richness maps ---</span></span>
<span id="cb95-13"><a href="#cb95-13" aria-hidden="true" tabindex="-1"></a><span class="co"># This assumes figure_output_dir is defined in your setup chunk</span></span>
<span id="cb95-14"><a href="#cb95-14" aria-hidden="true" tabindex="-1"></a>future_richness_maps_subdir <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb95-15"><a href="#cb95-15" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"figure_output_dir"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">dir.exists</span>(figure_output_dir)) {</span>
<span id="cb95-16"><a href="#cb95-16" aria-hidden="true" tabindex="-1"></a>  future_richness_maps_subdir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(figure_output_dir, <span class="st">"future_richness_projections"</span>)</span>
<span id="cb95-17"><a href="#cb95-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(future_richness_maps_subdir)) {</span>
<span id="cb95-18"><a href="#cb95-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>(future_richness_maps_subdir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb95-19"><a href="#cb95-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Created subdirectory for future richness maps at:"</span>, future_richness_maps_subdir, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb95-20"><a href="#cb95-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb95-21"><a href="#cb95-21" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb95-22"><a href="#cb95-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Warning: 'figure_output_dir' not defined or does not exist. Future richness maps will not be saved to file.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb95-23"><a href="#cb95-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb95-24"><a href="#cb95-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-25"><a href="#cb95-25" aria-hidden="true" tabindex="-1"></a>predictor_suffix_anemone <span class="ot">&lt;-</span> <span class="st">"_pca"</span></span>
<span id="cb95-26"><a href="#cb95-26" aria-hidden="true" tabindex="-1"></a>predictor_suffix <span class="ot">&lt;-</span> <span class="st">"_combined_pca"</span></span>
<span id="cb95-27"><a href="#cb95-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-28"><a href="#cb95-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-29"><a href="#cb95-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through each future scenario</span></span>
<span id="cb95-30"><a href="#cb95-30" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (scenario_name <span class="cf">in</span> future_scenarios_to_load) {</span>
<span id="cb95-31"><a href="#cb95-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Processing Future Scenario:"</span>, scenario_name, <span class="st">"---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb95-32"><a href="#cb95-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb95-33"><a href="#cb95-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- 1. Load Host Sea Anemone Future Predictions ---</span></span>
<span id="cb95-34"><a href="#cb95-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"  Loading Host Sea Anemone predictions for"</span>, scenario_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb95-35"><a href="#cb95-35" aria-hidden="true" tabindex="-1"></a>  host_future_raster_files <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb95-36"><a href="#cb95-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Assuming anemone_species_df and predictor_suffix are defined from a previous chunk</span></span>
<span id="cb95-37"><a href="#cb95-37" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(anemone_species_df)) { </span>
<span id="cb95-38"><a href="#cb95-38" aria-hidden="true" tabindex="-1"></a>    sp_name_sanitized <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">"_"</span>, anemone_species_df<span class="sc">$</span>scientificName[i])</span>
<span id="cb95-39"><a href="#cb95-39" aria-hidden="true" tabindex="-1"></a>    pred_file_path <span class="ot">&lt;-</span> <span class="fu">construct_mean_prediction_filename</span>(</span>
<span id="cb95-40"><a href="#cb95-40" aria-hidden="true" tabindex="-1"></a>      <span class="at">species_name_sanitized =</span> sp_name_sanitized,</span>
<span id="cb95-41"><a href="#cb95-41" aria-hidden="true" tabindex="-1"></a>      <span class="at">scenario_name =</span> scenario_name,</span>
<span id="cb95-42"><a href="#cb95-42" aria-hidden="true" tabindex="-1"></a>      <span class="at">predictor_type_suffix =</span> predictor_suffix_anemone, </span>
<span id="cb95-43"><a href="#cb95-43" aria-hidden="true" tabindex="-1"></a>      <span class="at">config =</span> config</span>
<span id="cb95-44"><a href="#cb95-44" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb95-45"><a href="#cb95-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">file.exists</span>(pred_file_path)) {</span>
<span id="cb95-46"><a href="#cb95-46" aria-hidden="true" tabindex="-1"></a>      host_future_raster_files <span class="ot">&lt;-</span> <span class="fu">c</span>(host_future_raster_files, pred_file_path)</span>
<span id="cb95-47"><a href="#cb95-47" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb95-48"><a href="#cb95-48" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"  Warning: Host prediction file not found for"</span>, sp_name_sanitized, <span class="st">"in"</span>, scenario_name, <span class="st">"at"</span>, pred_file_path, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb95-49"><a href="#cb95-49" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb95-50"><a href="#cb95-50" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb95-51"><a href="#cb95-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb95-52"><a href="#cb95-52" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(host_future_raster_files) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb95-53"><a href="#cb95-53" aria-hidden="true" tabindex="-1"></a>    host_pred_stack_future <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(host_future_raster_files)</span>
<span id="cb95-54"><a href="#cb95-54" aria-hidden="true" tabindex="-1"></a>    host_richness_sum_future <span class="ot">&lt;-</span> <span class="fu">sum</span>(host_pred_stack_future, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb95-55"><a href="#cb95-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb95-56"><a href="#cb95-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (config<span class="sc">$</span>apply_indo_pacific_crop) {</span>
<span id="cb95-57"><a href="#cb95-57" aria-hidden="true" tabindex="-1"></a>      ip_extent <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">ext</span>(config<span class="sc">$</span>indo_pacific_bbox)</span>
<span id="cb95-58"><a href="#cb95-58" aria-hidden="true" tabindex="-1"></a>      host_richness_future_list[[scenario_name]] <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">crop</span>(host_richness_sum_future, ip_extent)</span>
<span id="cb95-59"><a href="#cb95-59" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb95-60"><a href="#cb95-60" aria-hidden="true" tabindex="-1"></a>      host_richness_future_list[[scenario_name]] <span class="ot">&lt;-</span> host_richness_sum_future</span>
<span id="cb95-61"><a href="#cb95-61" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb95-62"><a href="#cb95-62" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"  Processed host anemone richness for"</span>, scenario_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb95-63"><a href="#cb95-63" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb95-64"><a href="#cb95-64" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"  Warning: No host prediction files found for scenario"</span>, scenario_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb95-65"><a href="#cb95-65" aria-hidden="true" tabindex="-1"></a>    host_richness_future_list[[scenario_name]] <span class="ot">&lt;-</span> <span class="cn">NULL</span> <span class="co"># Ensure it's NULL if no data</span></span>
<span id="cb95-66"><a href="#cb95-66" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb95-67"><a href="#cb95-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-68"><a href="#cb95-68" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- 2. Load Anemonefish (Environmental-Only) Future Predictions ---</span></span>
<span id="cb95-69"><a href="#cb95-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"  Loading Anemonefish (Env-Only) predictions for"</span>, scenario_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb95-70"><a href="#cb95-70" aria-hidden="true" tabindex="-1"></a>  fish_future_raster_files <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb95-71"><a href="#cb95-71" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Assuming anemonefish_species_df and predictor_suffix are defined</span></span>
<span id="cb95-72"><a href="#cb95-72" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(anemonefish_species_df)) { </span>
<span id="cb95-73"><a href="#cb95-73" aria-hidden="true" tabindex="-1"></a>    sp_name_sanitized <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">"_"</span>, anemonefish_species_df<span class="sc">$</span>scientificName[i])</span>
<span id="cb95-74"><a href="#cb95-74" aria-hidden="true" tabindex="-1"></a>    pred_file_path <span class="ot">&lt;-</span> <span class="fu">construct_mean_prediction_filename</span>(</span>
<span id="cb95-75"><a href="#cb95-75" aria-hidden="true" tabindex="-1"></a>      <span class="at">species_name_sanitized =</span> sp_name_sanitized,</span>
<span id="cb95-76"><a href="#cb95-76" aria-hidden="true" tabindex="-1"></a>      <span class="at">scenario_name =</span> scenario_name,</span>
<span id="cb95-77"><a href="#cb95-77" aria-hidden="true" tabindex="-1"></a>      <span class="at">predictor_type_suffix =</span> predictor_suffix, </span>
<span id="cb95-78"><a href="#cb95-78" aria-hidden="true" tabindex="-1"></a>      <span class="at">config =</span> config</span>
<span id="cb95-79"><a href="#cb95-79" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb95-80"><a href="#cb95-80" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">file.exists</span>(pred_file_path)) {</span>
<span id="cb95-81"><a href="#cb95-81" aria-hidden="true" tabindex="-1"></a>      fish_future_raster_files <span class="ot">&lt;-</span> <span class="fu">c</span>(fish_future_raster_files, pred_file_path)</span>
<span id="cb95-82"><a href="#cb95-82" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb95-83"><a href="#cb95-83" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"  Warning: Anemonefish (env-only) prediction file not found for"</span>, sp_name_sanitized, <span class="st">"in"</span>, scenario_name, <span class="st">"at"</span>, pred_file_path, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb95-84"><a href="#cb95-84" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb95-85"><a href="#cb95-85" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb95-86"><a href="#cb95-86" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb95-87"><a href="#cb95-87" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(fish_future_raster_files) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb95-88"><a href="#cb95-88" aria-hidden="true" tabindex="-1"></a>    fish_pred_stack_future <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(fish_future_raster_files)</span>
<span id="cb95-89"><a href="#cb95-89" aria-hidden="true" tabindex="-1"></a>    fish_richness_sum_future <span class="ot">&lt;-</span> <span class="fu">sum</span>(fish_pred_stack_future, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb95-90"><a href="#cb95-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-91"><a href="#cb95-91" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (config<span class="sc">$</span>apply_indo_pacific_crop) {</span>
<span id="cb95-92"><a href="#cb95-92" aria-hidden="true" tabindex="-1"></a>      ip_extent <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">ext</span>(config<span class="sc">$</span>indo_pacific_bbox)</span>
<span id="cb95-93"><a href="#cb95-93" aria-hidden="true" tabindex="-1"></a>      fish_richness_future_list[[scenario_name]] <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">crop</span>(fish_richness_sum_future, ip_extent)</span>
<span id="cb95-94"><a href="#cb95-94" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb95-95"><a href="#cb95-95" aria-hidden="true" tabindex="-1"></a>      fish_richness_future_list[[scenario_name]] <span class="ot">&lt;-</span> fish_richness_sum_future</span>
<span id="cb95-96"><a href="#cb95-96" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb95-97"><a href="#cb95-97" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"  Processed anemonefish (env-only) richness for"</span>, scenario_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb95-98"><a href="#cb95-98" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb95-99"><a href="#cb95-99" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"  Warning: No anemonefish (env-only) prediction files found for scenario"</span>, scenario_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb95-100"><a href="#cb95-100" aria-hidden="true" tabindex="-1"></a>    fish_richness_future_list[[scenario_name]] <span class="ot">&lt;-</span> <span class="cn">NULL</span> <span class="co"># Ensure it's NULL</span></span>
<span id="cb95-101"><a href="#cb95-101" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb95-102"><a href="#cb95-102" aria-hidden="true" tabindex="-1"></a>} <span class="co"># End loop through future scenarios</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Processing Future Scenario: ssp119_2050 ---
  Loading Host Sea Anemone predictions for ssp119_2050 
  Processed host anemone richness for ssp119_2050 
  Loading Anemonefish (Env-Only) predictions for ssp119_2050 
  Warning: Anemonefish (env-only) prediction file not found for Amphiprion_chagosensis in ssp119_2050 at /home/bi-server-kyoto/a0236995/sdm_anemonefish/data/output/predictions/Future/ssp119/1-pred_Amphiprion_chagosensis_ssp119_dec50_combined_pca.tif 
  Warning: Anemonefish (env-only) prediction file not found for Amphiprion_mccullochi in ssp119_2050 at /home/bi-server-kyoto/a0236995/sdm_anemonefish/data/output/predictions/Future/ssp119/1-pred_Amphiprion_mccullochi_ssp119_dec50_combined_pca.tif 
  Warning: Anemonefish (env-only) prediction file not found for Amphiprion_pacificus in ssp119_2050 at /home/bi-server-kyoto/a0236995/sdm_anemonefish/data/output/predictions/Future/ssp119/1-pred_Amphiprion_pacificus_ssp119_dec50_combined_pca.tif 
  Processed anemonefish (env-only) richness for ssp119_2050 

--- Processing Future Scenario: ssp119_2100 ---
  Loading Host Sea Anemone predictions for ssp119_2100 
  Processed host anemone richness for ssp119_2100 
  Loading Anemonefish (Env-Only) predictions for ssp119_2100 
  Warning: Anemonefish (env-only) prediction file not found for Amphiprion_chagosensis in ssp119_2100 at /home/bi-server-kyoto/a0236995/sdm_anemonefish/data/output/predictions/Future/ssp119/1-pred_Amphiprion_chagosensis_ssp119_dec100_combined_pca.tif 
  Warning: Anemonefish (env-only) prediction file not found for Amphiprion_mccullochi in ssp119_2100 at /home/bi-server-kyoto/a0236995/sdm_anemonefish/data/output/predictions/Future/ssp119/1-pred_Amphiprion_mccullochi_ssp119_dec100_combined_pca.tif 
  Warning: Anemonefish (env-only) prediction file not found for Amphiprion_pacificus in ssp119_2100 at /home/bi-server-kyoto/a0236995/sdm_anemonefish/data/output/predictions/Future/ssp119/1-pred_Amphiprion_pacificus_ssp119_dec100_combined_pca.tif 
  Processed anemonefish (env-only) richness for ssp119_2100 

--- Processing Future Scenario: ssp585_2050 ---
  Loading Host Sea Anemone predictions for ssp585_2050 
  Processed host anemone richness for ssp585_2050 
  Loading Anemonefish (Env-Only) predictions for ssp585_2050 
  Warning: Anemonefish (env-only) prediction file not found for Amphiprion_chagosensis in ssp585_2050 at /home/bi-server-kyoto/a0236995/sdm_anemonefish/data/output/predictions/Future/ssp585/1-pred_Amphiprion_chagosensis_ssp585_dec50_combined_pca.tif 
  Warning: Anemonefish (env-only) prediction file not found for Amphiprion_mccullochi in ssp585_2050 at /home/bi-server-kyoto/a0236995/sdm_anemonefish/data/output/predictions/Future/ssp585/1-pred_Amphiprion_mccullochi_ssp585_dec50_combined_pca.tif 
  Warning: Anemonefish (env-only) prediction file not found for Amphiprion_pacificus in ssp585_2050 at /home/bi-server-kyoto/a0236995/sdm_anemonefish/data/output/predictions/Future/ssp585/1-pred_Amphiprion_pacificus_ssp585_dec50_combined_pca.tif 
  Processed anemonefish (env-only) richness for ssp585_2050 

--- Processing Future Scenario: ssp585_2100 ---
  Loading Host Sea Anemone predictions for ssp585_2100 
  Processed host anemone richness for ssp585_2100 
  Loading Anemonefish (Env-Only) predictions for ssp585_2100 
  Warning: Anemonefish (env-only) prediction file not found for Amphiprion_chagosensis in ssp585_2100 at /home/bi-server-kyoto/a0236995/sdm_anemonefish/data/output/predictions/Future/ssp585/1-pred_Amphiprion_chagosensis_ssp585_dec100_combined_pca.tif 
  Warning: Anemonefish (env-only) prediction file not found for Amphiprion_mccullochi in ssp585_2100 at /home/bi-server-kyoto/a0236995/sdm_anemonefish/data/output/predictions/Future/ssp585/1-pred_Amphiprion_mccullochi_ssp585_dec100_combined_pca.tif 
  Warning: Anemonefish (env-only) prediction file not found for Amphiprion_pacificus in ssp585_2100 at /home/bi-server-kyoto/a0236995/sdm_anemonefish/data/output/predictions/Future/ssp585/1-pred_Amphiprion_pacificus_ssp585_dec100_combined_pca.tif 
  Processed anemonefish (env-only) richness for ssp585_2100 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Future species prediction loading and processing finished. ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Future species prediction loading and processing finished. ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Final Plots Comparison and Saving ---</span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Generating and Saving Final Richness Comparison Plots ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Generating and Saving Final Richness Comparison Plots ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define plot parameters (no longer needed by the helper, but kept for reference)</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>png_width_map <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>png_height_map <span class="ot">&lt;-</span> <span class="dv">750</span></span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>png_res_map <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a><span class="co"># MODIFIED Helper function to use the new ggplot-based plotting function</span></span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a>plot_and_save_richness_map <span class="ot">&lt;-</span> <span class="cf">function</span>(raster_obj, main_title, filename_base, subdir) {</span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(raster_obj)) {</span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Normalization for consistent color scale ---</span></span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a>    max_val <span class="ot">&lt;-</span> <span class="fu">global</span>(raster_obj, <span class="st">"max"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)<span class="sc">$</span>max</span>
<span id="cb101-11"><a href="#cb101-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Handle case where raster is all 0s or NAs</span></span>
<span id="cb101-12"><a href="#cb101-12" aria-hidden="true" tabindex="-1"></a>    richness_normalized <span class="ot">&lt;-</span> <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.na</span>(max_val) <span class="sc">&amp;&amp;</span> max_val <span class="sc">&gt;</span> <span class="dv">0</span>) raster_obj <span class="sc">/</span> max_val <span class="cf">else</span> raster_obj</span>
<span id="cb101-13"><a href="#cb101-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb101-14"><a href="#cb101-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Create plot using the ggplot function ---</span></span>
<span id="cb101-15"><a href="#cb101-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This assumes `plot_prediction_map` and `world_map_sf` are defined in a previous chunk</span></span>
<span id="cb101-16"><a href="#cb101-16" aria-hidden="true" tabindex="-1"></a>    the_plot <span class="ot">&lt;-</span> <span class="fu">plot_prediction_map</span>(</span>
<span id="cb101-17"><a href="#cb101-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">prediction_raster =</span> richness_normalized,</span>
<span id="cb101-18"><a href="#cb101-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">species_name =</span> main_title,</span>
<span id="cb101-19"><a href="#cb101-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">world_basemap =</span> world_map_sf</span>
<span id="cb101-20"><a href="#cb101-20" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb101-21"><a href="#cb101-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb101-22"><a href="#cb101-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Display plot in RMarkdown output ---</span></span>
<span id="cb101-23"><a href="#cb101-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(the_plot)</span>
<span id="cb101-24"><a href="#cb101-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb101-25"><a href="#cb101-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Save the plot to file ---</span></span>
<span id="cb101-26"><a href="#cb101-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This keeps your original file naming and location logic</span></span>
<span id="cb101-27"><a href="#cb101-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(subdir) <span class="sc">&amp;&amp;</span> <span class="fu">dir.exists</span>(subdir)) {</span>
<span id="cb101-28"><a href="#cb101-28" aria-hidden="true" tabindex="-1"></a>      <span class="co"># We add "_ggplot" to the filename to distinguish from potential old plots</span></span>
<span id="cb101-29"><a href="#cb101-29" aria-hidden="true" tabindex="-1"></a>      plot_filename <span class="ot">&lt;-</span> <span class="fu">file.path</span>(subdir, <span class="fu">paste0</span>(filename_base, <span class="st">"_ggplot.png"</span>))</span>
<span id="cb101-30"><a href="#cb101-30" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Use ggsave for ggplot objects</span></span>
<span id="cb101-31"><a href="#cb101-31" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ggsave</span>(plot_filename, <span class="at">plot =</span> the_plot, <span class="at">width =</span> <span class="dv">10</span>, <span class="at">height =</span> <span class="dv">7</span>, <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">bg =</span> <span class="st">"white"</span>)</span>
<span id="cb101-32"><a href="#cb101-32" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"  Plot saved to:"</span>, plot_filename, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb101-33"><a href="#cb101-33" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb101-34"><a href="#cb101-34" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"  Warning: Output subdirectory '"</span>, subdir, <span class="st">"' for plot '"</span>, filename_base, <span class="st">"' not available. Plot not saved to file.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb101-35"><a href="#cb101-35" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb101-36"><a href="#cb101-36" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb101-37"><a href="#cb101-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"  Skipping plot for '"</span>, main_title, <span class="st">"' as raster object is NULL.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb101-38"><a href="#cb101-38" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb101-39"><a href="#cb101-39" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb101-40"><a href="#cb101-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-41"><a href="#cb101-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot current richness maps first (assuming host_richness_sum_cropped and fish_richness_sum_cropped are from a previous chunk)</span></span>
<span id="cb101-42"><a href="#cb101-42" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">exists</span>(<span class="st">"host_richness_sum_cropped"</span>)){</span>
<span id="cb101-43"><a href="#cb101-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_and_save_richness_map</span>(</span>
<span id="cb101-44"><a href="#cb101-44" aria-hidden="true" tabindex="-1"></a>    host_richness_sum_cropped, </span>
<span id="cb101-45"><a href="#cb101-45" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Host Richness - Current"</span>, </span>
<span id="cb101-46"><a href="#cb101-46" aria-hidden="true" tabindex="-1"></a>    <span class="st">"host_richness_current"</span>,</span>
<span id="cb101-47"><a href="#cb101-47" aria-hidden="true" tabindex="-1"></a>    future_richness_maps_subdir</span>
<span id="cb101-48"><a href="#cb101-48" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb101-49"><a href="#cb101-49" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-future-species-predictions-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Plot saved to: /home/bi-server-kyoto/a0236995/sdm_anemonefish/figure_files/future_richness_projections/host_richness_current_ggplot.png </code></pre>
</div>
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">exists</span>(<span class="st">"fish_richness_sum_cropped"</span>)){</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot_and_save_richness_map</span>(</span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>    fish_richness_sum_cropped, </span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Anemonefish (Env-Only) Richness - Current"</span>, </span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fish_richness_env_only_current"</span>,</span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a>    future_richness_maps_subdir</span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-future-species-predictions-2.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Plot saved to: /home/bi-server-kyoto/a0236995/sdm_anemonefish/figure_files/future_richness_projections/fish_richness_env_only_current_ggplot.png </code></pre>
</div>
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Iterate through the scenarios you want for the final plot grid</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>scenarios_for_grid_plot <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"ssp119_2050"</span>, <span class="st">"ssp119_2100"</span>, <span class="st">"ssp585_2050"</span>, <span class="st">"ssp585_2100"</span>)</span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (scen_name <span class="cf">in</span> scenarios_for_grid_plot) {</span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Host plots</span></span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (scen_name <span class="sc">%in%</span> <span class="fu">names</span>(host_richness_future_list)) {</span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot_and_save_richness_map</span>(</span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a>      host_richness_future_list[[scen_name]], </span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">paste</span>(<span class="st">"Host Richness -"</span>, scenario_label_converter[scen_name]), </span>
<span id="cb105-10"><a href="#cb105-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">paste0</span>(<span class="st">"host_richness_"</span>, scen_name),</span>
<span id="cb105-11"><a href="#cb105-11" aria-hidden="true" tabindex="-1"></a>      future_richness_maps_subdir</span>
<span id="cb105-12"><a href="#cb105-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb105-13"><a href="#cb105-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb105-14"><a href="#cb105-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fish plots</span></span>
<span id="cb105-15"><a href="#cb105-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (scen_name <span class="sc">%in%</span> <span class="fu">names</span>(fish_richness_future_list)) {</span>
<span id="cb105-16"><a href="#cb105-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot_and_save_richness_map</span>(</span>
<span id="cb105-17"><a href="#cb105-17" aria-hidden="true" tabindex="-1"></a>      fish_richness_future_list[[scen_name]], </span>
<span id="cb105-18"><a href="#cb105-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">paste</span>(<span class="st">"Anemonefish (Env-Only) Richness -"</span>, scenario_label_converter[scen_name]), </span>
<span id="cb105-19"><a href="#cb105-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">paste0</span>(<span class="st">"fish_richness_env_only_"</span>, scen_name),</span>
<span id="cb105-20"><a href="#cb105-20" aria-hidden="true" tabindex="-1"></a>      future_richness_maps_subdir</span>
<span id="cb105-21"><a href="#cb105-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb105-22"><a href="#cb105-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb105-23"><a href="#cb105-23" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-future-species-predictions-3.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Plot saved to: /home/bi-server-kyoto/a0236995/sdm_anemonefish/figure_files/future_richness_projections/host_richness_ssp119_2050_ggplot.png </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-future-species-predictions-4.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Plot saved to: /home/bi-server-kyoto/a0236995/sdm_anemonefish/figure_files/future_richness_projections/fish_richness_env_only_ssp119_2050_ggplot.png </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-future-species-predictions-5.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Plot saved to: /home/bi-server-kyoto/a0236995/sdm_anemonefish/figure_files/future_richness_projections/host_richness_ssp119_2100_ggplot.png </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-future-species-predictions-6.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Plot saved to: /home/bi-server-kyoto/a0236995/sdm_anemonefish/figure_files/future_richness_projections/fish_richness_env_only_ssp119_2100_ggplot.png </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-future-species-predictions-7.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Plot saved to: /home/bi-server-kyoto/a0236995/sdm_anemonefish/figure_files/future_richness_projections/host_richness_ssp585_2050_ggplot.png </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-future-species-predictions-8.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Plot saved to: /home/bi-server-kyoto/a0236995/sdm_anemonefish/figure_files/future_richness_projections/fish_richness_env_only_ssp585_2050_ggplot.png </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-future-species-predictions-9.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Plot saved to: /home/bi-server-kyoto/a0236995/sdm_anemonefish/figure_files/future_richness_projections/host_richness_ssp585_2100_ggplot.png </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-future-species-predictions-10.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Plot saved to: /home/bi-server-kyoto/a0236995/sdm_anemonefish/figure_files/future_richness_projections/fish_richness_env_only_ssp585_2100_ggplot.png </code></pre>
</div>
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Finished generating final richness comparison plots. ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Finished generating final richness comparison plots. ---</code></pre>
</div>
</div>
</section>
<section id="future-environmental-predictors-pca" class="level2">
<h2 class="anchored" data-anchor-id="future-environmental-predictors-pca">Future Environmental Predictors (PCA)</h2>
<p>This section loads the PCA rasters for the future environmental conditions, corresponding to each future scenario and time step.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (config<span class="sc">$</span>use_pca_predictors) {</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"--- Loading Future Environmental PCA Rasters ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"all_pca_raster_paths"</span>) <span class="sc">||</span> <span class="fu">is.null</span>(all_pca_raster_paths)) {</span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Warning: 'all_pca_raster_paths' not found from previous chunk. Attempting to reload.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(config<span class="sc">$</span>pca_raster_paths_rds_path)) {</span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="st">"PCA raster paths RDS file not found: "</span>, config<span class="sc">$</span>pca_raster_paths_rds_path)</span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb116-8"><a href="#cb116-8" aria-hidden="true" tabindex="-1"></a>    all_pca_raster_paths <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(config<span class="sc">$</span>pca_raster_paths_rds_path)</span>
<span id="cb116-9"><a href="#cb116-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb116-10"><a href="#cb116-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb116-11"><a href="#cb116-11" aria-hidden="true" tabindex="-1"></a>  env_pca_future_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb116-12"><a href="#cb116-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb116-13"><a href="#cb116-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (scenario_name <span class="cf">in</span> future_scenarios_to_load) { <span class="co"># future_scenarios_to_load from previous chunk</span></span>
<span id="cb116-14"><a href="#cb116-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"  Loading PCA for future scenario:"</span>, scenario_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb116-15"><a href="#cb116-15" aria-hidden="true" tabindex="-1"></a>    future_pca_path <span class="ot">&lt;-</span> all_pca_raster_paths[[scenario_name]]</span>
<span id="cb116-16"><a href="#cb116-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb116-17"><a href="#cb116-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(future_pca_path) <span class="sc">||</span> <span class="sc">!</span><span class="fu">file.exists</span>(future_pca_path)) {</span>
<span id="cb116-18"><a href="#cb116-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"  Warning: Path for PCA raster not found for scenario:"</span>, scenario_name, <span class="st">"Path:"</span>, future_pca_path <span class="sc">%||%</span> <span class="st">"NULL"</span>, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb116-19"><a href="#cb116-19" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb116-20"><a href="#cb116-20" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb116-21"><a href="#cb116-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb116-22"><a href="#cb116-22" aria-hidden="true" tabindex="-1"></a>    env_pca_future_scenario <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb116-23"><a href="#cb116-23" aria-hidden="true" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">rast</span>(future_pca_path)</span>
<span id="cb116-24"><a href="#cb116-24" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb116-25"><a href="#cb116-25" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"  Error loading PCA raster for"</span>, scenario_name, <span class="st">"from:"</span>, future_pca_path, <span class="st">"</span><span class="sc">\n</span><span class="st">Error:"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb116-26"><a href="#cb116-26" aria-hidden="true" tabindex="-1"></a>      <span class="cn">NULL</span></span>
<span id="cb116-27"><a href="#cb116-27" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb116-28"><a href="#cb116-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb116-29"><a href="#cb116-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(env_pca_future_scenario)) {</span>
<span id="cb116-30"><a href="#cb116-30" aria-hidden="true" tabindex="-1"></a>      <span class="fu">names</span>(env_pca_future_scenario) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"Future Environmental PC"</span>, <span class="dv">1</span><span class="sc">:</span>terra<span class="sc">::</span><span class="fu">nlyr</span>(env_pca_future_scenario), <span class="st">" - "</span>, scenario_label_converter[scenario_name]) <span class="co"># Ensure standard names</span></span>
<span id="cb116-31"><a href="#cb116-31" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb116-32"><a href="#cb116-32" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (config<span class="sc">$</span>apply_indo_pacific_crop) {</span>
<span id="cb116-33"><a href="#cb116-33" aria-hidden="true" tabindex="-1"></a>        ip_extent <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">ext</span>(config<span class="sc">$</span>indo_pacific_bbox)</span>
<span id="cb116-34"><a href="#cb116-34" aria-hidden="true" tabindex="-1"></a>        env_pca_future_list[[scenario_name]] <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">crop</span>(env_pca_future_scenario, ip_extent)</span>
<span id="cb116-35"><a href="#cb116-35" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb116-36"><a href="#cb116-36" aria-hidden="true" tabindex="-1"></a>        env_pca_future_list[[scenario_name]] <span class="ot">&lt;-</span> env_pca_future_scenario</span>
<span id="cb116-37"><a href="#cb116-37" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb116-38"><a href="#cb116-38" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"    Loaded and processed PCA for"</span>, scenario_name, <span class="st">". Layers:"</span>, <span class="fu">paste</span>(<span class="fu">names</span>(env_pca_future_list[[scenario_name]]), <span class="at">collapse=</span><span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb116-39"><a href="#cb116-39" aria-hidden="true" tabindex="-1"></a>      <span class="fu">plot</span>(env_pca_future_list[[scenario_name]])</span>
<span id="cb116-40"><a href="#cb116-40" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb116-41"><a href="#cb116-41" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb116-42"><a href="#cb116-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb116-43"><a href="#cb116-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # Example: Plot one of the future PCA stacks</span></span>
<span id="cb116-44"><a href="#cb116-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># if (length(env_pca_future_list) &gt; 0 &amp;&amp; "ssp119_2050" %in% names(env_pca_future_list)) {</span></span>
<span id="cb116-45"><a href="#cb116-45" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   plot(env_pca_future_list[["ssp119_2050"]], main = "Future Env PCA - SSP1-1.9 (2050) - Cropped")</span></span>
<span id="cb116-46"><a href="#cb116-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># }</span></span>
<span id="cb116-47"><a href="#cb116-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb116-48"><a href="#cb116-48" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb116-49"><a href="#cb116-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"--- PCA predictors not used. Skipping loading of future PCA rasters. ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb116-50"><a href="#cb116-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"    You might need to load your VIF-selected future environmental rasters here if needed for specific analyses.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb116-51"><a href="#cb116-51" aria-hidden="true" tabindex="-1"></a>  env_pca_future_list <span class="ot">&lt;-</span> <span class="cn">NULL</span> <span class="co"># Ensure this object exists as NULL</span></span>
<span id="cb116-52"><a href="#cb116-52" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- Loading Future Environmental PCA Rasters ---
  Loading PCA for future scenario: ssp119_2050 
    Loaded and processed PCA for ssp119_2050 . Layers: Future Environmental PC1 - SSP1-1.9 (2050), Future Environmental PC2 - SSP1-1.9 (2050), Future Environmental PC3 - SSP1-1.9 (2050), Future Environmental PC4 - SSP1-1.9 (2050) </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-future-env-pca-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Loading PCA for future scenario: ssp119_2100 
    Loaded and processed PCA for ssp119_2100 . Layers: Future Environmental PC1 - SSP1-1.9 (2100), Future Environmental PC2 - SSP1-1.9 (2100), Future Environmental PC3 - SSP1-1.9 (2100), Future Environmental PC4 - SSP1-1.9 (2100) </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-future-env-pca-2.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Loading PCA for future scenario: ssp585_2050 
    Loaded and processed PCA for ssp585_2050 . Layers: Future Environmental PC1 - SSP5-8.5 (2050), Future Environmental PC2 - SSP5-8.5 (2050), Future Environmental PC3 - SSP5-8.5 (2050), Future Environmental PC4 - SSP5-8.5 (2050) </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-future-env-pca-3.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Loading PCA for future scenario: ssp585_2100 
    Loaded and processed PCA for ssp585_2100 . Layers: Future Environmental PC1 - SSP5-8.5 (2100), Future Environmental PC2 - SSP5-8.5 (2100), Future Environmental PC3 - SSP5-8.5 (2100), Future Environmental PC4 - SSP5-8.5 (2100) </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-future-env-pca-4.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The following objects are now available for subsequent analyses:</span></span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a><span class="co"># - env_pca_current_cropped: SpatRaster of current PCA env predictors</span></span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a><span class="co"># - host_richness_future_list: List of SpatRasters for host future richness, named by scenario</span></span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a><span class="co"># - fish_richness_future_list: List of SpatRasters for anemonefish (env-only) future richness, named by scenario</span></span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a><span class="co"># - env_pca_future_list: List of SpatRasters for future PCA env predictors, named by scenario</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="environmental-shifts-pca-components" class="level2">
<h2 class="anchored" data-anchor-id="environmental-shifts-pca-components">Environmental Shifts (PCA Components)</h2>
<p>This section examines the projected changes in the principal environmental gradients (PCA components) between the current conditions and future climate scenarios. This helps understand how the fundamental environmental space is predicted to change.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span>config<span class="sc">$</span>use_pca_predictors) {</span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"PCA predictors not used in this configuration. Skipping PCA environmental shift analysis.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(env_pca_current_cropped) <span class="sc">||</span> <span class="fu">is.null</span>(env_pca_future_list) <span class="sc">||</span> <span class="fu">length</span>(env_pca_future_list) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Warning: Current or future PCA environmental rasters are not available. Cannot calculate shifts.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"--- Calculating and Plotting Shifts in PCA Environmental Gradients ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb122-8"><a href="#cb122-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb122-9"><a href="#cb122-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure current PCA stack is SpatRaster for subtraction</span></span>
<span id="cb122-10"><a href="#cb122-10" aria-hidden="true" tabindex="-1"></a>    current_pca_terra <span class="ot">&lt;-</span> <span class="cf">if</span>(<span class="fu">inherits</span>(env_pca_current_cropped, <span class="st">"SpatRaster"</span>)) env_pca_current_cropped <span class="cf">else</span> terra<span class="sc">::</span><span class="fu">rast</span>(env_pca_current_cropped)</span>
<span id="cb122-11"><a href="#cb122-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-12"><a href="#cb122-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (scenario_name <span class="cf">in</span> <span class="fu">names</span>(env_pca_future_list)) {</span>
<span id="cb122-13"><a href="#cb122-13" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (scenario_name <span class="sc">==</span> <span class="st">"current"</span>) {</span>
<span id="cb122-14"><a href="#cb122-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">next</span></span>
<span id="cb122-15"><a href="#cb122-15" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb122-16"><a href="#cb122-16" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb122-17"><a href="#cb122-17" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"  Processing shifts for scenario:"</span>, scenario_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb122-18"><a href="#cb122-18" aria-hidden="true" tabindex="-1"></a>      future_pca_stack <span class="ot">&lt;-</span> env_pca_future_list[[scenario_name]]</span>
<span id="cb122-19"><a href="#cb122-19" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb122-20"><a href="#cb122-20" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">is.null</span>(future_pca_stack)) {</span>
<span id="cb122-21"><a href="#cb122-21" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"  Skipping scenario"</span>, scenario_name, <span class="st">"- future PCA stack is NULL.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb122-22"><a href="#cb122-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">next</span></span>
<span id="cb122-23"><a href="#cb122-23" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb122-24"><a href="#cb122-24" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb122-25"><a href="#cb122-25" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Ensure layers match for subtraction (e.g., up to n_pca_components)</span></span>
<span id="cb122-26"><a href="#cb122-26" aria-hidden="true" tabindex="-1"></a>      <span class="co"># It's crucial that both current and future PCA stacks were generated with the same number of components</span></span>
<span id="cb122-27"><a href="#cb122-27" aria-hidden="true" tabindex="-1"></a>      <span class="co"># and represent the same underlying variables in the same order before PCA.</span></span>
<span id="cb122-28"><a href="#cb122-28" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb122-29"><a href="#cb122-29" aria-hidden="true" tabindex="-1"></a>      <span class="co"># If layer names don't match exactly but number of layers does for the first N components:</span></span>
<span id="cb122-30"><a href="#cb122-30" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (terra<span class="sc">::</span><span class="fu">nlyr</span>(current_pca_terra) <span class="sc">&gt;=</span> config<span class="sc">$</span>n_pca_components <span class="sc">&amp;&amp;</span> terra<span class="sc">::</span><span class="fu">nlyr</span>(future_pca_stack) <span class="sc">&gt;=</span> config<span class="sc">$</span>n_pca_components) {</span>
<span id="cb122-31"><a href="#cb122-31" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb122-32"><a href="#cb122-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Select the first N components (defined in config)</span></span>
<span id="cb122-33"><a href="#cb122-33" aria-hidden="true" tabindex="-1"></a>        current_pca_subset <span class="ot">&lt;-</span> current_pca_terra[[<span class="dv">1</span><span class="sc">:</span>config<span class="sc">$</span>n_pca_components]]</span>
<span id="cb122-34"><a href="#cb122-34" aria-hidden="true" tabindex="-1"></a>        future_pca_subset <span class="ot">&lt;-</span> future_pca_stack[[<span class="dv">1</span><span class="sc">:</span>config<span class="sc">$</span>n_pca_components]]</span>
<span id="cb122-35"><a href="#cb122-35" aria-hidden="true" tabindex="-1"></a>        <span class="fu">names</span>(current_pca_subset) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"PC"</span>, <span class="dv">1</span><span class="sc">:</span>config<span class="sc">$</span>n_pca_components) <span class="co"># Standardize names for safety</span></span>
<span id="cb122-36"><a href="#cb122-36" aria-hidden="true" tabindex="-1"></a>        <span class="fu">names</span>(future_pca_subset) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"PC"</span>, <span class="dv">1</span><span class="sc">:</span>config<span class="sc">$</span>n_pca_components)</span>
<span id="cb122-37"><a href="#cb122-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-38"><a href="#cb122-38" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate the difference (shift)</span></span>
<span id="cb122-39"><a href="#cb122-39" aria-hidden="true" tabindex="-1"></a>        <span class="co"># terra::`-.SpatRaster` works element-wise if names match or by layer order if names don't.</span></span>
<span id="cb122-40"><a href="#cb122-40" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Better to ensure consistent naming (done above)</span></span>
<span id="cb122-41"><a href="#cb122-41" aria-hidden="true" tabindex="-1"></a>        env_shift_scenario <span class="ot">&lt;-</span> future_pca_subset <span class="sc">-</span> current_pca_subset </span>
<span id="cb122-42"><a href="#cb122-42" aria-hidden="true" tabindex="-1"></a>        <span class="fu">names</span>(env_shift_scenario) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"Environmental PC"</span>, <span class="dv">1</span><span class="sc">:</span>config<span class="sc">$</span>n_pca_components, <span class="st">" Shifts (Future - Current): "</span>, scenario_label_converter[scenario_name])</span>
<span id="cb122-43"><a href="#cb122-43" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb122-44"><a href="#cb122-44" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"    Calculated PCA shifts for scenario:"</span>, scenario_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb122-45"><a href="#cb122-45" aria-hidden="true" tabindex="-1"></a>        <span class="fu">plot</span>(env_shift_scenario, <span class="at">nc =</span> <span class="dv">2</span>)</span>
<span id="cb122-46"><a href="#cb122-46" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb122-47"><a href="#cb122-47" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb122-48"><a href="#cb122-48" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"  Warning: Layer mismatch or insufficient layers for PCA shift calculation in scenario"</span>, scenario_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb122-49"><a href="#cb122-49" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"    Current PCA layers:"</span>, terra<span class="sc">::</span><span class="fu">nlyr</span>(current_pca_terra), <span class="st">" Future PCA layers:"</span>, terra<span class="sc">::</span><span class="fu">nlyr</span>(future_pca_stack), <span class="st">" Needed:"</span>, config<span class="sc">$</span>n_pca_components, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb122-50"><a href="#cb122-50" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb122-51"><a href="#cb122-51" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb122-52"><a href="#cb122-52" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb122-53"><a href="#cb122-53" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- Calculating and Plotting Shifts in PCA Environmental Gradients ---
  Processing shifts for scenario: ssp119_2050 
    Calculated PCA shifts for scenario: ssp119_2050 </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/plot-environmental-pca-shifts-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Processing shifts for scenario: ssp119_2100 
    Calculated PCA shifts for scenario: ssp119_2100 </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/plot-environmental-pca-shifts-2.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Processing shifts for scenario: ssp585_2050 
    Calculated PCA shifts for scenario: ssp585_2050 </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/plot-environmental-pca-shifts-3.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Processing shifts for scenario: ssp585_2100 
    Calculated PCA shifts for scenario: ssp585_2100 </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/plot-environmental-pca-shifts-4.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="load-future-individual-species-prediction-rasters" class="level2">
<h2 class="anchored" data-anchor-id="load-future-individual-species-prediction-rasters">Load Future Individual Species Prediction Rasters</h2>
<p>This section loads the individual species prediction rasters for host sea anemones and anemonefish (environmental-only models) for each future scenario. These are needed for calculating Schoenerâ€™s D overlap and individual suitability shifts.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="co"># future_scenarios_to_load was defined in the "Future Species Richness Projections" chunk</span></span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"future_scenarios_to_load"</span>)) {</span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a>  future_scenarios_to_load <span class="ot">&lt;-</span> config<span class="sc">$</span>env_scenarios[config<span class="sc">$</span>env_scenarios <span class="sc">!=</span> <span class="st">"current"</span>]</span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a><span class="co"># predictor_suffix was defined in the "Drivers of Richness" chunk</span></span>
<span id="cb127-7"><a href="#cb127-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"predictor_suffix"</span>)) {</span>
<span id="cb127-8"><a href="#cb127-8" aria-hidden="true" tabindex="-1"></a>  predictor_suffix <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(config<span class="sc">$</span>use_pca_predictors, <span class="st">"_pca"</span>, <span class="st">"_vif"</span>)</span>
<span id="cb127-9"><a href="#cb127-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb127-10"><a href="#cb127-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-11"><a href="#cb127-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-12"><a href="#cb127-12" aria-hidden="true" tabindex="-1"></a>host_pred_stacks_future_individual <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb127-13"><a href="#cb127-13" aria-hidden="true" tabindex="-1"></a>fish_pred_stacks_future_individual <span class="ot">&lt;-</span> <span class="fu">list</span>() <span class="co"># For env-only fish models</span></span>
<span id="cb127-14"><a href="#cb127-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-15"><a href="#cb127-15" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (scenario_name <span class="cf">in</span> future_scenarios_to_load) {</span>
<span id="cb127-16"><a href="#cb127-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Loading individual future predictions for Scenario:"</span>, scenario_name, <span class="st">"---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb127-17"><a href="#cb127-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb127-18"><a href="#cb127-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Host Anemones ---</span></span>
<span id="cb127-19"><a href="#cb127-19" aria-hidden="true" tabindex="-1"></a>  current_host_future_files <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb127-20"><a href="#cb127-20" aria-hidden="true" tabindex="-1"></a>  current_host_future_names <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb127-21"><a href="#cb127-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"anemone_species_df"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(anemone_species_df) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb127-22"><a href="#cb127-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(anemone_species_df)) {</span>
<span id="cb127-23"><a href="#cb127-23" aria-hidden="true" tabindex="-1"></a>      sp_name_sanitized <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">"_"</span>, anemone_species_df<span class="sc">$</span>scientificName[i])</span>
<span id="cb127-24"><a href="#cb127-24" aria-hidden="true" tabindex="-1"></a>      pred_file_path <span class="ot">&lt;-</span> <span class="fu">construct_mean_prediction_filename</span>(</span>
<span id="cb127-25"><a href="#cb127-25" aria-hidden="true" tabindex="-1"></a>        <span class="at">species_name_sanitized =</span> sp_name_sanitized,</span>
<span id="cb127-26"><a href="#cb127-26" aria-hidden="true" tabindex="-1"></a>        <span class="at">scenario_name =</span> scenario_name,</span>
<span id="cb127-27"><a href="#cb127-27" aria-hidden="true" tabindex="-1"></a>        <span class="at">predictor_type_suffix =</span> predictor_suffix_anemone,</span>
<span id="cb127-28"><a href="#cb127-28" aria-hidden="true" tabindex="-1"></a>        <span class="at">config =</span> config</span>
<span id="cb127-29"><a href="#cb127-29" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb127-30"><a href="#cb127-30" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">file.exists</span>(pred_file_path)) {</span>
<span id="cb127-31"><a href="#cb127-31" aria-hidden="true" tabindex="-1"></a>        current_host_future_files <span class="ot">&lt;-</span> <span class="fu">c</span>(current_host_future_files, pred_file_path)</span>
<span id="cb127-32"><a href="#cb127-32" aria-hidden="true" tabindex="-1"></a>        current_host_future_names <span class="ot">&lt;-</span> <span class="fu">c</span>(current_host_future_names, sp_name_sanitized)</span>
<span id="cb127-33"><a href="#cb127-33" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb127-34"><a href="#cb127-34" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"  Warning: Host future prediction file not found for"</span>, sp_name_sanitized, <span class="st">"in"</span>, scenario_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb127-35"><a href="#cb127-35" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb127-36"><a href="#cb127-36" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb127-37"><a href="#cb127-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(current_host_future_files) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb127-38"><a href="#cb127-38" aria-hidden="true" tabindex="-1"></a>      temp_stack <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(current_host_future_files)</span>
<span id="cb127-39"><a href="#cb127-39" aria-hidden="true" tabindex="-1"></a>      <span class="fu">names</span>(temp_stack) <span class="ot">&lt;-</span> current_host_future_names</span>
<span id="cb127-40"><a href="#cb127-40" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (config<span class="sc">$</span>apply_indo_pacific_crop) {</span>
<span id="cb127-41"><a href="#cb127-41" aria-hidden="true" tabindex="-1"></a>        ip_extent <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">ext</span>(config<span class="sc">$</span>indo_pacific_bbox)</span>
<span id="cb127-42"><a href="#cb127-42" aria-hidden="true" tabindex="-1"></a>        host_pred_stacks_future_individual[[scenario_name]] <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">crop</span>(temp_stack, ip_extent)</span>
<span id="cb127-43"><a href="#cb127-43" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb127-44"><a href="#cb127-44" aria-hidden="true" tabindex="-1"></a>        host_pred_stacks_future_individual[[scenario_name]] <span class="ot">&lt;-</span> temp_stack</span>
<span id="cb127-45"><a href="#cb127-45" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb127-46"><a href="#cb127-46" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"  Loaded and cropped"</span>, terra<span class="sc">::</span><span class="fu">nlyr</span>(host_pred_stacks_future_individual[[scenario_name]]), <span class="st">"host future predictions for"</span>, scenario_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb127-47"><a href="#cb127-47" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb127-48"><a href="#cb127-48" aria-hidden="true" tabindex="-1"></a>       host_pred_stacks_future_individual[[scenario_name]] <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb127-49"><a href="#cb127-49" aria-hidden="true" tabindex="-1"></a>       <span class="fu">cat</span>(<span class="st">"  No host future prediction files found for"</span>, scenario_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb127-50"><a href="#cb127-50" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb127-51"><a href="#cb127-51" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb127-52"><a href="#cb127-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-53"><a href="#cb127-53" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Anemonefish (Environmental-Only) ---</span></span>
<span id="cb127-54"><a href="#cb127-54" aria-hidden="true" tabindex="-1"></a>  current_fish_future_files <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb127-55"><a href="#cb127-55" aria-hidden="true" tabindex="-1"></a>  current_fish_future_names <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb127-56"><a href="#cb127-56" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"anemonefish_species_df"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(anemonefish_species_df) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb127-57"><a href="#cb127-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(anemonefish_species_df)) {</span>
<span id="cb127-58"><a href="#cb127-58" aria-hidden="true" tabindex="-1"></a>      sp_name_sanitized <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">"_"</span>, anemonefish_species_df<span class="sc">$</span>scientificName[i])</span>
<span id="cb127-59"><a href="#cb127-59" aria-hidden="true" tabindex="-1"></a>      pred_file_path <span class="ot">&lt;-</span> <span class="fu">construct_mean_prediction_filename</span>(</span>
<span id="cb127-60"><a href="#cb127-60" aria-hidden="true" tabindex="-1"></a>        <span class="at">species_name_sanitized =</span> sp_name_sanitized,</span>
<span id="cb127-61"><a href="#cb127-61" aria-hidden="true" tabindex="-1"></a>        <span class="at">scenario_name =</span> scenario_name,</span>
<span id="cb127-62"><a href="#cb127-62" aria-hidden="true" tabindex="-1"></a>        <span class="at">predictor_type_suffix =</span> predictor_suffix, </span>
<span id="cb127-63"><a href="#cb127-63" aria-hidden="true" tabindex="-1"></a>        <span class="at">config =</span> config</span>
<span id="cb127-64"><a href="#cb127-64" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb127-65"><a href="#cb127-65" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">file.exists</span>(pred_file_path)) {</span>
<span id="cb127-66"><a href="#cb127-66" aria-hidden="true" tabindex="-1"></a>        current_fish_future_files <span class="ot">&lt;-</span> <span class="fu">c</span>(current_fish_future_files, pred_file_path)</span>
<span id="cb127-67"><a href="#cb127-67" aria-hidden="true" tabindex="-1"></a>        current_fish_future_names <span class="ot">&lt;-</span> <span class="fu">c</span>(current_fish_future_names, sp_name_sanitized)</span>
<span id="cb127-68"><a href="#cb127-68" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb127-69"><a href="#cb127-69" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"  Warning: Anemonefish (env-only) future prediction file not found for"</span>, sp_name_sanitized, <span class="st">"in"</span>, scenario_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb127-70"><a href="#cb127-70" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb127-71"><a href="#cb127-71" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb127-72"><a href="#cb127-72" aria-hidden="true" tabindex="-1"></a>     <span class="cf">if</span> (<span class="fu">length</span>(current_fish_future_files) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb127-73"><a href="#cb127-73" aria-hidden="true" tabindex="-1"></a>      temp_stack_fish <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(current_fish_future_files)</span>
<span id="cb127-74"><a href="#cb127-74" aria-hidden="true" tabindex="-1"></a>      <span class="fu">names</span>(temp_stack_fish) <span class="ot">&lt;-</span> current_fish_future_names</span>
<span id="cb127-75"><a href="#cb127-75" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (config<span class="sc">$</span>apply_indo_pacific_crop) {</span>
<span id="cb127-76"><a href="#cb127-76" aria-hidden="true" tabindex="-1"></a>        ip_extent <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">ext</span>(config<span class="sc">$</span>indo_pacific_bbox)</span>
<span id="cb127-77"><a href="#cb127-77" aria-hidden="true" tabindex="-1"></a>        fish_pred_stacks_future_individual[[scenario_name]] <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">crop</span>(temp_stack_fish, ip_extent)</span>
<span id="cb127-78"><a href="#cb127-78" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb127-79"><a href="#cb127-79" aria-hidden="true" tabindex="-1"></a>        fish_pred_stacks_future_individual[[scenario_name]] <span class="ot">&lt;-</span> temp_stack_fish</span>
<span id="cb127-80"><a href="#cb127-80" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb127-81"><a href="#cb127-81" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"  Loaded and cropped"</span>, terra<span class="sc">::</span><span class="fu">nlyr</span>(fish_pred_stacks_future_individual[[scenario_name]]), <span class="st">"anemonefish (env-only) future predictions for"</span>, scenario_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb127-82"><a href="#cb127-82" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb127-83"><a href="#cb127-83" aria-hidden="true" tabindex="-1"></a>       fish_pred_stacks_future_individual[[scenario_name]] <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb127-84"><a href="#cb127-84" aria-hidden="true" tabindex="-1"></a>       <span class="fu">cat</span>(<span class="st">"  No anemonefish (env-only) future prediction files found for"</span>, scenario_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb127-85"><a href="#cb127-85" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb127-86"><a href="#cb127-86" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb127-87"><a href="#cb127-87" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Loading individual future predictions for Scenario: ssp119_2050 ---
  Loaded and cropped 10 host future predictions for ssp119_2050 
  Warning: Anemonefish (env-only) future prediction file not found for Amphiprion_chagosensis in ssp119_2050 
  Warning: Anemonefish (env-only) future prediction file not found for Amphiprion_mccullochi in ssp119_2050 
  Warning: Anemonefish (env-only) future prediction file not found for Amphiprion_pacificus in ssp119_2050 
  Loaded and cropped 26 anemonefish (env-only) future predictions for ssp119_2050 

--- Loading individual future predictions for Scenario: ssp119_2100 ---
  Loaded and cropped 10 host future predictions for ssp119_2100 
  Warning: Anemonefish (env-only) future prediction file not found for Amphiprion_chagosensis in ssp119_2100 
  Warning: Anemonefish (env-only) future prediction file not found for Amphiprion_mccullochi in ssp119_2100 
  Warning: Anemonefish (env-only) future prediction file not found for Amphiprion_pacificus in ssp119_2100 
  Loaded and cropped 26 anemonefish (env-only) future predictions for ssp119_2100 

--- Loading individual future predictions for Scenario: ssp585_2050 ---
  Loaded and cropped 10 host future predictions for ssp585_2050 
  Warning: Anemonefish (env-only) future prediction file not found for Amphiprion_chagosensis in ssp585_2050 
  Warning: Anemonefish (env-only) future prediction file not found for Amphiprion_mccullochi in ssp585_2050 
  Warning: Anemonefish (env-only) future prediction file not found for Amphiprion_pacificus in ssp585_2050 
  Loaded and cropped 26 anemonefish (env-only) future predictions for ssp585_2050 

--- Loading individual future predictions for Scenario: ssp585_2100 ---
  Loaded and cropped 10 host future predictions for ssp585_2100 
  Warning: Anemonefish (env-only) future prediction file not found for Amphiprion_chagosensis in ssp585_2100 
  Warning: Anemonefish (env-only) future prediction file not found for Amphiprion_mccullochi in ssp585_2100 
  Warning: Anemonefish (env-only) future prediction file not found for Amphiprion_pacificus in ssp585_2100 
  Loaded and cropped 26 anemonefish (env-only) future predictions for ssp585_2100 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Result: host_pred_stacks_future_individual and fish_pred_stacks_future_individual</span></span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a><span class="co"># are lists of SpatRasters, named by scenario, containing individual species layers.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="individual-species-suitability-shifts" class="level2">
<h2 class="anchored" data-anchor-id="individual-species-suitability-shifts">Individual Species Suitability Shifts</h2>
<p>This section calculates the mean change in environmental suitability for each individual host sea anemone and anemonefish species between the current period and each future climate scenario. These shift values will be used to explore correlations with niche breadth.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prerequisites from previous chunks:</span></span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a><span class="co"># - host_pred_stack_cropped: Current individual host predictions (cropped)</span></span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a><span class="co"># - fish_pred_stack_cropped: Current individual fish (env-only) predictions (cropped)</span></span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a><span class="co"># - host_pred_stacks_future_individual: List of future individual host predictions (cropped), named by scenario</span></span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a><span class="co"># - fish_pred_stacks_future_individual: List of future individual fish (env-only) predictions (cropped), named by scenario</span></span>
<span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a><span class="co"># - future_scenarios_to_load: Vector of future scenario names (e.g., "ssp119_2050", "ssp585_2100")</span></span>
<span id="cb130-7"><a href="#cb130-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-8"><a href="#cb130-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"host_pred_stack_cropped"</span>) <span class="sc">||</span> <span class="sc">!</span><span class="fu">exists</span>(<span class="st">"fish_pred_stack_cropped"</span>) <span class="sc">||</span></span>
<span id="cb130-9"><a href="#cb130-9" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">exists</span>(<span class="st">"host_pred_stacks_future_individual"</span>) <span class="sc">||</span> <span class="sc">!</span><span class="fu">exists</span>(<span class="st">"fish_pred_stacks_future_individual"</span>) <span class="sc">||</span></span>
<span id="cb130-10"><a href="#cb130-10" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">exists</span>(<span class="st">"future_scenarios_to_load"</span>)) {</span>
<span id="cb130-11"><a href="#cb130-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"Prerequisite data for calculating suitability shifts is missing. Ensure previous chunks (loading current and future individual predictions) have run successfully."</span>)</span>
<span id="cb130-12"><a href="#cb130-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb130-13"><a href="#cb130-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-14"><a href="#cb130-14" aria-hidden="true" tabindex="-1"></a>suitability_shifts_list <span class="ot">&lt;-</span> <span class="fu">list</span>() <span class="co"># Initialize list to store results for all species and scenarios</span></span>
<span id="cb130-15"><a href="#cb130-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-16"><a href="#cb130-16" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"--- Calculating Mean Suitability Shifts for Individual Species ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- Calculating Mean Suitability Shifts for Individual Species ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (scenario_name_fut <span class="cf">in</span> future_scenarios_to_load) {</span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">  Processing Scenario:"</span>, scenario_name_fut, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Host Anemones Suitability Shifts ---</span></span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"    Calculating shifts for Host Anemones...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb132-6"><a href="#cb132-6" aria-hidden="true" tabindex="-1"></a>  current_hosts_for_diff <span class="ot">&lt;-</span> host_pred_stack_cropped</span>
<span id="cb132-7"><a href="#cb132-7" aria-hidden="true" tabindex="-1"></a>  future_hosts_for_diff_raw <span class="ot">&lt;-</span> host_pred_stacks_future_individual[[scenario_name_fut]]</span>
<span id="cb132-8"><a href="#cb132-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb132-9"><a href="#cb132-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(current_hosts_for_diff) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">is.null</span>(future_hosts_for_diff_raw) <span class="sc">&amp;&amp;</span> </span>
<span id="cb132-10"><a href="#cb132-10" aria-hidden="true" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">nlyr</span>(current_hosts_for_diff) <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span> terra<span class="sc">::</span><span class="fu">nlyr</span>(future_hosts_for_diff_raw) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb132-11"><a href="#cb132-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb132-12"><a href="#cb132-12" aria-hidden="true" tabindex="-1"></a>    common_host_species <span class="ot">&lt;-</span> <span class="fu">intersect</span>(<span class="fu">names</span>(current_hosts_for_diff), <span class="fu">names</span>(future_hosts_for_diff_raw))</span>
<span id="cb132-13"><a href="#cb132-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb132-14"><a href="#cb132-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(common_host_species) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb132-15"><a href="#cb132-15" aria-hidden="true" tabindex="-1"></a>      current_hosts_subset <span class="ot">&lt;-</span> current_hosts_for_diff[[common_host_species]]</span>
<span id="cb132-16"><a href="#cb132-16" aria-hidden="true" tabindex="-1"></a>      future_hosts_subset_raw <span class="ot">&lt;-</span> future_hosts_for_diff_raw[[common_host_species]]</span>
<span id="cb132-17"><a href="#cb132-17" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb132-18"><a href="#cb132-18" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Ensure geometry matches for subtraction by resampling future to current if needed</span></span>
<span id="cb132-19"><a href="#cb132-19" aria-hidden="true" tabindex="-1"></a>      future_hosts_subset_aligned <span class="ot">&lt;-</span> future_hosts_subset_raw</span>
<span id="cb132-20"><a href="#cb132-20" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="sc">!</span>terra<span class="sc">::</span><span class="fu">compareGeom</span>(current_hosts_subset, future_hosts_subset_raw, <span class="at">stopOnError=</span><span class="cn">FALSE</span>, <span class="at">res=</span><span class="cn">TRUE</span>, <span class="at">crs=</span><span class="cn">TRUE</span>, <span class="at">ext=</span><span class="cn">TRUE</span>)){</span>
<span id="cb132-21"><a href="#cb132-21" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"      Resampling future host predictions for scenario '"</span>, scenario_name_fut, <span class="st">"' to match current geometry for shift calculation.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb132-22"><a href="#cb132-22" aria-hidden="true" tabindex="-1"></a>          future_hosts_subset_aligned <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb132-23"><a href="#cb132-23" aria-hidden="true" tabindex="-1"></a>            terra<span class="sc">::</span><span class="fu">resample</span>(future_hosts_subset_raw, current_hosts_subset, <span class="at">method=</span><span class="st">"bilinear"</span>),</span>
<span id="cb132-24"><a href="#cb132-24" aria-hidden="true" tabindex="-1"></a>            <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb132-25"><a href="#cb132-25" aria-hidden="true" tabindex="-1"></a>              <span class="fu">cat</span>(<span class="st">"      ERROR resampling future host stack for"</span>, scenario_name_fut, <span class="st">":"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>); <span class="cn">NULL</span></span>
<span id="cb132-26"><a href="#cb132-26" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb132-27"><a href="#cb132-27" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb132-28"><a href="#cb132-28" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb132-29"><a href="#cb132-29" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb132-30"><a href="#cb132-30" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(future_hosts_subset_aligned)) {</span>
<span id="cb132-31"><a href="#cb132-31" aria-hidden="true" tabindex="-1"></a>        diff_hosts_scenario_indiv <span class="ot">&lt;-</span> future_hosts_subset_aligned <span class="sc">-</span> current_hosts_subset</span>
<span id="cb132-32"><a href="#cb132-32" aria-hidden="true" tabindex="-1"></a>        mean_shifts_hosts_indiv <span class="ot">&lt;-</span> <span class="fu">global</span>(diff_hosts_scenario_indiv, <span class="st">"mean"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb132-33"><a href="#cb132-33" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rownames</span>(mean_shifts_hosts_indiv) <span class="ot">&lt;-</span> <span class="fu">names</span>(diff_hosts_scenario_indiv) <span class="co"># Should be common_host_species</span></span>
<span id="cb132-34"><a href="#cb132-34" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb132-35"><a href="#cb132-35" aria-hidden="true" tabindex="-1"></a>        suitability_shifts_list[[<span class="fu">paste0</span>(<span class="st">"hosts_"</span>, scenario_name_fut)]] <span class="ot">&lt;-</span> mean_shifts_hosts_indiv</span>
<span id="cb132-36"><a href="#cb132-36" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"      Mean suitability shifts for hosts in"</span>, scenario_name_fut, <span class="st">"calculated.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb132-37"><a href="#cb132-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(head(mean_shifts_hosts_indiv)) </span></span>
<span id="cb132-38"><a href="#cb132-38" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb132-39"><a href="#cb132-39" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb132-40"><a href="#cb132-40" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"      No common host species found between current and future stacks for scenario"</span>, scenario_name_fut, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb132-41"><a href="#cb132-41" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb132-42"><a href="#cb132-42" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb132-43"><a href="#cb132-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"    Skipping host anemones for scenario"</span>, scenario_name_fut, <span class="st">"- current or future individual prediction stack missing or empty.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb132-44"><a href="#cb132-44" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb132-45"><a href="#cb132-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-46"><a href="#cb132-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Anemonefish (Environmental-Only Models) Suitability Shifts ---</span></span>
<span id="cb132-47"><a href="#cb132-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"    Calculating shifts for Anemonefish (Env-Only)...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb132-48"><a href="#cb132-48" aria-hidden="true" tabindex="-1"></a>  current_fish_for_diff <span class="ot">&lt;-</span> fish_pred_stack_cropped </span>
<span id="cb132-49"><a href="#cb132-49" aria-hidden="true" tabindex="-1"></a>  future_fish_for_diff_raw <span class="ot">&lt;-</span> fish_pred_stacks_future_individual[[scenario_name_fut]] </span>
<span id="cb132-50"><a href="#cb132-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb132-51"><a href="#cb132-51" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(current_fish_for_diff) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">is.null</span>(future_fish_for_diff_raw) <span class="sc">&amp;&amp;</span></span>
<span id="cb132-52"><a href="#cb132-52" aria-hidden="true" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">nlyr</span>(current_fish_for_diff) <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span> terra<span class="sc">::</span><span class="fu">nlyr</span>(future_fish_for_diff_raw) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb132-53"><a href="#cb132-53" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb132-54"><a href="#cb132-54" aria-hidden="true" tabindex="-1"></a>    common_fish_species <span class="ot">&lt;-</span> <span class="fu">intersect</span>(<span class="fu">names</span>(current_fish_for_diff), <span class="fu">names</span>(future_fish_for_diff_raw))</span>
<span id="cb132-55"><a href="#cb132-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb132-56"><a href="#cb132-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(common_fish_species) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb132-57"><a href="#cb132-57" aria-hidden="true" tabindex="-1"></a>      current_fish_subset <span class="ot">&lt;-</span> current_fish_for_diff[[common_fish_species]]</span>
<span id="cb132-58"><a href="#cb132-58" aria-hidden="true" tabindex="-1"></a>      future_fish_subset_raw <span class="ot">&lt;-</span> future_fish_for_diff_raw[[common_fish_species]]</span>
<span id="cb132-59"><a href="#cb132-59" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb132-60"><a href="#cb132-60" aria-hidden="true" tabindex="-1"></a>      future_fish_subset_aligned <span class="ot">&lt;-</span> future_fish_subset_raw</span>
<span id="cb132-61"><a href="#cb132-61" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="sc">!</span>terra<span class="sc">::</span><span class="fu">compareGeom</span>(current_fish_subset, future_fish_subset_raw, <span class="at">stopOnError=</span><span class="cn">FALSE</span>, <span class="at">res=</span><span class="cn">TRUE</span>, <span class="at">crs=</span><span class="cn">TRUE</span>, <span class="at">ext=</span><span class="cn">TRUE</span>)){</span>
<span id="cb132-62"><a href="#cb132-62" aria-hidden="true" tabindex="-1"></a>         <span class="fu">cat</span>(<span class="st">"      Resampling future fish (env-only) predictions for scenario '"</span>, scenario_name_fut, <span class="st">"' to match current geometry.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb132-63"><a href="#cb132-63" aria-hidden="true" tabindex="-1"></a>         future_fish_subset_aligned <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb132-64"><a href="#cb132-64" aria-hidden="true" tabindex="-1"></a>            terra<span class="sc">::</span><span class="fu">resample</span>(future_fish_subset_raw, current_fish_subset, <span class="at">method=</span><span class="st">"bilinear"</span>),</span>
<span id="cb132-65"><a href="#cb132-65" aria-hidden="true" tabindex="-1"></a>            <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb132-66"><a href="#cb132-66" aria-hidden="true" tabindex="-1"></a>              <span class="fu">cat</span>(<span class="st">"      ERROR resampling future fish stack for"</span>, scenario_name_fut, <span class="st">":"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>); <span class="cn">NULL</span></span>
<span id="cb132-67"><a href="#cb132-67" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb132-68"><a href="#cb132-68" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb132-69"><a href="#cb132-69" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb132-70"><a href="#cb132-70" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb132-71"><a href="#cb132-71" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(future_fish_subset_aligned)) {</span>
<span id="cb132-72"><a href="#cb132-72" aria-hidden="true" tabindex="-1"></a>        diff_fish_scenario_indiv <span class="ot">&lt;-</span> future_fish_subset_aligned <span class="sc">-</span> current_fish_subset</span>
<span id="cb132-73"><a href="#cb132-73" aria-hidden="true" tabindex="-1"></a>        mean_shifts_fish_indiv <span class="ot">&lt;-</span> <span class="fu">global</span>(diff_fish_scenario_indiv, <span class="st">"mean"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb132-74"><a href="#cb132-74" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rownames</span>(mean_shifts_fish_indiv) <span class="ot">&lt;-</span> <span class="fu">names</span>(diff_fish_scenario_indiv)</span>
<span id="cb132-75"><a href="#cb132-75" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb132-76"><a href="#cb132-76" aria-hidden="true" tabindex="-1"></a>        suitability_shifts_list[[<span class="fu">paste0</span>(<span class="st">"fish_env_only_"</span>, scenario_name_fut)]] <span class="ot">&lt;-</span> mean_shifts_fish_indiv</span>
<span id="cb132-77"><a href="#cb132-77" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"      Mean suitability shifts for anemonefish (env-only) in"</span>, scenario_name_fut, <span class="st">"calculated.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb132-78"><a href="#cb132-78" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(head(mean_shifts_fish_indiv)) </span></span>
<span id="cb132-79"><a href="#cb132-79" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb132-80"><a href="#cb132-80" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb132-81"><a href="#cb132-81" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"      No common anemonefish species found between current and future stacks for scenario"</span>, scenario_name_fut, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb132-82"><a href="#cb132-82" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb132-83"><a href="#cb132-83" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb132-84"><a href="#cb132-84" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"    Skipping anemonefish (env-only) for scenario"</span>, scenario_name_fut, <span class="st">"- current or future individual prediction stack missing or empty.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb132-85"><a href="#cb132-85" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb132-86"><a href="#cb132-86" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb132-87"><a href="#cb132-87" aria-hidden="true" tabindex="-1"></a>} <span class="co"># End loop through future scenarios</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
  Processing Scenario: ssp119_2050 
    Calculating shifts for Host Anemones...
      Mean suitability shifts for hosts in ssp119_2050 calculated.
    Calculating shifts for Anemonefish (Env-Only)...
      Mean suitability shifts for anemonefish (env-only) in ssp119_2050 calculated.

  Processing Scenario: ssp119_2100 
    Calculating shifts for Host Anemones...
      Mean suitability shifts for hosts in ssp119_2100 calculated.
    Calculating shifts for Anemonefish (Env-Only)...
      Mean suitability shifts for anemonefish (env-only) in ssp119_2100 calculated.

  Processing Scenario: ssp585_2050 
    Calculating shifts for Host Anemones...
      Mean suitability shifts for hosts in ssp585_2050 calculated.
    Calculating shifts for Anemonefish (Env-Only)...
      Mean suitability shifts for anemonefish (env-only) in ssp585_2050 calculated.

  Processing Scenario: ssp585_2100 
    Calculating shifts for Host Anemones...
      Mean suitability shifts for hosts in ssp585_2100 calculated.
    Calculating shifts for Anemonefish (Env-Only)...
      Mean suitability shifts for anemonefish (env-only) in ssp585_2100 calculated.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Individual species suitability shift calculations finished. ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Individual species suitability shift calculations finished. ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>suitability_shifts_list</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$hosts_ssp119_2050
                                  mean
Entacmaea_quadricolor    -0.0025224455
Radianthus_crispa         0.0031421267
Radianthus_magnifica     -0.0012377732
Stichodactyla_gigantea    0.0007430928
Cryptodendrum_adhaesivum -0.0023126082
Macrodactyla_doreensis   -0.0009896069
Stichodactyla_mertensii   0.0054552807
Stichodactyla_haddoni    -0.0016663194
Radianthus_malu          -0.0048252268
Heteractis_aurora         0.0030785942

$fish_env_only_ssp119_2050
                                  mean
Amphiprion_clarkii        0.0057921728
Amphiprion_frenatus      -0.0026789599
Amphiprion_ocellaris      0.0084518673
Amphiprion_perideraion   -0.0031836799
Amphiprion_polymnus       0.0089754971
Amphiprion_sandaracinos   0.0169316775
Amphiprion_akallopisos    0.0026284685
Amphiprion_omanensis      0.0094764040
Amphiprion_akindynos     -0.0007346459
Amphiprion_allardi       -0.0023869898
Amphiprion_barberi       -0.0038256038
Amphiprion_bicinctus      0.0005709677
Amphiprion_chrysogaster   0.0019562390
Amphiprion_chrysopterus   0.0135454746
Amphiprion_ephippium      0.0061825280
Amphiprion_fuscocaudatus  0.0102334345
Amphiprion_latezonatus             NaN
Amphiprion_latifasciatus -0.0016338290
Amphiprion_leucokranos    0.0290571243
Amphiprion_melanopus     -0.0033470567
Amphiprion_nigripes      -0.0032653919
Amphiprion_percula       -0.0050822887
Amphiprion_rubrocinctus  -0.0034015361
Amphiprion_sebae          0.0043716725
Amphiprion_tricinctus     0.0049534951
Premnas_biaculeatus      -0.0024444900

$hosts_ssp119_2100
                                  mean
Entacmaea_quadricolor    -0.0025421505
Radianthus_crispa         0.0028652963
Radianthus_magnifica     -0.0009520958
Stichodactyla_gigantea    0.0007150268
Cryptodendrum_adhaesivum -0.0027163390
Macrodactyla_doreensis   -0.0006921525
Stichodactyla_mertensii   0.0055798617
Stichodactyla_haddoni    -0.0015846655
Radianthus_malu          -0.0054188334
Heteractis_aurora         0.0029733021

$fish_env_only_ssp119_2100
                                  mean
Amphiprion_clarkii        0.0059389709
Amphiprion_frenatus      -0.0022929005
Amphiprion_ocellaris      0.0085763745
Amphiprion_perideraion   -0.0028119914
Amphiprion_polymnus       0.0086557769
Amphiprion_sandaracinos   0.0168944018
Amphiprion_akallopisos    0.0030167373
Amphiprion_omanensis      0.0095938490
Amphiprion_akindynos     -0.0008487362
Amphiprion_allardi       -0.0023853057
Amphiprion_barberi       -0.0042474413
Amphiprion_bicinctus      0.0005935605
Amphiprion_chrysogaster   0.0024206230
Amphiprion_chrysopterus   0.0143875423
Amphiprion_ephippium      0.0063545152
Amphiprion_fuscocaudatus  0.0097671919
Amphiprion_latezonatus             NaN
Amphiprion_latifasciatus -0.0018177108
Amphiprion_leucokranos    0.0287658579
Amphiprion_melanopus     -0.0030823393
Amphiprion_nigripes      -0.0030745510
Amphiprion_percula       -0.0048866165
Amphiprion_rubrocinctus  -0.0034361559
Amphiprion_sebae          0.0046845902
Amphiprion_tricinctus     0.0052862021
Premnas_biaculeatus      -0.0023837457

$hosts_ssp585_2050
                                  mean
Entacmaea_quadricolor    -0.0026364227
Radianthus_crispa         0.0033319436
Radianthus_magnifica     -0.0014548349
Stichodactyla_gigantea    0.0007854103
Cryptodendrum_adhaesivum -0.0025075729
Macrodactyla_doreensis   -0.0012689969
Stichodactyla_mertensii   0.0056615059
Stichodactyla_haddoni    -0.0015474526
Radianthus_malu          -0.0047421360
Heteractis_aurora         0.0033568552

$fish_env_only_ssp585_2050
                                  mean
Amphiprion_clarkii        0.0061144707
Amphiprion_frenatus      -0.0022767068
Amphiprion_ocellaris      0.0088672697
Amphiprion_perideraion   -0.0033397792
Amphiprion_polymnus       0.0092780223
Amphiprion_sandaracinos   0.0172594669
Amphiprion_akallopisos    0.0024596748
Amphiprion_omanensis      0.0095573555
Amphiprion_akindynos     -0.0009054875
Amphiprion_allardi       -0.0024392072
Amphiprion_barberi       -0.0037663138
Amphiprion_bicinctus      0.0004910370
Amphiprion_chrysogaster   0.0017348091
Amphiprion_chrysopterus   0.0136606810
Amphiprion_ephippium      0.0062192434
Amphiprion_fuscocaudatus  0.0102748239
Amphiprion_latezonatus             NaN
Amphiprion_latifasciatus -0.0019761288
Amphiprion_leucokranos    0.0299114770
Amphiprion_melanopus     -0.0036808045
Amphiprion_nigripes      -0.0033368763
Amphiprion_percula       -0.0051971804
Amphiprion_rubrocinctus  -0.0034279796
Amphiprion_sebae          0.0047308817
Amphiprion_tricinctus     0.0050039712
Premnas_biaculeatus      -0.0026148235

$hosts_ssp585_2100
                                  mean
Entacmaea_quadricolor    -0.0022142096
Radianthus_crispa         0.0034431140
Radianthus_magnifica     -0.0007652718
Stichodactyla_gigantea    0.0015242355
Cryptodendrum_adhaesivum -0.0025538645
Macrodactyla_doreensis   -0.0011575960
Stichodactyla_mertensii   0.0064396508
Stichodactyla_haddoni     0.0002452402
Radianthus_malu          -0.0039415193
Heteractis_aurora         0.0036177870

$fish_env_only_ssp585_2100
                                  mean
Amphiprion_clarkii        0.0066586929
Amphiprion_frenatus      -0.0006243751
Amphiprion_ocellaris      0.0093639136
Amphiprion_perideraion   -0.0018158388
Amphiprion_polymnus       0.0094944935
Amphiprion_sandaracinos   0.0180557323
Amphiprion_akallopisos    0.0033660058
Amphiprion_omanensis      0.0083519577
Amphiprion_akindynos     -0.0012055295
Amphiprion_allardi       -0.0017311421
Amphiprion_barberi       -0.0026486402
Amphiprion_bicinctus      0.0006129325
Amphiprion_chrysogaster   0.0027686651
Amphiprion_chrysopterus   0.0146272423
Amphiprion_ephippium      0.0058953800
Amphiprion_fuscocaudatus  0.0070264177
Amphiprion_latezonatus             NaN
Amphiprion_latifasciatus -0.0019577743
Amphiprion_leucokranos    0.0295596687
Amphiprion_melanopus     -0.0019991344
Amphiprion_nigripes      -0.0028180928
Amphiprion_percula       -0.0028850489
Amphiprion_rubrocinctus  -0.0026442359
Amphiprion_sebae          0.0053393748
Amphiprion_tricinctus     0.0051437465
Premnas_biaculeatus      -0.0020280617</code></pre>
</div>
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The `suitability_shifts_list` object is now populated.</span></span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Example access: suitability_shifts_list[["hosts_ssp119_2050"]]</span></span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a><span class="co"># It will contain data frames with rownames = species_name_sanitized and a column "mean" for the shift.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="future-host-anemonefish-overlap-changes-by-specialization" class="level2">
<h2 class="anchored" data-anchor-id="future-host-anemonefish-overlap-changes-by-specialization">Future Host-Anemonefish Overlap Changes by Specialization</h2>
<p>This section analyzes the projected changes in niche overlap (Schoenerâ€™s D) between anemonefish and their host anemones under future climate scenarios, considering the specialization strategy of the anemonefish. For <strong>Specialist</strong> anemonefish (â‰¤3 documented hosts), we calculate the change in overlap with their specific documented host(s). If a specialist uses multiple hosts (2 or 3), the average overlap change is considered. For <strong>Generalist</strong> anemonefish (&gt;3 documented hosts), we calculate the change in overlap with a composite raster representing the presence of <em>any</em> of their documented host anemones. This approach aims to quantify how the availability of suitable host partners might change differently for specialist versus generalist anemonefish.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co"> FIX THIS</span></span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(vegan) <span class="co"># For varpart</span></span>
<span id="cb139-4"><a href="#cb139-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure dplyr and terra are loaded from setup chunk if not re-loaded here</span></span>
<span id="cb139-5"><a href="#cb139-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-6"><a href="#cb139-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.null</span>(host_richness_sum_cropped) <span class="sc">||</span> <span class="fu">is.null</span>(fish_richness_sum_cropped) <span class="sc">||</span> </span>
<span id="cb139-7"><a href="#cb139-7" aria-hidden="true" tabindex="-1"></a>    (config<span class="sc">$</span>use_pca_predictors <span class="sc">&amp;&amp;</span> <span class="fu">is.null</span>(env_pca_current_cropped))) {</span>
<span id="cb139-8"><a href="#cb139-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Warning: Necessary raster data (host richness, fish richness, or current PCA env) is missing. Skipping variance partitioning.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb139-9"><a href="#cb139-9" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb139-10"><a href="#cb139-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"--- Preparing Data for Variance Partitioning ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb139-11"><a href="#cb139-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb139-12"><a href="#cb139-12" aria-hidden="true" tabindex="-1"></a>  layers_for_sampling <span class="ot">&lt;-</span> <span class="fu">c</span>(host_richness_sum_cropped, fish_richness_sum_cropped)</span>
<span id="cb139-13"><a href="#cb139-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb139-14"><a href="#cb139-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (config<span class="sc">$</span>use_pca_predictors <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">is.null</span>(env_pca_current_cropped)) {</span>
<span id="cb139-15"><a href="#cb139-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span>terra<span class="sc">::</span><span class="fu">compareGeom</span>(layers_for_sampling[[<span class="dv">1</span>]], env_pca_current_cropped[[<span class="dv">1</span>]], <span class="at">stopOnError=</span><span class="cn">FALSE</span>, <span class="at">res=</span><span class="cn">TRUE</span>, <span class="at">crs=</span><span class="cn">TRUE</span>)) {</span>
<span id="cb139-16"><a href="#cb139-16" aria-hidden="true" tabindex="-1"></a>       <span class="fu">cat</span>(<span class="st">"  Resampling current PCA environmental layers to match richness map geometry for sampling...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb139-17"><a href="#cb139-17" aria-hidden="true" tabindex="-1"></a>       env_pca_current_resampled <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb139-18"><a href="#cb139-18" aria-hidden="true" tabindex="-1"></a>         terra<span class="sc">::</span><span class="fu">resample</span>(env_pca_current_cropped, layers_for_sampling[[<span class="dv">1</span>]], <span class="at">method=</span><span class="st">"bilinear"</span>)</span>
<span id="cb139-19"><a href="#cb139-19" aria-hidden="true" tabindex="-1"></a>       }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb139-20"><a href="#cb139-20" aria-hidden="true" tabindex="-1"></a>         <span class="fu">cat</span>(<span class="st">"  Warning: Failed to resample PCA env layers:"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>); <span class="cn">NULL</span></span>
<span id="cb139-21"><a href="#cb139-21" aria-hidden="true" tabindex="-1"></a>       })</span>
<span id="cb139-22"><a href="#cb139-22" aria-hidden="true" tabindex="-1"></a>       <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(env_pca_current_resampled)) {</span>
<span id="cb139-23"><a href="#cb139-23" aria-hidden="true" tabindex="-1"></a>         env_pca_current_for_sampling <span class="ot">&lt;-</span> env_pca_current_resampled</span>
<span id="cb139-24"><a href="#cb139-24" aria-hidden="true" tabindex="-1"></a>       } <span class="cf">else</span> {</span>
<span id="cb139-25"><a href="#cb139-25" aria-hidden="true" tabindex="-1"></a>         <span class="fu">cat</span>(<span class="st">"  Using un-resampled PCA env. May lead to issues if extents differ significantly.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb139-26"><a href="#cb139-26" aria-hidden="true" tabindex="-1"></a>         env_pca_current_for_sampling <span class="ot">&lt;-</span> env_pca_current_cropped</span>
<span id="cb139-27"><a href="#cb139-27" aria-hidden="true" tabindex="-1"></a>       }</span>
<span id="cb139-28"><a href="#cb139-28" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb139-29"><a href="#cb139-29" aria-hidden="true" tabindex="-1"></a>      env_pca_current_for_sampling <span class="ot">&lt;-</span> env_pca_current_cropped</span>
<span id="cb139-30"><a href="#cb139-30" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb139-31"><a href="#cb139-31" aria-hidden="true" tabindex="-1"></a>    layers_for_sampling <span class="ot">&lt;-</span> <span class="fu">c</span>(layers_for_sampling, env_pca_current_for_sampling[[<span class="dv">1</span><span class="sc">:</span>config<span class="sc">$</span>n_pca_components]]) </span>
<span id="cb139-32"><a href="#cb139-32" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="sc">!</span>config<span class="sc">$</span>use_pca_predictors) {</span>
<span id="cb139-33"><a href="#cb139-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Warning: Variance partitioning without PCA environmental layers is not fully implemented here. Please adapt if using VIF-selected vars.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb139-34"><a href="#cb139-34" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb139-35"><a href="#cb139-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-36"><a href="#cb139-36" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (terra<span class="sc">::</span><span class="fu">nlyr</span>(layers_for_sampling) <span class="sc">&lt;</span> <span class="dv">3</span>) {</span>
<span id="cb139-37"><a href="#cb139-37" aria-hidden="true" tabindex="-1"></a>     <span class="fu">cat</span>(<span class="st">"Error: Need at least host richness, fish richness, and one environmental layer for variance partitioning. Found:"</span>, terra<span class="sc">::</span><span class="fu">nlyr</span>(layers_for_sampling), <span class="st">"layers.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb139-38"><a href="#cb139-38" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb139-39"><a href="#cb139-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(layers_for_sampling)[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="st">"HostRichness"</span></span>
<span id="cb139-40"><a href="#cb139-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(layers_for_sampling)[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="st">"FishRichness_EnvOnly"</span></span>
<span id="cb139-41"><a href="#cb139-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (config<span class="sc">$</span>use_pca_predictors <span class="sc">&amp;&amp;</span> terra<span class="sc">::</span><span class="fu">nlyr</span>(layers_for_sampling) <span class="sc">&gt;</span> <span class="dv">2</span>) {</span>
<span id="cb139-42"><a href="#cb139-42" aria-hidden="true" tabindex="-1"></a>      <span class="fu">names</span>(layers_for_sampling)[<span class="dv">3</span><span class="sc">:</span>(<span class="dv">2</span><span class="sc">+</span>config<span class="sc">$</span>n_pca_components)] <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"PC"</span>, <span class="dv">1</span><span class="sc">:</span>config<span class="sc">$</span>n_pca_components)</span>
<span id="cb139-43"><a href="#cb139-43" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb139-44"><a href="#cb139-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb139-45"><a href="#cb139-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Stack for sampling has layers:"</span>, <span class="fu">paste</span>(<span class="fu">names</span>(layers_for_sampling), <span class="at">collapse=</span><span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb139-46"><a href="#cb139-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb139-47"><a href="#cb139-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set.seed</span>(<span class="dv">123</span>) </span>
<span id="cb139-48"><a href="#cb139-48" aria-hidden="true" tabindex="-1"></a>    mask_all_valid <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(layers_for_sampling)) <span class="sc">==</span> <span class="fu">nlyr</span>(layers_for_sampling)</span>
<span id="cb139-49"><a href="#cb139-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">global</span>(mask_all_valid, <span class="st">"sum"</span>, <span class="at">na.rm=</span>T)<span class="sc">$</span>sum <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb139-50"><a href="#cb139-50" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"Error: No cells where all predictor layers for variance partitioning have valid data.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb139-51"><a href="#cb139-51" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb139-52"><a href="#cb139-52" aria-hidden="true" tabindex="-1"></a>      bg_points_sampled_varpart <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">spatSample</span>(mask_all_valid, <span class="dv">5000</span>, <span class="at">method =</span> <span class="st">"random"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>, <span class="at">xy=</span><span class="cn">TRUE</span>, <span class="at">warn=</span><span class="cn">FALSE</span>)</span>
<span id="cb139-53"><a href="#cb139-53" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"Sampled"</span>, <span class="fu">nrow</span>(bg_points_sampled_varpart), <span class="st">"points for variance partitioning.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb139-54"><a href="#cb139-54" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb139-55"><a href="#cb139-55" aria-hidden="true" tabindex="-1"></a>      df_sampled_values <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(layers_for_sampling, bg_points_sampled_varpart[, <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>)], <span class="at">ID =</span> <span class="cn">FALSE</span>)</span>
<span id="cb139-56"><a href="#cb139-56" aria-hidden="true" tabindex="-1"></a>      df_sampled_values <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(df_sampled_values)</span>
<span id="cb139-57"><a href="#cb139-57" aria-hidden="true" tabindex="-1"></a>      df_sampled_values <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(df_sampled_values) </span>
<span id="cb139-58"><a href="#cb139-58" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb139-59"><a href="#cb139-59" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"Using"</span>, <span class="fu">nrow</span>(df_sampled_values), <span class="st">"complete cases for variance partitioning.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb139-60"><a href="#cb139-60" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb139-61"><a href="#cb139-61" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">nrow</span>(df_sampled_values) <span class="sc">&gt;</span> <span class="dv">10</span> <span class="sc">&amp;&amp;</span> <span class="st">"HostRichness"</span> <span class="sc">%in%</span> <span class="fu">names</span>(df_sampled_values) <span class="sc">&amp;&amp;</span> <span class="st">"FishRichness_EnvOnly"</span> <span class="sc">%in%</span> <span class="fu">names</span>(df_sampled_values) <span class="sc">&amp;&amp;</span> </span>
<span id="cb139-62"><a href="#cb139-62" aria-hidden="true" tabindex="-1"></a>          ( (<span class="sc">!</span>config<span class="sc">$</span>use_pca_predictors <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(df_sampled_values) <span class="sc">&gt;</span> <span class="dv">2</span>) <span class="sc">||</span> (config<span class="sc">$</span>use_pca_predictors <span class="sc">&amp;&amp;</span> <span class="fu">all</span>(<span class="fu">paste0</span>(<span class="st">"PC"</span>, <span class="dv">1</span><span class="sc">:</span>config<span class="sc">$</span>n_pca_components) <span class="sc">%in%</span> <span class="fu">names</span>(df_sampled_values))) )</span>
<span id="cb139-63"><a href="#cb139-63" aria-hidden="true" tabindex="-1"></a>         ) {</span>
<span id="cb139-64"><a href="#cb139-64" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb139-65"><a href="#cb139-65" aria-hidden="true" tabindex="-1"></a>        fish_richness_response <span class="ot">&lt;-</span> df_sampled_values<span class="sc">$</span>FishRichness_EnvOnly</span>
<span id="cb139-66"><a href="#cb139-66" aria-hidden="true" tabindex="-1"></a>        host_richness_predictor <span class="ot">&lt;-</span> df_sampled_values<span class="sc">$</span>HostRichness</span>
<span id="cb139-67"><a href="#cb139-67" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb139-68"><a href="#cb139-68" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (config<span class="sc">$</span>use_pca_predictors) {</span>
<span id="cb139-69"><a href="#cb139-69" aria-hidden="true" tabindex="-1"></a>          env_predictors_df <span class="ot">&lt;-</span> df_sampled_values[, <span class="fu">paste0</span>(<span class="st">"PC"</span>, <span class="dv">1</span><span class="sc">:</span>config<span class="sc">$</span>n_pca_components), drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb139-70"><a href="#cb139-70" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb139-71"><a href="#cb139-71" aria-hidden="true" tabindex="-1"></a>          env_col_names <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(df_sampled_values), <span class="fu">c</span>(<span class="st">"HostRichness"</span>, <span class="st">"FishRichness_EnvOnly"</span>))</span>
<span id="cb139-72"><a href="#cb139-72" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span>(<span class="fu">length</span>(env_col_names) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb139-73"><a href="#cb139-73" aria-hidden="true" tabindex="-1"></a>            env_predictors_df <span class="ot">&lt;-</span> df_sampled_values[, env_col_names, drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb139-74"><a href="#cb139-74" aria-hidden="true" tabindex="-1"></a>          } <span class="cf">else</span> {</span>
<span id="cb139-75"><a href="#cb139-75" aria-hidden="true" tabindex="-1"></a>            env_predictors_df <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb139-76"><a href="#cb139-76" aria-hidden="true" tabindex="-1"></a>            <span class="fu">cat</span>(<span class="st">"Warning: No environmental predictor columns identified for VIF-based variance partitioning.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb139-77"><a href="#cb139-77" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb139-78"><a href="#cb139-78" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb139-79"><a href="#cb139-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-80"><a href="#cb139-80" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(env_predictors_df) <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(env_predictors_df) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb139-81"><a href="#cb139-81" aria-hidden="true" tabindex="-1"></a>          varpart_result <span class="ot">&lt;-</span> vegan<span class="sc">::</span><span class="fu">varpart</span>(fish_richness_response, host_richness_predictor, env_predictors_df)</span>
<span id="cb139-82"><a href="#cb139-82" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb139-83"><a href="#cb139-83" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Variance Partitioning Results ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb139-84"><a href="#cb139-84" aria-hidden="true" tabindex="-1"></a>          <span class="fu">print</span>(varpart_result)</span>
<span id="cb139-85"><a href="#cb139-85" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb139-86"><a href="#cb139-86" aria-hidden="true" tabindex="-1"></a>          <span class="co"># --- Plot and Save Variance Partitioning Diagram ---</span></span>
<span id="cb139-87"><a href="#cb139-87" aria-hidden="true" tabindex="-1"></a>          <span class="co"># Display in RMarkdown output first</span></span>
<span id="cb139-88"><a href="#cb139-88" aria-hidden="true" tabindex="-1"></a>          <span class="fu">plot</span>(varpart_result, </span>
<span id="cb139-89"><a href="#cb139-89" aria-hidden="true" tabindex="-1"></a>               <span class="at">main =</span> <span class="st">"Variance Partitioning: Anemonefish Richness (Env-Only Models)"</span>,</span>
<span id="cb139-90"><a href="#cb139-90" aria-hidden="true" tabindex="-1"></a>               <span class="at">Xnames =</span> <span class="fu">c</span>(<span class="st">"Host Richness"</span>, <span class="st">"Environment (PCA)"</span>), <span class="co"># More descriptive names for the circles</span></span>
<span id="cb139-91"><a href="#cb139-91" aria-hidden="true" tabindex="-1"></a>               <span class="at">bg =</span> <span class="fu">c</span>(<span class="st">"skyblue"</span>, <span class="st">"lightgreen"</span>), <span class="co"># Optional: colors for circles</span></span>
<span id="cb139-92"><a href="#cb139-92" aria-hidden="true" tabindex="-1"></a>               <span class="at">cex =</span> <span class="fl">0.9</span>, <span class="co"># Adjust text size inside circles if needed</span></span>
<span id="cb139-93"><a href="#cb139-93" aria-hidden="true" tabindex="-1"></a>               <span class="at">id.size =</span> <span class="fl">0.9</span> <span class="co"># Adjust ID size (a,b,c,d) if needed</span></span>
<span id="cb139-94"><a href="#cb139-94" aria-hidden="true" tabindex="-1"></a>               ) </span>
<span id="cb139-95"><a href="#cb139-95" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb139-96"><a href="#cb139-96" aria-hidden="true" tabindex="-1"></a>          <span class="co"># Save the plot if figure_output_dir exists</span></span>
<span id="cb139-97"><a href="#cb139-97" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"figure_output_dir"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">dir.exists</span>(figure_output_dir)) {</span>
<span id="cb139-98"><a href="#cb139-98" aria-hidden="true" tabindex="-1"></a>            varpart_plot_filename <span class="ot">&lt;-</span> <span class="fu">file.path</span>(figure_output_dir, <span class="st">"varpart_richness.png"</span>)</span>
<span id="cb139-99"><a href="#cb139-99" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Define plot dimensions for saved file - varpart plots often need specific aspect ratios</span></span>
<span id="cb139-100"><a href="#cb139-100" aria-hidden="true" tabindex="-1"></a>            png_width_varpart <span class="ot">&lt;-</span> <span class="dv">800</span> </span>
<span id="cb139-101"><a href="#cb139-101" aria-hidden="true" tabindex="-1"></a>            png_height_varpart <span class="ot">&lt;-</span> <span class="dv">600</span> </span>
<span id="cb139-102"><a href="#cb139-102" aria-hidden="true" tabindex="-1"></a>            png_res_varpart <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb139-103"><a href="#cb139-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-104"><a href="#cb139-104" aria-hidden="true" tabindex="-1"></a>            <span class="fu">png</span>(<span class="at">filename =</span> varpart_plot_filename, <span class="at">width =</span> png_width_varpart, <span class="at">height =</span> png_height_varpart, <span class="at">units =</span> <span class="st">"px"</span>, <span class="at">res =</span> png_res_varpart)</span>
<span id="cb139-105"><a href="#cb139-105" aria-hidden="true" tabindex="-1"></a>            <span class="fu">plot</span>(varpart_result, </span>
<span id="cb139-106"><a href="#cb139-106" aria-hidden="true" tabindex="-1"></a>                 <span class="at">main =</span> <span class="st">"Variance Partitioning: Fish Richness</span><span class="sc">\n</span><span class="st">(Host Richness vs. Environment)"</span>, <span class="co"># Example of a more concise title for saving</span></span>
<span id="cb139-107"><a href="#cb139-107" aria-hidden="true" tabindex="-1"></a>                 <span class="at">Xnames =</span> <span class="fu">c</span>(<span class="st">"Host Richness"</span>, <span class="st">"Environment"</span>), </span>
<span id="cb139-108"><a href="#cb139-108" aria-hidden="true" tabindex="-1"></a>                 <span class="at">bg =</span> <span class="fu">c</span>(<span class="st">"skyblue"</span>, <span class="st">"lightgreen"</span>),</span>
<span id="cb139-109"><a href="#cb139-109" aria-hidden="true" tabindex="-1"></a>                 <span class="at">cex =</span> <span class="fl">0.9</span>,</span>
<span id="cb139-110"><a href="#cb139-110" aria-hidden="true" tabindex="-1"></a>                 <span class="at">id.size =</span> <span class="fl">0.9</span></span>
<span id="cb139-111"><a href="#cb139-111" aria-hidden="true" tabindex="-1"></a>                 )</span>
<span id="cb139-112"><a href="#cb139-112" aria-hidden="true" tabindex="-1"></a>            <span class="fu">dev.off</span>()</span>
<span id="cb139-113"><a href="#cb139-113" aria-hidden="true" tabindex="-1"></a>            <span class="fu">cat</span>(<span class="st">"Saved variance partitioning plot to:"</span>, varpart_plot_filename, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb139-114"><a href="#cb139-114" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb139-115"><a href="#cb139-115" aria-hidden="true" tabindex="-1"></a>          <span class="co"># --- End Plot and Save ---</span></span>
<span id="cb139-116"><a href="#cb139-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-117"><a href="#cb139-117" aria-hidden="true" tabindex="-1"></a>          cor_test_result <span class="ot">&lt;-</span> <span class="fu">cor.test</span>(df_sampled_values<span class="sc">$</span>HostRichness, df_sampled_values<span class="sc">$</span>FishRichness_EnvOnly)</span>
<span id="cb139-118"><a href="#cb139-118" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Pearson Correlation between Host Richness and Fish (Env-Only) Richness:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb139-119"><a href="#cb139-119" aria-hidden="true" tabindex="-1"></a>          <span class="fu">print</span>(cor_test_result)</span>
<span id="cb139-120"><a href="#cb139-120" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb139-121"><a href="#cb139-121" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb139-122"><a href="#cb139-122" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"Warning: Environmental predictor data frame is empty. Skipping variance partitioning.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb139-123"><a href="#cb139-123" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb139-124"><a href="#cb139-124" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb139-125"><a href="#cb139-125" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"Warning: Not enough data or required columns missing for variance partitioning.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb139-126"><a href="#cb139-126" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb139-127"><a href="#cb139-127" aria-hidden="true" tabindex="-1"></a>    } </span>
<span id="cb139-128"><a href="#cb139-128" aria-hidden="true" tabindex="-1"></a>  } </span>
<span id="cb139-129"><a href="#cb139-129" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- Preparing Data for Variance Partitioning ---
Stack for sampling has layers: HostRichness, FishRichness_EnvOnly, PC1, PC2, PC3, PC4 
Sampled 5000 points for variance partitioning.
Using 3505 complete cases for variance partitioning.

--- Variance Partitioning Results ---

Partition of variance in RDA 

Call: vegan::varpart(Y = fish_richness_response, X =
host_richness_predictor, env_predictors_df)

Explanatory tables:
X1:  host_richness_predictor
X2:  env_predictors_df 

No. of explanatory tables: 2 
Total variation (SS): 39543 
            Variance: 11.285 
No. of observations: 3505 

Partition table:
                     Df R.squared Adj.R.squared Testable
[a+c] = X1            1   0.92674       0.92672     TRUE
[b+c] = X2            4   0.59582       0.59536     TRUE
[a+b+c] = X1+X2       5   0.94310       0.94302     TRUE
Individual fractions                                    
[a] = X1|X2           1                 0.34766     TRUE
[b] = X2|X1           4                 0.01630     TRUE
[c]                   0                 0.57906    FALSE
[d] = Residuals                         0.05698    FALSE
---
Use function 'rda' to test significance of fractions of interest</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/future-host-fish-overlap-specialization-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Saved variance partitioning plot to: /home/bi-server-kyoto/a0236995/sdm_anemonefish/figure_files/varpart_richness.png 

Pearson Correlation between Host Richness and Fish (Env-Only) Richness:

    Pearson's product-moment correlation

data:  df_sampled_values$HostRichness and df_sampled_values$FishRichness_EnvOnly
t = 210.51, df = 3503, p-value &lt; 2.2e-16
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 0.9601690 0.9650248
sample estimates:
      cor 
0.9626743 </code></pre>
</div>
</div>
</section>
<section id="relationship-between-host-and-anemonefish-richness-current" class="level2">
<h2 class="anchored" data-anchor-id="relationship-between-host-and-anemonefish-richness-current">Relationship between Host and Anemonefish Richness (Current)</h2>
<p>This section explores the relationship between the current predicted richness of host sea anemones and their mutualistic anemonefish (based on environmental-only models). We use variance partitioning to determine the independent and shared contributions of host richness and environmental factors (PCA components) to anemonefish richness.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(vegan) <span class="co"># For varpart</span></span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.null</span>(host_richness_sum_cropped) <span class="sc">||</span> <span class="fu">is.null</span>(fish_richness_sum_cropped) <span class="sc">||</span> </span>
<span id="cb142-4"><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a>    (config<span class="sc">$</span>use_pca_predictors <span class="sc">&amp;&amp;</span> <span class="fu">is.null</span>(env_pca_current_cropped))) {</span>
<span id="cb142-5"><a href="#cb142-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Warning: Necessary raster data (host richness, fish richness, or current PCA env) is missing. Skipping variance partitioning.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb142-6"><a href="#cb142-6" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb142-7"><a href="#cb142-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"--- Preparing Data for Variance Partitioning ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb142-8"><a href="#cb142-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-9"><a href="#cb142-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ensure all layers have the same extent and resolution for stacking.</span></span>
<span id="cb142-10"><a href="#cb142-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># The previous cropping step should have handled this for richness sums.</span></span>
<span id="cb142-11"><a href="#cb142-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If PCA was used, env_pca_current_cropped should also match.</span></span>
<span id="cb142-12"><a href="#cb142-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-13"><a href="#cb142-13" aria-hidden="true" tabindex="-1"></a>  layers_for_sampling <span class="ot">&lt;-</span> <span class="fu">c</span>(host_richness_sum_cropped, fish_richness_sum_cropped)</span>
<span id="cb142-14"><a href="#cb142-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-15"><a href="#cb142-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (config<span class="sc">$</span>use_pca_predictors <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">is.null</span>(env_pca_current_cropped)) {</span>
<span id="cb142-16"><a href="#cb142-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure the env_pca_current_cropped is compatible. Resample if necessary.</span></span>
<span id="cb142-17"><a href="#cb142-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span>terra<span class="sc">::</span><span class="fu">compareGeom</span>(layers_for_sampling[[<span class="dv">1</span>]], env_pca_current_cropped[[<span class="dv">1</span>]], <span class="at">stopOnError=</span><span class="cn">FALSE</span>, <span class="at">res=</span><span class="cn">TRUE</span>, <span class="at">crs=</span><span class="cn">TRUE</span>)) {</span>
<span id="cb142-18"><a href="#cb142-18" aria-hidden="true" tabindex="-1"></a>       <span class="fu">cat</span>(<span class="st">"  Resampling current PCA environmental layers to match richness map geometry for sampling...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb142-19"><a href="#cb142-19" aria-hidden="true" tabindex="-1"></a>       env_pca_current_resampled <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb142-20"><a href="#cb142-20" aria-hidden="true" tabindex="-1"></a>         terra<span class="sc">::</span><span class="fu">resample</span>(env_pca_current_cropped, layers_for_sampling[[<span class="dv">1</span>]], <span class="at">method=</span><span class="st">"bilinear"</span>)</span>
<span id="cb142-21"><a href="#cb142-21" aria-hidden="true" tabindex="-1"></a>       }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb142-22"><a href="#cb142-22" aria-hidden="true" tabindex="-1"></a>         <span class="fu">cat</span>(<span class="st">"  Warning: Failed to resample PCA env layers:"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>); <span class="cn">NULL</span></span>
<span id="cb142-23"><a href="#cb142-23" aria-hidden="true" tabindex="-1"></a>       })</span>
<span id="cb142-24"><a href="#cb142-24" aria-hidden="true" tabindex="-1"></a>       <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(env_pca_current_resampled)) {</span>
<span id="cb142-25"><a href="#cb142-25" aria-hidden="true" tabindex="-1"></a>         env_pca_current_for_sampling <span class="ot">&lt;-</span> env_pca_current_resampled</span>
<span id="cb142-26"><a href="#cb142-26" aria-hidden="true" tabindex="-1"></a>       } <span class="cf">else</span> {</span>
<span id="cb142-27"><a href="#cb142-27" aria-hidden="true" tabindex="-1"></a>         <span class="fu">cat</span>(<span class="st">"  Using un-resampled PCA env. May lead to issues if extents differ significantly.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb142-28"><a href="#cb142-28" aria-hidden="true" tabindex="-1"></a>         env_pca_current_for_sampling <span class="ot">&lt;-</span> env_pca_current_cropped</span>
<span id="cb142-29"><a href="#cb142-29" aria-hidden="true" tabindex="-1"></a>       }</span>
<span id="cb142-30"><a href="#cb142-30" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb142-31"><a href="#cb142-31" aria-hidden="true" tabindex="-1"></a>      env_pca_current_for_sampling <span class="ot">&lt;-</span> env_pca_current_cropped</span>
<span id="cb142-32"><a href="#cb142-32" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb142-33"><a href="#cb142-33" aria-hidden="true" tabindex="-1"></a>    layers_for_sampling <span class="ot">&lt;-</span> <span class="fu">c</span>(layers_for_sampling, env_pca_current_for_sampling[[<span class="dv">1</span><span class="sc">:</span>config<span class="sc">$</span>n_pca_components]]) <span class="co"># Use first N components</span></span>
<span id="cb142-34"><a href="#cb142-34" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="sc">!</span>config<span class="sc">$</span>use_pca_predictors) {</span>
<span id="cb142-35"><a href="#cb142-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">TODO</span><span class="co">: If not using PCA, you'd need to load your VIF-selected CURRENT environmental rasters here,</span></span>
<span id="cb142-36"><a href="#cb142-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ensure they are cropped and resampled like the richness maps, and add them to layers_for_sampling.</span></span>
<span id="cb142-37"><a href="#cb142-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Warning: Variance partitioning without PCA environmental layers is not fully implemented here. Please adapt if using VIF-selected vars.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb142-38"><a href="#cb142-38" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb142-39"><a href="#cb142-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-40"><a href="#cb142-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if we have enough layers to proceed</span></span>
<span id="cb142-41"><a href="#cb142-41" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (terra<span class="sc">::</span><span class="fu">nlyr</span>(layers_for_sampling) <span class="sc">&lt;</span> <span class="dv">3</span>) {</span>
<span id="cb142-42"><a href="#cb142-42" aria-hidden="true" tabindex="-1"></a>     <span class="fu">cat</span>(<span class="st">"Error: Need at least host richness, fish richness, and one environmental layer for variance partitioning. Found:"</span>, terra<span class="sc">::</span><span class="fu">nlyr</span>(layers_for_sampling), <span class="st">"layers.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb142-43"><a href="#cb142-43" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb142-44"><a href="#cb142-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb142-45"><a href="#cb142-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rename layers for clarity in the output dataframe</span></span>
<span id="cb142-46"><a href="#cb142-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(layers_for_sampling)[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="st">"HostRichness"</span></span>
<span id="cb142-47"><a href="#cb142-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(layers_for_sampling)[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="st">"FishRichness_EnvOnly"</span></span>
<span id="cb142-48"><a href="#cb142-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (config<span class="sc">$</span>use_pca_predictors <span class="sc">&amp;&amp;</span> terra<span class="sc">::</span><span class="fu">nlyr</span>(layers_for_sampling) <span class="sc">&gt;</span> <span class="dv">2</span>) {</span>
<span id="cb142-49"><a href="#cb142-49" aria-hidden="true" tabindex="-1"></a>      <span class="fu">names</span>(layers_for_sampling)[<span class="dv">3</span><span class="sc">:</span>(<span class="dv">2</span><span class="sc">+</span>config<span class="sc">$</span>n_pca_components)] <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"PC"</span>, <span class="dv">1</span><span class="sc">:</span>config<span class="sc">$</span>n_pca_components)</span>
<span id="cb142-50"><a href="#cb142-50" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb142-51"><a href="#cb142-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb142-52"><a href="#cb142-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Stack for sampling has layers:"</span>, <span class="fu">paste</span>(<span class="fu">names</span>(layers_for_sampling), <span class="at">collapse=</span><span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb142-53"><a href="#cb142-53" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb142-54"><a href="#cb142-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sample random points</span></span>
<span id="cb142-55"><a href="#cb142-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Using dismo::randomPoints for consistency with ant paper if preferred, or terra::spatSample</span></span>
<span id="cb142-56"><a href="#cb142-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set.seed</span>(<span class="dv">123</span>) <span class="co"># for reproducibility</span></span>
<span id="cb142-57"><a href="#cb142-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># bg_points_sampled_varpart &lt;- dismo::randomPoints(raster::raster(layers_for_sampling[[1]]), 5000) # dismo needs raster object</span></span>
<span id="cb142-58"><a href="#cb142-58" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Note: dismo::randomPoints might struggle with large SpatRasters or specific extents.</span></span>
<span id="cb142-59"><a href="#cb142-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Using terra::spatSample might be more robust here with SpatRasters.</span></span>
<span id="cb142-60"><a href="#cb142-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># We need to sample from areas where ALL layers have data.</span></span>
<span id="cb142-61"><a href="#cb142-61" aria-hidden="true" tabindex="-1"></a>    <span class="co"># One way is to sample from the first layer, then extract from the stack.</span></span>
<span id="cb142-62"><a href="#cb142-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Or, create a mask where all layers are non-NA.</span></span>
<span id="cb142-63"><a href="#cb142-63" aria-hidden="true" tabindex="-1"></a>    mask_all_valid <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(layers_for_sampling)) <span class="sc">==</span> <span class="fu">nlyr</span>(layers_for_sampling)</span>
<span id="cb142-64"><a href="#cb142-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">global</span>(mask_all_valid, <span class="st">"sum"</span>, <span class="at">na.rm=</span>T)<span class="sc">$</span>sum <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb142-65"><a href="#cb142-65" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"Error: No cells where all predictor layers for variance partitioning have valid data.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb142-66"><a href="#cb142-66" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb142-67"><a href="#cb142-67" aria-hidden="true" tabindex="-1"></a>      bg_points_sampled_varpart <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">spatSample</span>(mask_all_valid, <span class="dv">5000</span>, <span class="at">method =</span> <span class="st">"random"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>, <span class="at">xy=</span><span class="cn">TRUE</span>, <span class="at">warn=</span><span class="cn">FALSE</span>)</span>
<span id="cb142-68"><a href="#cb142-68" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"Sampled"</span>, <span class="fu">nrow</span>(bg_points_sampled_varpart), <span class="st">"points for variance partitioning.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb142-69"><a href="#cb142-69" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb142-70"><a href="#cb142-70" aria-hidden="true" tabindex="-1"></a>      df_sampled_values <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(layers_for_sampling, bg_points_sampled_varpart[, <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>)], <span class="at">ID =</span> <span class="cn">FALSE</span>)</span>
<span id="cb142-71"><a href="#cb142-71" aria-hidden="true" tabindex="-1"></a>      df_sampled_values <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(df_sampled_values)</span>
<span id="cb142-72"><a href="#cb142-72" aria-hidden="true" tabindex="-1"></a>      df_sampled_values <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(df_sampled_values) <span class="co"># Remove any rows with NAs that might have slipped through</span></span>
<span id="cb142-73"><a href="#cb142-73" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb142-74"><a href="#cb142-74" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"Using"</span>, <span class="fu">nrow</span>(df_sampled_values), <span class="st">"complete cases for variance partitioning.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb142-75"><a href="#cb142-75" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb142-76"><a href="#cb142-76" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">nrow</span>(df_sampled_values) <span class="sc">&gt;</span> <span class="dv">10</span> <span class="sc">&amp;&amp;</span> <span class="st">"HostRichness"</span> <span class="sc">%in%</span> <span class="fu">names</span>(df_sampled_values) <span class="sc">&amp;&amp;</span> <span class="st">"FishRichness_EnvOnly"</span> <span class="sc">%in%</span> <span class="fu">names</span>(df_sampled_values) <span class="sc">&amp;&amp;</span> </span>
<span id="cb142-77"><a href="#cb142-77" aria-hidden="true" tabindex="-1"></a>          ( (<span class="sc">!</span>config<span class="sc">$</span>use_pca_predictors <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(df_sampled_values) <span class="sc">&gt;</span> <span class="dv">2</span>) <span class="sc">||</span> (config<span class="sc">$</span>use_pca_predictors <span class="sc">&amp;&amp;</span> <span class="fu">all</span>(<span class="fu">paste0</span>(<span class="st">"PC"</span>, <span class="dv">1</span><span class="sc">:</span>config<span class="sc">$</span>n_pca_components) <span class="sc">%in%</span> <span class="fu">names</span>(df_sampled_values))) )</span>
<span id="cb142-78"><a href="#cb142-78" aria-hidden="true" tabindex="-1"></a>         ) {</span>
<span id="cb142-79"><a href="#cb142-79" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb142-80"><a href="#cb142-80" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Prepare data for varpart</span></span>
<span id="cb142-81"><a href="#cb142-81" aria-hidden="true" tabindex="-1"></a>        fish_richness_response <span class="ot">&lt;-</span> df_sampled_values<span class="sc">$</span>FishRichness_EnvOnly</span>
<span id="cb142-82"><a href="#cb142-82" aria-hidden="true" tabindex="-1"></a>        host_richness_predictor <span class="ot">&lt;-</span> df_sampled_values<span class="sc">$</span>HostRichness</span>
<span id="cb142-83"><a href="#cb142-83" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb142-84"><a href="#cb142-84" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (config<span class="sc">$</span>use_pca_predictors) {</span>
<span id="cb142-85"><a href="#cb142-85" aria-hidden="true" tabindex="-1"></a>          env_predictors_df <span class="ot">&lt;-</span> df_sampled_values[, <span class="fu">paste0</span>(<span class="st">"PC"</span>, <span class="dv">1</span><span class="sc">:</span>config<span class="sc">$</span>n_pca_components), drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb142-86"><a href="#cb142-86" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb142-87"><a href="#cb142-87" aria-hidden="true" tabindex="-1"></a>          <span class="co"># If using VIF, select the environmental columns (excluding HostRichness and FishRichness_EnvOnly)</span></span>
<span id="cb142-88"><a href="#cb142-88" aria-hidden="true" tabindex="-1"></a>          env_col_names <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(df_sampled_values), <span class="fu">c</span>(<span class="st">"HostRichness"</span>, <span class="st">"FishRichness_EnvOnly"</span>))</span>
<span id="cb142-89"><a href="#cb142-89" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span>(<span class="fu">length</span>(env_col_names) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb142-90"><a href="#cb142-90" aria-hidden="true" tabindex="-1"></a>            env_predictors_df <span class="ot">&lt;-</span> df_sampled_values[, env_col_names, drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb142-91"><a href="#cb142-91" aria-hidden="true" tabindex="-1"></a>          } <span class="cf">else</span> {</span>
<span id="cb142-92"><a href="#cb142-92" aria-hidden="true" tabindex="-1"></a>            env_predictors_df <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb142-93"><a href="#cb142-93" aria-hidden="true" tabindex="-1"></a>            <span class="fu">cat</span>(<span class="st">"Warning: No environmental predictor columns identified for VIF-based variance partitioning.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb142-94"><a href="#cb142-94" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb142-95"><a href="#cb142-95" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb142-96"><a href="#cb142-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-97"><a href="#cb142-97" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(env_predictors_df) <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(env_predictors_df) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb142-98"><a href="#cb142-98" aria-hidden="true" tabindex="-1"></a>          <span class="co"># Perform variance partitioning</span></span>
<span id="cb142-99"><a href="#cb142-99" aria-hidden="true" tabindex="-1"></a>          <span class="co"># Response: FishRichness_EnvOnly</span></span>
<span id="cb142-100"><a href="#cb142-100" aria-hidden="true" tabindex="-1"></a>          <span class="co"># Predictor Group 1: HostRichness</span></span>
<span id="cb142-101"><a href="#cb142-101" aria-hidden="true" tabindex="-1"></a>          <span class="co"># Predictor Group 2: Environmental variables (PCA components or VIF-selected)</span></span>
<span id="cb142-102"><a href="#cb142-102" aria-hidden="true" tabindex="-1"></a>          varpart_result <span class="ot">&lt;-</span> vegan<span class="sc">::</span><span class="fu">varpart</span>(fish_richness_response, host_richness_predictor, env_predictors_df)</span>
<span id="cb142-103"><a href="#cb142-103" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb142-104"><a href="#cb142-104" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Variance Partitioning Results ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb142-105"><a href="#cb142-105" aria-hidden="true" tabindex="-1"></a>          <span class="fu">print</span>(varpart_result)</span>
<span id="cb142-106"><a href="#cb142-106" aria-hidden="true" tabindex="-1"></a>          <span class="fu">plot</span>(varpart_result, <span class="at">main =</span> <span class="st">"Variance Partitioning: Anemonefish Richness (Env-Only Models)"</span>)</span>
<span id="cb142-107"><a href="#cb142-107" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb142-108"><a href="#cb142-108" aria-hidden="true" tabindex="-1"></a>          <span class="co"># Pearson correlation between host and fish richness</span></span>
<span id="cb142-109"><a href="#cb142-109" aria-hidden="true" tabindex="-1"></a>          cor_test_result <span class="ot">&lt;-</span> <span class="fu">cor.test</span>(df_sampled_values<span class="sc">$</span>HostRichness, df_sampled_values<span class="sc">$</span>FishRichness_EnvOnly)</span>
<span id="cb142-110"><a href="#cb142-110" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Pearson Correlation between Host Richness and Fish (Env-Only) Richness:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb142-111"><a href="#cb142-111" aria-hidden="true" tabindex="-1"></a>          <span class="fu">print</span>(cor_test_result)</span>
<span id="cb142-112"><a href="#cb142-112" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb142-113"><a href="#cb142-113" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb142-114"><a href="#cb142-114" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"Warning: Environmental predictor data frame is empty. Skipping variance partitioning.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb142-115"><a href="#cb142-115" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb142-116"><a href="#cb142-116" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb142-117"><a href="#cb142-117" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"Warning: Not enough data or required columns missing for variance partitioning.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb142-118"><a href="#cb142-118" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb142-119"><a href="#cb142-119" aria-hidden="true" tabindex="-1"></a>    } <span class="co"># end else for mask_all_valid check</span></span>
<span id="cb142-120"><a href="#cb142-120" aria-hidden="true" tabindex="-1"></a>  } <span class="co"># end else for nlyr check</span></span>
<span id="cb142-121"><a href="#cb142-121" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- Preparing Data for Variance Partitioning ---
Stack for sampling has layers: HostRichness, FishRichness_EnvOnly, PC1, PC2, PC3, PC4 
Sampled 5000 points for variance partitioning.
Using 3505 complete cases for variance partitioning.

--- Variance Partitioning Results ---

Partition of variance in RDA 

Call: vegan::varpart(Y = fish_richness_response, X =
host_richness_predictor, env_predictors_df)

Explanatory tables:
X1:  host_richness_predictor
X2:  env_predictors_df 

No. of explanatory tables: 2 
Total variation (SS): 39543 
            Variance: 11.285 
No. of observations: 3505 

Partition table:
                     Df R.squared Adj.R.squared Testable
[a+c] = X1            1   0.92674       0.92672     TRUE
[b+c] = X2            4   0.59582       0.59536     TRUE
[a+b+c] = X1+X2       5   0.94310       0.94302     TRUE
Individual fractions                                    
[a] = X1|X2           1                 0.34766     TRUE
[b] = X2|X1           4                 0.01630     TRUE
[c]                   0                 0.57906    FALSE
[d] = Residuals                         0.05698    FALSE
---
Use function 'rda' to test significance of fractions of interest</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/richness-sampling-and-varpart-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Pearson Correlation between Host Richness and Fish (Env-Only) Richness:

    Pearson's product-moment correlation

data:  df_sampled_values$HostRichness and df_sampled_values$FishRichness_EnvOnly
t = 210.51, df = 3503, p-value &lt; 2.2e-16
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 0.9601690 0.9650248
sample estimates:
      cor 
0.9626743 </code></pre>
</div>
</div>
<section id="levins-b-niche-breadth-current-predictions" class="level3">
<h3 class="anchored" data-anchor-id="levins-b-niche-breadth-current-predictions">Levinâ€™s B Niche Breadth (Current Predictions)</h3>
<p>This section calculates Levinâ€™s B (<span class="math inline">\(B_2\)</span>) niche breadth metric for each host sea anemone species and each anemonefish species (using their environmental-only model predictions for the current period). This metric quantifies the uniformity of a speciesâ€™ predicted suitability across its range. We then compare the mean niche breadth between the two guilds.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ENMTools)</span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb145-3"><a href="#cb145-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-4"><a href="#cb145-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure the current individual prediction stacks are available and cropped</span></span>
<span id="cb145-5"><a href="#cb145-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.null</span>(host_pred_stack_cropped) <span class="sc">||</span> <span class="sc">!</span><span class="fu">inherits</span>(host_pred_stack_cropped, <span class="st">"SpatRaster"</span>)) {</span>
<span id="cb145-6"><a href="#cb145-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"`host_pred_stack_cropped` is not available or not a SpatRaster. Run previous chunks."</span>)</span>
<span id="cb145-7"><a href="#cb145-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb145-8"><a href="#cb145-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.null</span>(fish_pred_stack_cropped) <span class="sc">||</span> <span class="sc">!</span><span class="fu">inherits</span>(fish_pred_stack_cropped, <span class="st">"SpatRaster"</span>)) {</span>
<span id="cb145-9"><a href="#cb145-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"`fish_pred_stack_cropped` (for env-only fish models) is not available or not a SpatRaster. Run previous chunks."</span>)</span>
<span id="cb145-10"><a href="#cb145-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb145-11"><a href="#cb145-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-12"><a href="#cb145-12" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 1. Calculate Niche Breadth for Host Sea Anemones ---</span></span>
<span id="cb145-13"><a href="#cb145-13" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"--- Calculating Levin's B Niche Breadth for Host Sea Anemones (Current) ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- Calculating Levin's B Niche Breadth for Host Sea Anemones (Current) ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a>host_niche_breadth_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">species_name_sanitized =</span> <span class="fu">character</span>(<span class="dv">0</span>),</span>
<span id="cb147-3"><a href="#cb147-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">levins_B1 =</span> <span class="fu">numeric</span>(<span class="dv">0</span>),</span>
<span id="cb147-4"><a href="#cb147-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">levins_B2 =</span> <span class="fu">numeric</span>(<span class="dv">0</span>),</span>
<span id="cb147-5"><a href="#cb147-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb147-6"><a href="#cb147-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb147-7"><a href="#cb147-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-8"><a href="#cb147-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (terra<span class="sc">::</span><span class="fu">nlyr</span>(host_pred_stack_cropped) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb147-9"><a href="#cb147-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>terra<span class="sc">::</span><span class="fu">nlyr</span>(host_pred_stack_cropped)) {</span>
<span id="cb147-10"><a href="#cb147-10" aria-hidden="true" tabindex="-1"></a>    species_raster_host <span class="ot">&lt;-</span> host_pred_stack_cropped[[i]]</span>
<span id="cb147-11"><a href="#cb147-11" aria-hidden="true" tabindex="-1"></a>    sp_name_host <span class="ot">&lt;-</span> <span class="fu">names</span>(species_raster_host)</span>
<span id="cb147-12"><a href="#cb147-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"  Calculating breadth for host:"</span>, sp_name_host, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb147-13"><a href="#cb147-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-14"><a href="#cb147-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- START: MODIFIED PLOTTING ---</span></span>
<span id="cb147-15"><a href="#cb147-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load the occurrence points for this specific host</span></span>
<span id="cb147-16"><a href="#cb147-16" aria-hidden="true" tabindex="-1"></a>    host_aphia_id <span class="ot">&lt;-</span> anemone_species_df<span class="sc">$</span>AphiaID[anemone_species_df<span class="sc">$</span>scientificName <span class="sc">==</span> <span class="fu">gsub</span>(<span class="st">"_"</span>, <span class="st">" "</span>, sp_name_host)]</span>
<span id="cb147-17"><a href="#cb147-17" aria-hidden="true" tabindex="-1"></a>    host_occ_sf <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb147-18"><a href="#cb147-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(host_aphia_id) <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb147-19"><a href="#cb147-19" aria-hidden="true" tabindex="-1"></a>        occ_file_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(config<span class="sc">$</span>anemone_occurrence_dir, <span class="fu">paste0</span>(host_aphia_id, <span class="st">".csv"</span>))</span>
<span id="cb147-20"><a href="#cb147-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">file.exists</span>(occ_file_path)) {</span>
<span id="cb147-21"><a href="#cb147-21" aria-hidden="true" tabindex="-1"></a>            host_occ_df <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(occ_file_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb147-22"><a href="#cb147-22" aria-hidden="true" tabindex="-1"></a>              <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(decimalLongitude) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(decimalLatitude))</span>
<span id="cb147-23"><a href="#cb147-23" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span>(<span class="fu">nrow</span>(host_occ_df) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb147-24"><a href="#cb147-24" aria-hidden="true" tabindex="-1"></a>              host_occ_sf <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_as_sf</span>(host_occ_df, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"decimalLongitude"</span>, <span class="st">"decimalLatitude"</span>), <span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb147-25"><a href="#cb147-25" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb147-26"><a href="#cb147-26" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb147-27"><a href="#cb147-27" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb147-28"><a href="#cb147-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-29"><a href="#cb147-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"plot_prediction_map"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">exists</span>(<span class="st">"world_map_sf"</span>)) {</span>
<span id="cb147-30"><a href="#cb147-30" aria-hidden="true" tabindex="-1"></a>      plot_title_host <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"Suitability - Host:"</span>, <span class="fu">gsub</span>(<span class="st">"_"</span>, <span class="st">" "</span>, sp_name_host))</span>
<span id="cb147-31"><a href="#cb147-31" aria-hidden="true" tabindex="-1"></a>      host_plot <span class="ot">&lt;-</span> <span class="fu">plot_prediction_map</span>(</span>
<span id="cb147-32"><a href="#cb147-32" aria-hidden="true" tabindex="-1"></a>        <span class="at">prediction_raster =</span> species_raster_host,</span>
<span id="cb147-33"><a href="#cb147-33" aria-hidden="true" tabindex="-1"></a>        <span class="at">species_name =</span> plot_title_host,</span>
<span id="cb147-34"><a href="#cb147-34" aria-hidden="true" tabindex="-1"></a>        <span class="at">world_basemap =</span> world_map_sf,</span>
<span id="cb147-35"><a href="#cb147-35" aria-hidden="true" tabindex="-1"></a>        <span class="at">occurrence_points_sf =</span> host_occ_sf <span class="co"># Pass the loaded points</span></span>
<span id="cb147-36"><a href="#cb147-36" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb147-37"><a href="#cb147-37" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(host_plot)</span>
<span id="cb147-38"><a href="#cb147-38" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb147-39"><a href="#cb147-39" aria-hidden="true" tabindex="-1"></a>      <span class="fu">plot</span>(species_raster_host, <span class="at">main =</span> <span class="fu">paste</span>(<span class="st">"Suitability - Host:"</span>, <span class="fu">gsub</span>(<span class="st">"_"</span>, <span class="st">" "</span>, sp_name_host)))</span>
<span id="cb147-40"><a href="#cb147-40" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb147-41"><a href="#cb147-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- </span><span class="re">END</span><span class="co">: MODIFIED PLOTTING ---</span></span>
<span id="cb147-42"><a href="#cb147-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-43"><a href="#cb147-43" aria-hidden="true" tabindex="-1"></a>    breadth_metrics_host <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb147-44"><a href="#cb147-44" aria-hidden="true" tabindex="-1"></a>      ENMTools<span class="sc">::</span><span class="fu">raster.breadth</span>(species_raster_host)</span>
<span id="cb147-45"><a href="#cb147-45" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb147-46"><a href="#cb147-46" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"  Warning: Could not calculate breadth for host"</span>, sp_name_host, <span class="st">":"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb147-47"><a href="#cb147-47" aria-hidden="true" tabindex="-1"></a>      <span class="cn">NULL</span></span>
<span id="cb147-48"><a href="#cb147-48" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb147-49"><a href="#cb147-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-50"><a href="#cb147-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(breadth_metrics_host)) {</span>
<span id="cb147-51"><a href="#cb147-51" aria-hidden="true" tabindex="-1"></a>      host_niche_breadth_df <span class="ot">&lt;-</span> <span class="fu">rbind</span>(host_niche_breadth_df,</span>
<span id="cb147-52"><a href="#cb147-52" aria-hidden="true" tabindex="-1"></a>                                     <span class="fu">data.frame</span>(<span class="at">species_name_sanitized =</span> sp_name_host,</span>
<span id="cb147-53"><a href="#cb147-53" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">levins_B1 =</span> breadth_metrics_host<span class="sc">$</span>B1,</span>
<span id="cb147-54"><a href="#cb147-54" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">levins_B2 =</span> breadth_metrics_host<span class="sc">$</span>B2))</span>
<span id="cb147-55"><a href="#cb147-55" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb147-56"><a href="#cb147-56" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb147-57"><a href="#cb147-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Finished calculating niche breadth for hosts.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb147-58"><a href="#cb147-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(host_niche_breadth_df)</span>
<span id="cb147-59"><a href="#cb147-59" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb147-60"><a href="#cb147-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"No host anemone prediction layers to calculate breadth for.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb147-61"><a href="#cb147-61" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for host: Entacmaea_quadricolor </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for host: Radianthus_crispa </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-2.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for host: Radianthus_magnifica </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-3.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for host: Stichodactyla_gigantea </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-4.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for host: Cryptodendrum_adhaesivum </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-5.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for host: Macrodactyla_doreensis </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-6.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for host: Stichodactyla_mertensii </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-7.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for host: Stichodactyla_haddoni </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-8.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for host: Radianthus_malu </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-9.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for host: Heteractis_aurora </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-10.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Finished calculating niche breadth for hosts.
     species_name_sanitized levins_B1  levins_B2
1     Entacmaea_quadricolor 0.8832633 0.09909694
2         Radianthus_crispa 0.9859543 0.58945211
3      Radianthus_magnifica 0.9150805 0.16363004
4    Stichodactyla_gigantea 0.9697815 0.30472228
5  Cryptodendrum_adhaesivum 0.9735046 0.42918133
6    Macrodactyla_doreensis 0.9091849 0.15074255
7   Stichodactyla_mertensii 0.9848459 0.57867840
8     Stichodactyla_haddoni 0.9384106 0.16306443
9           Radianthus_malu 0.9540615 0.26246512
10        Heteractis_aurora 0.9765100 0.45107519</code></pre>
</div>
<div class="sourceCode cell-code" id="cb159"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 2. Calculate Niche Breadth for Anemonefish (Environmental-Only Models) ---</span></span>
<span id="cb159-2"><a href="#cb159-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Calculating Levin's B Niche Breadth for Anemonefish (Env-Only, Current) ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Calculating Levin's B Niche Breadth for Anemonefish (Env-Only, Current) ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb161"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a>fish_niche_breadth_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb161-2"><a href="#cb161-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">species_name_sanitized =</span> <span class="fu">character</span>(<span class="dv">0</span>),</span>
<span id="cb161-3"><a href="#cb161-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">levins_B1 =</span> <span class="fu">numeric</span>(<span class="dv">0</span>),</span>
<span id="cb161-4"><a href="#cb161-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">levins_B2 =</span> <span class="fu">numeric</span>(<span class="dv">0</span>),</span>
<span id="cb161-5"><a href="#cb161-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb161-6"><a href="#cb161-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb161-7"><a href="#cb161-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-8"><a href="#cb161-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (terra<span class="sc">::</span><span class="fu">nlyr</span>(fish_pred_stack_cropped) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb161-9"><a href="#cb161-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>terra<span class="sc">::</span><span class="fu">nlyr</span>(fish_pred_stack_cropped)) {</span>
<span id="cb161-10"><a href="#cb161-10" aria-hidden="true" tabindex="-1"></a>    species_raster_fish <span class="ot">&lt;-</span> fish_pred_stack_cropped[[i]]</span>
<span id="cb161-11"><a href="#cb161-11" aria-hidden="true" tabindex="-1"></a>    sp_name_fish <span class="ot">&lt;-</span> <span class="fu">names</span>(species_raster_fish)</span>
<span id="cb161-12"><a href="#cb161-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"  Calculating breadth for anemonefish:"</span>, sp_name_fish, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb161-13"><a href="#cb161-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-14"><a href="#cb161-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- START: MODIFIED PLOTTING ---</span></span>
<span id="cb161-15"><a href="#cb161-15" aria-hidden="true" tabindex="-1"></a>    fish_aphia_id <span class="ot">&lt;-</span> anemonefish_species_df<span class="sc">$</span>AphiaID[anemonefish_species_df<span class="sc">$</span>scientificName <span class="sc">==</span> <span class="fu">gsub</span>(<span class="st">"_"</span>, <span class="st">" "</span>, sp_name_fish)]</span>
<span id="cb161-16"><a href="#cb161-16" aria-hidden="true" tabindex="-1"></a>    fish_occ_sf <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb161-17"><a href="#cb161-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(fish_aphia_id) <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb161-18"><a href="#cb161-18" aria-hidden="true" tabindex="-1"></a>        occ_file_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(config<span class="sc">$</span>anemonefish_occurrence_dir, <span class="fu">paste0</span>(fish_aphia_id, <span class="st">".csv"</span>))</span>
<span id="cb161-19"><a href="#cb161-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">file.exists</span>(occ_file_path)) {</span>
<span id="cb161-20"><a href="#cb161-20" aria-hidden="true" tabindex="-1"></a>            fish_occ_df <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(occ_file_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb161-21"><a href="#cb161-21" aria-hidden="true" tabindex="-1"></a>              <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(decimalLongitude) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(decimalLatitude))</span>
<span id="cb161-22"><a href="#cb161-22" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span>(<span class="fu">nrow</span>(fish_occ_df) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb161-23"><a href="#cb161-23" aria-hidden="true" tabindex="-1"></a>              fish_occ_sf <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_as_sf</span>(fish_occ_df, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"decimalLongitude"</span>, <span class="st">"decimalLatitude"</span>), <span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb161-24"><a href="#cb161-24" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb161-25"><a href="#cb161-25" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb161-26"><a href="#cb161-26" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb161-27"><a href="#cb161-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-28"><a href="#cb161-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"plot_prediction_map"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">exists</span>(<span class="st">"world_map_sf"</span>)) {</span>
<span id="cb161-29"><a href="#cb161-29" aria-hidden="true" tabindex="-1"></a>      plot_title_fish <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"Suitability - Anemonefish:"</span>, <span class="fu">gsub</span>(<span class="st">"_"</span>, <span class="st">" "</span>, sp_name_fish))</span>
<span id="cb161-30"><a href="#cb161-30" aria-hidden="true" tabindex="-1"></a>      fish_plot <span class="ot">&lt;-</span> <span class="fu">plot_prediction_map</span>(</span>
<span id="cb161-31"><a href="#cb161-31" aria-hidden="true" tabindex="-1"></a>        <span class="at">prediction_raster =</span> species_raster_fish,</span>
<span id="cb161-32"><a href="#cb161-32" aria-hidden="true" tabindex="-1"></a>        <span class="at">species_name =</span> plot_title_fish,</span>
<span id="cb161-33"><a href="#cb161-33" aria-hidden="true" tabindex="-1"></a>        <span class="at">world_basemap =</span> world_map_sf,</span>
<span id="cb161-34"><a href="#cb161-34" aria-hidden="true" tabindex="-1"></a>        <span class="at">occurrence_points_sf =</span> fish_occ_sf <span class="co"># Pass the loaded points</span></span>
<span id="cb161-35"><a href="#cb161-35" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb161-36"><a href="#cb161-36" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(fish_plot)</span>
<span id="cb161-37"><a href="#cb161-37" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb161-38"><a href="#cb161-38" aria-hidden="true" tabindex="-1"></a>      <span class="fu">plot</span>(species_raster_fish, <span class="at">main =</span> <span class="fu">paste</span>(<span class="st">"Suitability - Anemonefish:"</span>, <span class="fu">gsub</span>(<span class="st">"_"</span>, <span class="st">" "</span>, sp_name_fish)))</span>
<span id="cb161-39"><a href="#cb161-39" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb161-40"><a href="#cb161-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- </span><span class="re">END</span><span class="co">: MODIFIED PLOTTING ---</span></span>
<span id="cb161-41"><a href="#cb161-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-42"><a href="#cb161-42" aria-hidden="true" tabindex="-1"></a>    breadth_metrics_fish <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb161-43"><a href="#cb161-43" aria-hidden="true" tabindex="-1"></a>      ENMTools<span class="sc">::</span><span class="fu">raster.breadth</span>(species_raster_fish)</span>
<span id="cb161-44"><a href="#cb161-44" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb161-45"><a href="#cb161-45" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"  Warning: Could not calculate breadth for fish"</span>, sp_name_fish, <span class="st">":"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb161-46"><a href="#cb161-46" aria-hidden="true" tabindex="-1"></a>      <span class="cn">NULL</span></span>
<span id="cb161-47"><a href="#cb161-47" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb161-48"><a href="#cb161-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-49"><a href="#cb161-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(breadth_metrics_fish)) {</span>
<span id="cb161-50"><a href="#cb161-50" aria-hidden="true" tabindex="-1"></a>      fish_niche_breadth_df <span class="ot">&lt;-</span> <span class="fu">rbind</span>(fish_niche_breadth_df,</span>
<span id="cb161-51"><a href="#cb161-51" aria-hidden="true" tabindex="-1"></a>                                     <span class="fu">data.frame</span>(<span class="at">species_name_sanitized =</span> sp_name_fish,</span>
<span id="cb161-52"><a href="#cb161-52" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">levins_B1 =</span> breadth_metrics_fish<span class="sc">$</span>B1,</span>
<span id="cb161-53"><a href="#cb161-53" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">levins_B2 =</span> breadth_metrics_fish<span class="sc">$</span>B2))</span>
<span id="cb161-54"><a href="#cb161-54" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb161-55"><a href="#cb161-55" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb161-56"><a href="#cb161-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Finished calculating niche breadth for anemonefish (env-only).</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb161-57"><a href="#cb161-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(fish_niche_breadth_df)</span>
<span id="cb161-58"><a href="#cb161-58" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb161-59"><a href="#cb161-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"No anemonefish (env-only) prediction layers to calculate breadth for.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb161-60"><a href="#cb161-60" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_clarkii </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-11.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_frenatus </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-12.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_ocellaris </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-13.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_perideraion </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-14.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_polymnus </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-15.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_sandaracinos </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-16.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_akallopisos </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-17.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_omanensis </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-18.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_akindynos </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-19.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_allardi </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-20.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_barberi </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-21.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_bicinctus </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-22.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_chrysogaster </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-23.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_chrysopterus </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-24.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_ephippium </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-25.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_fuscocaudatus </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-26.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_latezonatus </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-27.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Warning: Could not calculate breadth for fish Amphiprion_latezonatus : missing value where TRUE/FALSE needed 
  Calculating breadth for anemonefish: Amphiprion_latifasciatus </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-28.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_leucokranos </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-29.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_melanopus </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-30.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_nigripes </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-31.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_percula </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-32.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_rubrocinctus </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-33.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_sebae </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-34.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_tricinctus </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-35.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Premnas_biaculeatus </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-36.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Finished calculating niche breadth for anemonefish (env-only).
     species_name_sanitized levins_B1  levins_B2
1        Amphiprion_clarkii 0.9156893 0.16855573
2       Amphiprion_frenatus 0.9260953 0.15518835
3      Amphiprion_ocellaris 0.9132149 0.15841845
4    Amphiprion_perideraion 0.9401089 0.20229228
5       Amphiprion_polymnus 0.9483661 0.25673533
6   Amphiprion_sandaracinos 0.9032486 0.14087516
7    Amphiprion_akallopisos 0.9198552 0.16248444
8      Amphiprion_omanensis 0.9714976 0.38921636
9      Amphiprion_akindynos 0.7752804 0.01460635
10       Amphiprion_allardi 0.7798264 0.02324953
11       Amphiprion_barberi 0.9602659 0.27449700
12     Amphiprion_bicinctus 0.7641116 0.01246312
13  Amphiprion_chrysogaster 0.9793202 0.45316631
14  Amphiprion_chrysopterus 0.9664554 0.36578032
15     Amphiprion_ephippium 0.9528502 0.26945771
16 Amphiprion_fuscocaudatus 0.9873569 0.64651584
17 Amphiprion_latifasciatus 0.8570075 0.05171353
18   Amphiprion_leucokranos 0.9756997 0.50012773
19     Amphiprion_melanopus 0.9276171 0.14477146
20      Amphiprion_nigripes 0.9186231 0.14414588
21       Amphiprion_percula 0.9368468 0.17482779
22  Amphiprion_rubrocinctus 0.8194611 0.02767565
23         Amphiprion_sebae 0.9708571 0.38323210
24    Amphiprion_tricinctus 0.8960367 0.08848325
25      Premnas_biaculeatus 0.9404717 0.18544295</code></pre>
</div>
<div class="sourceCode cell-code" id="cb189"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb189-1"><a href="#cb189-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 3. Compare Mean Niche Breadth (Levin's B2) ---</span></span>
<span id="cb189-2"><a href="#cb189-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(host_niche_breadth_df) <span class="sc">&gt;</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(fish_niche_breadth_df) <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb189-3"><a href="#cb189-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Comparing Mean Niche Breadth (Levin's B2) between Guilds ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb189-4"><a href="#cb189-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-5"><a href="#cb189-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"levins_B2"</span> <span class="sc">%in%</span> <span class="fu">names</span>(host_niche_breadth_df) <span class="sc">&amp;&amp;</span> <span class="st">"levins_B2"</span> <span class="sc">%in%</span> <span class="fu">names</span>(fish_niche_breadth_df)) {</span>
<span id="cb189-6"><a href="#cb189-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-7"><a href="#cb189-7" aria-hidden="true" tabindex="-1"></a>    valid_hosts_b2 <span class="ot">&lt;-</span> host_niche_breadth_df<span class="sc">$</span>levins_B2[<span class="sc">!</span><span class="fu">is.na</span>(host_niche_breadth_df<span class="sc">$</span>levins_B2)]</span>
<span id="cb189-8"><a href="#cb189-8" aria-hidden="true" tabindex="-1"></a>    valid_fish_b2 <span class="ot">&lt;-</span> fish_niche_breadth_df<span class="sc">$</span>levins_B2[<span class="sc">!</span><span class="fu">is.na</span>(fish_niche_breadth_df<span class="sc">$</span>levins_B2)]</span>
<span id="cb189-9"><a href="#cb189-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-10"><a href="#cb189-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(valid_hosts_b2) <span class="sc">&gt;</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(valid_fish_b2) <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb189-11"><a href="#cb189-11" aria-hidden="true" tabindex="-1"></a>      ttest_breadth_b2 <span class="ot">&lt;-</span> <span class="fu">t.test</span>(valid_hosts_b2, valid_fish_b2)</span>
<span id="cb189-12"><a href="#cb189-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"Welch Two Sample t-test for Levin's B2 (Hosts vs. Fish Env-Only):</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb189-13"><a href="#cb189-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(ttest_breadth_b2)</span>
<span id="cb189-14"><a href="#cb189-14" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb189-15"><a href="#cb189-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"Not enough valid B2 values for t-test after removing NAs.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb189-16"><a href="#cb189-16" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb189-17"><a href="#cb189-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-18"><a href="#cb189-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Standard Deviation of Levin's B2:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb189-19"><a href="#cb189-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"  Hosts:"</span>, <span class="fu">sd</span>(valid_hosts_b2, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb189-20"><a href="#cb189-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"  Anemonefish:"</span>, <span class="fu">sd</span>(valid_fish_b2, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb189-21"><a href="#cb189-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-22"><a href="#cb189-22" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb189-23"><a href="#cb189-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Levin's B2 column not found in one or both breadth data frames.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb189-24"><a href="#cb189-24" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb189-25"><a href="#cb189-25" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb189-26"><a href="#cb189-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Not enough data to compare niche breadths between hosts and anemonefish.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb189-27"><a href="#cb189-27" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Comparing Mean Niche Breadth (Levin's B2) between Guilds ---
Welch Two Sample t-test for Levin's B2 (Hosts vs. Fish Env-Only):

    Welch Two Sample t-test

data:  valid_hosts_b2 and valid_fish_b2
t = 1.5624, df = 15.123, p-value = 0.1389
alternative hypothesis: true difference in means is not equal to 0
95 percent confidence interval:
 -0.03757814  0.24448601
sample estimates:
mean of x mean of y 
0.3192108 0.2157569 


Standard Deviation of Levin's B2:
  Hosts: 0.1821734 
  Anemonefish: 0.1632156 </code></pre>
</div>
</div>
</section>
</section>
<section id="niche-breadth-vs.-suitability-shifts-a-comparative-analysis" class="level2">
<h2 class="anchored" data-anchor-id="niche-breadth-vs.-suitability-shifts-a-comparative-analysis">Niche Breadth vs.&nbsp;Suitability Shifts: A Comparative Analysis</h2>
<p>This section explores the relationship between current environmental niche breadth (Levinâ€™s B2) and projected mean suitability shifts under future climate scenarios. The analysis is performed separately for host sea anemones and for anemonefish. For anemonefish, a further distinction is made based on their host specialization (Generalist: &gt;3 host species; Specialist: â‰¤3 host species) to investigate if the degree of host dependency influences their response patterns. Correlation tests are performed for each group and scenario, and the relationships are visualized to identify potential links between a speciesâ€™ current niche characteristics and its vulnerability or resilience to environmental change.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb191"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Load necessary libraries if not already loaded ---</span></span>
<span id="cb191-2"><a href="#cb191-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure these libraries are loaded in your R session or a preceding chunk</span></span>
<span id="cb191-3"><a href="#cb191-3" aria-hidden="true" tabindex="-1"></a><span class="co"># library(dplyr)</span></span>
<span id="cb191-4"><a href="#cb191-4" aria-hidden="true" tabindex="-1"></a><span class="co"># library(tidyr)</span></span>
<span id="cb191-5"><a href="#cb191-5" aria-hidden="true" tabindex="-1"></a><span class="co"># library(ggplot2)</span></span>
<span id="cb191-6"><a href="#cb191-6" aria-hidden="true" tabindex="-1"></a><span class="co"># library(stringr)</span></span>
<span id="cb191-7"><a href="#cb191-7" aria-hidden="true" tabindex="-1"></a><span class="co"># library(tibble)</span></span>
<span id="cb191-8"><a href="#cb191-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-9"><a href="#cb191-9" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Ensure prerequisite data is available (modified to be anemonefish-specific) ---</span></span>
<span id="cb191-10"><a href="#cb191-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-11"><a href="#cb191-11" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"fish_niche_breadth_df"</span>)) {</span>
<span id="cb191-12"><a href="#cb191-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"Niche breadth data frame ('fish_niche_breadth_df') not found. Run previous chunk."</span>)</span>
<span id="cb191-13"><a href="#cb191-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb191-14"><a href="#cb191-14" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"suitability_shifts_list"</span>) <span class="sc">||</span> <span class="sc">!</span><span class="fu">is.list</span>(suitability_shifts_list) <span class="sc">||</span> <span class="fu">length</span>(suitability_shifts_list) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb191-15"><a href="#cb191-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"`suitability_shifts_list` not found or empty. Run 'Individual Species Suitability Shifts' chunk."</span>)</span>
<span id="cb191-16"><a href="#cb191-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb191-17"><a href="#cb191-17" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"anemonefish_specialization_df"</span>) <span class="sc">||</span> <span class="fu">is.null</span>(anemonefish_specialization_df)) {</span>
<span id="cb191-18"><a href="#cb191-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"`anemonefish_specialization_df` not found. Ensure the 'AUC Improvement by Host Specialization' chunk has run."</span>)</span>
<span id="cb191-19"><a href="#cb191-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb191-20"><a href="#cb191-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-21"><a href="#cb191-21" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Define 2100 scenarios for processing ---</span></span>
<span id="cb191-22"><a href="#cb191-22" aria-hidden="true" tabindex="-1"></a><span class="co"># This part assumes a variable like `future_scenarios_to_load_full` or `config$env_scenarios` holds your scenario names.</span></span>
<span id="cb191-23"><a href="#cb191-23" aria-hidden="true" tabindex="-1"></a><span class="co"># For this script, we'll create the variable directly based on what you've provided.</span></span>
<span id="cb191-24"><a href="#cb191-24" aria-hidden="true" tabindex="-1"></a>future_scenarios_to_load <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"ssp119_2050"</span>, <span class="st">"ssp119_2100"</span>, <span class="st">"ssp585_2050"</span>, <span class="st">"ssp585_2100"</span>) <span class="co"># As provided in your output</span></span>
<span id="cb191-25"><a href="#cb191-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-26"><a href="#cb191-26" aria-hidden="true" tabindex="-1"></a><span class="co"># CORRECTED: Filter to include only scenarios ending in "_2100"</span></span>
<span id="cb191-27"><a href="#cb191-27" aria-hidden="true" tabindex="-1"></a>scenarios_to_process <span class="ot">&lt;-</span> future_scenarios_to_load[<span class="fu">grepl</span>(<span class="st">"_2100$"</span>, future_scenarios_to_load)]</span>
<span id="cb191-28"><a href="#cb191-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-29"><a href="#cb191-29" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(scenarios_to_process) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb191-30"><a href="#cb191-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This error message is now updated to reflect the corrected logic</span></span>
<span id="cb191-31"><a href="#cb191-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"No scenarios ending in '_2100' found in the scenario list. Please check names like 'ssp119_2100'."</span>)</span>
<span id="cb191-32"><a href="#cb191-32" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb191-33"><a href="#cb191-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-34"><a href="#cb191-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-35"><a href="#cb191-35" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"--- Processing Anemonefish (Env-Only) Breadth vs. Suitability Shift for 2100 ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- Processing Anemonefish (Env-Only) Breadth vs. Suitability Shift for 2100 ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb193"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a>fish_breadth_shifts_df_final <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb193-2"><a href="#cb193-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-3"><a href="#cb193-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(fish_niche_breadth_df) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb193-4"><a href="#cb193-4" aria-hidden="true" tabindex="-1"></a>  fish_breadth_shifts_df_temp <span class="ot">&lt;-</span> fish_niche_breadth_df <span class="sc">%&gt;%</span></span>
<span id="cb193-5"><a href="#cb193-5" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(species_name_sanitized, <span class="at">breadth_B2 =</span> levins_B2) <span class="sc">%&gt;%</span></span>
<span id="cb193-6"><a href="#cb193-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(anemonefish_specialization_df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(species, specialization_type, n_hosts),</span>
<span id="cb193-7"><a href="#cb193-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"species_name_sanitized"</span> <span class="ot">=</span> <span class="st">"species"</span>))</span>
<span id="cb193-8"><a href="#cb193-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-9"><a href="#cb193-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (scenario_name <span class="cf">in</span> scenarios_to_process) {</span>
<span id="cb193-10"><a href="#cb193-10" aria-hidden="true" tabindex="-1"></a>    shift_data_name <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"fish_env_only_"</span>, scenario_name)</span>
<span id="cb193-11"><a href="#cb193-11" aria-hidden="true" tabindex="-1"></a>    shift_col_name <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"shift_"</span>, <span class="fu">gsub</span>(<span class="st">"ssp"</span>, <span class="st">""</span>, scenario_name)) <span class="co"># Results in "shift_119_2100" etc.</span></span>
<span id="cb193-12"><a href="#cb193-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-13"><a href="#cb193-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (shift_data_name <span class="sc">%in%</span> <span class="fu">names</span>(suitability_shifts_list) <span class="sc">&amp;&amp;</span></span>
<span id="cb193-14"><a href="#cb193-14" aria-hidden="true" tabindex="-1"></a>        <span class="sc">!</span><span class="fu">is.null</span>(suitability_shifts_list[[shift_data_name]]) <span class="sc">&amp;&amp;</span></span>
<span id="cb193-15"><a href="#cb193-15" aria-hidden="true" tabindex="-1"></a>        <span class="fu">nrow</span>(suitability_shifts_list[[shift_data_name]]) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb193-16"><a href="#cb193-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-17"><a href="#cb193-17" aria-hidden="true" tabindex="-1"></a>      temp_shift_df_fish <span class="ot">&lt;-</span> suitability_shifts_list[[shift_data_name]] <span class="sc">%&gt;%</span></span>
<span id="cb193-18"><a href="#cb193-18" aria-hidden="true" tabindex="-1"></a>        <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb193-19"><a href="#cb193-19" aria-hidden="true" tabindex="-1"></a>        tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>(<span class="st">"species_name_sanitized"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb193-20"><a href="#cb193-20" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(species_name_sanitized, <span class="at">mean_suitability_shift =</span> mean)</span>
<span id="cb193-21"><a href="#cb193-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-22"><a href="#cb193-22" aria-hidden="true" tabindex="-1"></a>      fish_breadth_shifts_df_temp <span class="ot">&lt;-</span> fish_breadth_shifts_df_temp <span class="sc">%&gt;%</span></span>
<span id="cb193-23"><a href="#cb193-23" aria-hidden="true" tabindex="-1"></a>        <span class="fu">left_join</span>(temp_shift_df_fish <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="sc">!!</span><span class="at">shift_col_name :=</span> mean_suitability_shift),</span>
<span id="cb193-24"><a href="#cb193-24" aria-hidden="true" tabindex="-1"></a>                  <span class="at">by =</span> <span class="st">"species_name_sanitized"</span>)</span>
<span id="cb193-25"><a href="#cb193-25" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb193-26"><a href="#cb193-26" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"  Warning: Shift data for anemonefish in scenario '"</span>, scenario_name, <span class="st">"' not found. Column '"</span>, shift_col_name, <span class="st">"' will be NA.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb193-27"><a href="#cb193-27" aria-hidden="true" tabindex="-1"></a>      fish_breadth_shifts_df_temp[[shift_col_name]] <span class="ot">&lt;-</span> <span class="cn">NA_real_</span></span>
<span id="cb193-28"><a href="#cb193-28" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb193-29"><a href="#cb193-29" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb193-30"><a href="#cb193-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-31"><a href="#cb193-31" aria-hidden="true" tabindex="-1"></a>  fish_breadth_shifts_df_final <span class="ot">&lt;-</span> fish_breadth_shifts_df_temp <span class="sc">%&gt;%</span></span>
<span id="cb193-32"><a href="#cb193-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(breadth_B2), <span class="sc">!</span><span class="fu">is.na</span>(specialization_type))</span>
<span id="cb193-33"><a href="#cb193-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-34"><a href="#cb193-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Anemonefish (env-only) data prepared for 2100 analysis:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb193-35"><a href="#cb193-35" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(fish_breadth_shifts_df_final)) <span class="fu">print</span>(<span class="fu">head</span>(fish_breadth_shifts_df_final))</span>
<span id="cb193-36"><a href="#cb193-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-37"><a href="#cb193-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate and print correlations for 2100 scenarios</span></span>
<span id="cb193-38"><a href="#cb193-38" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (scenario_name <span class="cf">in</span> scenarios_to_process) {</span>
<span id="cb193-39"><a href="#cb193-39" aria-hidden="true" tabindex="-1"></a>    shift_col_name <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"shift_"</span>, <span class="fu">gsub</span>(<span class="st">"ssp"</span>, <span class="st">""</span>, scenario_name))</span>
<span id="cb193-40"><a href="#cb193-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (shift_col_name <span class="sc">%in%</span> <span class="fu">names</span>(fish_breadth_shifts_df_final)) {</span>
<span id="cb193-41"><a href="#cb193-41" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Correlations - Breadth vs. Shift ("</span>, scenario_name, <span class="st">"):</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb193-42"><a href="#cb193-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-43"><a href="#cb193-43" aria-hidden="true" tabindex="-1"></a>      temp_df_cor_fish_gen <span class="ot">&lt;-</span> fish_breadth_shifts_df_final <span class="sc">%&gt;%</span></span>
<span id="cb193-44"><a href="#cb193-44" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(specialization_type <span class="sc">==</span> <span class="st">"Generalist"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb193-45"><a href="#cb193-45" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(breadth_B2, <span class="sc">!!</span><span class="fu">sym</span>(shift_col_name)) <span class="sc">%&gt;%</span> <span class="fu">na.omit</span>()</span>
<span id="cb193-46"><a href="#cb193-46" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">nrow</span>(temp_df_cor_fish_gen) <span class="sc">&gt;</span> <span class="dv">2</span>) {</span>
<span id="cb193-47"><a href="#cb193-47" aria-hidden="true" tabindex="-1"></a>        cor_test_fish_gen <span class="ot">&lt;-</span> <span class="fu">cor.test</span>(temp_df_cor_fish_gen<span class="sc">$</span>breadth_B2, temp_df_cor_fish_gen[[shift_col_name]], <span class="at">method =</span> <span class="st">"pearson"</span>)</span>
<span id="cb193-48"><a href="#cb193-48" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"  Generalists:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb193-49"><a href="#cb193-49" aria-hidden="true" tabindex="-1"></a>        <span class="fu">print</span>(cor_test_fish_gen)</span>
<span id="cb193-50"><a href="#cb193-50" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb193-51"><a href="#cb193-51" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"  Not enough data points for Generalists in scenario:"</span>, scenario_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb193-52"><a href="#cb193-52" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb193-53"><a href="#cb193-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-54"><a href="#cb193-54" aria-hidden="true" tabindex="-1"></a>      temp_df_cor_fish_spec <span class="ot">&lt;-</span> fish_breadth_shifts_df_final <span class="sc">%&gt;%</span></span>
<span id="cb193-55"><a href="#cb193-55" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(specialization_type <span class="sc">==</span> <span class="st">"Specialist"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb193-56"><a href="#cb193-56" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(breadth_B2, <span class="sc">!!</span><span class="fu">sym</span>(shift_col_name)) <span class="sc">%&gt;%</span> <span class="fu">na.omit</span>()</span>
<span id="cb193-57"><a href="#cb193-57" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">nrow</span>(temp_df_cor_fish_spec) <span class="sc">&gt;</span> <span class="dv">2</span>){</span>
<span id="cb193-58"><a href="#cb193-58" aria-hidden="true" tabindex="-1"></a>        cor_test_fish_spec <span class="ot">&lt;-</span> <span class="fu">cor.test</span>(temp_df_cor_fish_spec<span class="sc">$</span>breadth_B2, temp_df_cor_fish_spec[[shift_col_name]], <span class="at">method =</span> <span class="st">"pearson"</span>)</span>
<span id="cb193-59"><a href="#cb193-59" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"  Specialists:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb193-60"><a href="#cb193-60" aria-hidden="true" tabindex="-1"></a>        <span class="fu">print</span>(cor_test_fish_spec)</span>
<span id="cb193-61"><a href="#cb193-61" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb193-62"><a href="#cb193-62" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"  Not enough data points for Specialists in scenario:"</span>, scenario_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb193-63"><a href="#cb193-63" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb193-64"><a href="#cb193-64" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb193-65"><a href="#cb193-65" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb193-66"><a href="#cb193-66" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb193-67"><a href="#cb193-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"No anemonefish niche breadth data available.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb193-68"><a href="#cb193-68" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Anemonefish (env-only) data prepared for 2100 analysis:
   species_name_sanitized breadth_B2 specialization_type n_hosts shift_119_2100
1      Amphiprion_clarkii  0.1685557          Generalist       9    0.005938971
2     Amphiprion_frenatus  0.1551884          Specialist       1   -0.002292901
3    Amphiprion_ocellaris  0.1584185          Generalist       3    0.008576375
4  Amphiprion_perideraion  0.2022923          Generalist       4   -0.002811991
5     Amphiprion_polymnus  0.2567353          Generalist       2    0.008655777
6 Amphiprion_sandaracinos  0.1408752          Generalist       2    0.016894402
  shift_585_2100
1   0.0066586929
2  -0.0006243751
3   0.0093639136
4  -0.0018158388
5   0.0094944935
6   0.0180557323

Correlations - Breadth vs. Shift ( ssp119_2100 ):
  Generalists:

    Pearson's product-moment correlation

data:  temp_df_cor_fish_gen$breadth_B2 and temp_df_cor_fish_gen[[shift_col_name]]
t = 2.8849, df = 17, p-value = 0.01029
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 0.1610148 0.8152241
sample estimates:
      cor 
0.5732964 

  Specialists:

    Pearson's product-moment correlation

data:  temp_df_cor_fish_spec$breadth_B2 and temp_df_cor_fish_spec[[shift_col_name]]
t = 7.1627, df = 4, p-value = 0.002011
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 0.6943195 0.9961034
sample estimates:
      cor 
0.9631579 


Correlations - Breadth vs. Shift ( ssp585_2100 ):
  Generalists:

    Pearson's product-moment correlation

data:  temp_df_cor_fish_gen$breadth_B2 and temp_df_cor_fish_gen[[shift_col_name]]
t = 2.8897, df = 17, p-value = 0.01018
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 0.1619291 0.8155388
sample estimates:
      cor 
0.5739263 

  Specialists:

    Pearson's product-moment correlation

data:  temp_df_cor_fish_spec$breadth_B2 and temp_df_cor_fish_spec[[shift_col_name]]
t = 5.1846, df = 4, p-value = 0.006586
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 0.5000572 0.9928136
sample estimates:
      cor 
0.9329871 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb195"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Prepare data for plotting (only Anemonefish, only 2100) ---</span></span>
<span id="cb195-2"><a href="#cb195-2" aria-hidden="true" tabindex="-1"></a>all_breadth_shifts_long_df_final <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb195-3"><a href="#cb195-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb195-4"><a href="#cb195-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(fish_breadth_shifts_df_final) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(fish_breadth_shifts_df_final) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb195-5"><a href="#cb195-5" aria-hidden="true" tabindex="-1"></a>  fish_plot_df_final <span class="ot">&lt;-</span> fish_breadth_shifts_df_final <span class="sc">%&gt;%</span></span>
<span id="cb195-6"><a href="#cb195-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">"shift_"</span>),</span>
<span id="cb195-7"><a href="#cb195-7" aria-hidden="true" tabindex="-1"></a>                 <span class="at">names_to =</span> <span class="st">"scenario_shift_code"</span>,</span>
<span id="cb195-8"><a href="#cb195-8" aria-hidden="true" tabindex="-1"></a>                 <span class="at">values_to =</span> <span class="st">"suitability_shift"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb195-9"><a href="#cb195-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">guild =</span> <span class="st">"Anemonefish"</span>)</span>
<span id="cb195-10"><a href="#cb195-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb195-11"><a href="#cb195-11" aria-hidden="true" tabindex="-1"></a>  all_breadth_shifts_long_df_final <span class="ot">&lt;-</span> fish_plot_df_final</span>
<span id="cb195-12"><a href="#cb195-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb195-13"><a href="#cb195-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb195-14"><a href="#cb195-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb195-15"><a href="#cb195-15" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(all_breadth_shifts_long_df_final) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(all_breadth_shifts_long_df_final) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb195-16"><a href="#cb195-16" aria-hidden="true" tabindex="-1"></a>  all_breadth_shifts_long_df_final <span class="ot">&lt;-</span> all_breadth_shifts_long_df_final <span class="sc">%&gt;%</span></span>
<span id="cb195-17"><a href="#cb195-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(breadth_B2), <span class="sc">!</span><span class="fu">is.na</span>(suitability_shift)) <span class="sc">%&gt;%</span></span>
<span id="cb195-18"><a href="#cb195-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># CORRECTED: Simplified label creation for the "sspXXX_YYYY" format</span></span>
<span id="cb195-19"><a href="#cb195-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">scenario_display =</span> stringr<span class="sc">::</span><span class="fu">str_replace</span>(scenario_shift_code, <span class="st">"shift_"</span>, <span class="st">"SSP"</span>),</span>
<span id="cb195-20"><a href="#cb195-20" aria-hidden="true" tabindex="-1"></a>           <span class="at">scenario_display =</span> stringr<span class="sc">::</span><span class="fu">str_replace</span>(scenario_display, <span class="st">"_"</span>, <span class="st">"-"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb195-21"><a href="#cb195-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">facet_group =</span> <span class="fu">paste</span>(guild, specialization_type, <span class="at">sep=</span><span class="st">" - "</span>))</span>
<span id="cb195-22"><a href="#cb195-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb195-23"><a href="#cb195-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Combined long format data for plotting (Anemonefish, 2100):</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb195-24"><a href="#cb195-24" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(all_breadth_shifts_long_df_final)) <span class="fu">print</span>(<span class="fu">head</span>(all_breadth_shifts_long_df_final))</span>
<span id="cb195-25"><a href="#cb195-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb195-26"><a href="#cb195-26" aria-hidden="true" tabindex="-1"></a>  plot_breadth_vs_shift_specialization <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(all_breadth_shifts_long_df_final,</span>
<span id="cb195-27"><a href="#cb195-27" aria-hidden="true" tabindex="-1"></a>                                                 <span class="fu">aes</span>(<span class="at">x =</span> suitability_shift, <span class="at">y =</span> breadth_B2)) <span class="sc">+</span></span>
<span id="cb195-28"><a href="#cb195-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.7</span>, <span class="fu">aes</span>(<span class="at">color =</span> specialization_type)) <span class="sc">+</span></span>
<span id="cb195-29"><a href="#cb195-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">TRUE</span>, <span class="fu">aes</span>(<span class="at">linetype =</span> specialization_type, <span class="at">color=</span>specialization_type)) <span class="sc">+</span></span>
<span id="cb195-30"><a href="#cb195-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span> scenario_display, <span class="at">scales =</span> <span class="st">"free_x"</span>,</span>
<span id="cb195-31"><a href="#cb195-31" aria-hidden="true" tabindex="-1"></a>               <span class="at">ncol=</span><span class="fu">length</span>(<span class="fu">unique</span>(all_breadth_shifts_long_df_final<span class="sc">$</span>scenario_display))) <span class="sc">+</span></span>
<span id="cb195-32"><a href="#cb195-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb195-33"><a href="#cb195-33" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Anemonefish: Niche Breadth vs. Mean Suitability Shift (2100)"</span>,</span>
<span id="cb195-34"><a href="#cb195-34" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Mean Change in Suitability (2100 vs. Current)"</span>,</span>
<span id="cb195-35"><a href="#cb195-35" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"Levin's B2 (Niche Breadth)"</span></span>
<span id="cb195-36"><a href="#cb195-36" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb195-37"><a href="#cb195-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Generalist"</span> <span class="ot">=</span> <span class="st">"cornflowerblue"</span>, <span class="st">"Specialist"</span> <span class="ot">=</span> <span class="st">"darkorange"</span>), <span class="at">name =</span> <span class="st">"Specialization Type"</span>) <span class="sc">+</span></span>
<span id="cb195-38"><a href="#cb195-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_linetype_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Generalist"</span> <span class="ot">=</span> <span class="st">"dashed"</span>, <span class="st">"Specialist"</span> <span class="ot">=</span> <span class="st">"dotted"</span>), <span class="at">name =</span> <span class="st">"Specialization Type"</span>) <span class="sc">+</span></span>
<span id="cb195-39"><a href="#cb195-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb195-40"><a href="#cb195-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>), <span class="co"># Slightly larger font for clarity</span></span>
<span id="cb195-41"><a href="#cb195-41" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb195-42"><a href="#cb195-42" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust=</span><span class="fl">0.5</span>, <span class="at">face=</span><span class="st">"bold"</span>),</span>
<span id="cb195-43"><a href="#cb195-43" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust=</span><span class="fl">0.5</span>))</span>
<span id="cb195-44"><a href="#cb195-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb195-45"><a href="#cb195-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(plot_breadth_vs_shift_specialization)</span>
<span id="cb195-46"><a href="#cb195-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb195-47"><a href="#cb195-47" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"figure_output_dir"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">dir.exists</span>(figure_output_dir)) {</span>
<span id="cb195-48"><a href="#cb195-48" aria-hidden="true" tabindex="-1"></a>    faceted_breadth_shift_plot_filename <span class="ot">&lt;-</span> <span class="fu">file.path</span>(figure_output_dir, <span class="st">"anemonefish_breadth_vs_shift_2100.png"</span>)</span>
<span id="cb195-49"><a href="#cb195-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggsave</span>(<span class="at">filename =</span> faceted_breadth_shift_plot_filename,</span>
<span id="cb195-50"><a href="#cb195-50" aria-hidden="true" tabindex="-1"></a>           <span class="at">plot =</span> plot_breadth_vs_shift_specialization,</span>
<span id="cb195-51"><a href="#cb195-51" aria-hidden="true" tabindex="-1"></a>           <span class="at">width =</span> <span class="dv">10</span>, <span class="at">height =</span> <span class="dv">6</span>, <span class="at">units =</span> <span class="st">"in"</span>, <span class="at">dpi =</span> <span class="dv">300</span>)</span>
<span id="cb195-52"><a href="#cb195-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Saved plot to:"</span>, faceted_breadth_shift_plot_filename, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb195-53"><a href="#cb195-53" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb195-54"><a href="#cb195-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Warning: 'figure_output_dir' not defined. Plot not saved to file.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb195-55"><a href="#cb195-55" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb195-56"><a href="#cb195-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb195-57"><a href="#cb195-57" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb195-58"><a href="#cb195-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Not enough data to plot breadth vs. suitability shifts for 2100.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb195-59"><a href="#cb195-59" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Combined long format data for plotting (Anemonefish, 2100):
# A tibble: 6 Ã— 9
  species_name_sanitized breadth_B2 specialization_type n_hosts
  &lt;chr&gt;                       &lt;dbl&gt; &lt;fct&gt;                 &lt;int&gt;
1 Amphiprion_clarkii          0.169 Generalist                9
2 Amphiprion_clarkii          0.169 Generalist                9
3 Amphiprion_frenatus         0.155 Specialist                1
4 Amphiprion_frenatus         0.155 Specialist                1
5 Amphiprion_ocellaris        0.158 Generalist                3
6 Amphiprion_ocellaris        0.158 Generalist                3
# â„¹ 5 more variables: scenario_shift_code &lt;chr&gt;, suitability_shift &lt;dbl&gt;,
#   guild &lt;chr&gt;, scenario_display &lt;chr&gt;, facet_group &lt;chr&gt;</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/breadth-suitability-correlation-specialization-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Saved plot to: /home/bi-server-kyoto/a0236995/sdm_anemonefish/figure_files/anemonefish_breadth_vs_shift_2100.png </code></pre>
</div>
</div>
</section>
<section id="variable-importance-comparison" class="level2">
<h2 class="anchored" data-anchor-id="variable-importance-comparison">Variable Importance Comparison</h2>
<p>This section loads the variable importance (VI) scores from the environmental-only SDMs for host sea anemones and anemonefish. It then compares the importance of each environmental predictor (PCA components if used) between the two guilds.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb198"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb198-1"><a href="#cb198-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb198-2"><a href="#cb198-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr) <span class="co"># Not strictly needed for this chunk as is, but good to have if you modify</span></span>
<span id="cb198-3"><a href="#cb198-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb198-4"><a href="#cb198-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr) <span class="co"># For str_remove if needed in species_sanitized, though seems done by filename</span></span>
<span id="cb198-5"><a href="#cb198-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)   <span class="co"># For read_csv</span></span>
<span id="cb198-6"><a href="#cb198-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)   <span class="co"># For map_df</span></span>
<span id="cb198-7"><a href="#cb198-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb198-8"><a href="#cb198-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine predictor suffix used for the environmental-only models</span></span>
<span id="cb198-9"><a href="#cb198-9" aria-hidden="true" tabindex="-1"></a>env_model_predictor_suffix <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(config<span class="sc">$</span>use_pca_predictors, <span class="st">"_pca"</span>, <span class="st">"_vif"</span>)</span>
<span id="cb198-10"><a href="#cb198-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb198-11"><a href="#cb198-11" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Load Host Anemone Variable Importance ---</span></span>
<span id="cb198-12"><a href="#cb198-12" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"--- Loading Host Anemone Variable Importance ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- Loading Host Anemone Variable Importance ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb200"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb200-1"><a href="#cb200-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Original logic for finding host_vi_dir and host_vi_files</span></span>
<span id="cb200-2"><a href="#cb200-2" aria-hidden="true" tabindex="-1"></a>host_vi_subdir_name <span class="ot">&lt;-</span> config<span class="sc">$</span>model_output_subdir_map[[env_model_predictor_suffix]] <span class="sc">%||%</span> </span>
<span id="cb200-3"><a href="#cb200-3" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">ifelse</span>(config<span class="sc">$</span>use_pca_predictors, <span class="st">"anemone_pca"</span>, <span class="st">"anemone_vif"</span>)</span>
<span id="cb200-4"><a href="#cb200-4" aria-hidden="true" tabindex="-1"></a>host_vi_dir_base <span class="ot">&lt;-</span> <span class="fu">file.path</span>(config<span class="sc">$</span>target_vi_base, host_vi_subdir_name)</span>
<span id="cb200-5"><a href="#cb200-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb200-6"><a href="#cb200-6" aria-hidden="true" tabindex="-1"></a>host_vi_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path =</span> host_vi_dir_base, <span class="at">pattern =</span> <span class="st">"^VI_.*</span><span class="sc">\\</span><span class="st">.csv$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb200-7"><a href="#cb200-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Fallback if subdirectory structure is slightly different (e.g., .../anemone_pca/anemone_pca)</span></span>
<span id="cb200-8"><a href="#cb200-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(host_vi_files) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span> env_model_predictor_suffix <span class="sc">==</span> <span class="st">"_pca"</span>) { </span>
<span id="cb200-9"><a href="#cb200-9" aria-hidden="true" tabindex="-1"></a>    host_vi_dir_alt <span class="ot">&lt;-</span> <span class="fu">file.path</span>(config<span class="sc">$</span>target_vi_base, <span class="st">"anemone_pca"</span>) <span class="co"># Check one level up from expected subdir</span></span>
<span id="cb200-10"><a href="#cb200-10" aria-hidden="true" tabindex="-1"></a>    host_vi_files_alt_check <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path =</span> host_vi_dir_alt, <span class="at">pattern =</span> <span class="st">"^VI_.*</span><span class="sc">\\</span><span class="st">.csv$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb200-11"><a href="#cb200-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">length</span>(host_vi_files_alt_check) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb200-12"><a href="#cb200-12" aria-hidden="true" tabindex="-1"></a>        host_vi_files <span class="ot">&lt;-</span> host_vi_files_alt_check</span>
<span id="cb200-13"><a href="#cb200-13" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"  Found host VI files in alternative directory:"</span>, host_vi_dir_alt, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb200-14"><a href="#cb200-14" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> { <span class="co"># Check if it's nested further</span></span>
<span id="cb200-15"><a href="#cb200-15" aria-hidden="true" tabindex="-1"></a>        host_vi_dir_nested <span class="ot">&lt;-</span> <span class="fu">file.path</span>(host_vi_dir_base, <span class="st">"anemone_pca"</span>) <span class="co"># Original had host_vi_dir/anemone_pca</span></span>
<span id="cb200-16"><a href="#cb200-16" aria-hidden="true" tabindex="-1"></a>        host_vi_files_nested_check <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path =</span> host_vi_dir_nested, <span class="at">pattern =</span> <span class="st">"^VI_.*</span><span class="sc">\\</span><span class="st">.csv$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb200-17"><a href="#cb200-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">length</span>(host_vi_files_nested_check) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb200-18"><a href="#cb200-18" aria-hidden="true" tabindex="-1"></a>            host_vi_files <span class="ot">&lt;-</span> host_vi_files_nested_check</span>
<span id="cb200-19"><a href="#cb200-19" aria-hidden="true" tabindex="-1"></a>            <span class="fu">cat</span>(<span class="st">"  Found host VI files in nested directory:"</span>, host_vi_dir_nested, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb200-20"><a href="#cb200-20" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb200-21"><a href="#cb200-21" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb200-22"><a href="#cb200-22" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Found host VI files in alternative directory: /home/bi-server-kyoto/a0236995/sdm_anemonefish/data/output/anemone_pca </code></pre>
</div>
<div class="sourceCode cell-code" id="cb202"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb202-1"><a href="#cb202-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(host_vi_files) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb202-2"><a href="#cb202-2" aria-hidden="true" tabindex="-1"></a>  host_vi_data <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map_df</span>(host_vi_files, </span>
<span id="cb202-3"><a href="#cb202-3" aria-hidden="true" tabindex="-1"></a>                <span class="sc">~</span>readr<span class="sc">::</span><span class="fu">read_csv</span>(.x, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb202-4"><a href="#cb202-4" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">mutate</span>(<span class="at">filename =</span> <span class="fu">basename</span>(.x))) <span class="sc">%&gt;%</span></span>
<span id="cb202-5"><a href="#cb202-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb202-6"><a href="#cb202-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">species_sanitized =</span> <span class="fu">str_remove</span>(<span class="fu">str_remove</span>(filename, <span class="st">"^VI_"</span>), <span class="st">"</span><span class="sc">\\</span><span class="st">.csv$"</span>),</span>
<span id="cb202-7"><a href="#cb202-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">guild =</span> <span class="st">"Host Anemones"</span> <span class="co"># Consistent naming with scale_fill_manual later</span></span>
<span id="cb202-8"><a href="#cb202-8" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb202-9"><a href="#cb202-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">Permutation_Importance =</span> Importance) </span>
<span id="cb202-10"><a href="#cb202-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb202-11"><a href="#cb202-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Loaded VI data for"</span>, <span class="fu">length</span>(<span class="fu">unique</span>(host_vi_data<span class="sc">$</span>species_sanitized)), <span class="st">"host species.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb202-12"><a href="#cb202-12" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb202-13"><a href="#cb202-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Warning: No Variable Importance CSV files found for host anemones. Checked:"</span>, host_vi_dir_base, <span class="st">"and potential alternatives.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb202-14"><a href="#cb202-14" aria-hidden="true" tabindex="-1"></a>  host_vi_data <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb202-15"><a href="#cb202-15" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Loaded VI data for 10 host species.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb204"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb204-1"><a href="#cb204-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Load Anemonefish (Environmental-Only Models) Variable Importance ---</span></span>
<span id="cb204-2"><a href="#cb204-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Loading Anemonefish (Env-Only) Variable Importance ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Loading Anemonefish (Env-Only) Variable Importance ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb206"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb206-1"><a href="#cb206-1" aria-hidden="true" tabindex="-1"></a>fish_vi_subdir_name <span class="ot">&lt;-</span> config<span class="sc">$</span>model_output_subdir_map[[env_model_predictor_suffix]] <span class="sc">%||%</span> </span>
<span id="cb206-2"><a href="#cb206-2" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">ifelse</span>(config<span class="sc">$</span>use_pca_predictors, <span class="st">"anemonefish_pca"</span>, <span class="st">"anemonefish_vif"</span>)</span>
<span id="cb206-3"><a href="#cb206-3" aria-hidden="true" tabindex="-1"></a>fish_vi_dir_base <span class="ot">&lt;-</span> <span class="fu">file.path</span>(config<span class="sc">$</span>target_vi_base, fish_vi_subdir_name)</span>
<span id="cb206-4"><a href="#cb206-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-5"><a href="#cb206-5" aria-hidden="true" tabindex="-1"></a>fish_vi_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path =</span> fish_vi_dir_base, <span class="at">pattern =</span> <span class="st">"^VI_.*</span><span class="sc">\\</span><span class="st">.csv$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb206-6"><a href="#cb206-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(fish_vi_files) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span> env_model_predictor_suffix <span class="sc">==</span> <span class="st">"_pca"</span>) { </span>
<span id="cb206-7"><a href="#cb206-7" aria-hidden="true" tabindex="-1"></a>    fish_vi_dir_alt <span class="ot">&lt;-</span> <span class="fu">file.path</span>(config<span class="sc">$</span>target_vi_base, <span class="st">"anemonefish_pca"</span>)</span>
<span id="cb206-8"><a href="#cb206-8" aria-hidden="true" tabindex="-1"></a>    fish_vi_files_alt_check <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path =</span> fish_vi_dir_alt, <span class="at">pattern =</span> <span class="st">"^VI_.*</span><span class="sc">\\</span><span class="st">.csv$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb206-9"><a href="#cb206-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">length</span>(fish_vi_files_alt_check) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb206-10"><a href="#cb206-10" aria-hidden="true" tabindex="-1"></a>        fish_vi_files <span class="ot">&lt;-</span> fish_vi_files_alt_check</span>
<span id="cb206-11"><a href="#cb206-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"  Found fish VI files in alternative directory:"</span>, fish_vi_dir_alt, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb206-12"><a href="#cb206-12" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb206-13"><a href="#cb206-13" aria-hidden="true" tabindex="-1"></a>        fish_vi_dir_nested <span class="ot">&lt;-</span> <span class="fu">file.path</span>(fish_vi_dir_base, <span class="st">"anemonefish_pca"</span>)</span>
<span id="cb206-14"><a href="#cb206-14" aria-hidden="true" tabindex="-1"></a>        fish_vi_files_nested_check <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path =</span> fish_vi_dir_nested, <span class="at">pattern =</span> <span class="st">"^VI_.*</span><span class="sc">\\</span><span class="st">.csv$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb206-15"><a href="#cb206-15" aria-hidden="true" tabindex="-1"></a>         <span class="cf">if</span>(<span class="fu">length</span>(fish_vi_files_nested_check) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb206-16"><a href="#cb206-16" aria-hidden="true" tabindex="-1"></a>            fish_vi_files <span class="ot">&lt;-</span> fish_vi_files_nested_check</span>
<span id="cb206-17"><a href="#cb206-17" aria-hidden="true" tabindex="-1"></a>            <span class="fu">cat</span>(<span class="st">"  Found fish VI files in nested directory:"</span>, fish_vi_dir_nested, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb206-18"><a href="#cb206-18" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb206-19"><a href="#cb206-19" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb206-20"><a href="#cb206-20" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Found fish VI files in alternative directory: /home/bi-server-kyoto/a0236995/sdm_anemonefish/data/output/anemonefish_pca </code></pre>
</div>
<div class="sourceCode cell-code" id="cb208"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb208-1"><a href="#cb208-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(fish_vi_files) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb208-2"><a href="#cb208-2" aria-hidden="true" tabindex="-1"></a>  fish_vi_data <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map_df</span>(fish_vi_files, </span>
<span id="cb208-3"><a href="#cb208-3" aria-hidden="true" tabindex="-1"></a>                <span class="sc">~</span>readr<span class="sc">::</span><span class="fu">read_csv</span>(.x, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb208-4"><a href="#cb208-4" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">mutate</span>(<span class="at">filename =</span> <span class="fu">basename</span>(.x))) <span class="sc">%&gt;%</span></span>
<span id="cb208-5"><a href="#cb208-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb208-6"><a href="#cb208-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">species_sanitized =</span> <span class="fu">str_remove</span>(<span class="fu">str_remove</span>(filename, <span class="st">"^VI_"</span>), <span class="st">"</span><span class="sc">\\</span><span class="st">.csv$"</span>),</span>
<span id="cb208-7"><a href="#cb208-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">guild =</span> <span class="st">"Anemonefish (Env-Only)"</span> <span class="co"># Consistent naming</span></span>
<span id="cb208-8"><a href="#cb208-8" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb208-9"><a href="#cb208-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">Permutation_Importance =</span> Importance) </span>
<span id="cb208-10"><a href="#cb208-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Loaded VI data for"</span>, <span class="fu">length</span>(<span class="fu">unique</span>(fish_vi_data<span class="sc">$</span>species_sanitized)), <span class="st">"anemonefish (env-only) species.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb208-11"><a href="#cb208-11" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb208-12"><a href="#cb208-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Warning: No Variable Importance CSV files found for anemonefish (env-only). Checked:"</span>, fish_vi_dir_base, <span class="st">"and potential alternatives.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb208-13"><a href="#cb208-13" aria-hidden="true" tabindex="-1"></a>  fish_vi_data <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb208-14"><a href="#cb208-14" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Loaded VI data for 27 anemonefish (env-only) species.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb210"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb210-1"><a href="#cb210-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Combine and Compare VI ---</span></span>
<span id="cb210-2"><a href="#cb210-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(host_vi_data) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">is.null</span>(fish_vi_data) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(host_vi_data) <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(fish_vi_data) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb210-3"><a href="#cb210-3" aria-hidden="true" tabindex="-1"></a>  combined_vi_data <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(host_vi_data, fish_vi_data) <span class="sc">%&gt;%</span></span>
<span id="cb210-4"><a href="#cb210-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Permutation_Importance)) </span>
<span id="cb210-5"><a href="#cb210-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb210-6"><a href="#cb210-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="st">"Variable"</span> <span class="sc">%in%</span> <span class="fu">names</span>(combined_vi_data)) {</span>
<span id="cb210-7"><a href="#cb210-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"The 'Variable' column is missing from the loaded VI data. Check the output of SDMtune::varImp or your VI calculation script."</span>)</span>
<span id="cb210-8"><a href="#cb210-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb210-9"><a href="#cb210-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb210-10"><a href="#cb210-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Combined VI data for comparison:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb210-11"><a href="#cb210-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">head</span>(combined_vi_data))</span>
<span id="cb210-12"><a href="#cb210-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb210-13"><a href="#cb210-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ensure guild is a factor for consistent plotting order and legend</span></span>
<span id="cb210-14"><a href="#cb210-14" aria-hidden="true" tabindex="-1"></a>  combined_vi_data<span class="sc">$</span>guild <span class="ot">&lt;-</span> <span class="fu">factor</span>(combined_vi_data<span class="sc">$</span>guild, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Anemonefish (Env-Only)"</span>, <span class="st">"Host Anemones"</span>))</span>
<span id="cb210-15"><a href="#cb210-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb210-16"><a href="#cb210-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb210-17"><a href="#cb210-17" aria-hidden="true" tabindex="-1"></a>  plot_vi_comparison <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(combined_vi_data, <span class="fu">aes</span>(<span class="at">x =</span> Variable, <span class="at">y =</span> Permutation_Importance, <span class="at">fill =</span> guild)) <span class="sc">+</span></span>
<span id="cb210-18"><a href="#cb210-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_boxplot</span>(<span class="at">alpha =</span> <span class="fl">0.8</span>, <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">preserve =</span> <span class="st">"single"</span>)) <span class="sc">+</span></span>
<span id="cb210-19"><a href="#cb210-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb210-20"><a href="#cb210-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Variable Importance Comparison between Guilds"</span>,</span>
<span id="cb210-21"><a href="#cb210-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Predictor Variable (PCA Component)"</span>, <span class="co"># Clarified x-axis</span></span>
<span id="cb210-22"><a href="#cb210-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"Permutation Importance (%)"</span></span>
<span id="cb210-23"><a href="#cb210-23" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb210-24"><a href="#cb210-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Host Anemones"</span> <span class="ot">=</span> <span class="st">"coral"</span>, <span class="st">"Anemonefish (Env-Only)"</span> <span class="ot">=</span> <span class="st">"steelblue"</span>), <span class="at">name =</span> <span class="st">"Guild"</span>) <span class="sc">+</span> <span class="co"># Matched factor levels</span></span>
<span id="cb210-25"><a href="#cb210-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb210-26"><a href="#cb210-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>), <span class="at">legend.position =</span> <span class="st">"top"</span>)</span>
<span id="cb210-27"><a href="#cb210-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb210-28"><a href="#cb210-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Print plot to RMarkdown output</span></span>
<span id="cb210-29"><a href="#cb210-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(plot_vi_comparison)</span>
<span id="cb210-30"><a href="#cb210-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb210-31"><a href="#cb210-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- ADD THIS SECTION TO SAVE plot_vi_comparison ---</span></span>
<span id="cb210-32"><a href="#cb210-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ensure figure_output_dir is defined (should be from setup chunk)</span></span>
<span id="cb210-33"><a href="#cb210-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"figure_output_dir"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">dir.exists</span>(figure_output_dir)) {</span>
<span id="cb210-34"><a href="#cb210-34" aria-hidden="true" tabindex="-1"></a>    vi_comparison_plot_filename <span class="ot">&lt;-</span> <span class="fu">file.path</span>(figure_output_dir, <span class="st">"variable_importance_comparison_guilds.png"</span>)</span>
<span id="cb210-35"><a href="#cb210-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggsave</span>(<span class="at">filename =</span> vi_comparison_plot_filename, </span>
<span id="cb210-36"><a href="#cb210-36" aria-hidden="true" tabindex="-1"></a>           <span class="at">plot =</span> plot_vi_comparison, </span>
<span id="cb210-37"><a href="#cb210-37" aria-hidden="true" tabindex="-1"></a>           <span class="at">width =</span> <span class="dv">8</span>, <span class="at">height =</span> <span class="dv">6</span>, <span class="at">units =</span> <span class="st">"in"</span>, <span class="at">dpi =</span> <span class="dv">300</span>) <span class="co"># Adjust dimensions/dpi as needed</span></span>
<span id="cb210-38"><a href="#cb210-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Saved variable importance comparison plot to:"</span>, vi_comparison_plot_filename, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb210-39"><a href="#cb210-39" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb210-40"><a href="#cb210-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Warning: 'figure_output_dir' not defined or does not exist. Variable importance plot not saved to file.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb210-41"><a href="#cb210-41" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb210-42"><a href="#cb210-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- </span><span class="re">END</span><span class="co"> OF ADDED SECTION ---</span></span>
<span id="cb210-43"><a href="#cb210-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb210-44"><a href="#cb210-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Perform t-tests for each predictor variable</span></span>
<span id="cb210-45"><a href="#cb210-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- T-tests for difference in Variable Importance between Guilds ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb210-46"><a href="#cb210-46" aria-hidden="true" tabindex="-1"></a>  predictor_vars_to_test <span class="ot">&lt;-</span> <span class="fu">unique</span>(combined_vi_data<span class="sc">$</span>Variable)</span>
<span id="cb210-47"><a href="#cb210-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb210-48"><a href="#cb210-48" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (var_name <span class="cf">in</span> predictor_vars_to_test) {</span>
<span id="cb210-49"><a href="#cb210-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"  Testing variable:"</span>, var_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb210-50"><a href="#cb210-50" aria-hidden="true" tabindex="-1"></a>    data_for_ttest <span class="ot">&lt;-</span> combined_vi_data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Variable <span class="sc">==</span> var_name)</span>
<span id="cb210-51"><a href="#cb210-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb210-52"><a href="#cb210-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if both guild levels are present with more than 1 observation each for the current variable</span></span>
<span id="cb210-53"><a href="#cb210-53" aria-hidden="true" tabindex="-1"></a>    guild_counts_for_var <span class="ot">&lt;-</span> data_for_ttest <span class="sc">%&gt;%</span> </span>
<span id="cb210-54"><a href="#cb210-54" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">group_by</span>(guild) <span class="sc">%&gt;%</span> </span>
<span id="cb210-55"><a href="#cb210-55" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">summarise</span>(<span class="at">n_obs =</span> <span class="fu">n</span>(), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb210-56"><a href="#cb210-56" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">filter</span>(n_obs <span class="sc">&gt;</span> <span class="dv">1</span>)</span>
<span id="cb210-57"><a href="#cb210-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb210-58"><a href="#cb210-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">nrow</span>(guild_counts_for_var) <span class="sc">==</span> <span class="dv">2</span>) { <span class="co"># Needs exactly two groups with &gt;1 obs each</span></span>
<span id="cb210-59"><a href="#cb210-59" aria-hidden="true" tabindex="-1"></a>      ttest_vi_result <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb210-60"><a href="#cb210-60" aria-hidden="true" tabindex="-1"></a>        <span class="fu">t.test</span>(Permutation_Importance <span class="sc">~</span> guild, <span class="at">data =</span> data_for_ttest)</span>
<span id="cb210-61"><a href="#cb210-61" aria-hidden="true" tabindex="-1"></a>      }, <span class="at">error =</span> <span class="cf">function</span>(e){</span>
<span id="cb210-62"><a href="#cb210-62" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"    Error in t-test for"</span>, var_name, <span class="st">":"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>); <span class="cn">NULL</span></span>
<span id="cb210-63"><a href="#cb210-63" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb210-64"><a href="#cb210-64" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(ttest_vi_result)) <span class="fu">print</span>(ttest_vi_result)</span>
<span id="cb210-65"><a href="#cb210-65" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb210-66"><a href="#cb210-66" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb210-67"><a href="#cb210-67" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"    Skipping t-test for"</span>, var_name, <span class="st">"- insufficient data or only one guild present for this variable after filtering.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb210-68"><a href="#cb210-68" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(data_for_ttest <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(guild) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">Count=</span><span class="fu">n</span>())) <span class="co"># Show counts for debugging</span></span>
<span id="cb210-69"><a href="#cb210-69" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb210-70"><a href="#cb210-70" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb210-71"><a href="#cb210-71" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb210-72"><a href="#cb210-72" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb210-73"><a href="#cb210-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Not enough variable importance data to compare between guilds.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb210-74"><a href="#cb210-74" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Combined VI data for comparison:
# A tibble: 6 Ã— 5
  Variable Permutation_Importance filename               species_sanitized guild
  &lt;chr&gt;                     &lt;dbl&gt; &lt;chr&gt;                  &lt;chr&gt;             &lt;chr&gt;
1 PC1                        75.4 VI_Cryptodendrum_adhaâ€¦ Cryptodendrum_adâ€¦ Hostâ€¦
2 PC2                        17.5 VI_Cryptodendrum_adhaâ€¦ Cryptodendrum_adâ€¦ Hostâ€¦
3 PC4                         6.1 VI_Cryptodendrum_adhaâ€¦ Cryptodendrum_adâ€¦ Hostâ€¦
4 PC3                         0.9 VI_Cryptodendrum_adhaâ€¦ Cryptodendrum_adâ€¦ Hostâ€¦
5 PC1                        78.5 VI_Entacmaea_quadricoâ€¦ Entacmaea_quadriâ€¦ Hostâ€¦
6 PC2                        10.1 VI_Entacmaea_quadricoâ€¦ Entacmaea_quadriâ€¦ Hostâ€¦</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/variable-importance-comparison-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Saved variable importance comparison plot to: /home/bi-server-kyoto/a0236995/sdm_anemonefish/figure_files/variable_importance_comparison_guilds.png 

--- T-tests for difference in Variable Importance between Guilds ---
  Testing variable: PC1 

    Welch Two Sample t-test

data:  Permutation_Importance by guild
t = -3.0751, df = 34.118, p-value = 0.004126
alternative hypothesis: true difference in means between group Anemonefish (Env-Only) and group Host Anemones is not equal to 0
95 percent confidence interval:
 -30.514988  -6.232419
sample estimates:
mean in group Anemonefish (Env-Only)          mean in group Host Anemones 
                             64.1963                              82.5700 

  Testing variable: PC2 

    Welch Two Sample t-test

data:  Permutation_Importance by guild
t = 1.3376, df = 33.688, p-value = 0.19
alternative hypothesis: true difference in means between group Anemonefish (Env-Only) and group Host Anemones is not equal to 0
95 percent confidence interval:
 -3.265165 15.826646
sample estimates:
mean in group Anemonefish (Env-Only)          mean in group Host Anemones 
                            16.54074                             10.26000 

  Testing variable: PC4 

    Welch Two Sample t-test

data:  Permutation_Importance by guild
t = 1.3099, df = 33.684, p-value = 0.1991
alternative hypothesis: true difference in means between group Anemonefish (Env-Only) and group Host Anemones is not equal to 0
95 percent confidence interval:
 -2.016450  9.322376
sample estimates:
mean in group Anemonefish (Env-Only)          mean in group Host Anemones 
                            8.862963                             5.210000 

  Testing variable: PC3 

    Welch Two Sample t-test

data:  Permutation_Importance by guild
t = 2.3588, df = 28.522, p-value = 0.02541
alternative hypothesis: true difference in means between group Anemonefish (Env-Only) and group Host Anemones is not equal to 0
95 percent confidence interval:
  1.118441 15.788966
sample estimates:
mean in group Anemonefish (Env-Only)          mean in group Host Anemones 
                             10.4037                               1.9500 </code></pre>
</div>
</div>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>